<!-- build time:Tue Jan 12 2021 23:56:36 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta name="referrer" content="no-referrer"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>数据仓库超详细案例 | 布兰特 | 不忘初心</title><meta name="description" content="以下这篇博客转载自数据仓库案例，巨详细👍👍👍👍👍离线数据仓库数据仓库（Data WareHouse）是为企业所有决策制定过程，提供所有系统数据支持的战略集合通过对数据仓库中数据的分析，可以帮助企业，改进业务流程、控制、成本、提高产品质量等数据仓库，并不是数据最终目的地，而是为数据最终的目的地做好准备：清洗、转义、分类、重组、合并、拆分、统计等等1 项目简介1.1 项目需求用户行为数据采集"><meta property="og:type" content="article"><meta property="og:title" content="数据仓库超详细案例"><meta property="og:url" content="cpeixin.cn/2020/07/07/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E8%B6%85%E8%AF%A6%E7%BB%86%E6%A1%88%E4%BE%8B/index.html"><meta property="og:site_name" content="布兰特 | 不忘初心"><meta property="og:description" content="以下这篇博客转载自数据仓库案例，巨详细👍👍👍👍👍离线数据仓库数据仓库（Data WareHouse）是为企业所有决策制定过程，提供所有系统数据支持的战略集合通过对数据仓库中数据的分析，可以帮助企业，改进业务流程、控制、成本、提高产品质量等数据仓库，并不是数据最终目的地，而是为数据最终的目的地做好准备：清洗、转义、分类、重组、合并、拆分、统计等等1 项目简介1.1 项目需求用户行为数据采集"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445205-31fdcfc5-e2d2-41a6-b5cc-624c31b3e574.png#align=left&display=inline&height=744&margin=%5Bobject%20Object%5D&originHeight=744&originWidth=1234&size=0&status=done&style=none&width=1234"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445253-8d922f5c-47b5-4f1d-ad8e-1a71eeae15aa.png#align=left&display=inline&height=736&margin=%5Bobject%20Object%5D&originHeight=736&originWidth=1703&size=0&status=done&style=none&width=1703"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445220-53833589-bf8f-44b6-8c7b-465e87e1e711.png#align=left&display=inline&height=836&margin=%5Bobject%20Object%5D&originHeight=836&originWidth=482&size=0&status=done&style=none&width=482"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445213-0bbd34e0-bb23-4e03-b90e-3ca09d0c5569.png#align=left&display=inline&height=838&margin=%5Bobject%20Object%5D&originHeight=838&originWidth=499&size=0&status=done&style=none&width=499"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445268-6588114c-b79a-4e79-8763-250f838f3536.png#align=left&display=inline&height=711&margin=%5Bobject%20Object%5D&originHeight=711&originWidth=493&size=0&status=done&style=none&width=493"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445229-1c9049ba-ee68-4f5c-ad71-bba666fde424.png#align=left&display=inline&height=858&margin=%5Bobject%20Object%5D&originHeight=858&originWidth=513&size=0&status=done&style=none&width=513"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445234-c1ea35e6-d731-485d-9f74-e1eccba7431e.png#align=left&display=inline&height=894&margin=%5Bobject%20Object%5D&originHeight=894&originWidth=537&size=0&status=done&style=none&width=537"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445204-a4518660-4192-4dc1-b934-848b40a364d9.png#align=left&display=inline&height=772&margin=%5Bobject%20Object%5D&originHeight=772&originWidth=493&size=0&status=done&style=none&width=493"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445276-36599c24-74d5-4b7f-8674-1979b36b32cf.png#align=left&display=inline&height=815&margin=%5Bobject%20Object%5D&originHeight=815&originWidth=1918&size=0&status=done&style=none&width=1918"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445197-5930bda1-7de7-4d77-8450-d1408dde46ad.png#align=left&display=inline&height=738&margin=%5Bobject%20Object%5D&originHeight=738&originWidth=1301&size=0&status=done&style=none&width=1301"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445200-dd221676-3d59-4d7f-a516-52882e9754d2.png#align=left&display=inline&height=810&margin=%5Bobject%20Object%5D&originHeight=810&originWidth=1300&size=0&status=done&style=none&width=1300"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445354-3c28f41c-e63c-4fb9-84d2-2758e24117d7.png#align=left&display=inline&height=356&margin=%5Bobject%20Object%5D&originHeight=356&originWidth=1501&size=0&status=done&style=none&width=1501"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445239-29830e5f-2628-4b61-b25c-860285f21cc5.png#align=left&display=inline&height=733&margin=%5Bobject%20Object%5D&originHeight=733&originWidth=1500&size=0&status=done&style=none&width=1500"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445257-f8650a51-09ee-42f3-b9e6-c374f207c5b9.png#align=left&display=inline&height=402&margin=%5Bobject%20Object%5D&originHeight=402&originWidth=1501&size=0&status=done&style=none&width=1501"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445238-b3a082a7-5282-4ffe-b763-62f4d159a8b3.png#align=left&display=inline&height=395&margin=%5Bobject%20Object%5D&originHeight=395&originWidth=1501&size=0&status=done&style=none&width=1501"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445231-a9463aec-bcbe-4716-9e21-e761f37fc57e.png#align=left&display=inline&height=64&margin=%5Bobject%20Object%5D&originHeight=64&originWidth=1152&size=0&status=done&style=none&width=1152"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445356-4fb1c879-70b3-4a9b-aecd-98bc3096d13d.png#align=left&display=inline&height=61&margin=%5Bobject%20Object%5D&originHeight=61&originWidth=1150&size=0&status=done&style=none&width=1150"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445278-2645af1d-a1c6-49eb-9fae-9a2e54c6fdd1.png#align=left&display=inline&height=125&margin=%5Bobject%20Object%5D&originHeight=125&originWidth=1204&size=0&status=done&style=none&width=1204"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445291-68eeb8c7-d2d0-4420-b26b-7008b185d7d4.png#align=left&display=inline&height=278&margin=%5Bobject%20Object%5D&originHeight=278&originWidth=918&size=0&status=done&style=none&width=918"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445578-b0c40759-4e33-4b63-899b-6757a21dca2b.png#align=left&display=inline&height=821&margin=%5Bobject%20Object%5D&originHeight=821&originWidth=1920&size=0&status=done&style=none&width=1920"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445286-e3d74a0a-846a-497d-9395-835dc06bbe36.png#align=left&display=inline&height=378&margin=%5Bobject%20Object%5D&originHeight=378&originWidth=1509&size=0&status=done&style=none&width=1509"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445293-b89b1d01-98f1-4ea2-9a5f-8b49b3bb9549.png#align=left&display=inline&height=385&margin=%5Bobject%20Object%5D&originHeight=385&originWidth=1511&size=0&status=done&style=none&width=1511"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445281-63bb8866-411b-4829-b0b3-0d989bca1884.png#align=left&display=inline&height=571&margin=%5Bobject%20Object%5D&originHeight=571&originWidth=1159&size=0&status=done&style=none&width=1159"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445499-c8b438ec-8428-4251-83c3-daecf0ea0f47.png#align=left&display=inline&height=647&margin=%5Bobject%20Object%5D&originHeight=647&originWidth=959&size=0&status=done&style=none&width=959"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445306-c312505f-c425-4ba5-97ee-9970d00d11df.png#align=left&display=inline&height=603&margin=%5Bobject%20Object%5D&originHeight=603&originWidth=1244&size=0&status=done&style=none&width=1244"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445320-2cc623a5-0587-4abf-a3ae-daaaf038854d.png#align=left&display=inline&height=682&margin=%5Bobject%20Object%5D&originHeight=682&originWidth=1134&size=0&status=done&style=none&width=1134"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445293-807044ab-66a1-4421-823b-b7945c79f048.png#align=left&display=inline&height=370&margin=%5Bobject%20Object%5D&originHeight=370&originWidth=820&size=0&status=done&style=none&width=820"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445421-3fefa623-d4e1-4458-9247-ceafcc11bbd9.png#align=left&display=inline&height=188&margin=%5Bobject%20Object%5D&originHeight=188&originWidth=820&size=0&status=done&style=none&width=820"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445457-375551a4-5ba5-4fe2-8594-36a86445a0e9.png#align=left&display=inline&height=224&margin=%5Bobject%20Object%5D&originHeight=224&originWidth=820&size=0&status=done&style=none&width=820"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445409-4fcce741-b0a9-40fe-ae2a-e0669c51338b.png#align=left&display=inline&height=261&margin=%5Bobject%20Object%5D&originHeight=261&originWidth=820&size=0&status=done&style=none&width=820"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445599-b968e841-b432-4d76-87e3-e4e4990466c9.png#align=left&display=inline&height=93&margin=%5Bobject%20Object%5D&originHeight=93&originWidth=820&size=0&status=done&style=none&width=820"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445399-404c5075-6615-4886-8101-ae6a9a2ea836.png#align=left&display=inline&height=99&margin=%5Bobject%20Object%5D&originHeight=99&originWidth=820&size=0&status=done&style=none&width=820"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445762-7d1a4322-7ef5-4fe2-bb8b-ef97c0bcbb9a.png#align=left&display=inline&height=103&margin=%5Bobject%20Object%5D&originHeight=103&originWidth=820&size=0&status=done&style=none&width=820"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445446820-0341ff71-434e-4a82-8036-eba14a8476b9.png#align=left&display=inline&height=199&margin=%5Bobject%20Object%5D&originHeight=199&originWidth=820&size=0&status=done&style=none&width=820"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445408-12faad35-63c2-4718-ac13-83b26354b3c3.png#align=left&display=inline&height=119&margin=%5Bobject%20Object%5D&originHeight=119&originWidth=820&size=0&status=done&style=none&width=820"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445709-051d048d-66ef-40a7-981a-8538094858a6.png#align=left&display=inline&height=72&margin=%5Bobject%20Object%5D&originHeight=72&originWidth=820&size=0&status=done&style=none&width=820"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445417-956df41f-c8d8-43e9-a9ef-478c4e16fa95.png#align=left&display=inline&height=106&margin=%5Bobject%20Object%5D&originHeight=106&originWidth=1277&size=0&status=done&style=none&width=1277"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445403-6ebe9cc2-6007-4e39-9647-1d63cb9886f4.png#align=left&display=inline&height=118&margin=%5Bobject%20Object%5D&originHeight=118&originWidth=820&size=0&status=done&style=none&width=820"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445616-7c564b8c-e4be-4942-a245-5a986b440689.png#align=left&display=inline&height=136&margin=%5Bobject%20Object%5D&originHeight=136&originWidth=820&size=0&status=done&style=none&width=820"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445432-2a0d5fa0-0fcf-45b9-9d62-a3c97be4ced3.png#align=left&display=inline&height=260&margin=%5Bobject%20Object%5D&originHeight=260&originWidth=1132&size=0&status=done&style=none&width=1132"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445415-560c225d-39ad-4e97-ae5e-feded91e61bc.png#align=left&display=inline&height=211&margin=%5Bobject%20Object%5D&originHeight=211&originWidth=820&size=0&status=done&style=none&width=820"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445420-ec008b1a-ac25-4d67-8f30-a4f22f8bf986.png#align=left&display=inline&height=229&margin=%5Bobject%20Object%5D&originHeight=229&originWidth=820&size=0&status=done&style=none&width=820"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445413-5bc2fefc-43ea-4198-962a-68e04c3693b5.png#align=left&display=inline&height=167&margin=%5Bobject%20Object%5D&originHeight=167&originWidth=820&size=0&status=done&style=none&width=820"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445440-5134d8aa-2085-457c-bb47-4ba611528bc1.png#align=left&display=inline&height=193&margin=%5Bobject%20Object%5D&originHeight=193&originWidth=820&size=0&status=done&style=none&width=820"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445469-06ad320b-4efb-4e48-b359-66b5a0180987.png#align=left&display=inline&height=306&margin=%5Bobject%20Object%5D&originHeight=306&originWidth=820&size=0&status=done&style=none&width=820"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445480-d02fd607-dfe9-47b8-992f-8f675460e400.png#align=left&display=inline&height=172&margin=%5Bobject%20Object%5D&originHeight=172&originWidth=820&size=0&status=done&style=none&width=820"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445580-ef8aff78-4e6e-4cfa-8a34-5cb0929bbf8f.png#align=left&display=inline&height=133&margin=%5Bobject%20Object%5D&originHeight=133&originWidth=820&size=0&status=done&style=none&width=820"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445455-d299fd9e-7ed4-4419-a4eb-41e0d3af4c25.png#align=left&display=inline&height=181&margin=%5Bobject%20Object%5D&originHeight=181&originWidth=1279&size=0&status=done&style=none&width=1279"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445509-9e9b8580-ed76-4d31-9524-0d9d35af8e7e.png#align=left&display=inline&height=194&margin=%5Bobject%20Object%5D&originHeight=194&originWidth=820&size=0&status=done&style=none&width=820"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445498-cace1b91-fd1c-495e-ae9e-5b20b950f181.png#align=left&display=inline&height=80&margin=%5Bobject%20Object%5D&originHeight=80&originWidth=820&size=0&status=done&style=none&width=820"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445585-dfcd1dca-4af1-4822-98c0-729ff17ad0cd.png#align=left&display=inline&height=105&margin=%5Bobject%20Object%5D&originHeight=105&originWidth=820&size=0&status=done&style=none&width=820"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445558-f3526a7c-422a-4254-b832-a0edb969ecd0.png#align=left&display=inline&height=577&margin=%5Bobject%20Object%5D&originHeight=577&originWidth=1161&size=0&status=done&style=none&width=1161"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445503-1f00df37-1048-4dab-bd2a-b93874b97ed6.png#align=left&display=inline&height=563&margin=%5Bobject%20Object%5D&originHeight=563&originWidth=1141&size=0&status=done&style=none&width=1141"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445576-95ae80a2-e157-4ba2-ac2f-39c0057bfc4d.png#align=left&display=inline&height=820&margin=%5Bobject%20Object%5D&originHeight=820&originWidth=1920&size=0&status=done&style=none&width=1920"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445577-7f5949c5-01ad-4097-b19b-0ebe0cfd3546.png#align=left&display=inline&height=625&margin=%5Bobject%20Object%5D&originHeight=625&originWidth=847&size=0&status=done&style=none&width=847"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445447507-0aa01c2c-12fc-4d51-ba3e-a055609bcb47.png#align=left&display=inline&height=682&margin=%5Bobject%20Object%5D&originHeight=682&originWidth=1134&size=0&status=done&style=none&width=1134"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445580-441c434e-54a5-49d6-973a-ef7d97c1b4ac.png#align=left&display=inline&height=577&margin=%5Bobject%20Object%5D&originHeight=577&originWidth=1161&size=0&status=done&style=none&width=1161"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445560-1a8ada2f-b802-4db9-b161-788f80c89770.png#align=left&display=inline&height=683&margin=%5Bobject%20Object%5D&originHeight=683&originWidth=1168&size=0&status=done&style=none&width=1168"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445550-cccdcf34-74d8-42ae-ba5e-2c3769ca3c9e.png#align=left&display=inline&height=77&margin=%5Bobject%20Object%5D&originHeight=77&originWidth=1255&size=0&status=done&style=none&width=1255"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445578-aeef9cf0-c4cf-4a5a-91ea-02ec01c0bf61.png#align=left&display=inline&height=622&margin=%5Bobject%20Object%5D&originHeight=622&originWidth=981&size=0&status=done&style=none&width=981"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445446614-4652a8e0-0b0a-4e2a-910b-e90751aed058.png#align=left&display=inline&height=446&margin=%5Bobject%20Object%5D&originHeight=446&originWidth=951&size=0&status=done&style=none&width=951"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445749-02840e2e-dcb1-4a8a-8778-e6ee6b650936.png#align=left&display=inline&height=614&margin=%5Bobject%20Object%5D&originHeight=614&originWidth=1477&size=0&status=done&style=none&width=1477"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445567-5b7c6d42-4d24-4807-afb3-cdea023f4f90.png#align=left&display=inline&height=477&margin=%5Bobject%20Object%5D&originHeight=477&originWidth=951&size=0&status=done&style=none&width=951"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445612-d6f7562c-f0bb-430f-b4af-7b42344e971f.png#align=left&display=inline&height=730&margin=%5Bobject%20Object%5D&originHeight=730&originWidth=1437&size=0&status=done&style=none&width=1437"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445586-766cb2b8-d761-4c9a-a289-16f60a99ddcd.png#align=left&display=inline&height=477&margin=%5Bobject%20Object%5D&originHeight=477&originWidth=951&size=0&status=done&style=none&width=951"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445702-d1a78ffa-edf3-4d58-a3bb-dab7ac195815.png#align=left&display=inline&height=604&margin=%5Bobject%20Object%5D&originHeight=604&originWidth=1333&size=0&status=done&style=none&width=1333"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445677-bc019011-2053-412d-b4c8-bfd856f29547.png#align=left&display=inline&height=603&margin=%5Bobject%20Object%5D&originHeight=603&originWidth=1333&size=0&status=done&style=none&width=1333"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445698-37476ac6-25f3-4cea-86ac-f907a3cb1d1d.png#align=left&display=inline&height=621&margin=%5Bobject%20Object%5D&originHeight=621&originWidth=1376&size=0&status=done&style=none&width=1376"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445696-3b581062-c5d4-427f-ba12-e6867d59b49c.png#align=left&display=inline&height=417&margin=%5Bobject%20Object%5D&originHeight=417&originWidth=1318&size=0&status=done&style=none&width=1318"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445883-e8c65772-697b-4f7a-9dd5-d454e8615019.png#align=left&display=inline&height=534&margin=%5Bobject%20Object%5D&originHeight=534&originWidth=1315&size=0&status=done&style=none&width=1315"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445446239-9b99f151-4d88-4505-ab08-fb212a6d8ac7.png#align=left&display=inline&height=339&margin=%5Bobject%20Object%5D&originHeight=339&originWidth=1207&size=0&status=done&style=none&width=1207"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445446059-b20b058a-4006-4c97-bce2-84b85cd28599.png#align=left&display=inline&height=624&margin=%5Bobject%20Object%5D&originHeight=624&originWidth=1205&size=0&status=done&style=none&width=1205"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445818-d1c8fc14-e529-4591-805f-7345bab479e8.png#align=left&display=inline&height=330&margin=%5Bobject%20Object%5D&originHeight=330&originWidth=1906&size=0&status=done&style=none&width=1906"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445645-ab931a0b-bb10-4b9a-9c67-c42afdb4132d.png#align=left&display=inline&height=334&margin=%5Bobject%20Object%5D&originHeight=334&originWidth=1722&size=0&status=done&style=none&width=1722"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445674-85cdb9f6-3bc5-45af-a42c-260b856251c4.png#align=left&display=inline&height=727&margin=%5Bobject%20Object%5D&originHeight=727&originWidth=1200&size=0&status=done&style=none&width=1200"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445446714-5b66a38b-d703-4552-a3b2-78e2bb1093b0.png#align=left&display=inline&height=633&margin=%5Bobject%20Object%5D&originHeight=633&originWidth=1129&size=0&status=done&style=none&width=1129"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445779-c15f3dba-9e4f-4a43-aa6a-da30699cb8ae.png#align=left&display=inline&height=554&margin=%5Bobject%20Object%5D&originHeight=554&originWidth=1243&size=0&status=done&style=none&width=1243"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445711-5342c8ec-2d69-476f-bb7d-80084793cdc7.png#align=left&display=inline&height=699&margin=%5Bobject%20Object%5D&originHeight=699&originWidth=1309&size=0&status=done&style=none&width=1309"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445446108-d1824bc2-adf7-4c28-bc32-71e8ba274913.png#align=left&display=inline&height=806&margin=%5Bobject%20Object%5D&originHeight=806&originWidth=1435&size=0&status=done&style=none&width=1435"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445740-8f05faaa-a871-4d74-9b27-f4fa1da7e452.png#align=left&display=inline&height=771&margin=%5Bobject%20Object%5D&originHeight=771&originWidth=1437&size=0&status=done&style=none&width=1437"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445877-2b94e8bb-aec2-445a-bea1-1e80c6f64ace.png#align=left&display=inline&height=836&margin=%5Bobject%20Object%5D&originHeight=836&originWidth=1647&size=0&status=done&style=none&width=1647"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445836-498738cf-a65f-4127-af18-9a1661eda52d.png#align=left&display=inline&height=522&margin=%5Bobject%20Object%5D&originHeight=522&originWidth=987&size=0&status=done&style=none&width=987"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445739-01d3c47c-ce57-475d-9b12-238c669b7f15.png#align=left&display=inline&height=412&margin=%5Bobject%20Object%5D&originHeight=412&originWidth=963&size=0&status=done&style=none&width=963"><meta property="article:published_time" content="2020-07-07T09:17:57.000Z"><meta property="article:modified_time" content="2020-08-03T09:19:05.745Z"><meta property="article:author" content="Brent"><meta property="article:tag" content="数据仓库"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445205-31fdcfc5-e2d2-41a6-b5cc-624c31b3e574.png#align=left&display=inline&height=744&margin=%5Bobject%20Object%5D&originHeight=744&originWidth=1234&size=0&status=done&style=none&width=1234"><link rel="canonical" href="cpeixin.cn/2020/07/07/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E8%B6%85%E8%AF%A6%E7%BB%86%E6%A1%88%E4%BE%8B/index.html"><link rel="alternate" href="/atom.xml" title="布兰特 | 不忘初心" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.css" rel="stylesheet"><meta name="generator" content="Hexo 4.2.0"></head><body class="main-center" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/cpeixin" target="_blank" rel="external nofollow noopener noreferrer"><img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">Brent</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">大数据工程师 &amp; 机器学习</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Malaysia</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">分类</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">标签</span></a></li><li class="menu-item menu-item-repository"><a href="/repository"><i class="icon icon-project"></i> <span class="menu-title">项目</span></a></li><li class="menu-item menu-item-books"><a href="/books"><i class="icon icon-book-fill"></i> <span class="menu-title">书单</span></a></li><li class="menu-item menu-item-links"><a href="/links"><i class="icon icon-friendship"></i> <span class="menu-title">友链</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-cup-fill"></i> <span class="menu-title">关于</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/cpeixin" target="_blank" title="Github" data-toggle="tooltip" data-placement="top" rel="external nofollow noopener noreferrer"><i class="icon icon-github"></i></a></li><li><a href="https://www.weibo.com/u/1970875963" target="_blank" title="Weibo" data-toggle="tooltip" data-placement="top" rel="external nofollow noopener noreferrer"><i class="icon icon-weibo"></i></a></li><li><a href="https://twitter.com/iwebued" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top" rel="external nofollow noopener noreferrer"><i class="icon icon-twitter"></i></a></li><li><a href="https://www.behance.net/cofess" target="_blank" title="Behance" data-toggle="tooltip" data-placement="top" rel="external nofollow noopener noreferrer"><i class="icon icon-behance"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><p>人处在一种默默奋斗的状态，精神就会从琐碎生活中得到升华</p></div></div></div></div><div class="widget"><h3 class="widget-title">分类</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/DataBase/">DataBase</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/DataBases/">DataBases</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/NLP/">NLP</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tools/">Tools</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a><span class="category-list-count">111</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">开发工具</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a><span class="category-list-count">31</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9E%B6%E6%9E%84/">架构</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">深度学习</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97/">源码系列</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/">计算机组成原理</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a><span class="category-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签</h3><div class="widget-body"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Apriori/" rel="tag">Apriori</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/COS/" rel="tag">COS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CPU/" rel="tag">CPU</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DMP/" rel="tag">DMP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Decision-Tree/" rel="tag">Decision Tree</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EM/" rel="tag">EM</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ETL/" rel="tag">ETL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flink/" rel="tag">Flink</a><span class="tag-list-count">33</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GPT-2/" rel="tag">GPT-2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HBase/" rel="tag">HBase</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HashMap/" rel="tag">HashMap</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hive/" rel="tag">Hive</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IDEA/" rel="tag">IDEA</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K-Means/" rel="tag">K-Means</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KNN/" rel="tag">KNN</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LRU%E6%B7%98%E6%B1%B0%E7%AE%97%E6%B3%95/" rel="tag">LRU淘汰算法</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Naive-Bayes/" rel="tag">Naive Bayes</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OLAP/" rel="tag">OLAP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PageRank/" rel="tag">PageRank</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Parquet/" rel="tag">Parquet</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Random-Forest/" rel="tag">Random Forest</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SVM/" rel="tag">SVM</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flask/" rel="tag">flask</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flink/" rel="tag">flink</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hdfs/" rel="tag">hdfs</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hive/" rel="tag">hive</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafka/" rel="tag">kafka</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kali/" rel="tag">kali</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mapreduce/" rel="tag">mapreduce</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/paxos/" rel="tag">paxos</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scala/" rel="tag">scala</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shadowsock/" rel="tag">shadowsock</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/skipList/" rel="tag">skipList</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sklearn/" rel="tag">sklearn</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spark/" rel="tag">spark</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/yarn/" rel="tag">yarn</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE/" rel="tag">二分查找</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/" rel="tag">二叉树</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" rel="tag">动态规划</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" rel="tag">单例模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9B%9E%E6%BA%AF/" rel="tag">回溯</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A0%86/" rel="tag">堆</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/" rel="tag">布隆过滤器</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8E%92%E5%BA%8F/" rel="tag">排序</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%A3%E5%88%97%E8%A1%A8/" rel="tag">散列表</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/" rel="tag">数据仓库</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97/" rel="tag">数据清洗</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86/" rel="tag">数据采集</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E7%BB%84/" rel="tag">数组</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97/" rel="tag">时间序列</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%89%E5%85%A8/" rel="tag">服务器安全</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A0%88/" rel="tag">栈</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" rel="tag">深度学习</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%88%AC%E8%99%AB/" rel="tag">爬虫</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%89%B9%E5%BE%81%E5%B7%A5%E7%A8%8B/" rel="tag">特征工程</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%94%A8%E6%88%B7%E7%94%BB%E5%83%8F/" rel="tag">用户画像</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%A2%E9%BB%91%E6%A0%91/" rel="tag">红黑树</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E6%80%A7%E8%A1%A8/" rel="tag">线性表</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%8D%E5%90%91%E9%87%8F/" rel="tag">词向量</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%92%E5%BD%92/" rel="tag">递归</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92/" rel="tag">逻辑回归</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%93%BE%E8%A1%A8/" rel="tag">链表</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%98%9F%E5%88%97/" rel="tag">队列</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签云</h3><div class="widget-body tagcloud"><a href="/tags/Apriori/" style="font-size:13.11px">Apriori</a> <a href="/tags/COS/" style="font-size:13px">COS</a> <a href="/tags/CPU/" style="font-size:13px">CPU</a> <a href="/tags/DMP/" style="font-size:13px">DMP</a> <a href="/tags/Decision-Tree/" style="font-size:13.44px">Decision Tree</a> <a href="/tags/EM/" style="font-size:13.11px">EM</a> <a href="/tags/ETL/" style="font-size:13px">ETL</a> <a href="/tags/Flink/" style="font-size:14px">Flink</a> <a href="/tags/GPT-2/" style="font-size:13px">GPT-2</a> <a href="/tags/HBase/" style="font-size:13.56px">HBase</a> <a href="/tags/HashMap/" style="font-size:13px">HashMap</a> <a href="/tags/Hive/" style="font-size:13px">Hive</a> <a href="/tags/IDEA/" style="font-size:13px">IDEA</a> <a href="/tags/K-Means/" style="font-size:13px">K-Means</a> <a href="/tags/KNN/" style="font-size:13.11px">KNN</a> <a href="/tags/LRU%E6%B7%98%E6%B1%B0%E7%AE%97%E6%B3%95/" style="font-size:13px">LRU淘汰算法</a> <a href="/tags/Naive-Bayes/" style="font-size:13.11px">Naive Bayes</a> <a href="/tags/OLAP/" style="font-size:13px">OLAP</a> <a href="/tags/PageRank/" style="font-size:13.11px">PageRank</a> <a href="/tags/Parquet/" style="font-size:13px">Parquet</a> <a href="/tags/Random-Forest/" style="font-size:13px">Random Forest</a> <a href="/tags/SVM/" style="font-size:13.11px">SVM</a> <a href="/tags/docker/" style="font-size:13.11px">docker</a> <a href="/tags/flask/" style="font-size:13.11px">flask</a> <a href="/tags/flink/" style="font-size:13px">flink</a> <a href="/tags/hdfs/" style="font-size:13.33px">hdfs</a> <a href="/tags/hive/" style="font-size:13.44px">hive</a> <a href="/tags/java/" style="font-size:13px">java</a> <a href="/tags/kafka/" style="font-size:13.67px">kafka</a> <a href="/tags/kali/" style="font-size:13px">kali</a> <a href="/tags/mapreduce/" style="font-size:13.11px">mapreduce</a> <a href="/tags/mysql/" style="font-size:13.22px">mysql</a> <a href="/tags/paxos/" style="font-size:13.11px">paxos</a> <a href="/tags/python/" style="font-size:13.56px">python</a> <a href="/tags/redis/" style="font-size:13.33px">redis</a> <a href="/tags/scala/" style="font-size:13.33px">scala</a> <a href="/tags/shadowsock/" style="font-size:13px">shadowsock</a> <a href="/tags/skipList/" style="font-size:13px">skipList</a> <a href="/tags/sklearn/" style="font-size:13px">sklearn</a> <a href="/tags/spark/" style="font-size:13.89px">spark</a> <a href="/tags/yarn/" style="font-size:13px">yarn</a> <a href="/tags/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE/" style="font-size:13.11px">二分查找</a> <a href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/" style="font-size:13.22px">二叉树</a> <a href="/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" style="font-size:13px">动态规划</a> <a href="/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" style="font-size:13px">单例模式</a> <a href="/tags/%E5%9B%9E%E6%BA%AF/" style="font-size:13px">回溯</a> <a href="/tags/%E5%A0%86/" style="font-size:13px">堆</a> <a href="/tags/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/" style="font-size:13px">布隆过滤器</a> <a href="/tags/%E6%8E%92%E5%BA%8F/" style="font-size:13.78px">排序</a> <a href="/tags/%E6%95%A3%E5%88%97%E8%A1%A8/" style="font-size:13px">散列表</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/" style="font-size:13.78px">数据仓库</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97/" style="font-size:13px">数据清洗</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86/" style="font-size:13px">数据采集</a> <a href="/tags/%E6%95%B0%E7%BB%84/" style="font-size:13px">数组</a> <a href="/tags/%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97/" style="font-size:13px">时间序列</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%89%E5%85%A8/" style="font-size:13.11px">服务器安全</a> <a href="/tags/%E6%A0%88/" style="font-size:13px">栈</a> <a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" style="font-size:13px">深度学习</a> <a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size:13px">爬虫</a> <a href="/tags/%E7%89%B9%E5%BE%81%E5%B7%A5%E7%A8%8B/" style="font-size:13.33px">特征工程</a> <a href="/tags/%E7%94%A8%E6%88%B7%E7%94%BB%E5%83%8F/" style="font-size:13.11px">用户画像</a> <a href="/tags/%E7%BA%A2%E9%BB%91%E6%A0%91/" style="font-size:13px">红黑树</a> <a href="/tags/%E7%BA%BF%E6%80%A7%E8%A1%A8/" style="font-size:13px">线性表</a> <a href="/tags/%E8%AF%8D%E5%90%91%E9%87%8F/" style="font-size:13px">词向量</a> <a href="/tags/%E9%80%92%E5%BD%92/" style="font-size:13px">递归</a> <a href="/tags/%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92/" style="font-size:13px">逻辑回归</a> <a href="/tags/%E9%93%BE%E8%A1%A8/" style="font-size:13.11px">链表</a> <a href="/tags/%E9%98%9F%E5%88%97/" style="font-size:13px">队列</a></div></div><div class="widget"><h3 class="widget-title">归档</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a><span class="archive-list-count">16</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">22</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a><span class="archive-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">最新文章</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></p><p class="item-title"><a href="/2021/01/12/Hive-Cli-%E5%90%AF%E5%8A%A8%E5%8D%A1%E6%AD%BB%E7%9A%84%E9%97%AE%E9%A2%98/" class="title">Hive Cli 启动卡死的问题</a></p><p class="item-date"><time datetime="2021-01-12T15:54:22.000Z" itemprop="datePublished">2021-01-12</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97/">源码系列</a></p><p class="item-title"><a href="/2020/12/06/MapReduce%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E4%B8%80/" class="title">MapReduce源码解析(一)</a></p><p class="item-date"><time datetime="2020-12-06T10:15:23.000Z" itemprop="datePublished">2020-12-06</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></p><p class="item-title"><a href="/2020/11/29/%E5%A4%A7%E6%95%B0%E6%8D%AE%E9%9B%86%E7%BE%A4%E6%96%B0%E6%A8%A1%E5%BC%8F-%E5%AD%98%E7%AE%97%E5%88%86%E7%A6%BB/" class="title">大数据集群新模式-存算分离</a></p><p class="item-date"><time datetime="2020-11-29T15:02:43.000Z" itemprop="datePublished">2020-11-29</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></p><p class="item-title"><a href="/2020/11/21/Flink%E6%B6%88%E8%B4%B9Kafka%E4%BB%A5%E5%8F%8A%E5%8F%82%E6%95%B0%E8%AE%BE%E7%BD%AE/" class="title">Flink消费Kafka以及参数设置</a></p><p class="item-date"><time datetime="2020-11-21T10:25:43.000Z" itemprop="datePublished">2020-11-21</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></p><p class="item-title"><a href="/2020/11/19/%E5%85%B3%E4%BA%8EHive%E4%B8%AD%E7%9A%84NULL/" class="title">关于Hive中的NULL</a></p><p class="item-date"><time datetime="2020-11-18T16:35:14.000Z" itemprop="datePublished">2020-11-19</time></p></div></li></ul></div></div></div></aside><main class="main" role="main"><div class="content"><article id="post-数据仓库超详细案例" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">数据仓库超详细案例</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2020/07/07/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E8%B6%85%E8%AF%A6%E7%BB%86%E6%A1%88%E4%BE%8B/" class="article-date"><time datetime="2020-07-07T09:17:57.000Z" itemprop="datePublished">2020-07-07</time></a></span> <span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></span> <span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link" href="/tags/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/" rel="tag">数据仓库</a></span> <span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="/2020/07/07/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E8%B6%85%E8%AF%A6%E7%BB%86%E6%A1%88%E4%BE%8B/" class="leancloud_visitors" data-flag-title="数据仓库超详细案例">0</span></span> <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2020/07/07/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E8%B6%85%E8%AF%A6%E7%BB%86%E6%A1%88%E4%BE%8B/#comments" class="article-comment-link">评论</a></span> <span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 42.9k(字)</span> <span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 230(分)</span></div></div><div class="article-entry marked-body" itemprop="articleBody"><p>以下这篇博客转载自<a href="https://www.cnblogs.com/ttzzyy/p/13255841.html" target="_blank" rel="external nofollow noopener noreferrer">数据仓库案例</a>，巨详细👍👍👍👍👍<br><a name="9oBBW"></a></p><h1 id="离线数据仓库"><a href="#离线数据仓库" class="headerlink" title="离线数据仓库"></a>离线数据仓库</h1><blockquote><p>数据仓库（Data WareHouse）是为企业所有决策制定过程，提供所有系统数据支持的战略集合<br>通过对数据仓库中数据的分析，可以帮助企业，改进业务流程、控制、成本、提高产品质量等<br>数据仓库，并不是数据最终目的地，而是为数据最终的目的地做好准备：清洗、转义、分类、重组、合并、拆分、统计等等</p></blockquote><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445205-31fdcfc5-e2d2-41a6-b5cc-624c31b3e574.png#align=left&display=inline&height=744&margin=%5Bobject%20Object%5D&originHeight=744&originWidth=1234&size=0&status=done&style=none&width=1234" alt><br><a name="blogTitle0"></a></p><h2 id="1-项目简介"><a href="#1-项目简介" class="headerlink" title="1 项目简介"></a>1 项目简介</h2><p><a name="blogTitle1"></a></p><h3 id="1-1-项目需求"><a href="#1-1-项目需求" class="headerlink" title="1.1 项目需求"></a>1.1 项目需求</h3><ol><li>用户行为数据采集平台搭建</li><li>业务数据采集平台搭建</li><li>数据仓库维度建模</li><li>分析：用户、流量、会员、商品、销售、地区、活动等主题</li><li>采用即席查询工具，随时进行指标分析</li><li>对集群性能进行监控，发生异常需要报警</li><li>元数据管理</li><li>质量监控<br><a name="blogTitle2"></a><h3 id="1-2-技术选型"><a href="#1-2-技术选型" class="headerlink" title="1.2 技术选型"></a>1.2 技术选型</h3></li></ol><ul><li><p>数据采集功能如何技术选型</p><table><thead><tr><th align="center">采集框架名称</th><th>主要功能</th></tr></thead><tbody><tr><td align="center">Sqoop</td><td>大数据平台和关系型数据库的导入导出</td></tr><tr><td align="center">Datax</td><td>大数据平台和关系型数据库的导入导出</td></tr><tr><td align="center">flume</td><td>擅长日志数据的采集和解析</td></tr><tr><td align="center">logstash</td><td>擅长日志数据的采集和解析</td></tr><tr><td align="center">maxwell</td><td>常用作实时解析mysql的binlog数据</td></tr><tr><td align="center">canal</td><td>常用作实时解析mysql的binlog数据</td></tr><tr><td align="center">waterDrop</td><td>数据导入导出工具</td></tr></tbody></table></li><li><p>消息中间件的技术选型</p><table><thead><tr><th align="center"><strong>开源MQ</strong></th><th><strong>概述</strong></th></tr></thead><tbody><tr><td align="center">RabbitMQ</td><td>LShift 用Erlang实现，支持多协议，broker架构，重量级</td></tr><tr><td align="center">ZeroMQ</td><td>AMQP最初设计者iMatix公司实现，轻量消息内核，无broker设计。C++实现</td></tr><tr><td align="center">Kafka</td><td>LinkedIn用Scala语言实现，支持hadoop数据并行加载</td></tr><tr><td align="center">ActiveMQ</td><td>Apach的一种JMS具体实现，支持代理和p2p部署。支持多协议。Java实现</td></tr><tr><td align="center">Redis</td><td>Key-value NoSQL数据库，有MQ的功能</td></tr><tr><td align="center">MemcacheQ</td><td>国人利用memcache缓冲队列协议开发的消息队列,C/C++实现</td></tr></tbody></table></li><li><p>数据永久存储技术框架选型</p><table><thead><tr><th align="center">框架名称</th><th>主要用途</th></tr></thead><tbody><tr><td align="center">HDFS</td><td>分布式文件存储系统</td></tr><tr><td align="center">Hbase</td><td>Key，value对的nosql数据库</td></tr><tr><td align="center">Kudu</td><td>Cloudera公司开源提供的类似于Hbase的数据存储</td></tr><tr><td align="center">Hive</td><td>基于MR的数据仓库工具</td></tr></tbody></table></li><li><p>数据离线计算框架技术选型(hive引擎)</p><table><thead><tr><th align="center">框架名称</th><th>基本介绍</th></tr></thead><tbody><tr><td align="center">MapReduce</td><td>最早期的分布式文件计算系统</td></tr><tr><td align="center">Spark</td><td>基于spark，一站式解决批流处理问题</td></tr><tr><td align="center">Flink</td><td>基于flink，一站式解决批流处理问题</td></tr></tbody></table></li><li><p>分析数据库选型</p><table><thead><tr><th>对比项目</th><th align="center">Druid</th><th align="center">Kylin</th><th align="center">Presto</th><th align="center">Impala</th><th align="center">ES</th></tr></thead><tbody><tr><td>亚秒级响应</td><td align="center">√</td><td align="center">√</td><td align="center">×</td><td align="center">×</td><td align="center">×</td></tr><tr><td>百亿数据集</td><td align="center">√</td><td align="center">√</td><td align="center">√</td><td align="center">√</td><td align="center">√</td></tr><tr><td>SQL支持</td><td align="center">√</td><td align="center">√</td><td align="center">√</td><td align="center">√</td><td align="center">√(需插件)</td></tr><tr><td>离线</td><td align="center">√</td><td align="center">√</td><td align="center">√</td><td align="center">√</td><td align="center">√</td></tr><tr><td>实时</td><td align="center">√</td><td align="center">√</td><td align="center">×</td><td align="center">×</td><td align="center">×</td></tr><tr><td>精确去重</td><td align="center">×</td><td align="center">√</td><td align="center">√</td><td align="center">√</td><td align="center">×</td></tr><tr><td>多表Join</td><td align="center">×</td><td align="center">√</td><td align="center">√</td><td align="center">√</td><td align="center">×</td></tr><tr><td>JDBC for BI</td><td align="center">×</td><td align="center">√</td><td align="center">√</td><td align="center">√</td><td align="center">×</td></tr></tbody></table></li><li><p>其他选型</p><ul><li>任务调度：DolphinScheduler</li><li>集群监控：CM+CDH</li><li>元数据管理：Atlas</li><li>BI工具：Zeppelin、Superset<br><a name="blogTitle3"></a><h3 id="1-3-架构"><a href="#1-3-架构" class="headerlink" title="1.3 架构"></a>1.3 架构</h3><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445253-8d922f5c-47b5-4f1d-ad8e-1a71eeae15aa.png#align=left&display=inline&height=736&margin=%5Bobject%20Object%5D&originHeight=736&originWidth=1703&size=0&status=done&style=none&width=1703" alt><br><a name="blogTitle4"></a><h3 id="1-4-集群资源规划"><a href="#1-4-集群资源规划" class="headerlink" title="1.4 集群资源规划"></a>1.4 集群资源规划</h3></li></ul></li><li><p>如何确认集群规模（假设每台服务器8T磁盘，128G内存）</p><ol><li>每天日活跃用户100万，每人一天平均100条：100万 * 100条 = 1亿条</li><li>每条日志1K左右，每天1一条：1亿 / 1024 /1024 = 约100G</li><li>半年内不扩容服务器来算：100G * 180天 = 约18T</li><li>保存3个副本：18T * 3 = 54T</li><li>预留20% ~ 30%BUF：54T / 0.7 = 77T</li><li>总结：约10台服务器<blockquote><p>由于资源有限，采用3台进行制作</p></blockquote></li></ol></li></ul><table><thead><tr><th>服务名称</th><th>子服务</th><th>服务器 cdh01.cm</th><th>服务器 cdh02.cm</th><th>服务器 cdh03.cm</th></tr></thead><tbody><tr><td>HDFS</td><td>NameNode<br>DataNode<br>SecondaryNameNode</td><td>√<br>√</td><td>√</td><td>√<br>√</td></tr><tr><td>Yarn</td><td>NodeManager<br>Resourcemanager</td><td>√</td><td>√<br>√</td><td>√</td></tr><tr><td>Zookeeper</td><td>Zookeeper Server</td><td>√</td><td>√</td><td>√</td></tr><tr><td>Flume</td><td>Flume<br>Flume（消费 Kafka）</td><td>√</td><td>√</td><td>√</td></tr><tr><td>Kafka</td><td>Kafka</td><td>√</td><td>√</td><td>√</td></tr><tr><td>Hive</td><td>Hive</td><td>√</td><td></td><td></td></tr><tr><td>MySQL</td><td>MySQL</td><td>√</td><td></td><td></td></tr><tr><td>Sqoop</td><td>Sqoop</td><td>√</td><td></td><td></td></tr><tr><td>Presto</td><td>Coordinator<br>Worker</td><td>√</td><td>√</td><td>√</td></tr><tr><td>DolphinScheduler</td><td>DolphinScheduler</td><td>√</td><td></td><td></td></tr><tr><td>Druid</td><td>Druid</td><td>√</td><td>√</td><td>√</td></tr><tr><td>Kylin</td><td>Kylin</td><td>√</td><td></td><td></td></tr><tr><td>Hbase</td><td>HMaster<br>HRegionServer</td><td>√<br>√</td><td>√</td><td>√</td></tr><tr><td>Superset</td><td>Superset</td><td>√</td><td></td><td></td></tr><tr><td>Atlas</td><td>Atlas</td><td>√</td><td></td><td></td></tr><tr><td>Solr</td><td>Solr</td><td>√</td><td></td><td></td></tr></tbody></table><p><a name="blogTitle5"></a></p><h2 id="2-数据生成模块"><a href="#2-数据生成模块" class="headerlink" title="2 数据生成模块"></a>2 数据生成模块</h2><blockquote><p>此模块主要针对于用户行为数据的采集，为什么要进行用户行为数据的采集呢？<br>因为对于企业来说，用户就是钱，需要将用户的习惯等数据进行采集，以便在大数据衍生产品如用户画像标签系统进行分析，那么一般情况下用户的信息都是离线分析的，后期我们可以将分析结果存入ES等倒排索引生态中，在使用实时计算的方式匹配用户习惯，进行定制化推荐，更进一步的深度学习，对相似用户进行推荐。</p></blockquote><p><a name="blogTitle6"></a></p><h3 id="2-1-埋点数据基本格式"><a href="#2-1-埋点数据基本格式" class="headerlink" title="2.1 埋点数据基本格式"></a>2.1 埋点数据基本格式</h3><ul><li><p>公共字段：基本所有安卓手机都包含的字段<br></p></li><li><p>业务字段：埋点上报的字段，有具体的业务类型<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;ap&quot;:&quot;xxxxx&quot;,&#x2F;&#x2F;项目数据来源 app pc</span><br><span class="line">&quot;cm&quot;: &#123; &#x2F;&#x2F;公共字段</span><br><span class="line">	&quot;mid&quot;: &quot;&quot;, &#x2F;&#x2F; (String) 设备唯一标识</span><br><span class="line">	&quot;uid&quot;: &quot;&quot;, &#x2F;&#x2F; (String) 用户标识</span><br><span class="line">	&quot;vc&quot;: &quot;1&quot;, &#x2F;&#x2F; (String) versionCode，程序版本号</span><br><span class="line">	&quot;vn&quot;: &quot;1.0&quot;, &#x2F;&#x2F; (String) versionName，程序版本名</span><br><span class="line">	&quot;l&quot;: &quot;zh&quot;, &#x2F;&#x2F; (String) language 系统语言</span><br><span class="line">	&quot;sr&quot;: &quot;&quot;, &#x2F;&#x2F; (String) 渠道号，应用从哪个渠道来的。</span><br><span class="line">	&quot;os&quot;: &quot;7.1.1&quot;, &#x2F;&#x2F; (String) Android 系统版本</span><br><span class="line">	&quot;ar&quot;: &quot;CN&quot;, &#x2F;&#x2F; (String) area 区域</span><br><span class="line">	&quot;md&quot;: &quot;BBB100-1&quot;, &#x2F;&#x2F; (String) model 手机型号</span><br><span class="line">	&quot;ba&quot;: &quot;blackberry&quot;, &#x2F;&#x2F; (String) brand 手机品牌</span><br><span class="line">	&quot;sv&quot;: &quot;V2.2.1&quot;, &#x2F;&#x2F; (String) sdkVersion</span><br><span class="line">	&quot;g&quot;: &quot;&quot;, &#x2F;&#x2F; (String) gmail</span><br><span class="line">	&quot;hw&quot;: &quot;1620x1080&quot;, &#x2F;&#x2F; (String) heightXwidth，屏幕宽高</span><br><span class="line">	&quot;t&quot;: &quot;1506047606608&quot;, &#x2F;&#x2F; (String) 客户端日志产生时的时间</span><br><span class="line">	&quot;nw&quot;: &quot;WIFI&quot;, &#x2F;&#x2F; (String) 网络模式</span><br><span class="line">	&quot;ln&quot;: 0, &#x2F;&#x2F; (double) lng 经度</span><br><span class="line">	&quot;la&quot;: 0 &#x2F;&#x2F; (double) lat 纬度</span><br><span class="line">&#125;,</span><br><span class="line">&quot;et&quot;: [ &#x2F;&#x2F;事件</span><br><span class="line">	&#123;</span><br><span class="line">	&quot;ett&quot;: &quot;1506047605364&quot;, &#x2F;&#x2F;客户端事件产生时间</span><br><span class="line">	&quot;en&quot;: &quot;display&quot;, &#x2F;&#x2F;事件名称</span><br><span class="line">	&quot;kv&quot;: &#123; &#x2F;&#x2F;事件结果，以 key-value 形式自行定义</span><br><span class="line">		&quot;goodsid&quot;: &quot;236&quot;,</span><br><span class="line">		&quot;action&quot;: &quot;1&quot;,</span><br><span class="line">		&quot;extend1&quot;: &quot;1&quot;,</span><br><span class="line">		&quot;place&quot;: &quot;2&quot;,</span><br><span class="line">		&quot;category&quot;: &quot;75&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>示例日志（服务器时间戳 | 日志），时间戳可以有效判定网络服务的通信时长：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">1540934156385| &#123;</span><br><span class="line">	&quot;ap&quot;: &quot;gmall&quot;,	&#x2F;&#x2F;数仓库名</span><br><span class="line">	&quot;cm&quot;: &#123;</span><br><span class="line">	&quot;uid&quot;: &quot;1234&quot;,</span><br><span class="line">	&quot;vc&quot;: &quot;2&quot;,</span><br><span class="line">	&quot;vn&quot;: &quot;1.0&quot;,</span><br><span class="line">	&quot;la&quot;: &quot;EN&quot;,</span><br><span class="line">	&quot;sr&quot;: &quot;&quot;,</span><br><span class="line">	&quot;os&quot;: &quot;7.1.1&quot;,</span><br><span class="line">	&quot;ar&quot;: &quot;CN&quot;,</span><br><span class="line">	&quot;md&quot;: &quot;BBB100-1&quot;,</span><br><span class="line">	&quot;ba&quot;: &quot;blackberry&quot;,</span><br><span class="line">	&quot;sv&quot;: &quot;V2.2.1&quot;,</span><br><span class="line">	&quot;g&quot;: &quot;abc@gmail.com&quot;,</span><br><span class="line">	&quot;hw&quot;: &quot;1620x1080&quot;,</span><br><span class="line">	&quot;t&quot;: &quot;1506047606608&quot;,</span><br><span class="line">	&quot;nw&quot;: &quot;WIFI&quot;,</span><br><span class="line">	&quot;ln&quot;: 0,</span><br><span class="line">        &quot;la&quot;: 0</span><br><span class="line">&#125;,</span><br><span class="line">&quot;et&quot;: [</span><br><span class="line">	&#123;</span><br><span class="line">	&quot;ett&quot;: &quot;1506047605364&quot;, &#x2F;&#x2F;客户端事件产生时间</span><br><span class="line">	&quot;en&quot;: &quot;display&quot;, &#x2F;&#x2F;事件名称</span><br><span class="line">	&quot;kv&quot;: &#123; &#x2F;&#x2F;事件结果，以 key-value 形式自行定义</span><br><span class="line">		&quot;goodsid&quot;: &quot;236&quot;,</span><br><span class="line">		&quot;action&quot;: &quot;1&quot;,</span><br><span class="line">		&quot;extend1&quot;: &quot;1&quot;,</span><br><span class="line">		&quot;place&quot;: &quot;2&quot;,</span><br><span class="line">		&quot;category&quot;: &quot;75&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,&#123;</span><br><span class="line">	&quot;ett&quot;: &quot;1552352626835&quot;,</span><br><span class="line">	&quot;en&quot;: &quot;active_background&quot;,</span><br><span class="line">	&quot;kv&quot;: &#123;</span><br><span class="line">		&quot;active_source&quot;: &quot;1&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a name="blogTitle7"></a></p><h3 id="2-2-埋点事件日志数据"><a href="#2-2-埋点事件日志数据" class="headerlink" title="2.2 埋点事件日志数据"></a>2.2 埋点事件日志数据</h3><p><a name="bfe09d0c"></a></p><h4 id="2-2-1-商品列表页"><a href="#2-2-1-商品列表页" class="headerlink" title="2.2.1 商品列表页"></a>2.2.1 商品列表页</h4><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445220-53833589-bf8f-44b6-8c7b-465e87e1e711.png#align=left&display=inline&height=836&margin=%5Bobject%20Object%5D&originHeight=836&originWidth=482&size=0&status=done&style=none&width=482" alt></p></li><li><p>事件名称：loading</p><table><thead><tr><th>标签</th><th>含义</th></tr></thead><tbody><tr><td>action</td><td>动作：开始加载=1，加载成功=2，加载失败=3</td></tr><tr><td>loading_time</td><td>加载时长：计算下拉开始到接口返回数据的时间，（开始加载报 0，加载成 功或加载失败才上报时间）</td></tr><tr><td>loading_way</td><td>加载类型：1-读取缓存，2-从接口拉新数据 （加载成功才上报加载类型）</td></tr><tr><td>extend1</td><td>扩展字段 Extend1</td></tr><tr><td>extend2</td><td>扩展字段 Extend2</td></tr><tr><td>type</td><td>加载类型：自动加载=1，用户下拽加载=2，底部加载=3（底部条触发点击底部提示条/点击返回顶部加载）</td></tr><tr><td>type1</td><td>加载失败码：把加载失败状态码报回来（报空为加载成功，没有失败）</td></tr></tbody></table></li></ul><p><a name="ee4b4b36"></a></p><h4 id="2-2-2-商品点击"><a href="#2-2-2-商品点击" class="headerlink" title="2.2.2 商品点击"></a>2.2.2 商品点击</h4><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445213-0bbd34e0-bb23-4e03-b90e-3ca09d0c5569.png#align=left&display=inline&height=838&margin=%5Bobject%20Object%5D&originHeight=838&originWidth=499&size=0&status=done&style=none&width=499" alt></p><ul><li>事件标签：display<table><thead><tr><th>标签</th><th>含义</th></tr></thead><tbody><tr><td>action</td><td>动作：曝光商品=1，点击商品=2</td></tr><tr><td>goodsid</td><td>商品 ID（服务端下发的 ID）</td></tr><tr><td>place</td><td>顺序（第几条商品，第一条为 0，第二条为 1，如此类推）</td></tr><tr><td>extend1</td><td>曝光类型：1 - 首次曝光 2-重复曝光</td></tr><tr><td>category</td><td>分类 ID（服务端定义的分类 ID）</td></tr></tbody></table></li></ul><p><a name="16ea94b9"></a></p><h4 id="2-2-3-商品详情页"><a href="#2-2-3-商品详情页" class="headerlink" title="2.2.3 商品详情页"></a>2.2.3 商品详情页</h4><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445268-6588114c-b79a-4e79-8763-250f838f3536.png#align=left&display=inline&height=711&margin=%5Bobject%20Object%5D&originHeight=711&originWidth=493&size=0&status=done&style=none&width=493" alt></p><ul><li>事件标签：newsdetail<table><thead><tr><th>标签</th><th>含义</th></tr></thead><tbody><tr><td>entry</td><td>页面入口来源：应用首页=1、push=2、详情页相关推荐=3</td></tr><tr><td>action</td><td>动作：开始加载=1，加载成功=2（pv），加载失败=3, 退出页面=4</td></tr><tr><td>goodsid</td><td>商品 ID（服务端下发的 ID）</td></tr><tr><td>show_style</td><td>商品样式：0、无图、1、一张大图、2、两张图、3、三张小图、4、一张小图、 5、一张大图两张小图</td></tr><tr><td>news_staytime</td><td>页面停留时长：从商品开始加载时开始计算，到用户关闭页面所用的时间。 若中途用跳转到其它页面了，则暂停计时，待回到详情页时恢复计时。或中 途划出的时间超过 10 分钟，则本次计时作废，不上报本次数据。如未加载成 功退出，则报空。</td></tr><tr><td>loading_time</td><td>加载时长：计算页面开始加载到接口返回数据的时间 （开始加载报 0，加载 成功或加载失败才上报时间）</td></tr><tr><td>type1</td><td>加载失败码：把加载失败状态码报回来（报空为加载成功，没有失败）</td></tr><tr><td>category</td><td>分类 ID（服务端定义的分类 ID）</td></tr></tbody></table></li></ul><p><a name="571b8d48"></a></p><h4 id="2-2-4-广告"><a href="#2-2-4-广告" class="headerlink" title="2.2.4 广告"></a>2.2.4 广告</h4><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445229-1c9049ba-ee68-4f5c-ad71-bba666fde424.png#align=left&display=inline&height=858&margin=%5Bobject%20Object%5D&originHeight=858&originWidth=513&size=0&status=done&style=none&width=513" alt></p><ul><li>事件名称：ad<table><thead><tr><th>标签</th><th>含义</th></tr></thead><tbody><tr><td>entry</td><td>入口：商品列表页=1 应用首页=2 商品详情页=3</td></tr><tr><td>action</td><td>动作： 广告展示=1 广告点击=2</td></tr><tr><td>contentType</td><td>Type: 1 商品 2 营销活动</td></tr><tr><td>displayMills</td><td>展示时长 毫秒数</td></tr><tr><td>itemId</td><td>商品 id</td></tr><tr><td>activityId</td><td>营销活动 id</td></tr></tbody></table></li></ul><p><a name="23c440b4"></a></p><h4 id="2-2-5-消息通知"><a href="#2-2-5-消息通知" class="headerlink" title="2.2.5 消息通知"></a>2.2.5 消息通知</h4><ul><li>事件标签：notification<table><thead><tr><th>标签</th><th>含义</th></tr></thead><tbody><tr><td>action</td><td>动作：通知产生=1，通知弹出=2，通知点击=3，常驻通知展示（不重复上 报，一天之内只报一次）=4</td></tr><tr><td>type</td><td>通知 id：预警通知=1，天气预报（早=2，晚=3），常驻=4</td></tr><tr><td>ap_time</td><td>客户端弹出时间</td></tr><tr><td>content</td><td>备用字段</td></tr></tbody></table></li></ul><p><a name="409b258a"></a></p><h4 id="2-2-6-用户后台活跃"><a href="#2-2-6-用户后台活跃" class="headerlink" title="2.2.6 用户后台活跃"></a>2.2.6 用户后台活跃</h4><ul><li>事件标签: active_background<table><thead><tr><th>标签</th><th>含义</th></tr></thead><tbody><tr><td>active_source</td><td>1=upgrade,2=download(下载),3=plugin_upgrade</td></tr></tbody></table></li></ul><p><a name="d3d9a6ee"></a></p><h4 id="2-2-7-评论"><a href="#2-2-7-评论" class="headerlink" title="2.2.7 评论"></a>2.2.7 评论</h4><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445234-c1ea35e6-d731-485d-9f74-e1eccba7431e.png#align=left&display=inline&height=894&margin=%5Bobject%20Object%5D&originHeight=894&originWidth=537&size=0&status=done&style=none&width=537" alt></p><ul><li>描述：评论表（comment）<table><thead><tr><th align="center">序号</th><th>字段名称</th><th>字段描述</th><th align="center">字段类型</th><th align="center">长度</th><th align="center">允许空</th><th align="center">缺省值</th></tr></thead><tbody><tr><td align="center">1</td><td>comment_id</td><td>评论表</td><td align="center">int</td><td align="center">10,0</td><td align="center"></td><td align="center"></td></tr><tr><td align="center">2</td><td>userid</td><td>用户 id</td><td align="center">int</td><td align="center">10,0</td><td align="center">√</td><td align="center">0</td></tr><tr><td align="center">3</td><td>p_comment_id</td><td>父级评论 id(为 0 则是<br>一级评论,不 为 0 则是回复)</td><td align="center">int</td><td align="center">10,0</td><td align="center">√</td><td align="center"></td></tr><tr><td align="center">4</td><td>content</td><td>评论内容</td><td align="center">string</td><td align="center">1000</td><td align="center">√</td><td align="center"></td></tr><tr><td align="center">5</td><td>addtime</td><td>创建时间</td><td align="center">string</td><td align="center"></td><td align="center">√</td><td align="center"></td></tr><tr><td align="center">6</td><td>other_id</td><td>评论的相关 id</td><td align="center">int</td><td align="center">10,0</td><td align="center">√</td><td align="center"></td></tr><tr><td align="center">7</td><td>praise_count</td><td>点赞数量</td><td align="center">int</td><td align="center">10,0</td><td align="center">√</td><td align="center">0</td></tr><tr><td align="center">8</td><td>reply_count</td><td>回复数量</td><td align="center">int</td><td align="center">10,0</td><td align="center">√</td><td align="center">0</td></tr></tbody></table></li></ul><p><a name="aa37918b"></a></p><h4 id="2-2-8-收藏"><a href="#2-2-8-收藏" class="headerlink" title="2.2.8 收藏"></a>2.2.8 收藏</h4><ul><li>描述：收藏（favorites）<table><thead><tr><th align="center">序号</th><th>字段名称</th><th>字段描述</th><th align="center">字段类型</th><th align="center">长度</th><th align="center">允许空</th><th align="center">缺省值</th></tr></thead><tbody><tr><td align="center">1</td><td>id</td><td>主键</td><td align="center">int</td><td align="center">10,0</td><td align="center"></td><td align="center"></td></tr><tr><td align="center">2</td><td>course_id</td><td>商品 id</td><td align="center">int</td><td align="center">10,0</td><td align="center">√</td><td align="center">0</td></tr><tr><td align="center">3</td><td>userid</td><td>用户 ID</td><td align="center">int</td><td align="center">10,0</td><td align="center">√</td><td align="center">0</td></tr><tr><td align="center">4</td><td>add_time</td><td>创建时间</td><td align="center">string</td><td align="center"></td><td align="center">√</td><td align="center"></td></tr></tbody></table></li></ul><p><a name="2407bbc4"></a></p><h4 id="2-2-9-点赞"><a href="#2-2-9-点赞" class="headerlink" title="2.2.9 点赞"></a>2.2.9 点赞</h4><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445204-a4518660-4192-4dc1-b934-848b40a364d9.png#align=left&display=inline&height=772&margin=%5Bobject%20Object%5D&originHeight=772&originWidth=493&size=0&status=done&style=none&width=493" alt></p><ul><li>描述：所有的点赞表（praise）<table><thead><tr><th align="center">序号</th><th>字段名称</th><th>字段描述</th><th align="center">字段类型</th><th align="center">长度</th><th align="center">允许空</th><th align="center">缺省值</th></tr></thead><tbody><tr><td align="center">1</td><td>id</td><td>主键 id</td><td align="center">int</td><td align="center">10,0</td><td align="center"></td><td align="center"></td></tr><tr><td align="center">2</td><td>userid</td><td>用户 id</td><td align="center">int</td><td align="center">10,0</td><td align="center">√</td><td align="center"></td></tr><tr><td align="center">3</td><td>target_id</td><td>点赞的对象 id</td><td align="center">int</td><td align="center">10,0</td><td align="center">√</td><td align="center"></td></tr><tr><td align="center">4</td><td>type</td><td>创建点赞类型：1问答点赞 2问答评论点赞<br>3文章点赞数 4评论点赞</td><td align="center">int</td><td align="center">10,0</td><td align="center">√</td><td align="center"></td></tr><tr><td align="center">5</td><td>add_time</td><td>添加时间</td><td align="center">string</td><td align="center"></td><td align="center">√</td><td align="center"></td></tr></tbody></table></li></ul><p><a name="f4f90cd0"></a></p><h4 id="2-2-10-错误日志"><a href="#2-2-10-错误日志" class="headerlink" title="2.2.10 错误日志"></a>2.2.10 错误日志</h4><table><thead><tr><th align="center"><strong>errorBrief</strong></th><th align="center"><strong>错误摘要</strong></th></tr></thead><tbody><tr><td align="center"><strong>errorBrief</strong></td><td align="center"><strong>错误详情</strong></td></tr></tbody></table><p><a name="blogTitle8"></a></p><h3 id="2-3-埋点启动日志数据"><a href="#2-3-埋点启动日志数据" class="headerlink" title="2.3 埋点启动日志数据"></a>2.3 埋点启动日志数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;action&quot;:&quot;1&quot;,</span><br><span class="line">	&quot;ar&quot;:&quot;MX&quot;,</span><br><span class="line">	&quot;ba&quot;:&quot;HTC&quot;,</span><br><span class="line">	&quot;detail&quot;:&quot;&quot;,</span><br><span class="line">	&quot;en&quot;:&quot;start&quot;,</span><br><span class="line">	&quot;entry&quot;:&quot;2&quot;,</span><br><span class="line">	&quot;extend1&quot;:&quot;&quot;,</span><br><span class="line">	&quot;g&quot;:&quot;43R2SEQX@gmail.com&quot;,</span><br><span class="line">	&quot;hw&quot;:&quot;640*960&quot;,</span><br><span class="line">	&quot;l&quot;:&quot;en&quot;,</span><br><span class="line">	&quot;la&quot;:&quot;20.4&quot;,</span><br><span class="line">	&quot;ln&quot;:&quot;-99.3&quot;,</span><br><span class="line">	&quot;loading_time&quot;:&quot;2&quot;,</span><br><span class="line">	&quot;md&quot;:&quot;HTC-2&quot;,</span><br><span class="line">	&quot;mid&quot;:&quot;995&quot;,</span><br><span class="line">	&quot;nw&quot;:&quot;4G&quot;,</span><br><span class="line">	&quot;open_ad_type&quot;:&quot;2&quot;,</span><br><span class="line">	&quot;os&quot;:&quot;8.1.2&quot;,</span><br><span class="line">	&quot;sr&quot;:&quot;B&quot;,</span><br><span class="line">	&quot;sv&quot;:&quot;V2.0.6&quot;,</span><br><span class="line">	&quot;t&quot;:&quot;1561472502444&quot;,</span><br><span class="line">	&quot;uid&quot;:&quot;995&quot;,</span><br><span class="line">	&quot;vc&quot;:&quot;10&quot;,</span><br><span class="line">	&quot;vn&quot;:&quot;1.3.4&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>事件标签: start<table><thead><tr><th>标签</th><th>含义</th></tr></thead><tbody><tr><td>entry</td><td>入 口 ： push=1 ， widget=2 ， icon=3 ， notification=4, lockscreen_widget =5</td></tr><tr><td>open_ad_type</td><td>开屏广告类型: 开屏原生广告=1, 开屏插屏广告=2</td></tr><tr><td>action</td><td>状态：成功=1 失败=2</td></tr><tr><td>loading_time</td><td>加载时长：计算下拉开始到接口返回数据的时间，（开始加载报 0，加载成 功或加载失败才上报时间）</td></tr><tr><td>detail</td><td>失败码（没有则上报空）</td></tr><tr><td>extend1</td><td>失败的 message（没有则上报空）</td></tr><tr><td>en</td><td>日志类型 start</td></tr></tbody></table></li></ul><p><a name="blogTitle9"></a></p><h3 id="2-4-数据生成脚本"><a href="#2-4-数据生成脚本" class="headerlink" title="2.4 数据生成脚本"></a>2.4 数据生成脚本</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445276-36599c24-74d5-4b7f-8674-1979b36b32cf.png#align=left&display=inline&height=815&margin=%5Bobject%20Object%5D&originHeight=815&originWidth=1918&size=0&status=done&style=none&width=1918" alt></p><blockquote><p>如下案例中将省略图中红框中的日志生成过程，直接使用Java程序构建logFile文件。</p></blockquote><p><a name="4c767f75"></a></p><h4 id="2-4-1-数据生成格式"><a href="#2-4-1-数据生成格式" class="headerlink" title="2.4.1 数据生成格式"></a>2.4.1 数据生成格式</h4><ul><li>启动日志</li></ul><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445197-5930bda1-7de7-4d77-8450-d1408dde46ad.png#align=left&display=inline&height=738&margin=%5Bobject%20Object%5D&originHeight=738&originWidth=1301&size=0&status=done&style=none&width=1301" alt></p><blockquote><p>{“action”:”1”,”ar”:”MX”,”ba”:”Sumsung”,”detail”:”201”,”en”:”start”,”entry”:”4”,”extend1”:””,”g”:”<a href="mailto:69021X1Q@gmail.com" rel="external nofollow noopener noreferrer" target="_blank">69021X1Q@gmail.com</a>“,”hw”:”1080*1920”,”l”:”pt”,”la”:”-11.0”,”ln”:”-70.0”,”loading_time”:”9”,”md”:”sumsung-5”,”mid”:”244”,”nw”:”3G”,”open_ad_type”:”1”,”os”:”8.2.3”,”sr”:”D”,”sv”:”V2.1.3”,”t”:”1589612165914”,”uid”:”244”,”vc”:”16”,”vn”:”1.2.1”}</p></blockquote><ul><li>事件日志(由于转换问题，图中没有 “时间戳|”)</li></ul><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445200-dd221676-3d59-4d7f-a516-52882e9754d2.png#align=left&display=inline&height=810&margin=%5Bobject%20Object%5D&originHeight=810&originWidth=1300&size=0&status=done&style=none&width=1300" alt></p><blockquote><p>1589695383284|{“cm”:{“ln”:”-79.4”,”sv”:”V2.5.3”,”os”:”8.0.6”,”g”:”<a href="mailto:81614U54@gmail.com" rel="external nofollow noopener noreferrer" target="_blank">81614U54@gmail.com</a>“,”mid”:”245”,”nw”:”WIFI”,”l”:”pt”,”vc”:”6”,”hw”:”1080*1920”,”ar”:”MX”,”uid”:”245”,”t”:”1589627025851”,”la”:”-39.6”,”md”:”HTC-7”,”vn”:”1.3.5”,”ba”:”HTC”,”sr”:”N”},”ap”:”app”,”et”:[{“ett”:”1589650631883”,”en”:”display”,”kv”:{“goodsid”:”53”,”action”:”2”,”extend1”:”2”,”place”:”3”,”category”:”50”}},{“ett”:”1589690866312”,”en”:”newsdetail”,”kv”:{“entry”:”3”,”goodsid”:”54”,”news_staytime”:”1”,”loading_time”:”6”,”action”:”4”,”showtype”:”0”,”category”:”78”,”type1”:””}},{“ett”:”1589641734037”,”en”:”loading”,”kv”:{“extend2”:””,”loading_time”:”0”,”action”:”1”,”extend1”:””,”type”:”2”,”type1”:”201”,”loading_way”:”2”}},{“ett”:”1589687684878”,”en”:”ad”,”kv”:{“activityId”:”1”,”displayMills”:”92030”,”entry”:”3”,”action”:”5”,”contentType”:”0”}},{“ett”:”1589632980772”,”en”:”active_background”,”kv”:{“active_source”:”1”}},{“ett”:”1589682030324”,”en”:”error”,”kv”:{“errorDetail”:”java.lang.NullPointerException\n at cn.lift.appIn.web.AbstractBaseController.validInbound(AbstractBaseController.java:72)\n at cn.lift.dfdf.web.AbstractBaseController.validInbound”,”errorBrief”:”at cn.lift.dfdf.web.AbstractBaseController.validInbound(AbstractBaseController.java:72)”}},{“ett”:”1589675065650”,”en”:”comment”,”kv”:{“p_comment_id”:2,”addtime”:”1589624299628”,”praise_count”:509,”other_id”:6,”comment_id”:7,”reply_count”:35,”userid”:3,”content”:”关色芦候佰间纶珊斑禁尹赞涤仇彭企呵姜毅”}},{“ett”:”1589631359459”,”en”:”favorites”,”kv”:{“course_id”:7,”id”:0,”add_time”:”1589681240066”,”userid”:7}},{“ett”:”1589616574187”,”en”:”praise”,”kv”:{“target_id”:1,”id”:7,”type”:3,”add_time”:”1589642497314”,”userid”:8}}]}</p></blockquote><p><a name="e84eff3b"></a></p><h4 id="2-4-2-创建maven工程"><a href="#2-4-2-创建maven工程" class="headerlink" title="2.4.2 创建maven工程"></a>2.4.2 创建maven工程</h4><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445354-3c28f41c-e63c-4fb9-84d2-2758e24117d7.png#align=left&display=inline&height=356&margin=%5Bobject%20Object%5D&originHeight=356&originWidth=1501&size=0&status=done&style=none&width=1501" alt><br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445239-29830e5f-2628-4b61-b25c-860285f21cc5.png#align=left&display=inline&height=733&margin=%5Bobject%20Object%5D&originHeight=733&originWidth=1500&size=0&status=done&style=none&width=1500" alt><br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445257-f8650a51-09ee-42f3-b9e6-c374f207c5b9.png#align=left&display=inline&height=402&margin=%5Bobject%20Object%5D&originHeight=402&originWidth=1501&size=0&status=done&style=none&width=1501" alt><br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445238-b3a082a7-5282-4ffe-b763-62f4d159a8b3.png#align=left&display=inline&height=395&margin=%5Bobject%20Object%5D&originHeight=395&originWidth=1501&size=0&status=done&style=none&width=1501" alt></p><ul><li><p>data-producer：pom.xml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--版本号统一--&gt;</span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;slf4j.version&gt;1.7.20&lt;&#x2F;slf4j.version&gt;</span><br><span class="line">        &lt;logback.version&gt;1.0.7&lt;&#x2F;logback.version&gt;</span><br><span class="line">    &lt;&#x2F;properties&gt;</span><br><span class="line">    &lt;dependencies&gt; &lt;!--阿里巴巴开源 json 解析框架--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;fastjson&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.2.51&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt; &lt;!--日志生成框架--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;ch.qos.logback&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;logback-core&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;logback.version&#125;&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;ch.qos.logback&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;logback-classic&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;logback.version&#125;&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.projectlombok&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lombok&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.18.10&lt;&#x2F;version&gt;</span><br><span class="line">            &lt;scope&gt;provided&lt;&#x2F;scope&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-compiler-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;2.3.2&lt;&#x2F;version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;source&gt;1.8&lt;&#x2F;source&gt;</span><br><span class="line">                    &lt;target&gt;1.8&lt;&#x2F;target&gt;</span><br><span class="line">                &lt;&#x2F;configuration&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-assembly-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;descriptorRefs&gt;</span><br><span class="line">                        &lt;descriptorRef&gt;jar-with-dependencies&lt;&#x2F;descriptorRef&gt;</span><br><span class="line">                    &lt;&#x2F;descriptorRefs&gt;</span><br><span class="line">                    &lt;archive&gt;</span><br><span class="line">                        &lt;manifest&gt;</span><br><span class="line">                            &lt;!--主类名--&gt;</span><br><span class="line">                            &lt;mainClass&gt;com.heaton.bigdata.datawarehouse.app.App&lt;&#x2F;mainClass&gt;</span><br><span class="line">                        &lt;&#x2F;manifest&gt;</span><br><span class="line">                    &lt;&#x2F;archive&gt;</span><br><span class="line">                &lt;&#x2F;configuration&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;id&gt;make-assembly&lt;&#x2F;id&gt;</span><br><span class="line">                        &lt;phase&gt;package&lt;&#x2F;phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;single&lt;&#x2F;goal&gt;</span><br><span class="line">                        &lt;&#x2F;goals&gt;</span><br><span class="line">                    &lt;&#x2F;execution&gt;</span><br><span class="line">                &lt;&#x2F;executions&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">        &lt;&#x2F;plugins&gt;</span><br><span class="line">    &lt;&#x2F;build&gt;</span><br></pre></td></tr></table></figure></li><li><p>data-producer：logback.xml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;configuration debug&#x3D;&quot;false&quot;&gt; &lt;!--定义日志文件的存储地址 勿在 LogBack 的配置中使用相对路径 --&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;LOG_HOME&quot; value&#x3D;&quot;&#x2F;root&#x2F;logs&#x2F;&quot;&#x2F;&gt; &lt;!-- 控制台输出 --&gt;</span><br><span class="line">    &lt;appender name&#x3D;&quot;STDOUT&quot; class&#x3D;&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;</span><br><span class="line">        &lt;encoder</span><br><span class="line">                class&#x3D;&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;&gt; &lt;!--格式化输出：%d 表示日期，%thread 表示线程名，%-5level：级别从左显示 5 个字符宽度%msg： 日志消息，%n 是换行符 --&gt;</span><br><span class="line">            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n&lt;&#x2F;pattern&gt;</span><br><span class="line">        &lt;&#x2F;encoder&gt;</span><br><span class="line">    &lt;&#x2F;appender&gt; &lt;!-- 按照每天生成日志文件。存储事件日志 --&gt;</span><br><span class="line">    &lt;appender name&#x3D;&quot;FILE&quot;</span><br><span class="line">              class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt; &lt;!-- &lt;File&gt;$&#123;LOG_HOME&#125;&#x2F;app.log&lt;&#x2F;File&gt;设置日志不超过$&#123;log.max.size&#125;时的保存路径，注意， 如果是 web 项目会保存到 Tomcat 的 bin 目录 下 --&gt;</span><br><span class="line">        &lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt; &lt;!--日志文件输出的文件名 --&gt;</span><br><span class="line">            &lt;FileNamePattern&gt;$&#123;LOG_HOME&#125;&#x2F;app-%d&#123;yyyy-MM-dd&#125;.log&lt;&#x2F;FileNamePattern&gt; &lt;!--日志文件保留天数 --&gt;</span><br><span class="line">            &lt;MaxHistory&gt;30&lt;&#x2F;MaxHistory&gt;</span><br><span class="line">        &lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">        &lt;encoder class&#x3D;&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;&gt;</span><br><span class="line">            &lt;pattern&gt;%msg%n&lt;&#x2F;pattern&gt;</span><br><span class="line">        &lt;&#x2F;encoder&gt; &lt;!--日志文件最大的大小 --&gt;</span><br><span class="line">        &lt;triggeringPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;&gt;</span><br><span class="line">            &lt;MaxFileSize&gt;10MB&lt;&#x2F;MaxFileSize&gt;</span><br><span class="line">        &lt;&#x2F;triggeringPolicy&gt;</span><br><span class="line">    &lt;&#x2F;appender&gt; &lt;!--异步打印日志--&gt;</span><br><span class="line">    &lt;appender name&#x3D;&quot;ASYNC_FILE&quot;</span><br><span class="line">              class&#x3D;&quot;ch.qos.logback.classic.AsyncAppender&quot;&gt; &lt;!-- 不丢失日志.默认的,如果队列的 80%已满,则会丢弃 TRACT、DEBUG、INFO 级别的日志 --&gt;</span><br><span class="line">        &lt;discardingThreshold&gt;0&lt;&#x2F;discardingThreshold&gt; &lt;!-- 更改默认的队列的深度,该值会影响性能.默认值为 256 --&gt;</span><br><span class="line">        &lt;queueSize&gt;512&lt;&#x2F;queueSize&gt; &lt;!-- 添加附加的 appender,最多只能添加一个 --&gt;</span><br><span class="line">        &lt;appender-ref ref&#x3D;&quot;FILE&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;appender&gt; &lt;!-- 日志输出级别 --&gt;</span><br><span class="line">    &lt;root level&#x3D;&quot;INFO&quot;&gt;</span><br><span class="line">        &lt;appender-ref ref&#x3D;&quot;STDOUT&quot;&#x2F;&gt;</span><br><span class="line">        &lt;appender-ref ref&#x3D;&quot;ASYNC_FILE&quot;&#x2F;&gt;</span><br><span class="line">        &lt;appender-ref ref&#x3D;&quot;error&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;root&gt;</span><br><span class="line">&lt;&#x2F;configuration&gt;</span><br></pre></td></tr></table></figure></li><li><p>data-flume：pom.xml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.flume&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;flume-ng-core&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.9.0&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-compiler-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;2.3.2&lt;&#x2F;version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;source&gt;1.8&lt;&#x2F;source&gt;</span><br><span class="line">                    &lt;target&gt;1.8&lt;&#x2F;target&gt;</span><br><span class="line">                &lt;&#x2F;configuration&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">        &lt;&#x2F;plugins&gt;</span><br><span class="line">    &lt;&#x2F;build&gt;</span><br></pre></td></tr></table></figure></li><li><p>hive-function：pom.xml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.hive&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;hive-exec&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.1.1&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-compiler-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;2.3.2&lt;&#x2F;version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;source&gt;1.8&lt;&#x2F;source&gt;</span><br><span class="line">                    &lt;target&gt;1.8&lt;&#x2F;target&gt;</span><br><span class="line">                &lt;&#x2F;configuration&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">        &lt;&#x2F;plugins&gt;</span><br><span class="line">    &lt;&#x2F;build&gt;</span><br></pre></td></tr></table></figure><p><a name="9ad75b74"></a></p><h4 id="2-4-3-各事件bean"><a href="#2-4-3-各事件bean" class="headerlink" title="2.4.3 各事件bean"></a>2.4.3 各事件bean</h4><blockquote><p>data-producer工程</p></blockquote></li></ul><p><a name="fd2c10ec"></a></p><h5 id="2-4-3-1-公共日志类"><a href="#2-4-3-1-公共日志类" class="headerlink" title="2.4.3.1 公共日志类"></a>2.4.3.1 公共日志类</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">import lombok.Data;</span><br><span class="line">&#x2F;** </span><br><span class="line">* @author Heaton</span><br><span class="line">* @email 70416450@qq.com</span><br><span class="line">* @date 2020&#x2F;4&#x2F;25 14:54 </span><br><span class="line">* @describe 公共日志类</span><br><span class="line">*&#x2F;</span><br><span class="line">@Data</span><br><span class="line">public class AppBase &#123;</span><br><span class="line">    private String mid; &#x2F;&#x2F; (String) 设备唯一</span><br><span class="line">    private String uid; &#x2F;&#x2F; (String) 用户 uid</span><br><span class="line">    private String vc; &#x2F;&#x2F; (String) versionCode，程序版本号</span><br><span class="line">    private String vn; &#x2F;&#x2F; (String) versionName，程序版本名</span><br><span class="line">    private String l; &#x2F;&#x2F; (String) 系统语言</span><br><span class="line">    private String sr; &#x2F;&#x2F; (String) 渠道号，应用从哪个渠道来的。</span><br><span class="line">    private String os; &#x2F;&#x2F; (String) Android 系统版本</span><br><span class="line">    private String ar; &#x2F;&#x2F; (String) 区域</span><br><span class="line">    private String md; &#x2F;&#x2F; (String) 手机型号</span><br><span class="line">    private String ba; &#x2F;&#x2F; (String) 手机品牌</span><br><span class="line">    private String sv; &#x2F;&#x2F; (String) sdkVersion</span><br><span class="line">    private String g; &#x2F;&#x2F; (String) gmail</span><br><span class="line">    private String hw; &#x2F;&#x2F; (String) heightXwidth，屏幕宽高</span><br><span class="line">    private String t; &#x2F;&#x2F; (String) 客户端日志产生时的时间</span><br><span class="line">    private String nw; &#x2F;&#x2F; (String) 网络模式</span><br><span class="line">    private String ln; &#x2F;&#x2F; (double) lng 经度</span><br><span class="line">    private String la; &#x2F;&#x2F; (double) lat 纬度</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a name="b18452f7"></a></p><h5 id="2-4-3-2-启动日志类"><a href="#2-4-3-2-启动日志类" class="headerlink" title="2.4.3.2 启动日志类"></a>2.4.3.2 启动日志类</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">import lombok.Data;</span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author Heaton</span><br><span class="line"> * @email 70416450@qq.com</span><br><span class="line"> * @date 2020&#x2F;4&#x2F;25 14:54</span><br><span class="line"> * @describe 启动日志类</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Data</span><br><span class="line">public class AppStart extends AppBase &#123;</span><br><span class="line">    private String entry;&#x2F;&#x2F;入口： push&#x3D;1，widget&#x3D;2，icon&#x3D;3，notification&#x3D;4, lockscreen_widget</span><br><span class="line">    private String open_ad_type;&#x2F;&#x2F;开屏广告类型: 开屏原生广告&#x3D;1, 开屏插屏广告&#x3D;2</span><br><span class="line">    private String action;&#x2F;&#x2F;状态：成功&#x3D;1 失败&#x3D;2</span><br><span class="line">    private String loading_time;&#x2F;&#x2F;加载时长：计算下拉开始到接口返回数据的时间，（开始加载报 0，加载成功或加载失败才上报时间）</span><br><span class="line">    private String detail;&#x2F;&#x2F;失败码（没有则上报空）</span><br><span class="line">    private String extend1;&#x2F;&#x2F;失败的 message（没有则上报空）</span><br><span class="line">    private String en;&#x2F;&#x2F;启动日志类型标记</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a name="9355740a"></a></p><h5 id="2-4-3-3-错误日志类"><a href="#2-4-3-3-错误日志类" class="headerlink" title="2.4.3.3 错误日志类"></a>2.4.3.3 错误日志类</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import lombok.Data;</span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author Heaton</span><br><span class="line"> * @email 70416450@qq.com</span><br><span class="line"> * @date 2020&#x2F;4&#x2F;25 14:54</span><br><span class="line"> * @describe 错误日志类</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Data</span><br><span class="line">public class AppErrorLog &#123;</span><br><span class="line">    private String errorBrief; &#x2F;&#x2F;错误摘要</span><br><span class="line">    private String errorDetail; &#x2F;&#x2F;错误详情</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a name="14491595"></a></p><h5 id="2-4-3-4-商品点击日志类"><a href="#2-4-3-4-商品点击日志类" class="headerlink" title="2.4.3.4 商品点击日志类"></a>2.4.3.4 商品点击日志类</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import lombok.Data;</span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author Heaton</span><br><span class="line"> * @email 70416450@qq.com</span><br><span class="line"> * @date 2020&#x2F;4&#x2F;25 14:54</span><br><span class="line"> * @describe 商品点击日志类</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Data</span><br><span class="line">public class AppDisplay &#123;</span><br><span class="line">    private String action;&#x2F;&#x2F;动作：曝光商品&#x3D;1，点击商品&#x3D;2</span><br><span class="line">    private String goodsid;&#x2F;&#x2F;商品 ID（服务端下发的 ID）</span><br><span class="line">    private String place;&#x2F;&#x2F;顺序（第几条商品，第一条为 0，第二条为 1，如此类推）</span><br><span class="line">    private String extend1;&#x2F;&#x2F;曝光类型：1 - 首次曝光 2-重复曝光（没有使用）</span><br><span class="line">    private String category;&#x2F;&#x2F;分类 ID（服务端定义的分类 ID）</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a name="938fbf96"></a></p><h5 id="2-4-3-5-商品详情类"><a href="#2-4-3-5-商品详情类" class="headerlink" title="2.4.3.5 商品详情类"></a>2.4.3.5 商品详情类</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import lombok.Data;</span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author Heaton</span><br><span class="line"> * @email 70416450@qq.com</span><br><span class="line"> * @date 2020&#x2F;4&#x2F;25 14:54</span><br><span class="line"> * @describe 商品详情类</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Data</span><br><span class="line">public class AppNewsDetail &#123;</span><br><span class="line">    private String entry;&#x2F;&#x2F;页面入口来源：应用首页&#x3D;1、push&#x3D;2、详情页相关推荐</span><br><span class="line">    private String action;&#x2F;&#x2F;动作：开始加载&#x3D;1，加载成功&#x3D;2（pv），加载失败&#x3D;3, 退出页面&#x3D;4</span><br><span class="line">    private String goodsid;&#x2F;&#x2F;商品 ID（服务端下发的 ID）</span><br><span class="line">    private String showtype;&#x2F;&#x2F;商品样式：0、无图 1、一张大图 2、两张图 3、三张小图 4、一张小 图 5、一张大图两张小图 来源于详情页相关推荐的商品，上报样式都为 0（因为都是左文右图）</span><br><span class="line">    private String news_staytime;&#x2F;&#x2F;页面停留时长：从商品开始加载时开始计算，到用户关闭页面 所用的时间。若中途用跳转到其它页面了，则暂停计时，待回到详情页时恢复计时。或中途划出的时间超 过 10 分钟，则本次计时作废，不上报本次数据。如未加载成功退出，则报空。</span><br><span class="line">    private String loading_time;&#x2F;&#x2F;加载时长：计算页面开始加载到接口返回数据的时间 （开始加 载报 0，加载成功或加载失败才上报时间）</span><br><span class="line">    private String type1;&#x2F;&#x2F;加载失败码：把加载失败状态码报回来（报空为加载成功，没有失败）</span><br><span class="line">    private String category;&#x2F;&#x2F;分类 ID（服务端定义的分类 ID）</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a name="3841af8f"></a></p><h5 id="2-4-3-6-商品列表类"><a href="#2-4-3-6-商品列表类" class="headerlink" title="2.4.3.6 商品列表类"></a>2.4.3.6 商品列表类</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">import lombok.Data;</span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author Heaton</span><br><span class="line"> * @email 70416450@qq.com</span><br><span class="line"> * @date 2020&#x2F;4&#x2F;25 14:54</span><br><span class="line"> * @describe 商品列表类</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Data</span><br><span class="line">public class AppLoading &#123;</span><br><span class="line">    private String action;&#x2F;&#x2F;动作：开始加载&#x3D;1，加载成功&#x3D;2，加载失败</span><br><span class="line">    private String loading_time;&#x2F;&#x2F;加载时长：计算下拉开始到接口返回数据的时间，（开始加载报 0， 加载成功或加载失败才上报时间）</span><br><span class="line">    private String loading_way;&#x2F;&#x2F;加载类型：1-读取缓存，2-从接口拉新数据 （加载成功才上报加 载类型）</span><br><span class="line">    private String extend1;&#x2F;&#x2F;扩展字段 Extend1</span><br><span class="line">    private String extend2;&#x2F;&#x2F;扩展字段 Extend2</span><br><span class="line">    private String type;&#x2F;&#x2F;加载类型：自动加载&#x3D;1，用户下拽加载&#x3D;2，底部加载&#x3D;3（底部条触发点击底 部提示条&#x2F;点击返回顶部加载）</span><br><span class="line">    private String type1;&#x2F;&#x2F;加载失败码：把加载失败状态码报回来（报空为加载成功，没有失败）</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a name="fe8dffa0"></a></p><h5 id="2-4-3-7-广告类"><a href="#2-4-3-7-广告类" class="headerlink" title="2.4.3.7 广告类"></a>2.4.3.7 广告类</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">import lombok.Data;</span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author Heaton</span><br><span class="line"> * @email 70416450@qq.com</span><br><span class="line"> * @date 2020&#x2F;4&#x2F;25 14:54</span><br><span class="line"> * @describe 广告类</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Data</span><br><span class="line">public class AppAd &#123;</span><br><span class="line">    private String entry;&#x2F;&#x2F;入口：商品列表页&#x3D;1  应用首页&#x3D;2 商品详情页&#x3D;3</span><br><span class="line">    private String action;&#x2F;&#x2F;动作： 广告展示&#x3D;1 广告点击&#x3D;2</span><br><span class="line">    private String contentType;&#x2F;&#x2F;Type: 1 商品 2 营销活动</span><br><span class="line">    private String displayMills;&#x2F;&#x2F;展示时长 毫秒数</span><br><span class="line">    private String itemId; &#x2F;&#x2F;商品id</span><br><span class="line">    private String activityId; &#x2F;&#x2F;营销活动id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a name="7e94e787"></a></p><h5 id="2-4-3-8-消息通知日志类"><a href="#2-4-3-8-消息通知日志类" class="headerlink" title="2.4.3.8 消息通知日志类"></a>2.4.3.8 消息通知日志类</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import lombok.Data;</span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author Heaton</span><br><span class="line"> * @email 70416450@qq.com</span><br><span class="line"> * @date 2020&#x2F;4&#x2F;25 14:54</span><br><span class="line"> * @describe 消息通知日志类</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Data</span><br><span class="line">public class AppNotification &#123;</span><br><span class="line">    private String action;&#x2F;&#x2F;动作：通知产生&#x3D;1，通知弹出&#x3D;2，通知点击&#x3D;3，常驻通知展示（不重复上 报，一天之内只报一次）</span><br><span class="line">    private String type;&#x2F;&#x2F;通知 id：预警通知&#x3D;1，天气预报（早&#x3D;2，晚&#x3D;3），常驻&#x3D;4</span><br><span class="line">    private String ap_time;&#x2F;&#x2F;客户端弹出时间</span><br><span class="line">    private String content;&#x2F;&#x2F;备用字段</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a name="f7b8845a"></a></p><h5 id="2-4-3-9-用户后台活跃类"><a href="#2-4-3-9-用户后台活跃类" class="headerlink" title="2.4.3.9 用户后台活跃类"></a>2.4.3.9 用户后台活跃类</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import lombok.Data;</span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author Heaton</span><br><span class="line"> * @email 70416450@qq.com</span><br><span class="line"> * @date 2020&#x2F;4&#x2F;25 14:54</span><br><span class="line"> * @describe 用户后台活跃类</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Data</span><br><span class="line">public class AppActive &#123;</span><br><span class="line">    private String active_source;&#x2F;&#x2F;1&#x3D;upgrade,2&#x3D;download(下载),3&#x3D;plugin_upgrade</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a name="eed5386c"></a></p><h5 id="2-4-3-10-用户评论类"><a href="#2-4-3-10-用户评论类" class="headerlink" title="2.4.3.10 用户评论类"></a>2.4.3.10 用户评论类</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import lombok.Data;</span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author Heaton</span><br><span class="line"> * @email 70416450@qq.com</span><br><span class="line"> * @date 2020&#x2F;4&#x2F;25 14:54</span><br><span class="line"> * @describe 用户评论类</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Data</span><br><span class="line">public class AppComment &#123;</span><br><span class="line">    private int comment_id;&#x2F;&#x2F;评论表</span><br><span class="line">    private int userid;&#x2F;&#x2F;用户 id</span><br><span class="line">    private int p_comment_id;&#x2F;&#x2F;父级评论 id(为 0 则是一级评论,不为 0 则是回复)</span><br><span class="line">    private String content;&#x2F;&#x2F;评论内容</span><br><span class="line">    private String addtime;&#x2F;&#x2F;创建时间</span><br><span class="line">    private int other_id;&#x2F;&#x2F;评论的相关 id</span><br><span class="line">    private int praise_count;&#x2F;&#x2F;点赞数量</span><br><span class="line">    private int reply_count;&#x2F;&#x2F;回复数量</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a name="01adfa90"></a></p><h5 id="2-4-3-11-用户收藏类"><a href="#2-4-3-11-用户收藏类" class="headerlink" title="2.4.3.11 用户收藏类"></a>2.4.3.11 用户收藏类</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import lombok.Data;</span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author Heaton</span><br><span class="line"> * @email 70416450@qq.com</span><br><span class="line"> * @date 2020&#x2F;4&#x2F;25 14:54</span><br><span class="line"> * @describe 用户收藏类</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Data</span><br><span class="line">public class AppFavorites &#123;</span><br><span class="line">    private int id;&#x2F;&#x2F;主键</span><br><span class="line">    private int course_id;&#x2F;&#x2F;商品 id</span><br><span class="line">    private int userid;&#x2F;&#x2F;用户 ID</span><br><span class="line">    private String add_time;&#x2F;&#x2F;创建时间</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a name="381f0e2a"></a></p><h5 id="2-4-3-12-用户点赞类"><a href="#2-4-3-12-用户点赞类" class="headerlink" title="2.4.3.12 用户点赞类"></a>2.4.3.12 用户点赞类</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import lombok.Data;</span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author Heaton</span><br><span class="line"> * @email 70416450@qq.com</span><br><span class="line"> * @date 2020&#x2F;4&#x2F;25 14:54</span><br><span class="line"> * @describe 用户点赞类</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Data</span><br><span class="line">public class AppPraise &#123;</span><br><span class="line">    private int id; &#x2F;&#x2F;主键 id</span><br><span class="line">    private int userid;&#x2F;&#x2F;用户 id</span><br><span class="line">    private int target_id;&#x2F;&#x2F;点赞的对象 id</span><br><span class="line">    private int type;&#x2F;&#x2F;点赞类型 1 问答点赞 2 问答评论点赞 3 文章点赞数 4 评论点赞</span><br><span class="line">    private String add_time;&#x2F;&#x2F;添加时间</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a name="c9fc3b91"></a></p><h4 id="2-4-4-启动类"><a href="#2-4-4-启动类" class="headerlink" title="2.4.4 启动类"></a>2.4.4 启动类</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br></pre></td><td class="code"><pre><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import com.alibaba.fastjson.JSONArray;</span><br><span class="line">import com.alibaba.fastjson.JSONObject;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line">import java.io.UnsupportedEncodingException;</span><br><span class="line">import java.util.Random;</span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author Heaton</span><br><span class="line"> * @email 70416450@qq.com</span><br><span class="line"> * @date 2020&#x2F;4&#x2F;25 14:54</span><br><span class="line"> * @describe 启动类</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class App &#123;</span><br><span class="line">    private final static Logger logger &#x3D; LoggerFactory.getLogger(App.class);</span><br><span class="line">    private static Random rand &#x3D; new Random();</span><br><span class="line">    &#x2F;&#x2F; 设备id</span><br><span class="line">    private static int s_mid &#x3D; 0;</span><br><span class="line">    &#x2F;&#x2F; 用户id</span><br><span class="line">    private static int s_uid &#x3D; 0;</span><br><span class="line">    &#x2F;&#x2F; 商品id</span><br><span class="line">    private static int s_goodsid &#x3D; 0;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        &#x2F;&#x2F; 参数一：控制发送每条的延时时间，默认是0</span><br><span class="line">        Long delay &#x3D; args.length &gt; 0 ? Long.parseLong(args[0]) : 0L;</span><br><span class="line">        &#x2F;&#x2F; 参数二：循环遍历次数</span><br><span class="line">        int loop_len &#x3D; args.length &gt; 1 ? Integer.parseInt(args[1]) : 1000;</span><br><span class="line">        &#x2F;&#x2F; 生成数据</span><br><span class="line">        generateLog(delay, loop_len);</span><br><span class="line">    &#125;</span><br><span class="line">    private static void generateLog(Long delay, int loop_len) &#123;</span><br><span class="line">        for (int i &#x3D; 0; i &lt; loop_len; i++) &#123;</span><br><span class="line">            int flag &#x3D; rand.nextInt(2);</span><br><span class="line">            switch (flag) &#123;</span><br><span class="line">                case (0):</span><br><span class="line">                    &#x2F;&#x2F;应用启动</span><br><span class="line">                    AppStart appStart &#x3D; generateStart();</span><br><span class="line">                    String jsonString &#x3D; JSON.toJSONString(appStart);</span><br><span class="line">                    &#x2F;&#x2F;控制台打印</span><br><span class="line">                    logger.info(jsonString);</span><br><span class="line">                    break;</span><br><span class="line">                case (1):</span><br><span class="line">                    JSONObject json &#x3D; new JSONObject();</span><br><span class="line">                    json.put(&quot;ap&quot;, &quot;app&quot;);</span><br><span class="line">                    json.put(&quot;cm&quot;, generateComFields());</span><br><span class="line">                    JSONArray eventsArray &#x3D; new JSONArray();</span><br><span class="line">                    &#x2F;&#x2F; 事件日志</span><br><span class="line">                    &#x2F;&#x2F; 商品点击，展示</span><br><span class="line">                    if (rand.nextBoolean()) &#123;</span><br><span class="line">                        eventsArray.add(generateDisplay());</span><br><span class="line">                        json.put(&quot;et&quot;, eventsArray);</span><br><span class="line">                    &#125;</span><br><span class="line">                    &#x2F;&#x2F; 商品详情页</span><br><span class="line">                    if (rand.nextBoolean()) &#123;</span><br><span class="line">                        eventsArray.add(generateNewsDetail());</span><br><span class="line">                        json.put(&quot;et&quot;, eventsArray);</span><br><span class="line">                    &#125;</span><br><span class="line">                    &#x2F;&#x2F; 商品列表页</span><br><span class="line">                    if (rand.nextBoolean()) &#123;</span><br><span class="line">                        eventsArray.add(generateNewList());</span><br><span class="line">                        json.put(&quot;et&quot;, eventsArray);</span><br><span class="line">                    &#125;</span><br><span class="line">                    &#x2F;&#x2F; 广告</span><br><span class="line">                    if (rand.nextBoolean()) &#123;</span><br><span class="line">                        eventsArray.add(generateAd());</span><br><span class="line">                        json.put(&quot;et&quot;, eventsArray);</span><br><span class="line">                    &#125;</span><br><span class="line">                    &#x2F;&#x2F; 消息通知</span><br><span class="line">                    if (rand.nextBoolean()) &#123;</span><br><span class="line">                        eventsArray.add(generateNotification());</span><br><span class="line">                        json.put(&quot;et&quot;, eventsArray);</span><br><span class="line">                    &#125;</span><br><span class="line">                    &#x2F;&#x2F; 用户后台活跃</span><br><span class="line">                    if (rand.nextBoolean()) &#123;</span><br><span class="line">                        eventsArray.add(generateBackground());</span><br><span class="line">                        json.put(&quot;et&quot;, eventsArray);</span><br><span class="line">                    &#125;</span><br><span class="line">                    &#x2F;&#x2F;故障日志</span><br><span class="line">                    if (rand.nextBoolean()) &#123;</span><br><span class="line">                        eventsArray.add(generateError());</span><br><span class="line">                        json.put(&quot;et&quot;, eventsArray);</span><br><span class="line">                    &#125;</span><br><span class="line">                    &#x2F;&#x2F; 用户评论</span><br><span class="line">                    if (rand.nextBoolean()) &#123;</span><br><span class="line">                        eventsArray.add(generateComment());</span><br><span class="line">                        json.put(&quot;et&quot;, eventsArray);</span><br><span class="line">                    &#125;</span><br><span class="line">                    &#x2F;&#x2F; 用户收藏</span><br><span class="line">                    if (rand.nextBoolean()) &#123;</span><br><span class="line">                        eventsArray.add(generateFavorites());</span><br><span class="line">                        json.put(&quot;et&quot;, eventsArray);</span><br><span class="line">                    &#125;</span><br><span class="line">                    &#x2F;&#x2F; 用户点赞</span><br><span class="line">                    if (rand.nextBoolean()) &#123;</span><br><span class="line">                        eventsArray.add(generatePraise());</span><br><span class="line">                        json.put(&quot;et&quot;, eventsArray);</span><br><span class="line">                    &#125;</span><br><span class="line">                    &#x2F;&#x2F;时间</span><br><span class="line">                    long millis &#x3D; System.currentTimeMillis();</span><br><span class="line">                    &#x2F;&#x2F;控制台打印</span><br><span class="line">                    logger.info(millis + &quot;|&quot; + json.toJSONString());</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F; 延迟</span><br><span class="line">            try &#123;</span><br><span class="line">                Thread.sleep(delay);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 公共字段设置</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static JSONObject generateComFields() &#123;</span><br><span class="line">        AppBase appBase &#x3D; new AppBase();</span><br><span class="line">        &#x2F;&#x2F;设备id</span><br><span class="line">        appBase.setMid(s_mid + &quot;&quot;);</span><br><span class="line">        s_mid++;</span><br><span class="line">        &#x2F;&#x2F; 用户id</span><br><span class="line">        appBase.setUid(s_uid + &quot;&quot;);</span><br><span class="line">        s_uid++;</span><br><span class="line">        &#x2F;&#x2F; 程序版本号 5,6等</span><br><span class="line">        appBase.setVc(&quot;&quot; + rand.nextInt(20));</span><br><span class="line">        &#x2F;&#x2F;程序版本名 v1.1.1</span><br><span class="line">        appBase.setVn(&quot;1.&quot; + rand.nextInt(4) + &quot;.&quot; + rand.nextInt(10));</span><br><span class="line">        &#x2F;&#x2F; 安卓系统版本</span><br><span class="line">        appBase.setOs(&quot;8.&quot; + rand.nextInt(3) + &quot;.&quot; + rand.nextInt(10));</span><br><span class="line">        &#x2F;&#x2F; 语言  es,en,pt</span><br><span class="line">        int flag &#x3D; rand.nextInt(3);</span><br><span class="line">        switch (flag) &#123;</span><br><span class="line">            case (0):</span><br><span class="line">                appBase.setL(&quot;es&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case (1):</span><br><span class="line">                appBase.setL(&quot;en&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case (2):</span><br><span class="line">                appBase.setL(&quot;pt&quot;);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 渠道号   从哪个渠道来的</span><br><span class="line">        appBase.setSr(getRandomChar(1));</span><br><span class="line">        &#x2F;&#x2F; 区域</span><br><span class="line">        flag &#x3D; rand.nextInt(2);</span><br><span class="line">        switch (flag) &#123;</span><br><span class="line">            case 0:</span><br><span class="line">                appBase.setAr(&quot;BR&quot;);</span><br><span class="line">            case 1:</span><br><span class="line">                appBase.setAr(&quot;MX&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 手机品牌 ba ,手机型号 md，就取2位数字了</span><br><span class="line">        flag &#x3D; rand.nextInt(3);</span><br><span class="line">        switch (flag) &#123;</span><br><span class="line">            case 0:</span><br><span class="line">                appBase.setBa(&quot;Sumsung&quot;);</span><br><span class="line">                appBase.setMd(&quot;sumsung-&quot; + rand.nextInt(20));</span><br><span class="line">                break;</span><br><span class="line">            case 1:</span><br><span class="line">                appBase.setBa(&quot;Huawei&quot;);</span><br><span class="line">                appBase.setMd(&quot;Huawei-&quot; + rand.nextInt(20));</span><br><span class="line">                break;</span><br><span class="line">            case 2:</span><br><span class="line">                appBase.setBa(&quot;HTC&quot;);</span><br><span class="line">                appBase.setMd(&quot;HTC-&quot; + rand.nextInt(20));</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 嵌入sdk的版本</span><br><span class="line">        appBase.setSv(&quot;V2.&quot; + rand.nextInt(10) + &quot;.&quot; + rand.nextInt(10));</span><br><span class="line">        &#x2F;&#x2F; gmail</span><br><span class="line">        appBase.setG(getRandomCharAndNumr(8) + &quot;@gmail.com&quot;);</span><br><span class="line">        &#x2F;&#x2F; 屏幕宽高 hw</span><br><span class="line">        flag &#x3D; rand.nextInt(4);</span><br><span class="line">        switch (flag) &#123;</span><br><span class="line">            case 0:</span><br><span class="line">                appBase.setHw(&quot;640*960&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case 1:</span><br><span class="line">                appBase.setHw(&quot;640*1136&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case 2:</span><br><span class="line">                appBase.setHw(&quot;750*1134&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case 3:</span><br><span class="line">                appBase.setHw(&quot;1080*1920&quot;);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 客户端产生日志时间</span><br><span class="line">        long millis &#x3D; System.currentTimeMillis();</span><br><span class="line">        appBase.setT(&quot;&quot; + (millis - rand.nextInt(99999999)));</span><br><span class="line">        &#x2F;&#x2F; 手机网络模式 3G,4G,WIFI</span><br><span class="line">        flag &#x3D; rand.nextInt(3);</span><br><span class="line">        switch (flag) &#123;</span><br><span class="line">            case 0:</span><br><span class="line">                appBase.setNw(&quot;3G&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case 1:</span><br><span class="line">                appBase.setNw(&quot;4G&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case 2:</span><br><span class="line">                appBase.setNw(&quot;WIFI&quot;);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 拉丁美洲 西经34°46′至西经117°09；北纬32°42′至南纬53°54′</span><br><span class="line">        &#x2F;&#x2F; 经度</span><br><span class="line">        appBase.setLn((-34 - rand.nextInt(83) - rand.nextInt(60) &#x2F; 10.0) + &quot;&quot;);</span><br><span class="line">        &#x2F;&#x2F; 纬度</span><br><span class="line">        appBase.setLa((32 - rand.nextInt(85) - rand.nextInt(60) &#x2F; 10.0) + &quot;&quot;);</span><br><span class="line">        return (JSONObject) JSON.toJSON(appBase);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 商品展示事件</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static JSONObject generateDisplay() &#123;</span><br><span class="line">        AppDisplay appDisplay &#x3D; new AppDisplay();</span><br><span class="line">        boolean boolFlag &#x3D; rand.nextInt(10) &lt; 7;</span><br><span class="line">        &#x2F;&#x2F; 动作：曝光商品&#x3D;1，点击商品&#x3D;2，</span><br><span class="line">        if (boolFlag) &#123;</span><br><span class="line">            appDisplay.setAction(&quot;1&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            appDisplay.setAction(&quot;2&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 商品id</span><br><span class="line">        String goodsId &#x3D; s_goodsid + &quot;&quot;;</span><br><span class="line">        s_goodsid++;</span><br><span class="line">        appDisplay.setGoodsid(goodsId);</span><br><span class="line">        &#x2F;&#x2F; 顺序  设置成6条吧</span><br><span class="line">        int flag &#x3D; rand.nextInt(6);</span><br><span class="line">        appDisplay.setPlace(&quot;&quot; + flag);</span><br><span class="line">        &#x2F;&#x2F; 曝光类型</span><br><span class="line">        flag &#x3D; 1 + rand.nextInt(2);</span><br><span class="line">        appDisplay.setExtend1(&quot;&quot; + flag);</span><br><span class="line">        &#x2F;&#x2F; 分类</span><br><span class="line">        flag &#x3D; 1 + rand.nextInt(100);</span><br><span class="line">        appDisplay.setCategory(&quot;&quot; + flag);</span><br><span class="line">        JSONObject jsonObject &#x3D; (JSONObject) JSON.toJSON(appDisplay);</span><br><span class="line">        return packEventJson(&quot;display&quot;, jsonObject);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 商品详情页</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static JSONObject generateNewsDetail() &#123;</span><br><span class="line">        AppNewsDetail appNewsDetail &#x3D; new AppNewsDetail();</span><br><span class="line">        &#x2F;&#x2F; 页面入口来源</span><br><span class="line">        int flag &#x3D; 1 + rand.nextInt(3);</span><br><span class="line">        appNewsDetail.setEntry(flag + &quot;&quot;);</span><br><span class="line">        &#x2F;&#x2F; 动作</span><br><span class="line">        appNewsDetail.setAction(&quot;&quot; + (rand.nextInt(4) + 1));</span><br><span class="line">        &#x2F;&#x2F; 商品id</span><br><span class="line">        appNewsDetail.setGoodsid(s_goodsid + &quot;&quot;);</span><br><span class="line">        &#x2F;&#x2F; 商品来源类型</span><br><span class="line">        flag &#x3D; 1 + rand.nextInt(3);</span><br><span class="line">        appNewsDetail.setShowtype(flag + &quot;&quot;);</span><br><span class="line">        &#x2F;&#x2F; 商品样式</span><br><span class="line">        flag &#x3D; rand.nextInt(6);</span><br><span class="line">        appNewsDetail.setShowtype(&quot;&quot; + flag);</span><br><span class="line">        &#x2F;&#x2F; 页面停留时长</span><br><span class="line">        flag &#x3D; rand.nextInt(10) * rand.nextInt(7);</span><br><span class="line">        appNewsDetail.setNews_staytime(flag + &quot;&quot;);</span><br><span class="line">        &#x2F;&#x2F; 加载时长</span><br><span class="line">        flag &#x3D; rand.nextInt(10) * rand.nextInt(7);</span><br><span class="line">        appNewsDetail.setLoading_time(flag + &quot;&quot;);</span><br><span class="line">        &#x2F;&#x2F; 加载失败码</span><br><span class="line">        flag &#x3D; rand.nextInt(10);</span><br><span class="line">        switch (flag) &#123;</span><br><span class="line">            case 1:</span><br><span class="line">                appNewsDetail.setType1(&quot;102&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case 2:</span><br><span class="line">                appNewsDetail.setType1(&quot;201&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case 3:</span><br><span class="line">                appNewsDetail.setType1(&quot;325&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case 4:</span><br><span class="line">                appNewsDetail.setType1(&quot;433&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case 5:</span><br><span class="line">                appNewsDetail.setType1(&quot;542&quot;);</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                appNewsDetail.setType1(&quot;&quot;);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 分类</span><br><span class="line">        flag &#x3D; 1 + rand.nextInt(100);</span><br><span class="line">        appNewsDetail.setCategory(&quot;&quot; + flag);</span><br><span class="line">        JSONObject eventJson &#x3D; (JSONObject) JSON.toJSON(appNewsDetail);</span><br><span class="line">        return packEventJson(&quot;newsdetail&quot;, eventJson);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 商品列表</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static JSONObject generateNewList() &#123;</span><br><span class="line">        AppLoading appLoading &#x3D; new AppLoading();</span><br><span class="line">        &#x2F;&#x2F; 动作</span><br><span class="line">        int flag &#x3D; rand.nextInt(3) + 1;</span><br><span class="line">        appLoading.setAction(flag + &quot;&quot;);</span><br><span class="line">        &#x2F;&#x2F; 加载时长</span><br><span class="line">        flag &#x3D; rand.nextInt(10) * rand.nextInt(7);</span><br><span class="line">        appLoading.setLoading_time(flag + &quot;&quot;);</span><br><span class="line">        &#x2F;&#x2F; 失败码</span><br><span class="line">        flag &#x3D; rand.nextInt(10);</span><br><span class="line">        switch (flag) &#123;</span><br><span class="line">            case 1:</span><br><span class="line">                appLoading.setType1(&quot;102&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case 2:</span><br><span class="line">                appLoading.setType1(&quot;201&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case 3:</span><br><span class="line">                appLoading.setType1(&quot;325&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case 4:</span><br><span class="line">                appLoading.setType1(&quot;433&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case 5:</span><br><span class="line">                appLoading.setType1(&quot;542&quot;);</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                appLoading.setType1(&quot;&quot;);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 页面  加载类型</span><br><span class="line">        flag &#x3D; 1 + rand.nextInt(2);</span><br><span class="line">        appLoading.setLoading_way(&quot;&quot; + flag);</span><br><span class="line">        &#x2F;&#x2F; 扩展字段1</span><br><span class="line">        appLoading.setExtend1(&quot;&quot;);</span><br><span class="line">        &#x2F;&#x2F; 扩展字段2</span><br><span class="line">        appLoading.setExtend2(&quot;&quot;);</span><br><span class="line">        &#x2F;&#x2F; 用户加载类型</span><br><span class="line">        flag &#x3D; 1 + rand.nextInt(3);</span><br><span class="line">        appLoading.setType(&quot;&quot; + flag);</span><br><span class="line">        JSONObject jsonObject &#x3D; (JSONObject) JSON.toJSON(appLoading);</span><br><span class="line">        return packEventJson(&quot;loading&quot;, jsonObject);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 广告相关字段</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static JSONObject generateAd() &#123;</span><br><span class="line">        AppAd appAd &#x3D; new AppAd();</span><br><span class="line">        &#x2F;&#x2F; 入口</span><br><span class="line">        int flag &#x3D; rand.nextInt(3) + 1;</span><br><span class="line">        appAd.setEntry(flag + &quot;&quot;);</span><br><span class="line">        &#x2F;&#x2F; 动作</span><br><span class="line">        flag &#x3D; rand.nextInt(5) + 1;</span><br><span class="line">        appAd.setAction(flag + &quot;&quot;);</span><br><span class="line">        &#x2F;&#x2F; 内容类型类型</span><br><span class="line">        flag &#x3D; rand.nextInt(6) + 1;</span><br><span class="line">        appAd.setContentType(flag + &quot;&quot;);</span><br><span class="line">        &#x2F;&#x2F; 展示样式</span><br><span class="line">        flag &#x3D; rand.nextInt(120000) + 1000;</span><br><span class="line">        appAd.setDisplayMills(flag + &quot;&quot;);</span><br><span class="line">        flag &#x3D; rand.nextInt(1);</span><br><span class="line">        if (flag &#x3D;&#x3D; 1) &#123;</span><br><span class="line">            appAd.setContentType(flag + &quot;&quot;);</span><br><span class="line">            flag &#x3D; rand.nextInt(6);</span><br><span class="line">            appAd.setItemId(flag + &quot;&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            appAd.setContentType(flag + &quot;&quot;);</span><br><span class="line">            flag &#x3D; rand.nextInt(1) + 1;</span><br><span class="line">            appAd.setActivityId(flag + &quot;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        JSONObject jsonObject &#x3D; (JSONObject) JSON.toJSON(appAd);</span><br><span class="line">        return packEventJson(&quot;ad&quot;, jsonObject);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 启动日志</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static AppStart generateStart() &#123;</span><br><span class="line">        AppStart appStart &#x3D; new AppStart();</span><br><span class="line">        &#x2F;&#x2F;设备id</span><br><span class="line">        appStart.setMid(s_mid + &quot;&quot;);</span><br><span class="line">        s_mid++;</span><br><span class="line">        &#x2F;&#x2F; 用户id</span><br><span class="line">        appStart.setUid(s_uid + &quot;&quot;);</span><br><span class="line">        s_uid++;</span><br><span class="line">        &#x2F;&#x2F; 程序版本号 5,6等</span><br><span class="line">        appStart.setVc(&quot;&quot; + rand.nextInt(20));</span><br><span class="line">        &#x2F;&#x2F;程序版本名 v1.1.1</span><br><span class="line">        appStart.setVn(&quot;1.&quot; + rand.nextInt(4) + &quot;.&quot; + rand.nextInt(10));</span><br><span class="line">        &#x2F;&#x2F; 安卓系统版本</span><br><span class="line">        appStart.setOs(&quot;8.&quot; + rand.nextInt(3) + &quot;.&quot; + rand.nextInt(10));</span><br><span class="line">        &#x2F;&#x2F;设置日志类型</span><br><span class="line">        appStart.setEn(&quot;start&quot;);</span><br><span class="line">        &#x2F;&#x2F;    语言  es,en,pt</span><br><span class="line">        int flag &#x3D; rand.nextInt(3);</span><br><span class="line">        switch (flag) &#123;</span><br><span class="line">            case (0):</span><br><span class="line">                appStart.setL(&quot;es&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case (1):</span><br><span class="line">                appStart.setL(&quot;en&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case (2):</span><br><span class="line">                appStart.setL(&quot;pt&quot;);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 渠道号   从哪个渠道来的</span><br><span class="line">        appStart.setSr(getRandomChar(1));</span><br><span class="line">        &#x2F;&#x2F; 区域</span><br><span class="line">        flag &#x3D; rand.nextInt(2);</span><br><span class="line">        switch (flag) &#123;</span><br><span class="line">            case 0:</span><br><span class="line">                appStart.setAr(&quot;BR&quot;);</span><br><span class="line">            case 1:</span><br><span class="line">                appStart.setAr(&quot;MX&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 手机品牌 ba ,手机型号 md，就取2位数字了</span><br><span class="line">        flag &#x3D; rand.nextInt(3);</span><br><span class="line">        switch (flag) &#123;</span><br><span class="line">            case 0:</span><br><span class="line">                appStart.setBa(&quot;Sumsung&quot;);</span><br><span class="line">                appStart.setMd(&quot;sumsung-&quot; + rand.nextInt(20));</span><br><span class="line">                break;</span><br><span class="line">            case 1:</span><br><span class="line">                appStart.setBa(&quot;Huawei&quot;);</span><br><span class="line">                appStart.setMd(&quot;Huawei-&quot; + rand.nextInt(20));</span><br><span class="line">                break;</span><br><span class="line">            case 2:</span><br><span class="line">                appStart.setBa(&quot;HTC&quot;);</span><br><span class="line">                appStart.setMd(&quot;HTC-&quot; + rand.nextInt(20));</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 嵌入sdk的版本</span><br><span class="line">        appStart.setSv(&quot;V2.&quot; + rand.nextInt(10) + &quot;.&quot; + rand.nextInt(10));</span><br><span class="line">        &#x2F;&#x2F; gmail</span><br><span class="line">        appStart.setG(getRandomCharAndNumr(8) + &quot;@gmail.com&quot;);</span><br><span class="line">        &#x2F;&#x2F; 屏幕宽高 hw</span><br><span class="line">        flag &#x3D; rand.nextInt(4);</span><br><span class="line">        switch (flag) &#123;</span><br><span class="line">            case 0:</span><br><span class="line">                appStart.setHw(&quot;640*960&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case 1:</span><br><span class="line">                appStart.setHw(&quot;640*1136&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case 2:</span><br><span class="line">                appStart.setHw(&quot;750*1134&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case 3:</span><br><span class="line">                appStart.setHw(&quot;1080*1920&quot;);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 客户端产生日志时间</span><br><span class="line">        long millis &#x3D; System.currentTimeMillis();</span><br><span class="line">        appStart.setT(&quot;&quot; + (millis - rand.nextInt(99999999)));</span><br><span class="line">        &#x2F;&#x2F; 手机网络模式 3G,4G,WIFI</span><br><span class="line">        flag &#x3D; rand.nextInt(3);</span><br><span class="line">        switch (flag) &#123;</span><br><span class="line">            case 0:</span><br><span class="line">                appStart.setNw(&quot;3G&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case 1:</span><br><span class="line">                appStart.setNw(&quot;4G&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case 2:</span><br><span class="line">                appStart.setNw(&quot;WIFI&quot;);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 拉丁美洲 西经34°46′至西经117°09；北纬32°42′至南纬53°54′</span><br><span class="line">        &#x2F;&#x2F; 经度</span><br><span class="line">        appStart.setLn((-34 - rand.nextInt(83) - rand.nextInt(60) &#x2F; 10.0) + &quot;&quot;);</span><br><span class="line">        &#x2F;&#x2F; 纬度</span><br><span class="line">        appStart.setLa((32 - rand.nextInt(85) - rand.nextInt(60) &#x2F; 10.0) + &quot;&quot;);</span><br><span class="line">        &#x2F;&#x2F; 入口</span><br><span class="line">        flag &#x3D; rand.nextInt(5) + 1;</span><br><span class="line">        appStart.setEntry(flag + &quot;&quot;);</span><br><span class="line">        &#x2F;&#x2F; 开屏广告类型</span><br><span class="line">        flag &#x3D; rand.nextInt(2) + 1;</span><br><span class="line">        appStart.setOpen_ad_type(flag + &quot;&quot;);</span><br><span class="line">        &#x2F;&#x2F; 状态</span><br><span class="line">        flag &#x3D; rand.nextInt(10) &gt; 8 ? 2 : 1;</span><br><span class="line">        appStart.setAction(flag + &quot;&quot;);</span><br><span class="line">        &#x2F;&#x2F; 加载时长</span><br><span class="line">        appStart.setLoading_time(rand.nextInt(20) + &quot;&quot;);</span><br><span class="line">        &#x2F;&#x2F; 失败码</span><br><span class="line">        flag &#x3D; rand.nextInt(10);</span><br><span class="line">        switch (flag) &#123;</span><br><span class="line">            case 1:</span><br><span class="line">                appStart.setDetail(&quot;102&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case 2:</span><br><span class="line">                appStart.setDetail(&quot;201&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case 3:</span><br><span class="line">                appStart.setDetail(&quot;325&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case 4:</span><br><span class="line">                appStart.setDetail(&quot;433&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case 5:</span><br><span class="line">                appStart.setDetail(&quot;542&quot;);</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                appStart.setDetail(&quot;&quot;);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 扩展字段</span><br><span class="line">        appStart.setExtend1(&quot;&quot;);</span><br><span class="line">        return appStart;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 消息通知</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static JSONObject generateNotification() &#123;</span><br><span class="line">        AppNotification appNotification &#x3D; new AppNotification();</span><br><span class="line">        int flag &#x3D; rand.nextInt(4) + 1;</span><br><span class="line">        &#x2F;&#x2F; 动作</span><br><span class="line">        appNotification.setAction(flag + &quot;&quot;);</span><br><span class="line">        &#x2F;&#x2F; 通知id</span><br><span class="line">        flag &#x3D; rand.nextInt(4) + 1;</span><br><span class="line">        appNotification.setType(flag + &quot;&quot;);</span><br><span class="line">        &#x2F;&#x2F; 客户端弹时间</span><br><span class="line">        appNotification.setAp_time((System.currentTimeMillis() - rand.nextInt(99999999)) + &quot;&quot;);</span><br><span class="line">        &#x2F;&#x2F; 备用字段</span><br><span class="line">        appNotification.setContent(&quot;&quot;);</span><br><span class="line">        JSONObject jsonObject &#x3D; (JSONObject) JSON.toJSON(appNotification);</span><br><span class="line">        return packEventJson(&quot;notification&quot;, jsonObject);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 后台活跃</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static JSONObject generateBackground() &#123;</span><br><span class="line">        AppActive appActive_background &#x3D; new AppActive();</span><br><span class="line">        &#x2F;&#x2F; 启动源</span><br><span class="line">        int flag &#x3D; rand.nextInt(3) + 1;</span><br><span class="line">        appActive_background.setActive_source(flag + &quot;&quot;);</span><br><span class="line">        JSONObject jsonObject &#x3D; (JSONObject) JSON.toJSON(appActive_background);</span><br><span class="line">        return packEventJson(&quot;active_background&quot;, jsonObject);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 错误日志数据</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static JSONObject generateError() &#123;</span><br><span class="line">        AppErrorLog appErrorLog &#x3D; new AppErrorLog();</span><br><span class="line">        String[] errorBriefs &#x3D; &#123;&quot;at cn.lift.dfdf.web.AbstractBaseController.validInbound(AbstractBaseController.java:72)&quot;, &quot;at cn.lift.appIn.control.CommandUtil.getInfo(CommandUtil.java:67)&quot;&#125;;        &#x2F;&#x2F;错误摘要</span><br><span class="line">        String[] errorDetails &#x3D; &#123;&quot;java.lang.NullPointerException\\n    &quot; + &quot;at cn.lift.appIn.web.AbstractBaseController.validInbound(AbstractBaseController.java:72)\\n &quot; + &quot;at cn.lift.dfdf.web.AbstractBaseController.validInbound&quot;, &quot;at cn.lift.dfdfdf.control.CommandUtil.getInfo(CommandUtil.java:67)\\n &quot; + &quot;at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\\n&quot; + &quot; at java.lang.reflect.Method.invoke(Method.java:606)\\n&quot;&#125;;        &#x2F;&#x2F;错误详情</span><br><span class="line">        &#x2F;&#x2F;错误摘要</span><br><span class="line">        appErrorLog.setErrorBrief(errorBriefs[rand.nextInt(errorBriefs.length)]);</span><br><span class="line">        &#x2F;&#x2F;错误详情</span><br><span class="line">        appErrorLog.setErrorDetail(errorDetails[rand.nextInt(errorDetails.length)]);</span><br><span class="line">        JSONObject jsonObject &#x3D; (JSONObject) JSON.toJSON(appErrorLog);</span><br><span class="line">        return packEventJson(&quot;error&quot;, jsonObject);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 为各个事件类型的公共字段（时间、事件类型、Json数据）拼接</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static JSONObject packEventJson(String eventName, JSONObject jsonObject) &#123;</span><br><span class="line">        JSONObject eventJson &#x3D; new JSONObject();</span><br><span class="line">        eventJson.put(&quot;ett&quot;, (System.currentTimeMillis() - rand.nextInt(99999999)) + &quot;&quot;);</span><br><span class="line">        eventJson.put(&quot;en&quot;, eventName);</span><br><span class="line">        eventJson.put(&quot;kv&quot;, jsonObject);</span><br><span class="line">        return eventJson;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 获取随机字母组合</span><br><span class="line">     *</span><br><span class="line">     * @param length 字符串长度</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static String getRandomChar(Integer length) &#123;</span><br><span class="line">        StringBuilder str &#x3D; new StringBuilder();</span><br><span class="line">        Random random &#x3D; new Random();</span><br><span class="line">        for (int i &#x3D; 0; i &lt; length; i++) &#123;</span><br><span class="line">            &#x2F;&#x2F; 字符串</span><br><span class="line">            str.append((char) (65 + random.nextInt(26)));&#x2F;&#x2F; 取得大写字母</span><br><span class="line">        &#125;</span><br><span class="line">        return str.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 获取随机字母数字组合</span><br><span class="line">     *</span><br><span class="line">     * @param length 字符串长度</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static String getRandomCharAndNumr(Integer length) &#123;</span><br><span class="line">        StringBuilder str &#x3D; new StringBuilder();</span><br><span class="line">        Random random &#x3D; new Random();</span><br><span class="line">        for (int i &#x3D; 0; i &lt; length; i++) &#123;</span><br><span class="line">            boolean b &#x3D; random.nextBoolean();</span><br><span class="line">            if (b) &#123; &#x2F;&#x2F; 字符串</span><br><span class="line">                &#x2F;&#x2F; int choice &#x3D; random.nextBoolean() ? 65 : 97; 取得65大写字母还是97小写字母</span><br><span class="line">                str.append((char) (65 + random.nextInt(26)));&#x2F;&#x2F; 取得大写字母</span><br><span class="line">            &#125; else &#123; &#x2F;&#x2F; 数字</span><br><span class="line">                str.append(String.valueOf(random.nextInt(10)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return str.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 收藏</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static JSONObject generateFavorites() &#123;</span><br><span class="line">        AppFavorites favorites &#x3D; new AppFavorites();</span><br><span class="line">        favorites.setCourse_id(rand.nextInt(10));</span><br><span class="line">        favorites.setUserid(rand.nextInt(10));</span><br><span class="line">        favorites.setAdd_time((System.currentTimeMillis() - rand.nextInt(99999999)) + &quot;&quot;);</span><br><span class="line">        JSONObject jsonObject &#x3D; (JSONObject) JSON.toJSON(favorites);</span><br><span class="line">        return packEventJson(&quot;favorites&quot;, jsonObject);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 点赞</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static JSONObject generatePraise() &#123;</span><br><span class="line">        AppPraise praise &#x3D; new AppPraise();</span><br><span class="line">        praise.setId(rand.nextInt(10));</span><br><span class="line">        praise.setUserid(rand.nextInt(10));</span><br><span class="line">        praise.setTarget_id(rand.nextInt(10));</span><br><span class="line">        praise.setType(rand.nextInt(4) + 1);</span><br><span class="line">        praise.setAdd_time((System.currentTimeMillis() - rand.nextInt(99999999)) + &quot;&quot;);</span><br><span class="line">        JSONObject jsonObject &#x3D; (JSONObject) JSON.toJSON(praise);</span><br><span class="line">        return packEventJson(&quot;praise&quot;, jsonObject);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 评论</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static JSONObject generateComment() &#123;</span><br><span class="line">        AppComment comment &#x3D; new AppComment();</span><br><span class="line">        comment.setComment_id(rand.nextInt(10));</span><br><span class="line">        comment.setUserid(rand.nextInt(10));</span><br><span class="line">        comment.setP_comment_id(rand.nextInt(5));</span><br><span class="line">        comment.setContent(getCONTENT());</span><br><span class="line">        comment.setAddtime((System.currentTimeMillis() - rand.nextInt(99999999)) + &quot;&quot;);</span><br><span class="line">        comment.setOther_id(rand.nextInt(10));</span><br><span class="line">        comment.setPraise_count(rand.nextInt(1000));</span><br><span class="line">        comment.setReply_count(rand.nextInt(200));</span><br><span class="line">        JSONObject jsonObject &#x3D; (JSONObject) JSON.toJSON(comment);</span><br><span class="line">        return packEventJson(&quot;comment&quot;, jsonObject);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 生成单个汉字</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static char getRandomChar() &#123;</span><br><span class="line">        String str &#x3D; &quot;&quot;;</span><br><span class="line">        int hightPos; &#x2F;&#x2F;</span><br><span class="line">        int lowPos;</span><br><span class="line">        Random random &#x3D; new Random();</span><br><span class="line">        &#x2F;&#x2F;随机生成汉子的两个字节</span><br><span class="line">        hightPos &#x3D; (176 + Math.abs(random.nextInt(39)));</span><br><span class="line">        lowPos &#x3D; (161 + Math.abs(random.nextInt(93)));</span><br><span class="line">        byte[] b &#x3D; new byte[2];</span><br><span class="line">        b[0] &#x3D; (Integer.valueOf(hightPos)).byteValue();</span><br><span class="line">        b[1] &#x3D; (Integer.valueOf(lowPos)).byteValue();</span><br><span class="line">        try &#123;</span><br><span class="line">            str &#x3D; new String(b, &quot;GBK&quot;);</span><br><span class="line">        &#125; catch (UnsupportedEncodingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.out.println(&quot;错误&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return str.charAt(0);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 拼接成多个汉字</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static String getCONTENT() &#123;</span><br><span class="line">        StringBuilder str &#x3D; new StringBuilder();</span><br><span class="line">        for (int i &#x3D; 0; i &lt; rand.nextInt(100); i++) &#123;</span><br><span class="line">            str.append(getRandomChar());</span><br><span class="line">        &#125;</span><br><span class="line">        return str.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a name="d6c3b682"></a></p><h4 id="2-4-5-启动测试"><a href="#2-4-5-启动测试" class="headerlink" title="2.4.5 启动测试"></a>2.4.5 启动测试</h4><blockquote><p>注意，需要将日志模拟放到2台服务器上，模拟日志每一条中即包括公共日志，又包含事件日志，需要flume拦截器进行日志分发，当然也需要两个flume-ng来做这个事情<br>打包上传2台服务器节点，生产数据为后面的测试做准备，这里为用户目录test文件夹下</p></blockquote><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445231-a9463aec-bcbe-4716-9e21-e761f37fc57e.png#align=left&display=inline&height=64&margin=%5Bobject%20Object%5D&originHeight=64&originWidth=1152&size=0&status=done&style=none&width=1152" alt><br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445356-4fb1c879-70b3-4a9b-aecd-98bc3096d13d.png#align=left&display=inline&height=61&margin=%5Bobject%20Object%5D&originHeight=61&originWidth=1150&size=0&status=done&style=none&width=1150" alt></p><blockquote><p>通过参数控制生成消息速度及产量(如下 2秒一条，打印1000条)</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#控制时间及条数</span><br><span class="line">nohup java -jar data-producer-1.0-SNAPSHOT-jar-with-dependencies.jar 2000 1000 &amp;</span><br><span class="line">#监控日志</span><br><span class="line">tail -F &#x2F;root&#x2F;logs&#x2F;*.log</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445278-2645af1d-a1c6-49eb-9fae-9a2e54c6fdd1.png#align=left&display=inline&height=125&margin=%5Bobject%20Object%5D&originHeight=125&originWidth=1204&size=0&status=done&style=none&width=1204" alt></p><blockquote><p>通过<a href="https://www.json.cn/" target="_blank" rel="external nofollow noopener noreferrer">www.json.cn</a>查看数据格式</p></blockquote><p><a name="blogTitle10"></a></p><h2 id="3-创建KafKa-Topic"><a href="#3-创建KafKa-Topic" class="headerlink" title="3 创建KafKa-Topic"></a>3 创建KafKa-Topic</h2><ul><li>创建启动日志主题：topic_start</li><li>创建事件日志主题：topic_event</li></ul><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445291-68eeb8c7-d2d0-4420-b26b-7008b185d7d4.png#align=left&display=inline&height=278&margin=%5Bobject%20Object%5D&originHeight=278&originWidth=918&size=0&status=done&style=none&width=918" alt><br><a name="blogTitle11"></a></p><h2 id="4-Flume准备"><a href="#4-Flume准备" class="headerlink" title="4 Flume准备"></a>4 Flume准备</h2><blockquote><p>共分为2组flume<br>第一组：将服务器日志收集，并使用Kafka-Channels将数据发往Kafka不同的Topic，其中使用拦截器进行公共日志和事件日志的分发，<br>第二组：收集Kafka数据，使用Flie-Channels缓存数据，最终发往Hdfs保存</p></blockquote><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445578-b0c40759-4e33-4b63-899b-6757a21dca2b.png#align=left&display=inline&height=821&margin=%5Bobject%20Object%5D&originHeight=821&originWidth=1920&size=0&status=done&style=none&width=1920" alt><br><a name="blogTitle12"></a></p><h3 id="4-1-Flume：File-gt-Kafka配置编写"><a href="#4-1-Flume：File-gt-Kafka配置编写" class="headerlink" title="4.1 Flume：File-&gt;Kafka配置编写"></a>4.1 Flume：File-&gt;Kafka配置编写</h3><ul><li>vim /root/test/file-flume-kafka.conf<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#1 定义组件</span><br><span class="line">a1.sources&#x3D;r1</span><br><span class="line">a1.channels&#x3D;c1 c2</span><br><span class="line"># 2 source配置 type类型 positionFile记录日志读取位置 filegroups读取哪些目录  app.+为读取什么开头 channels发往哪里</span><br><span class="line">a1.sources.r1.type &#x3D; TAILDIR</span><br><span class="line">a1.sources.r1.positionFile &#x3D; &#x2F;root&#x2F;test&#x2F;flume&#x2F;log_position.json</span><br><span class="line">a1.sources.r1.filegroups &#x3D; f1</span><br><span class="line">a1.sources.r1.filegroups.f1 &#x3D; &#x2F;root&#x2F;logs&#x2F;app.+</span><br><span class="line">a1.sources.r1.fileHeader &#x3D; true</span><br><span class="line">a1.sources.r1.channels &#x3D; c1 c2</span><br><span class="line">#3 拦截器 这里2个为自定义的拦截器 multiplexing为类型区分选择器 header头用于区分类型 mapping匹配头</span><br><span class="line">a1.sources.r1.interceptors &#x3D; i1 i2</span><br><span class="line">a1.sources.r1.interceptors.i1.type &#x3D; com.heaton.bigdata.flume.LogETLInterceptor$Builder</span><br><span class="line">a1.sources.r1.interceptors.i2.type &#x3D; com.heaton.bigdata.flume.LogTypeInterceptor$Builder</span><br><span class="line">a1.sources.r1.selector.type &#x3D; multiplexing</span><br><span class="line">a1.sources.r1.selector.header &#x3D; topic</span><br><span class="line">a1.sources.r1.selector.mapping.topic_start &#x3D; c1</span><br><span class="line">a1.sources.r1.selector.mapping.topic_event &#x3D; c2</span><br><span class="line">#4 channel配置 kafkaChannel</span><br><span class="line">a1.channels.c1.type &#x3D; org.apache.flume.channel.kafka.KafkaChannel</span><br><span class="line">a1.channels.c1.kafka.bootstrap.servers &#x3D; cdh01.cm:9092,cdh02.cm:9092,cdh03.cm:9092</span><br><span class="line">a1.channels.c1.kafka.topic &#x3D; topic_start</span><br><span class="line">a1.channels.c1.parseAsFlumeEvent &#x3D; false</span><br><span class="line">a1.channels.c1.kafka.consumer.group.id &#x3D; flume-consumer</span><br><span class="line">a1.channels.c2.type &#x3D;org.apache.flume.channel.kafka.KafkaChannel</span><br><span class="line">a1.channels.c2.kafka.bootstrap.servers &#x3D; cdh01.cm:9092,cdh02.cm:9092,cdh03.cm:9092</span><br><span class="line">a1.channels.c2.kafka.topic &#x3D; topic_event</span><br><span class="line">a1.channels.c2.parseAsFlumeEvent &#x3D; false</span><br><span class="line">a1.channels.c2.kafka.consumer.group.id &#x3D; flume-consumer</span><br></pre></td></tr></table></figure><blockquote><p>在生产日志的2台服务器节点上创建flume配置文件。<br>LogETLInterceptor，LogTypeInterceptor为自定义拦截</p></blockquote></li></ul><p><a name="blogTitle13"></a></p><h3 id="4-2-自定义拦截器"><a href="#4-2-自定义拦截器" class="headerlink" title="4.2 自定义拦截器"></a>4.2 自定义拦截器</h3><blockquote><p>data-flume工程</p></blockquote><ul><li><p>LogUtils</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.commons.lang.math.NumberUtils;</span><br><span class="line">public class LogUtils &#123;</span><br><span class="line">    public static boolean validateEvent(String log) &#123;</span><br><span class="line">        &#x2F;** 服务器时间 | json</span><br><span class="line">         1588319303710|&#123;</span><br><span class="line">         &quot;cm&quot;:&#123;</span><br><span class="line">         &quot;ln&quot;:&quot;-51.5&quot;,&quot;sv&quot;:&quot;V2.0.7&quot;,&quot;os&quot;:&quot;8.0.8&quot;,&quot;g&quot;:&quot;L1470998@gmail.com&quot;,&quot;mid&quot;:&quot;13&quot;,</span><br><span class="line">         &quot;nw&quot;:&quot;4G&quot;,&quot;l&quot;:&quot;en&quot;,&quot;vc&quot;:&quot;7&quot;,&quot;hw&quot;:&quot;640*960&quot;,&quot;ar&quot;:&quot;MX&quot;,&quot;uid&quot;:&quot;13&quot;,&quot;t&quot;:&quot;1588291826938&quot;,</span><br><span class="line">         &quot;la&quot;:&quot;-38.2&quot;,&quot;md&quot;:&quot;Huawei-14&quot;,&quot;vn&quot;:&quot;1.3.6&quot;,&quot;ba&quot;:&quot;Huawei&quot;,&quot;sr&quot;:&quot;Y&quot;</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;ap&quot;:&quot;app&quot;,</span><br><span class="line">         &quot;et&quot;:[&#123;</span><br><span class="line">                &quot;ett&quot;:&quot;1588228193191&quot;,&quot;en&quot;:&quot;ad&quot;,&quot;kv&quot;:&#123;&quot;activityId&quot;:&quot;1&quot;,&quot;displayMills&quot;:&quot;113201&quot;,&quot;entry&quot;:&quot;3&quot;,&quot;action&quot;:&quot;5&quot;,&quot;contentType&quot;:&quot;0&quot;&#125;</span><br><span class="line">                &#125;,&#123;</span><br><span class="line">                &quot;ett&quot;:&quot;1588300304713&quot;,&quot;en&quot;:&quot;notification&quot;,&quot;kv&quot;:&#123;&quot;ap_time&quot;:&quot;1588277440794&quot;,&quot;action&quot;:&quot;2&quot;,&quot;type&quot;:&quot;3&quot;,&quot;content&quot;:&quot;&quot;&#125;</span><br><span class="line">                &#125;,&#123;</span><br><span class="line">                &quot;ett&quot;:&quot;1588249203743&quot;,&quot;en&quot;:&quot;active_background&quot;,&quot;kv&quot;:&#123;&quot;active_source&quot;:&quot;3&quot;&#125;</span><br><span class="line">                &#125;,&#123;</span><br><span class="line">                &quot;ett&quot;:&quot;1588254200122&quot;,&quot;en&quot;:&quot;favorites&quot;,&quot;kv&quot;:&#123;&quot;course_id&quot;:5,&quot;id&quot;:0,&quot;add_time&quot;:&quot;1588264138625&quot;,&quot;userid&quot;:0&#125;</span><br><span class="line">                &#125;,&#123;</span><br><span class="line">                &quot;ett&quot;:&quot;1588281152824&quot;,&quot;en&quot;:&quot;praise&quot;,&quot;kv&quot;:&#123;&quot;target_id&quot;:4,&quot;id&quot;:3,&quot;type&quot;:3,&quot;add_time&quot;:&quot;1588307696417&quot;,&quot;userid&quot;:8&#125;</span><br><span class="line">                &#125;]</span><br><span class="line">         &#125;</span><br><span class="line">         *&#x2F;</span><br><span class="line">        &#x2F;&#x2F; 1 切割</span><br><span class="line">        String[] logContents &#x3D; log.split(&quot;\\|&quot;);</span><br><span class="line">        &#x2F;&#x2F; 2 校验</span><br><span class="line">        if (logContents.length !&#x3D; 2) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;3 校验服务器时间</span><br><span class="line">        if (logContents[0].length() !&#x3D; 13 || !NumberUtils.isDigits(logContents[0])) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 4 校验 json</span><br><span class="line">        if (!logContents[1].trim().startsWith(&quot;&#123;&quot;)</span><br><span class="line">                || !logContents[1].trim().endsWith(&quot;&#125;&quot;)) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    public static boolean validateStart(String log) &#123;</span><br><span class="line">        &#x2F;**</span><br><span class="line">         &#123;</span><br><span class="line">         &quot;action&quot;:&quot;1&quot;,&quot;ar&quot;:&quot;MX&quot;,&quot;ba&quot;:&quot;HTC&quot;,&quot;detail&quot;:&quot;201&quot;,&quot;en&quot;:&quot;start&quot;,&quot;entry&quot;:&quot;4&quot;,&quot;extend1&quot;:&quot;&quot;,</span><br><span class="line">         &quot;g&quot;:&quot;4Z174142@gmail.com&quot;,&quot;hw&quot;:&quot;750*1134&quot;,&quot;l&quot;:&quot;pt&quot;,&quot;la&quot;:&quot;-29.7&quot;,&quot;ln&quot;:&quot;-48.1&quot;,&quot;loading_time&quot;:&quot;0&quot;,</span><br><span class="line">         &quot;md&quot;:&quot;HTC-18&quot;,&quot;mid&quot;:&quot;14&quot;,&quot;nw&quot;:&quot;3G&quot;,&quot;open_ad_type&quot;:&quot;2&quot;,&quot;os&quot;:&quot;8.0.8&quot;,&quot;sr&quot;:&quot;D&quot;,&quot;sv&quot;:&quot;V2.8.2&quot;,</span><br><span class="line">         &quot;t&quot;:&quot;1588251833523&quot;,&quot;uid&quot;:&quot;14&quot;,&quot;vc&quot;:&quot;15&quot;,&quot;vn&quot;:&quot;1.2.9&quot;</span><br><span class="line">         &#125;</span><br><span class="line">        *&#x2F;</span><br><span class="line">        if (log &#x3D;&#x3D; null) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 校验 json</span><br><span class="line">        if (!log.trim().startsWith(&quot;&#123;&quot;) || !log.trim().endsWith(&quot;&#125;&quot;)) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>LogETLInterceptor</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.flume.Context;</span><br><span class="line">import org.apache.flume.Event;</span><br><span class="line">import org.apache.flume.interceptor.Interceptor;</span><br><span class="line">import java.nio.charset.Charset;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line">public class LogETLInterceptor implements Interceptor &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void initialize() &#123;</span><br><span class="line">    &#x2F;&#x2F;初始化</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public Event intercept(Event event) &#123;</span><br><span class="line">        &#x2F;&#x2F; 1 获取数据</span><br><span class="line">        byte[] body &#x3D; event.getBody();</span><br><span class="line">        String log &#x3D; new String(body, Charset.forName(&quot;UTF-8&quot;));</span><br><span class="line">        &#x2F;&#x2F; 2 判断数据类型并向 Header 中赋值</span><br><span class="line">        if (log.contains(&quot;start&quot;)) &#123;</span><br><span class="line">            if (LogUtils.validateStart(log)) &#123;</span><br><span class="line">                return event;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            if (LogUtils.validateEvent(log)) &#123;</span><br><span class="line">                return event;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 3 返回校验结果</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;Event&gt; intercept(List&lt;Event&gt; events) &#123;</span><br><span class="line">        ArrayList&lt;Event&gt; interceptors &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">        for (Event event : events) &#123;</span><br><span class="line">            Event intercept1 &#x3D; intercept(event);</span><br><span class="line">            if (intercept1 !&#x3D; null) &#123;</span><br><span class="line">                interceptors.add(intercept1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return interceptors;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public void close() &#123;</span><br><span class="line">    &#x2F;&#x2F;关闭</span><br><span class="line">    &#125;</span><br><span class="line">    public static class Builder implements Interceptor.Builder &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public Interceptor build() &#123;</span><br><span class="line">            return new LogETLInterceptor();</span><br><span class="line">        &#125;</span><br><span class="line">        @Override</span><br><span class="line">        public void configure(Context context) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>LogTypeInterceptor</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.flume.Context;</span><br><span class="line">import org.apache.flume.Event;</span><br><span class="line">import org.apache.flume.interceptor.Interceptor;</span><br><span class="line">import java.nio.charset.Charset;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line">public class LogTypeInterceptor implements Interceptor &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void initialize() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public Event intercept(Event event) &#123;</span><br><span class="line">        &#x2F;&#x2F; 区分日志类型： body header</span><br><span class="line">        &#x2F;&#x2F; 1 获取 body 数据</span><br><span class="line">        byte[] body &#x3D; event.getBody();</span><br><span class="line">        String log &#x3D; new String(body, Charset.forName(&quot;UTF-8&quot;));</span><br><span class="line">        &#x2F;&#x2F; 2 获取 header</span><br><span class="line">        Map&lt;String, String&gt; headers &#x3D; event.getHeaders();</span><br><span class="line">        &#x2F;&#x2F; 3 判断数据类型并向 Header 中赋值</span><br><span class="line">        if (log.contains(&quot;start&quot;)) &#123;</span><br><span class="line">            headers.put(&quot;topic&quot;, &quot;topic_start&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            headers.put(&quot;topic&quot;, &quot;topic_event&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return event;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;Event&gt; intercept(List&lt;Event&gt; events) &#123;</span><br><span class="line">        ArrayList&lt;Event&gt; interceptors &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">        for (Event event : events) &#123;</span><br><span class="line">            Event intercept1 &#x3D; intercept(event);</span><br><span class="line">            interceptors.add(intercept1);</span><br><span class="line">        &#125;</span><br><span class="line">        return interceptors;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public void close() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    public static class Builder implements Interceptor.Builder &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public Interceptor build() &#123;</span><br><span class="line">            return new LogTypeInterceptor();</span><br><span class="line">        &#125;</span><br><span class="line">        @Override</span><br><span class="line">        public void configure(Context context) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>将项目打包放入Flume/lib目录下(所有节点)：<br>CDH路径参考：/opt/cloudera/parcels/CDH-6.2.0-1.cdh6.2.0.p0.967373/lib/flume-ng/lib</p></blockquote></li></ul><p><a name="blogTitle14"></a></p><h3 id="4-3-Flume启停脚本"><a href="#4-3-Flume启停脚本" class="headerlink" title="4.3 Flume启停脚本"></a>4.3 Flume启停脚本</h3><ul><li><p>vim /root/log-kafka-flume.sh</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#! &#x2F;bin&#x2F;bash</span><br><span class="line">case $1 in</span><br><span class="line">&quot;start&quot;)&#123;</span><br><span class="line">	for i in cdh02.cm cdh03.cm</span><br><span class="line">	do</span><br><span class="line">		echo &quot; --------启动 $i 消费 flume-------&quot;</span><br><span class="line">		ssh $i &quot;nohup flume-ng agent --conf-file &#x2F;root&#x2F;test&#x2F;file-flume-kafka.conf --name a1 -Dflume.root.logger&#x3D;INFO,LOGFILE &gt;&#x2F;root&#x2F;test&#x2F;file-flume-kafka.log 2&gt;&amp;1 &amp;&quot;</span><br><span class="line">	done</span><br><span class="line">&#125;;;</span><br><span class="line">&quot;stop&quot;)&#123;</span><br><span class="line">	for i in cdh02.cm cdh03.cm</span><br><span class="line">	do</span><br><span class="line">		echo &quot; --------停止 $i 消费 flume-------&quot;</span><br><span class="line">		ssh $i &quot;ps -ef | grep file-flume-kafka | grep -v grep |awk &#39;&#123;print \$2&#125;&#39; | xargs kill&quot;</span><br><span class="line">	done</span><br><span class="line">&#125;;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445286-e3d74a0a-846a-497d-9395-835dc06bbe36.png#align=left&display=inline&height=378&margin=%5Bobject%20Object%5D&originHeight=378&originWidth=1509&size=0&status=done&style=none&width=1509" alt><br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445293-b89b1d01-98f1-4ea2-9a5f-8b49b3bb9549.png#align=left&display=inline&height=385&margin=%5Bobject%20Object%5D&originHeight=385&originWidth=1511&size=0&status=done&style=none&width=1511" alt><br><a name="blogTitle15"></a></p><h3 id="4-4-Flume：Kafka-gt-HDFS配置编写"><a href="#4-4-Flume：Kafka-gt-HDFS配置编写" class="headerlink" title="4.4 Flume：Kafka-&gt;HDFS配置编写"></a>4.4 Flume：Kafka-&gt;HDFS配置编写</h3><blockquote><p>在第三台服务上准备</p></blockquote></li><li><p>vim /root/test/kafka-flume-hdfs.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">## 组件 </span><br><span class="line">a1.sources&#x3D;r1 r2</span><br><span class="line">a1.channels&#x3D;c1 c2 </span><br><span class="line">a1.sinks&#x3D;k1 k2</span><br><span class="line">    </span><br><span class="line">## Kafka-source1</span><br><span class="line">a1.sources.r1.type &#x3D; org.apache.flume.source.kafka.KafkaSource</span><br><span class="line">a1.sources.r1.batchSize &#x3D; 5000</span><br><span class="line">a1.sources.r1.batchDurationMillis &#x3D; 2000</span><br><span class="line">a1.sources.r1.kafka.bootstrap.servers&#x3D; cdh01.cm:9092,cdh02.cm:9092,cdh03.cm:9092</span><br><span class="line">a1.sources.r1.kafka.topics &#x3D; topic_start</span><br><span class="line">## Kafka- source2</span><br><span class="line">a1.sources.r2.type &#x3D; org.apache.flume.source.kafka.KafkaSource</span><br><span class="line">a1.sources.r2.batchSize &#x3D; 5000</span><br><span class="line">a1.sources.r2.batchDurationMillis &#x3D; 2000</span><br><span class="line">a1.sources.r2.kafka.bootstrap.servers &#x3D; cdh01.cm:9092,cdh02.cm:9092,cdh03.cm:9092</span><br><span class="line">a1.sources.r2.kafka.topics &#x3D; topic_event</span><br><span class="line">    </span><br><span class="line">## channel1</span><br><span class="line">a1.channels.c1.type &#x3D; file</span><br><span class="line">##索引文件路径</span><br><span class="line">a1.channels.c1.checkpointDir&#x3D;&#x2F;root&#x2F;test&#x2F;flume&#x2F;checkpoint&#x2F;behavior1</span><br><span class="line">##持久化路径</span><br><span class="line">a1.channels.c1.dataDirs &#x3D; &#x2F;root&#x2F;test&#x2F;flume&#x2F;data&#x2F;behavior1&#x2F;</span><br><span class="line">a1.channels.c1.maxFileSize &#x3D; 2146435071</span><br><span class="line">a1.channels.c1.capacity &#x3D; 1000000</span><br><span class="line">a1.channels.c1.keep-alive &#x3D; 6</span><br><span class="line">## channel2</span><br><span class="line">a1.channels.c2.type &#x3D; file</span><br><span class="line">##索引文件路径</span><br><span class="line">a1.channels.c1.checkpointDir&#x3D;&#x2F;root&#x2F;test&#x2F;flume&#x2F;checkpoint&#x2F;behavior2</span><br><span class="line">##持久化路径</span><br><span class="line">a1.channels.c1.dataDirs &#x3D; &#x2F;root&#x2F;test&#x2F;flume&#x2F;data&#x2F;behavior2&#x2F;</span><br><span class="line">a1.channels.c2.maxFileSize &#x3D; 2146435071</span><br><span class="line">a1.channels.c2.capacity &#x3D; 1000000</span><br><span class="line">a1.channels.c2.keep-alive &#x3D; 6</span><br><span class="line">    </span><br><span class="line">## HDFS-sink1</span><br><span class="line">a1.sinks.k1.type &#x3D; hdfs</span><br><span class="line">a1.sinks.k1.hdfs.path&#x3D;&#x2F;origin_data&#x2F;gmall&#x2F;log&#x2F;topic_start&#x2F;%Y-%m-%d</span><br><span class="line">a1.sinks.k1.hdfs.filePrefix &#x3D; logstart-</span><br><span class="line">## HDFS-sink2       </span><br><span class="line">a1.sinks.k2.type &#x3D; hdfs</span><br><span class="line">a1.sinks.k2.hdfs.path &#x3D; &#x2F;origin_data&#x2F;gmall&#x2F;log&#x2F;topic_event&#x2F;%Y-%m-%d</span><br><span class="line">a1.sinks.k2.hdfs.filePrefix &#x3D; logevent-</span><br><span class="line">    </span><br><span class="line">## 不要产生大量小文件</span><br><span class="line">a1.sinks.k1.hdfs.rollInterval &#x3D; 10</span><br><span class="line">a1.sinks.k1.hdfs.rollSize &#x3D; 134217728</span><br><span class="line">a1.sinks.k1.hdfs.rollCount &#x3D; 0</span><br><span class="line">a1.sinks.k2.hdfs.rollInterval &#x3D; 50</span><br><span class="line">a1.sinks.k2.hdfs.rollSize &#x3D; 134217728</span><br><span class="line">a1.sinks.k2.hdfs.rollCount &#x3D; 0</span><br><span class="line">## 控制输出文件是原生文件。</span><br><span class="line">a1.sinks.k1.hdfs.fileType &#x3D; CompressedStream</span><br><span class="line">a1.sinks.k2.hdfs.fileType &#x3D; CompressedStream</span><br><span class="line">a1.sinks.k1.hdfs.codeC &#x3D; snappy</span><br><span class="line">a1.sinks.k2.hdfs.codeC &#x3D; snappy</span><br><span class="line">    </span><br><span class="line">## 组件拼装</span><br><span class="line">a1.sources.r1.channels &#x3D; c1</span><br><span class="line">a1.sinks.k1.channel&#x3D; c1</span><br><span class="line">a1.sources.r2.channels &#x3D; c2</span><br><span class="line">a1.sinks.k2.channel&#x3D; c2</span><br></pre></td></tr></table></figure><p><a name="blogTitle16"></a></p><h3 id="4-5-Flume启停脚本"><a href="#4-5-Flume启停脚本" class="headerlink" title="4.5 Flume启停脚本"></a>4.5 Flume启停脚本</h3><blockquote><p>在第三台服务上准备</p></blockquote></li><li><p>vim /root/test/kafka-hdfs-flume.sh</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#! &#x2F;bin&#x2F;bash</span><br><span class="line">case $1 in</span><br><span class="line">&quot;start&quot;)&#123;</span><br><span class="line">	for i in cdh01.cm</span><br><span class="line">	do</span><br><span class="line">		echo &quot; --------启动 $i 消费 flume-------&quot;</span><br><span class="line">		ssh $i &quot;nohup flume-ng agent --conf-file &#x2F;root&#x2F;test&#x2F;kafka-flume-hdfs.conf --name a1 -Dflume.root.logger&#x3D;INFO,LOGFILE &gt;&#x2F;root&#x2F;test&#x2F;kafka-flume-hdfs.log 2&gt;&amp;1 &amp;&quot;</span><br><span class="line">	done</span><br><span class="line">&#125;;;</span><br><span class="line">&quot;stop&quot;)&#123;</span><br><span class="line">	for i in cdh01.cm</span><br><span class="line">	do</span><br><span class="line">		echo &quot; --------停止 $i 消费 flume-------&quot;</span><br><span class="line">		ssh $i &quot;ps -ef | grep kafka-flume-hdfs | grep -v grep |awk &#39;&#123;print \$2&#125;&#39; | xargs kill&quot;</span><br><span class="line">	done</span><br><span class="line">&#125;;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure></li></ul><p><br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445281-63bb8866-411b-4829-b0b3-0d989bca1884.png#align=left&display=inline&height=571&margin=%5Bobject%20Object%5D&originHeight=571&originWidth=1159&size=0&status=done&style=none&width=1159" alt><br><a name="blogTitle17"></a></p><h2 id="5-业务数据"><a href="#5-业务数据" class="headerlink" title="5 业务数据"></a>5 业务数据</h2><blockquote><p>此模块后主要针对于企业报表决策，为数据分析提供数据支持，解决大数据量下，无法快速产出报表，及一些即席业务需求的快速展示提供数据支撑。划分企业离线与实时业务，用离线的方式直观的管理数据呈现，为实时方案奠定良好基础。</p></blockquote><p><a name="blogTitle18"></a></p><h3 id="5-1-电商业务流程"><a href="#5-1-电商业务流程" class="headerlink" title="5.1 电商业务流程"></a>5.1 电商业务流程</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445499-c8b438ec-8428-4251-83c3-daecf0ea0f47.png#align=left&display=inline&height=647&margin=%5Bobject%20Object%5D&originHeight=647&originWidth=959&size=0&status=done&style=none&width=959" alt><br><a name="blogTitle19"></a></p><h3 id="5-2-SKU-SPU"><a href="#5-2-SKU-SPU" class="headerlink" title="5.2 SKU-SPU"></a>5.2 SKU-SPU</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445306-c312505f-c425-4ba5-97ee-9970d00d11df.png#align=left&display=inline&height=603&margin=%5Bobject%20Object%5D&originHeight=603&originWidth=1244&size=0&status=done&style=none&width=1244" alt></p><ul><li>SKU（Stock Keeping Unit）：库存量基本单位，现在已经被引申为产品统一编号的简称， 每种产品均对应有唯一的 SKU 号。</li><li>SPU（Standard Product Unit）：是商品信息聚合的最小单位，是一组可复用、易检索的 标准化信息集合。</li><li>总结：黑鲨3 手机就是 SPU。一台铠甲灰、256G 内存的就是 SKU。<br><a name="blogTitle20"></a><h3 id="5-3-业务表结构"><a href="#5-3-业务表结构" class="headerlink" title="5.3 业务表结构"></a>5.3 业务表结构</h3><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445320-2cc623a5-0587-4abf-a3ae-daaaf038854d.png#align=left&display=inline&height=682&margin=%5Bobject%20Object%5D&originHeight=682&originWidth=1134&size=0&status=done&style=none&width=1134" alt><br><a name="2a0538a3"></a><h4 id="5-3-1-订单表（order-info）"><a href="#5-3-1-订单表（order-info）" class="headerlink" title="5.3.1 订单表（order_info）"></a>5.3.1 订单表（order_info）</h4><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445293-807044ab-66a1-4421-823b-b7945c79f048.png#align=left&display=inline&height=370&margin=%5Bobject%20Object%5D&originHeight=370&originWidth=820&size=0&status=done&style=none&width=820" alt><br><a name="e3c30ff7"></a><h4 id="5-3-2-订单详情表（order-detail）"><a href="#5-3-2-订单详情表（order-detail）" class="headerlink" title="5.3.2 订单详情表（order_detail）"></a>5.3.2 订单详情表（order_detail）</h4><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445421-3fefa623-d4e1-4458-9247-ceafcc11bbd9.png#align=left&display=inline&height=188&margin=%5Bobject%20Object%5D&originHeight=188&originWidth=820&size=0&status=done&style=none&width=820" alt><br><a name="ef4539a6"></a><h4 id="5-3-3-SKU-商品表（sku-info）"><a href="#5-3-3-SKU-商品表（sku-info）" class="headerlink" title="5.3.3 SKU 商品表（sku_info）"></a>5.3.3 SKU 商品表（sku_info）</h4><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445457-375551a4-5ba5-4fe2-8594-36a86445a0e9.png#align=left&display=inline&height=224&margin=%5Bobject%20Object%5D&originHeight=224&originWidth=820&size=0&status=done&style=none&width=820" alt><br><a name="9ecdba66"></a><h4 id="5-3-4-用户表（user-info）"><a href="#5-3-4-用户表（user-info）" class="headerlink" title="5.3.4 用户表（user_info）"></a>5.3.4 用户表（user_info）</h4><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445409-4fcce741-b0a9-40fe-ae2a-e0669c51338b.png#align=left&display=inline&height=261&margin=%5Bobject%20Object%5D&originHeight=261&originWidth=820&size=0&status=done&style=none&width=820" alt><br><a name="4097e291"></a><h4 id="5-3-5-商品一级分类表（base-category1）"><a href="#5-3-5-商品一级分类表（base-category1）" class="headerlink" title="5.3.5 商品一级分类表（base_category1）"></a>5.3.5 商品一级分类表（base_category1）</h4><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445599-b968e841-b432-4d76-87e3-e4e4990466c9.png#align=left&display=inline&height=93&margin=%5Bobject%20Object%5D&originHeight=93&originWidth=820&size=0&status=done&style=none&width=820" alt><br><a name="edd3477b"></a><h4 id="5-3-6-商品二级分类表（base-category2）"><a href="#5-3-6-商品二级分类表（base-category2）" class="headerlink" title="5.3.6 商品二级分类表（base_category2）"></a>5.3.6 商品二级分类表（base_category2）</h4><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445399-404c5075-6615-4886-8101-ae6a9a2ea836.png#align=left&display=inline&height=99&margin=%5Bobject%20Object%5D&originHeight=99&originWidth=820&size=0&status=done&style=none&width=820" alt><br><a name="761365da"></a><h4 id="5-3-7-商品三级分类表（base-category3）"><a href="#5-3-7-商品三级分类表（base-category3）" class="headerlink" title="5.3.7 商品三级分类表（base_category3）"></a>5.3.7 商品三级分类表（base_category3）</h4><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445762-7d1a4322-7ef5-4fe2-bb8b-ef97c0bcbb9a.png#align=left&display=inline&height=103&margin=%5Bobject%20Object%5D&originHeight=103&originWidth=820&size=0&status=done&style=none&width=820" alt><br><a name="d73753a2"></a><h4 id="5-3-8-支付流水表（payment-info）"><a href="#5-3-8-支付流水表（payment-info）" class="headerlink" title="5.3.8 支付流水表（payment_info）"></a>5.3.8 支付流水表（payment_info）</h4><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445446820-0341ff71-434e-4a82-8036-eba14a8476b9.png#align=left&display=inline&height=199&margin=%5Bobject%20Object%5D&originHeight=199&originWidth=820&size=0&status=done&style=none&width=820" alt><br><a name="8e375166"></a><h4 id="5-3-9-省份表（base-province）"><a href="#5-3-9-省份表（base-province）" class="headerlink" title="5.3.9 省份表（base_province）"></a>5.3.9 省份表（base_province）</h4><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445408-12faad35-63c2-4718-ac13-83b26354b3c3.png#align=left&display=inline&height=119&margin=%5Bobject%20Object%5D&originHeight=119&originWidth=820&size=0&status=done&style=none&width=820" alt><br><a name="d0920d19"></a><h4 id="5-3-10-地区表（base-region）"><a href="#5-3-10-地区表（base-region）" class="headerlink" title="5.3.10 地区表（base_region）"></a>5.3.10 地区表（base_region）</h4><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445709-051d048d-66ef-40a7-981a-8538094858a6.png#align=left&display=inline&height=72&margin=%5Bobject%20Object%5D&originHeight=72&originWidth=820&size=0&status=done&style=none&width=820" alt><br><a name="3df9abe4"></a><h4 id="5-3-11-品牌表（base-trademark）"><a href="#5-3-11-品牌表（base-trademark）" class="headerlink" title="5.3.11 品牌表（base_trademark）"></a>5.3.11 品牌表（base_trademark）</h4><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445417-956df41f-c8d8-43e9-a9ef-478c4e16fa95.png#align=left&display=inline&height=106&margin=%5Bobject%20Object%5D&originHeight=106&originWidth=1277&size=0&status=done&style=none&width=1277" alt><br><a name="e1eb5124"></a><h4 id="5-3-12-订单状态表（order-status-log）"><a href="#5-3-12-订单状态表（order-status-log）" class="headerlink" title="5.3.12 订单状态表（order_status_log）"></a>5.3.12 订单状态表（order_status_log）</h4><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445403-6ebe9cc2-6007-4e39-9647-1d63cb9886f4.png#align=left&display=inline&height=118&margin=%5Bobject%20Object%5D&originHeight=118&originWidth=820&size=0&status=done&style=none&width=820" alt><br><a name="dbb7a316"></a><h4 id="5-3-13-SPU-商品表（spu-info）"><a href="#5-3-13-SPU-商品表（spu-info）" class="headerlink" title="5.3.13 SPU 商品表（spu_info）"></a>5.3.13 SPU 商品表（spu_info）</h4><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445616-7c564b8c-e4be-4942-a245-5a986b440689.png#align=left&display=inline&height=136&margin=%5Bobject%20Object%5D&originHeight=136&originWidth=820&size=0&status=done&style=none&width=820" alt><br><a name="afc9aaeb"></a><h4 id="5-3-14-商品评论表（comment-info）"><a href="#5-3-14-商品评论表（comment-info）" class="headerlink" title="5.3.14 商品评论表（comment_info）"></a>5.3.14 商品评论表（comment_info）</h4><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445432-2a0d5fa0-0fcf-45b9-9d62-a3c97be4ced3.png#align=left&display=inline&height=260&margin=%5Bobject%20Object%5D&originHeight=260&originWidth=1132&size=0&status=done&style=none&width=1132" alt><br><a name="3cd84c4c"></a><h4 id="5-3-15-退单表（order-refund-info）"><a href="#5-3-15-退单表（order-refund-info）" class="headerlink" title="5.3.15 退单表（order_refund_info）"></a>5.3.15 退单表（order_refund_info）</h4><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445415-560c225d-39ad-4e97-ae5e-feded91e61bc.png#align=left&display=inline&height=211&margin=%5Bobject%20Object%5D&originHeight=211&originWidth=820&size=0&status=done&style=none&width=820" alt><br><a name="86808c1f"></a><h4 id="5-3-16-加入购物车表（cart-info）"><a href="#5-3-16-加入购物车表（cart-info）" class="headerlink" title="5.3.16 加入购物车表（cart_info）"></a>5.3.16 加入购物车表（cart_info）</h4><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445420-ec008b1a-ac25-4d67-8f30-a4f22f8bf986.png#align=left&display=inline&height=229&margin=%5Bobject%20Object%5D&originHeight=229&originWidth=820&size=0&status=done&style=none&width=820" alt><br><a name="e396f00d"></a><h4 id="5-3-17-商品收藏表（favor-info）"><a href="#5-3-17-商品收藏表（favor-info）" class="headerlink" title="5.3.17 商品收藏表（favor_info）"></a>5.3.17 商品收藏表（favor_info）</h4><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445413-5bc2fefc-43ea-4198-962a-68e04c3693b5.png#align=left&display=inline&height=167&margin=%5Bobject%20Object%5D&originHeight=167&originWidth=820&size=0&status=done&style=none&width=820" alt><br><a name="599c2d57"></a><h4 id="5-3-18-优惠券领用表（coupon-use）"><a href="#5-3-18-优惠券领用表（coupon-use）" class="headerlink" title="5.3.18 优惠券领用表（coupon_use）"></a>5.3.18 优惠券领用表（coupon_use）</h4><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445440-5134d8aa-2085-457c-bb47-4ba611528bc1.png#align=left&display=inline&height=193&margin=%5Bobject%20Object%5D&originHeight=193&originWidth=820&size=0&status=done&style=none&width=820" alt><br><a name="597f8aa7"></a><h4 id="5-3-19-优惠券表（coupon-info）"><a href="#5-3-19-优惠券表（coupon-info）" class="headerlink" title="5.3.19 优惠券表（coupon_info）"></a>5.3.19 优惠券表（coupon_info）</h4><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445469-06ad320b-4efb-4e48-b359-66b5a0180987.png#align=left&display=inline&height=306&margin=%5Bobject%20Object%5D&originHeight=306&originWidth=820&size=0&status=done&style=none&width=820" alt><br><a name="14b73501"></a><h4 id="5-3-20-活动表（activity-info）"><a href="#5-3-20-活动表（activity-info）" class="headerlink" title="5.3.20 活动表（activity_info）"></a>5.3.20 活动表（activity_info）</h4><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445480-d02fd607-dfe9-47b8-992f-8f675460e400.png#align=left&display=inline&height=172&margin=%5Bobject%20Object%5D&originHeight=172&originWidth=820&size=0&status=done&style=none&width=820" alt><br><a name="23b08d0d"></a><h4 id="5-3-21-活动订单关联表（activity-order）"><a href="#5-3-21-活动订单关联表（activity-order）" class="headerlink" title="5.3.21 活动订单关联表（activity_order）"></a>5.3.21 活动订单关联表（activity_order）</h4></li></ul><p><a name="f2c83679"></a></p><h4 id="5-3-22-优惠规则表（activity-rule）"><a href="#5-3-22-优惠规则表（activity-rule）" class="headerlink" title="5.3.22 优惠规则表（activity_rule）"></a>5.3.22 优惠规则表（activity_rule）</h4><p><a name="c05cf4cd"></a></p><h4 id="5-3-23-编码字典表（base-dic）"><a href="#5-3-23-编码字典表（base-dic）" class="headerlink" title="5.3.23 编码字典表（base_dic）"></a>5.3.23 编码字典表（base_dic）</h4><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445580-ef8aff78-4e6e-4cfa-8a34-5cb0929bbf8f.png#align=left&display=inline&height=133&margin=%5Bobject%20Object%5D&originHeight=133&originWidth=820&size=0&status=done&style=none&width=820" alt><br><a name="41ae15c6"></a></p><h4 id="5-3-24-活动参与商品表（activity-sku）"><a href="#5-3-24-活动参与商品表（activity-sku）" class="headerlink" title="5.3.24 活动参与商品表（activity_sku）"></a>5.3.24 活动参与商品表（activity_sku）</h4><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445455-d299fd9e-7ed4-4419-a4eb-41e0d3af4c25.png#align=left&display=inline&height=181&margin=%5Bobject%20Object%5D&originHeight=181&originWidth=1279&size=0&status=done&style=none&width=1279" alt><br><a name="blogTitle21"></a></p><h3 id="5-4-时间表结构"><a href="#5-4-时间表结构" class="headerlink" title="5.4 时间表结构"></a>5.4 时间表结构</h3><p><a name="f09b2786"></a></p><h4 id="5-4-1-时间表（date-info）"><a href="#5-4-1-时间表（date-info）" class="headerlink" title="5.4.1 时间表（date_info）"></a>5.4.1 时间表（date_info）</h4><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445509-9e9b8580-ed76-4d31-9524-0d9d35af8e7e.png#align=left&display=inline&height=194&margin=%5Bobject%20Object%5D&originHeight=194&originWidth=820&size=0&status=done&style=none&width=820" alt><br><a name="f703d98c"></a></p><h4 id="5-4-2-假期表（holiday-info）"><a href="#5-4-2-假期表（holiday-info）" class="headerlink" title="5.4.2 假期表（holiday_info）"></a>5.4.2 假期表（holiday_info）</h4><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445498-cace1b91-fd1c-495e-ae9e-5b20b950f181.png#align=left&display=inline&height=80&margin=%5Bobject%20Object%5D&originHeight=80&originWidth=820&size=0&status=done&style=none&width=820" alt><br><a name="421431fc"></a></p><h4 id="5-4-3-假期年表（holiday-year）"><a href="#5-4-3-假期年表（holiday-year）" class="headerlink" title="5.4.3 假期年表（holiday_year）"></a>5.4.3 假期年表（holiday_year）</h4><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445585-dfcd1dca-4af1-4822-98c0-729ff17ad0cd.png#align=left&display=inline&height=105&margin=%5Bobject%20Object%5D&originHeight=105&originWidth=820&size=0&status=done&style=none&width=820" alt><br><a name="blogTitle22"></a></p><h2 id="6-同步策略及数仓分层"><a href="#6-同步策略及数仓分层" class="headerlink" title="6 同步策略及数仓分层"></a>6 同步策略及数仓分层</h2><blockquote><p>数据同步策略的类型包括：全量表、增量表、新增及变化表</p></blockquote><ul><li>全量表：每天一个分区，存储完整的数据。<br></li><li>增量表：每天新增数据放在一个分区，存储新增加的数据。<br></li><li>新增及变化表：每天新增和变化的数据放在一个分区，存储新增加的数据和变化的数据。<br></li><li>特殊表：没有分区，只需要存储一次。<br><br><a name="blogTitle23"></a><h3 id="6-1-全量策略"><a href="#6-1-全量策略" class="headerlink" title="6.1 全量策略"></a>6.1 全量策略</h3><blockquote><p>每日全量，每天存储一份完整数据，作为一个分区。<br>适合场景：表数据量不大，且有新增或修改业务的场景<br>例如：品牌表、编码表、商品分类表、优惠规则表、活动表、商品表、加购表、收藏表、SKU/SPU表</p></blockquote></li></ul><p><a name="blogTitle24"></a></p><h3 id="6-2-增量策略"><a href="#6-2-增量策略" class="headerlink" title="6.2 增量策略"></a>6.2 增量策略</h3><blockquote><p>每日增量，每天储存一份增量数据，作为一个分区<br>适合场景：表数据量大，且只会有新增数据的场景。<br>例如：退单表、订单状态表、支付流水表、订单详情表、活动与订单关联表、商品评论表</p></blockquote><p><a name="blogTitle25"></a></p><h3 id="6-3-新增及变化策略"><a href="#6-3-新增及变化策略" class="headerlink" title="6.3 新增及变化策略"></a>6.3 新增及变化策略</h3><blockquote><p>每日新增及变化，储存创建时间和操作时间都是今天的数据，作为一个分区<br>适合场景：表数据量大，既会有新增，又会有修改。<br>例如：用户表、订单表、优惠卷领用表。</p></blockquote><p><a name="blogTitle26"></a></p><h3 id="6-4-特殊策略"><a href="#6-4-特殊策略" class="headerlink" title="6.4 特殊策略"></a>6.4 特殊策略</h3><blockquote><p>某些特殊的维度表，可不必遵循上述同步策略，在数仓中只做一次同步，数据不变化不更新<br>适合场景：表数据几乎不会变化<br>1.客观世界维度：没变化的客观世界的维度（比如性别，地区，民族，政治成分，鞋子尺码）可以只存一 份固定值<br>2.日期维度：日期维度可以一次性导入一年或若干年的数据。<br>3.地区维度：省份表、地区表</p></blockquote><p><a name="blogTitle27"></a></p><h3 id="6-5-分析业务表同步策略"><a href="#6-5-分析业务表同步策略" class="headerlink" title="6.5 分析业务表同步策略"></a>6.5 分析业务表同步策略</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445558-f3526a7c-422a-4254-b832-a0edb969ecd0.png#align=left&display=inline&height=577&margin=%5Bobject%20Object%5D&originHeight=577&originWidth=1161&size=0&status=done&style=none&width=1161" alt></p><blockquote><p>考虑到特殊表可能会缓慢变化，比如打仗占地盘，地区表可能就会发生变化，故也选择分区全量同步策略。</p></blockquote><p><a name="blogTitle28"></a></p><h3 id="6-6-数仓分层"><a href="#6-6-数仓分层" class="headerlink" title="6.6 数仓分层"></a>6.6 数仓分层</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445503-1f00df37-1048-4dab-bd2a-b93874b97ed6.png#align=left&display=inline&height=563&margin=%5Bobject%20Object%5D&originHeight=563&originWidth=1141&size=0&status=done&style=none&width=1141" alt></p><ul><li><p>为什么分层：</p><ul><li>简单化：把复杂的任务分解为多层来完成，每层处理各自的任务，方便定位问题。</li><li>减少重复开发：规范数据分层，通过中间层数据，能够极大的减少重复计算，增加结果复用性。</li><li>隔离数据：不论是数据异常还是数据敏感性，使真实数据和统计数据解耦。</li><li>一般在DWD层进行维度建模</li></ul></li><li><p>ODS层：原始数据层，存放原始数据</p></li><li><p>DWD层：对ODS层数据进行清洗（去空、脏数据，转换类型等），维度退化，脱敏(保护隐私)</p></li><li><p>DWS层：以DWD为基础，按天进行汇总</p></li><li><p>DWT层：以DWS为基础，按主题进行汇总</p></li><li><p>ADS层：为各种数据分析报表提供数据<br><a name="blogTitle29"></a></p><h2 id="7-Sqoop同步数据"><a href="#7-Sqoop同步数据" class="headerlink" title="7 Sqoop同步数据"></a>7 Sqoop同步数据</h2><blockquote><p>Sqoop注意点：<br>Hive 中的 Null 在底层是以“\N”来存储，而 MySQL 中的 Null 在底层就是 Null，为了 保证数据两端的一致性。</p><ul><li>在导出数据时采用 –input-null-string 和 –input-null-non-string</li><li>导入数据时采用 –null-string 和 –null-non-string</li></ul></blockquote><p>本例思路为：sqoop抽取mysql数据上传至Hdfs上，存储为parquet文件，在建立hive-ods表，使用对应数据。</p><blockquote><p>使用DolphinScheduler调度执行脚本。</p></blockquote></li><li><p>Sqoop采集Mysql和Hive数据格式</p><table><thead><tr><th>mysql字段类型</th><th>hive:ods字段类型</th><th>hive:dwd-ads字段类型</th></tr></thead><tbody><tr><td>tinyint</td><td>tinyint</td><td>tinyint</td></tr><tr><td>int</td><td>int</td><td>int</td></tr><tr><td>bigint</td><td>bigint</td><td>bigint</td></tr><tr><td>varchar</td><td>string</td><td>string</td></tr><tr><td>datetime</td><td>bigint</td><td>string</td></tr><tr><td>bit</td><td>boolean</td><td>int</td></tr><tr><td>double</td><td>double</td><td>double</td></tr><tr><td>decimal</td><td>decimal</td><td>decimal</td></tr></tbody></table></li></ul><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445576-95ae80a2-e157-4ba2-ac2f-39c0057bfc4d.png#align=left&display=inline&height=820&margin=%5Bobject%20Object%5D&originHeight=820&originWidth=1920&size=0&status=done&style=none&width=1920" alt><br><a name="blogTitle30"></a></p><h2 id="8-ods层构建"><a href="#8-ods层构建" class="headerlink" title="8 ods层构建"></a>8 ods层构建</h2><p><a name="blogTitle31"></a></p><h3 id="8-1-ods建表"><a href="#8-1-ods建表" class="headerlink" title="8.1 ods建表"></a>8.1 ods建表</h3><blockquote><p>hive创建ods数据库，使用DolphinScheduler创建数据源，在创建DAG时需要选择hive库。<br>顺便将dwd，dws，dwt，ads一起创建了</p></blockquote><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445577-7f5949c5-01ad-4097-b19b-0ebe0cfd3546.png#align=left&display=inline&height=625&margin=%5Bobject%20Object%5D&originHeight=625&originWidth=847&size=0&status=done&style=none&width=847" alt><br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445447507-0aa01c2c-12fc-4d51-ba3e-a055609bcb47.png#align=left&display=inline&height=682&margin=%5Bobject%20Object%5D&originHeight=682&originWidth=1134&size=0&status=done&style=none&width=1134" alt><br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445580-441c434e-54a5-49d6-973a-ef7d97c1b4ac.png#align=left&display=inline&height=577&margin=%5Bobject%20Object%5D&originHeight=577&originWidth=1161&size=0&status=done&style=none&width=1161" alt><br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445560-1a8ada2f-b802-4db9-b161-788f80c89770.png#align=left&display=inline&height=683&margin=%5Bobject%20Object%5D&originHeight=683&originWidth=1168&size=0&status=done&style=none&width=1168" alt></p><ol><li><p>base_dic</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__base_dic</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__base_dic&#96;(</span><br><span class="line">  &#96;dic_code&#96; string COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;dic_name&#96; string COMMENT &#39;编码名称&#39;,</span><br><span class="line">  &#96;parent_code&#96;  string COMMENT &#39;父编号&#39;,</span><br><span class="line">  &#96;create_time&#96; bigint COMMENT &#39;创建日期&#39;,</span><br><span class="line">  &#96;operate_time&#96; bigint COMMENT &#39;修改日期&#39;</span><br><span class="line">  ) COMMENT &#39;编码字典表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;base_dic&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>base_trademark</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__base_trademark</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__base_trademark&#96;(</span><br><span class="line">  &#96;tm_id&#96; string COMMENT &#39;品牌id&#39;,</span><br><span class="line">  &#96;tm_name&#96; string COMMENT &#39;品牌名称&#39;</span><br><span class="line">  ) COMMENT &#39;品牌表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;base_trademark&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>base_category3</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__base_category3</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__base_category3&#96;(</span><br><span class="line">  &#96;id&#96; bigint COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;name&#96; string COMMENT &#39;三级分类名称&#39;,</span><br><span class="line">  &#96;category2_id&#96; bigint COMMENT &#39;二级分类编号&#39;</span><br><span class="line">  ) COMMENT &#39;三级分类表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;base_category3&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>base_category2</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__base_category2</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__base_category2&#96;(</span><br><span class="line">  &#96;id&#96; bigint COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;name&#96; string COMMENT &#39;二级分类名称&#39;,</span><br><span class="line">  &#96;category1_id&#96; bigint COMMENT &#39;一级分类编号&#39;</span><br><span class="line">  ) COMMENT &#39;二级分类表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;base_category2&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>base_category1</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__base_category1</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__base_category1&#96;(</span><br><span class="line">  &#96;id&#96; bigint COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;name&#96; string COMMENT &#39;分类名称&#39;</span><br><span class="line">  ) COMMENT &#39;一级分类表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;base_category1&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>activity_rule</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__activity_rule</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__activity_rule&#96;(</span><br><span class="line">  &#96;id&#96; int COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;activity_id&#96; int COMMENT &#39;类型&#39;,</span><br><span class="line">  &#96;condition_amount&#96; decimal(16,2) COMMENT &#39;满减金额&#39;,</span><br><span class="line">  &#96;condition_num&#96; bigint COMMENT &#39;满减件数&#39;,</span><br><span class="line">  &#96;benefit_amount&#96; decimal(16,2) COMMENT &#39;优惠金额&#39;,</span><br><span class="line">  &#96;benefit_discount&#96; bigint COMMENT &#39;优惠折扣&#39;,</span><br><span class="line">  &#96;benefit_level&#96; bigint COMMENT &#39;优惠级别&#39;</span><br><span class="line">  ) COMMENT &#39;优惠规则&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;activity_rule&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>activity_info</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__activity_info</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__activity_info&#96;(</span><br><span class="line">  &#96;id&#96; bigint COMMENT &#39;活动id&#39;,</span><br><span class="line">  &#96;activity_name&#96; string COMMENT &#39;活动名称&#39;,</span><br><span class="line">  &#96;activity_type&#96; string COMMENT &#39;活动类型&#39;,</span><br><span class="line">  &#96;start_time&#96; bigint COMMENT &#39;开始时间&#39;,</span><br><span class="line">  &#96;end_time&#96; bigint COMMENT &#39;结束时间&#39;,</span><br><span class="line">  &#96;create_time&#96; bigint COMMENT &#39;创建时间&#39;</span><br><span class="line">  ) COMMENT &#39;活动表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;activity_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>activity_sku</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__activity_sku</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__activity_sku&#96;(</span><br><span class="line">  &#96;id&#96; bigint COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;activity_id&#96; bigint COMMENT &#39;活动id&#39;,</span><br><span class="line">  &#96;sku_id&#96; bigint COMMENT &#39;sku_id&#39;,</span><br><span class="line">  &#96;create_time&#96; bigint COMMENT &#39;创建时间&#39;</span><br><span class="line">  ) COMMENT &#39;活动参与商品&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;activity_sku&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>cart_info</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__cart_info</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__cart_info&#96;(</span><br><span class="line">  &#96;id&#96; bigint COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;user_id&#96; bigint COMMENT &#39;用户id&#39;,</span><br><span class="line">  &#96;sku_id&#96; bigint COMMENT &#39;sku_id&#39;,</span><br><span class="line">  &#96;cart_price&#96; decimal(10,2) COMMENT &#39;放入购物车时价格&#39;,</span><br><span class="line">  &#96;sku_num&#96; bigint COMMENT &#39;数量&#39;,</span><br><span class="line">  &#96;sku_name&#96; string COMMENT &#39;sku名称&#39;,</span><br><span class="line">  &#96;create_time&#96; bigint COMMENT &#39;创建时间&#39;,</span><br><span class="line">  &#96;operate_time&#96; bigint COMMENT &#39;修改时间&#39;,</span><br><span class="line">  &#96;is_ordered&#96; bigint COMMENT &#39;是否已经下单&#39;,</span><br><span class="line">  &#96;order_time&#96; bigint COMMENT &#39;下单时间&#39;</span><br><span class="line">  ) COMMENT &#39;购物车表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;cart_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>favor_info</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__favor_info</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__favor_info&#96;(</span><br><span class="line">  &#96;id&#96; bigint COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;user_id&#96; bigint COMMENT &#39;用户id&#39;,</span><br><span class="line">  &#96;sku_id&#96; bigint COMMENT &#39;sku_id&#39;,</span><br><span class="line">  &#96;spu_id&#96; bigint COMMENT &#39;商品id&#39;,</span><br><span class="line">  &#96;is_cancel&#96; string COMMENT &#39;是否已取消 0 正常 1 已取消&#39;,</span><br><span class="line">  &#96;create_time&#96; bigint COMMENT &#39;创建时间&#39;,</span><br><span class="line">  &#96;cancel_time&#96; bigint COMMENT &#39;修改时间&#39;</span><br><span class="line">  ) COMMENT &#39;商品收藏表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;favor_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>coupon_info</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__coupon_info</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__coupon_info&#96;(</span><br><span class="line">  &#96;id&#96; bigint COMMENT &#39;购物券编号&#39;,</span><br><span class="line">  &#96;coupon_name&#96; string COMMENT &#39;购物券名称&#39;,</span><br><span class="line">  &#96;coupon_type&#96; string COMMENT &#39;购物券类型 1 现金券 2 折扣券 3 满减券 4 满件打折券&#39;,</span><br><span class="line">  &#96;condition_amount&#96; decimal(10,2) COMMENT &#39;满额数&#39;,</span><br><span class="line">  &#96;condition_num&#96; bigint COMMENT &#39;满件数&#39;,</span><br><span class="line">  &#96;activity_id&#96; bigint COMMENT &#39;活动编号&#39;,</span><br><span class="line">  &#96;benefit_amount&#96; decimal(16,2) COMMENT &#39;减金额&#39;,</span><br><span class="line">  &#96;benefit_discount&#96; bigint COMMENT &#39;折扣&#39;,</span><br><span class="line">  &#96;create_time&#96; bigint COMMENT &#39;创建时间&#39;,</span><br><span class="line">  &#96;range_type&#96; string COMMENT &#39;范围类型 1、商品 2、品类 3、品牌&#39;,</span><br><span class="line">  &#96;spu_id&#96; bigint COMMENT &#39;商品id&#39;,</span><br><span class="line">  &#96;tm_id&#96; bigint COMMENT &#39;品牌id&#39;,</span><br><span class="line">  &#96;category3_id&#96; bigint COMMENT &#39;品类id&#39;,</span><br><span class="line">  &#96;limit_num&#96; int COMMENT &#39;最多领用次数&#39;,</span><br><span class="line">  &#96;operate_time&#96; bigint COMMENT &#39;修改时间&#39;,</span><br><span class="line">  &#96;expire_time&#96; bigint COMMENT &#39;过期时间&#39;</span><br><span class="line">  ) COMMENT &#39;优惠券表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;coupon_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>sku_info</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__sku_info</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__sku_info&#96;(</span><br><span class="line">  &#96;id&#96; bigint COMMENT &#39;skuid&#39;,</span><br><span class="line">  &#96;spu_id&#96; bigint COMMENT &#39;spuid&#39;,</span><br><span class="line">  &#96;price&#96; decimal(10,0) COMMENT &#39;价格&#39;,</span><br><span class="line">  &#96;sku_name&#96; string COMMENT &#39;sku名称&#39;,</span><br><span class="line">  &#96;sku_desc&#96; string COMMENT &#39;商品规格描述&#39;,</span><br><span class="line">  &#96;weight&#96; decimal(10,2) COMMENT &#39;重量&#39;,</span><br><span class="line">  &#96;tm_id&#96; bigint COMMENT &#39;品牌&#39;,</span><br><span class="line">  &#96;category3_id&#96; bigint COMMENT &#39;三级分类id&#39;,</span><br><span class="line">  &#96;create_time&#96; bigint COMMENT &#39;创建时间&#39;</span><br><span class="line">  ) COMMENT &#39;库存单元表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;sku_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>spu_info</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__spu_info</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__spu_info&#96;(</span><br><span class="line">  &#96;id&#96; bigint COMMENT &#39;商品id&#39;,</span><br><span class="line">  &#96;spu_name&#96; string COMMENT &#39;商品名称&#39;,</span><br><span class="line">  &#96;category3_id&#96; bigint COMMENT &#39;三级分类id&#39;,</span><br><span class="line">  &#96;tm_id&#96; bigint COMMENT &#39;品牌id&#39;</span><br><span class="line">  ) COMMENT &#39;商品表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;spu_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>base_province</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__base_province</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__base_province&#96;(</span><br><span class="line">  &#96;id&#96; bigint COMMENT &#39;id&#39;,</span><br><span class="line">  &#96;name&#96; string COMMENT &#39;省名称&#39;,</span><br><span class="line">  &#96;region_id&#96; string COMMENT &#39;大区id&#39;,</span><br><span class="line">  &#96;area_code&#96; string COMMENT &#39;行政区位码&#39;,</span><br><span class="line">  &#96;iso_code&#96; string COMMENT &#39;国际编码&#39;</span><br><span class="line">  ) COMMENT &#39;省份表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;base_province&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>base_region</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__base_region</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__base_region&#96;(</span><br><span class="line">  &#96;id&#96; string COMMENT &#39;大区id&#39;,</span><br><span class="line">  &#96;region_name&#96; string COMMENT &#39;大区名称&#39;</span><br><span class="line">  ) COMMENT &#39;地区表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;base_region&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>refund_info</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__order_refund_info</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__order_refund_info&#96;(</span><br><span class="line">  &#96;id&#96; bigint COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;user_id&#96; bigint COMMENT &#39;用户id&#39;,</span><br><span class="line">  &#96;order_id&#96; bigint COMMENT &#39;订单编号&#39;,</span><br><span class="line">  &#96;sku_id&#96; bigint COMMENT &#39;skuid&#39;,</span><br><span class="line">  &#96;refund_type&#96; string COMMENT &#39;退款类型&#39;,</span><br><span class="line">  &#96;refund_num&#96; bigint COMMENT &#39;退货件数&#39;,</span><br><span class="line">  &#96;refund_amount&#96; decimal(16,2) COMMENT &#39;退款金额&#39;,</span><br><span class="line">  &#96;refund_reason_type&#96; string COMMENT &#39;原因类型&#39;,</span><br><span class="line">  &#96;create_time&#96; bigint COMMENT &#39;创建时间&#39;</span><br><span class="line">  ) COMMENT &#39;退单表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;order_refund_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>order_status_log</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__order_status_log</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__order_status_log&#96;(</span><br><span class="line">  &#96;id&#96; bigint COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;order_id&#96; bigint COMMENT &#39;订单编号&#39;,</span><br><span class="line">  &#96;order_status&#96; string COMMENT &#39;订单状态&#39;,</span><br><span class="line">  &#96;operate_time&#96; bigint COMMENT &#39;操作时间&#39;</span><br><span class="line">  ) COMMENT &#39;订单状态表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;order_status_log&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>payment_info</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__payment_info</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__payment_info&#96;(</span><br><span class="line">  &#96;id&#96; bigint COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;out_trade_no&#96; string COMMENT &#39;对外业务编号&#39;,</span><br><span class="line">  &#96;order_id&#96; bigint COMMENT &#39;订单编号&#39;,</span><br><span class="line">  &#96;user_id&#96; bigint COMMENT &#39;用户编号&#39;,</span><br><span class="line">  &#96;alipay_trade_no&#96; string COMMENT &#39;支付宝交易流水编号&#39;,</span><br><span class="line">  &#96;total_amount&#96; decimal(16,2) COMMENT &#39;支付金额&#39;,</span><br><span class="line">  &#96;subject&#96; string COMMENT &#39;交易内容&#39;,</span><br><span class="line">  &#96;payment_type&#96; string COMMENT &#39;支付方式&#39;,</span><br><span class="line">  &#96;payment_time&#96; bigint COMMENT &#39;支付时间&#39;</span><br><span class="line">  ) COMMENT &#39;支付流水表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;payment_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>order_detail</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__order_detail</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__order_detail&#96;(</span><br><span class="line">  &#96;id&#96; bigint COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;order_id&#96; bigint COMMENT &#39;订单编号&#39;,</span><br><span class="line">  &#96;user_id&#96; bigint COMMENT &#39;用户id&#39;,</span><br><span class="line">  &#96;sku_id&#96; bigint COMMENT &#39;sku_id&#39;,</span><br><span class="line">  &#96;sku_name&#96; string COMMENT &#39;sku名称&#39;,</span><br><span class="line">  &#96;order_price&#96; decimal(10,2) COMMENT &#39;购买价格(下单时sku价格）&#39;,</span><br><span class="line">  &#96;sku_num&#96; string COMMENT &#39;购买个数&#39;,</span><br><span class="line">  &#96;create_time&#96; bigint COMMENT &#39;创建时间&#39;</span><br><span class="line">  ) COMMENT &#39;订单明细表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;order_detail&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>activity_order</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__activity_order</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__activity_order&#96;(</span><br><span class="line">  &#96;id&#96; bigint COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;activity_id&#96; bigint COMMENT &#39;活动id&#39;,</span><br><span class="line">  &#96;order_id&#96; bigint COMMENT &#39;订单编号&#39;,</span><br><span class="line">  &#96;create_time&#96; bigint COMMENT &#39;发生日期&#39;</span><br><span class="line">  ) COMMENT &#39;活动与订单关联表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;activity_order&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>comment_info</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__comment_info</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__comment_info&#96;(</span><br><span class="line">  &#96;id&#96; bigint COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;user_id&#96; bigint COMMENT &#39;用户名称&#39;,</span><br><span class="line">  &#96;sku_id&#96; bigint COMMENT &#39;skuid&#39;,</span><br><span class="line">  &#96;spu_id&#96; bigint COMMENT &#39;商品id&#39;,</span><br><span class="line">  &#96;order_id&#96; bigint COMMENT &#39;订单编号&#39;,</span><br><span class="line">  &#96;appraise&#96; string COMMENT &#39;评价 1 好评 2 中评 3 差评&#39;,</span><br><span class="line">  &#96;comment_txt&#96; string COMMENT &#39;评价内容&#39;,</span><br><span class="line">  &#96;create_time&#96; bigint COMMENT &#39;创建时间&#39;</span><br><span class="line">  ) COMMENT &#39;商品评论表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;comment_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>coupon_use</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__coupon_use</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__coupon_use&#96;(</span><br><span class="line">  &#96;id&#96; bigint COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;coupon_id&#96; bigint COMMENT &#39;购物券ID&#39;,</span><br><span class="line">  &#96;user_id&#96; bigint COMMENT &#39;用户ID&#39;,</span><br><span class="line">  &#96;order_id&#96; bigint COMMENT &#39;订单ID&#39;,</span><br><span class="line">  &#96;coupon_status&#96; string COMMENT &#39;购物券状态&#39;,</span><br><span class="line">  &#96;get_time&#96; bigint COMMENT &#39;领券时间&#39;,</span><br><span class="line">  &#96;using_time&#96; bigint COMMENT &#39;使用时间&#39;,</span><br><span class="line">  &#96;used_time&#96; bigint COMMENT &#39;过期时间&#39;</span><br><span class="line">  ) COMMENT &#39;优惠券领用表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;coupon_use&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>user_info</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__user_info</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__user_info&#96;(</span><br><span class="line">  &#96;id&#96; bigint COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;name&#96; string COMMENT &#39;用户姓名&#39;,</span><br><span class="line">  &#96;email&#96; string COMMENT &#39;邮箱&#39;,</span><br><span class="line">  &#96;user_level&#96; string COMMENT &#39;用户级别&#39;,</span><br><span class="line">  &#96;birthday&#96; bigint COMMENT &#39;用户生日&#39;,</span><br><span class="line">  &#96;gender&#96; string COMMENT &#39;性别 M男,F女&#39;,</span><br><span class="line">  &#96;create_time&#96; bigint COMMENT &#39;创建时间&#39;,</span><br><span class="line">  &#96;operate_time&#96; bigint COMMENT &#39;修改时间&#39;</span><br><span class="line">  ) COMMENT &#39;用户表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;user_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>order_info</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__order_info</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__order_info&#96;(</span><br><span class="line">  &#96;id&#96; bigint COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;final_total_amount&#96; decimal(16,2) COMMENT &#39;总金额&#39;,</span><br><span class="line">  &#96;order_status&#96; string COMMENT &#39;订单状态&#39;,</span><br><span class="line">  &#96;user_id&#96; bigint COMMENT &#39;用户id&#39;,</span><br><span class="line">  &#96;out_trade_no&#96; string COMMENT &#39;订单交易编号（第三方支付用)&#39;,</span><br><span class="line">  &#96;create_time&#96; bigint COMMENT &#39;创建时间&#39;,</span><br><span class="line">  &#96;operate_time&#96; bigint COMMENT &#39;操作时间&#39;,</span><br><span class="line">  &#96;province_id&#96; int COMMENT &#39;地区&#39;,</span><br><span class="line">  &#96;benefit_reduce_amount&#96; decimal(16,2) COMMENT &#39;优惠金额&#39;,</span><br><span class="line">  &#96;original_total_amount&#96; decimal(16,2) COMMENT &#39;原价金额&#39;,</span><br><span class="line">  &#96;feight_fee&#96; decimal(16,2) COMMENT &#39;运费&#39;</span><br><span class="line">  ) COMMENT &#39;订单表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;order_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>start_log</p><blockquote><p>此为埋点启动日志表</p></blockquote></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__start_log</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__start_log&#96;(</span><br><span class="line">  &#96;line&#96; string COMMENT &#39;启动日志&#39;</span><br><span class="line">  ) COMMENT &#39;启动日志表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;start_log&#x2F;&#39;</span><br></pre></td></tr></table></figure><ol start="26"><li>event_log<blockquote><p>此为埋点事件日志表</p></blockquote></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__event_log</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__event_log&#96;(</span><br><span class="line">  &#96;line&#96; string COMMENT &#39;事件日志&#39;</span><br><span class="line">  ) COMMENT &#39;事件日志表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;event_log&#x2F;&#39;</span><br></pre></td></tr></table></figure><ol start="27"><li>date_info<blockquote><p>此为时间表</p></blockquote></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ods.mall__date_info</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ods.mall__date_info&#96;(</span><br><span class="line">&#96;date_id&#96; int COMMENT &#39;日&#39;,</span><br><span class="line">&#96;week_id&#96; int COMMENT &#39;周&#39;,</span><br><span class="line">&#96;week_day&#96; int COMMENT &#39;周的第几天&#39;,</span><br><span class="line">&#96;day&#96; int COMMENT &#39;每月的第几天&#39;,</span><br><span class="line">&#96;month&#96; int COMMENT &#39;第几月&#39;,</span><br><span class="line">&#96;quarter&#96; int COMMENT &#39;第几季度&#39;,</span><br><span class="line">&#96;year&#96; int COMMENT &#39;年&#39;,</span><br><span class="line">&#96;is_workday&#96; int COMMENT &#39;是否是周末&#39;,</span><br><span class="line">&#96;holiday_id&#96; int COMMENT &#39;是否是节假日&#39;</span><br><span class="line">  ) COMMENT &#39;时间维度表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ods&#x2F;mall&#x2F;date_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure><p><a name="blogTitle32"></a></p><h3 id="8-2-mysql数据抽取"><a href="#8-2-mysql数据抽取" class="headerlink" title="8.2 mysql数据抽取"></a>8.2 mysql数据抽取</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445550-cccdcf34-74d8-42ae-ba5e-2c3769ca3c9e.png#align=left&display=inline&height=77&margin=%5Bobject%20Object%5D&originHeight=77&originWidth=1255&size=0&status=done&style=none&width=1255" alt></p><ul><li><p>sqoop抽取脚本基础</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">mysql_db_name&#x3D;$&#123;db_name&#125;</span><br><span class="line">mysql_db_addr&#x3D;$&#123;db_addr&#125;</span><br><span class="line">mysql_db_user&#x3D;$&#123;db_user&#125;</span><br><span class="line">mysql_db_password&#x3D;$&#123;db_password&#125;</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">echo &quot;日期:&quot;$db_date</span><br><span class="line">echo &quot;mysql库名:&quot;$mysql_db_name</span><br><span class="line">import_data() &#123;</span><br><span class="line">&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;sqoop import \</span><br><span class="line">--connect jdbc:mysql:&#x2F;&#x2F;$mysql_db_addr:3306&#x2F;$mysql_db_name?tinyInt1isBit&#x3D;false \</span><br><span class="line">--username $mysql_db_user \</span><br><span class="line">--password $mysql_db_password \</span><br><span class="line">--target-dir &#x2F;origin_data&#x2F;$mysql_db_name&#x2F;$1&#x2F;$db_date \</span><br><span class="line">--delete-target-dir \</span><br><span class="line">--num-mappers 1 \</span><br><span class="line">--null-string &#39;&#39; \</span><br><span class="line">--null-non-string &#39;\\n&#39; \</span><br><span class="line">--fields-terminated-by &quot;\t&quot; \</span><br><span class="line">--query &quot;$2&quot;&#39; and $CONDITIONS;&#39; \</span><br><span class="line">--as-parquetfile </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>DolphinScheduler全局参数</p></li></ul><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445578-aeef9cf0-c4cf-4a5a-91ea-02ec01c0bf61.png#align=left&display=inline&height=622&margin=%5Bobject%20Object%5D&originHeight=622&originWidth=981&size=0&status=done&style=none&width=981" alt></p><table><thead><tr><th>date</th><th>不传为昨天</th></tr></thead><tbody><tr><td>db_name</td><td>数据库名字</td></tr><tr><td>db_addr</td><td>数据库IP地址</td></tr><tr><td>db_user</td><td>数据库用户</td></tr><tr><td>db_password</td><td>数据库密码</td></tr></tbody></table><blockquote><p>元数据中数据开始日期为2020-03-15<br>如下导入数据代码片段，拼接上述的基础片段执行</p></blockquote><ul><li><p>全量表代码片段</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">import_data &quot;base_dic&quot; &quot;select</span><br><span class="line">dic_code,</span><br><span class="line">dic_name,</span><br><span class="line">parent_code,</span><br><span class="line">create_time,</span><br><span class="line">operate_time</span><br><span class="line">from base_dic</span><br><span class="line">where 1&#x3D;1&quot;</span><br><span class="line">import_data &quot;base_trademark&quot; &quot;select</span><br><span class="line">tm_id,</span><br><span class="line">tm_name</span><br><span class="line">from base_trademark</span><br><span class="line">where 1&#x3D;1&quot;</span><br><span class="line">import_data &quot;base_category3&quot; &quot;select</span><br><span class="line">id,</span><br><span class="line">name,</span><br><span class="line">category2_id</span><br><span class="line">from base_category3 where 1&#x3D;1&quot;</span><br><span class="line">import_data &quot;base_category2&quot; &quot;select</span><br><span class="line">id,</span><br><span class="line">name,</span><br><span class="line">category1_id</span><br><span class="line">from base_category2 where 1&#x3D;1&quot;</span><br><span class="line">import_data &quot;base_category1&quot; &quot;select</span><br><span class="line">id,</span><br><span class="line">name</span><br><span class="line">from base_category1 where 1&#x3D;1&quot;</span><br><span class="line">import_data &quot;activity_rule&quot; &quot;select</span><br><span class="line">id,</span><br><span class="line">activity_id,</span><br><span class="line">condition_amount,</span><br><span class="line">condition_num,</span><br><span class="line">benefit_amount,</span><br><span class="line">benefit_discount,</span><br><span class="line">benefit_level</span><br><span class="line">from activity_rule</span><br><span class="line">where 1&#x3D;1&quot;</span><br><span class="line">import_data &quot;activity_info&quot; &quot;select</span><br><span class="line">id,</span><br><span class="line">activity_name,</span><br><span class="line">activity_type,</span><br><span class="line">start_time,</span><br><span class="line">end_time,</span><br><span class="line">create_time</span><br><span class="line">from activity_info</span><br><span class="line">where 1&#x3D;1&quot;</span><br><span class="line">import_data &quot;activity_sku&quot; &quot;select</span><br><span class="line">id,</span><br><span class="line">activity_id,</span><br><span class="line">sku_id,</span><br><span class="line">create_time</span><br><span class="line">FROM</span><br><span class="line">activity_sku</span><br><span class="line">where 1&#x3D;1&quot;</span><br><span class="line">import_data &quot;cart_info&quot; &quot;select</span><br><span class="line">id,</span><br><span class="line">user_id,</span><br><span class="line">sku_id,</span><br><span class="line">cart_price,</span><br><span class="line">sku_num,</span><br><span class="line">sku_name,</span><br><span class="line">create_time,</span><br><span class="line">operate_time,</span><br><span class="line">is_ordered,</span><br><span class="line">order_time</span><br><span class="line">from cart_info</span><br><span class="line">where 1&#x3D;1&quot;</span><br><span class="line">import_data &quot;favor_info&quot; &quot;select</span><br><span class="line">id,</span><br><span class="line">user_id,</span><br><span class="line">sku_id,</span><br><span class="line">spu_id,</span><br><span class="line">is_cancel,</span><br><span class="line">create_time,</span><br><span class="line">cancel_time</span><br><span class="line">from favor_info</span><br><span class="line">where 1&#x3D;1&quot;</span><br><span class="line">import_data &quot;coupon_info&quot; &quot;select</span><br><span class="line">id,</span><br><span class="line">coupon_name,</span><br><span class="line">coupon_type,</span><br><span class="line">condition_amount,</span><br><span class="line">condition_num,</span><br><span class="line">activity_id,</span><br><span class="line">benefit_amount,</span><br><span class="line">benefit_discount,</span><br><span class="line">create_time,</span><br><span class="line">range_type,</span><br><span class="line">spu_id,</span><br><span class="line">tm_id,</span><br><span class="line">category3_id,</span><br><span class="line">limit_num,</span><br><span class="line">operate_time,</span><br><span class="line">expire_time</span><br><span class="line">from coupon_info</span><br><span class="line">where 1&#x3D;1&quot;</span><br><span class="line">import_data &quot;sku_info&quot; &quot;select</span><br><span class="line">id,</span><br><span class="line">spu_id,</span><br><span class="line">price,</span><br><span class="line">sku_name,</span><br><span class="line">sku_desc,</span><br><span class="line">weight,</span><br><span class="line">tm_id,</span><br><span class="line">category3_id,</span><br><span class="line">create_time</span><br><span class="line">from sku_info where 1&#x3D;1&quot;</span><br><span class="line">import_data &quot;spu_info&quot; &quot;select</span><br><span class="line">id,</span><br><span class="line">spu_name,</span><br><span class="line">category3_id,</span><br><span class="line">tm_id</span><br><span class="line">from spu_info</span><br><span class="line">where 1&#x3D;1&quot;</span><br></pre></td></tr></table></figure></li><li><p>特殊表代码片段</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import_data &quot;base_province&quot; &quot;select</span><br><span class="line">id,</span><br><span class="line">name,</span><br><span class="line">region_id,</span><br><span class="line">area_code,</span><br><span class="line">iso_code</span><br><span class="line">from base_province</span><br><span class="line">where 1&#x3D;1&quot;</span><br><span class="line">import_data &quot;base_region&quot; &quot;select</span><br><span class="line">id,</span><br><span class="line">region_name</span><br><span class="line">from base_region</span><br><span class="line">where 1&#x3D;1&quot;</span><br><span class="line">import_data &quot;date_info&quot; &quot;select</span><br><span class="line">date_id,</span><br><span class="line">week_id,</span><br><span class="line">week_day,</span><br><span class="line">day,</span><br><span class="line">month,</span><br><span class="line">quarter,</span><br><span class="line">year,</span><br><span class="line">is_workday,</span><br><span class="line">holiday_id</span><br><span class="line">from date_info</span><br><span class="line">where 1&#x3D;1&quot;</span><br></pre></td></tr></table></figure></li><li><p>增量表代码片段</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">import_data &quot;order_refund_info&quot; &quot;select</span><br><span class="line">id,</span><br><span class="line">user_id,</span><br><span class="line">order_id,</span><br><span class="line">sku_id,</span><br><span class="line">refund_type,</span><br><span class="line">refund_num,</span><br><span class="line">refund_amount,</span><br><span class="line">refund_reason_type,</span><br><span class="line">create_time</span><br><span class="line">from order_refund_info</span><br><span class="line">where</span><br><span class="line">date_format(create_time,&#39;%Y-%m-%d&#39;)&#x3D;&#39;$db_date&#39;&quot;</span><br><span class="line">import_data &quot;order_status_log&quot; &quot;select</span><br><span class="line">id,</span><br><span class="line">order_id,</span><br><span class="line">order_status,</span><br><span class="line">operate_time</span><br><span class="line">from order_status_log</span><br><span class="line">where</span><br><span class="line">date_format(operate_time,&#39;%Y-%m-%d&#39;)&#x3D;&#39;$db_date&#39;&quot;</span><br><span class="line">import_data &quot;payment_info&quot; &quot;select</span><br><span class="line">id,</span><br><span class="line">out_trade_no,</span><br><span class="line">order_id,</span><br><span class="line">user_id,</span><br><span class="line">alipay_trade_no,</span><br><span class="line">total_amount,</span><br><span class="line">subject,</span><br><span class="line">payment_type,</span><br><span class="line">payment_time</span><br><span class="line">from payment_info</span><br><span class="line">where</span><br><span class="line">DATE_FORMAT(payment_time,&#39;%Y-%m-%d&#39;)&#x3D;&#39;$db_date&#39;&quot;</span><br><span class="line">import_data &quot;order_detail&quot; &quot;select</span><br><span class="line">od.id,</span><br><span class="line">od.order_id,</span><br><span class="line">oi.user_id,</span><br><span class="line">od.sku_id,</span><br><span class="line">od.sku_name,</span><br><span class="line">od.order_price,</span><br><span class="line">od.sku_num,</span><br><span class="line">od.create_time</span><br><span class="line">from order_detail od</span><br><span class="line">join order_info oi</span><br><span class="line">on od.order_id&#x3D;oi.id</span><br><span class="line">where</span><br><span class="line">DATE_FORMAT(od.create_time,&#39;%Y-%m-%d&#39;)&#x3D;&#39;$db_date&#39;&quot;</span><br><span class="line">import_data &quot;activity_order&quot; &quot;select</span><br><span class="line">id,</span><br><span class="line">activity_id,</span><br><span class="line">order_id,</span><br><span class="line">create_time</span><br><span class="line">from activity_order</span><br><span class="line">where</span><br><span class="line">date_format(create_time,&#39;%Y-%m-%d&#39;)&#x3D;&#39;$db_date&#39;&quot;</span><br><span class="line">import_data &quot;comment_info&quot; &quot;select</span><br><span class="line">id,</span><br><span class="line">user_id,</span><br><span class="line">sku_id,</span><br><span class="line">spu_id,</span><br><span class="line">order_id,</span><br><span class="line">appraise,</span><br><span class="line">comment_txt,</span><br><span class="line">create_time</span><br><span class="line">from comment_info</span><br><span class="line">where date_format(create_time,&#39;%Y-%m-%d&#39;)&#x3D;&#39;$db_date&#39;&quot;</span><br></pre></td></tr></table></figure></li><li><p>增量及变化表代码片段</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">import_data &quot;coupon_use&quot; &quot;select</span><br><span class="line">id,</span><br><span class="line">coupon_id,</span><br><span class="line">user_id,</span><br><span class="line">order_id,</span><br><span class="line">coupon_status,</span><br><span class="line">get_time,</span><br><span class="line">using_time,</span><br><span class="line">used_time</span><br><span class="line">from coupon_use</span><br><span class="line">where (date_format(get_time,&#39;%Y-%m-%d&#39;)&#x3D;&#39;$db_date&#39;</span><br><span class="line">or date_format(using_time,&#39;%Y-%m-%d&#39;)&#x3D;&#39;$db_date&#39;</span><br><span class="line">or date_format(used_time,&#39;%Y-%m-%d&#39;)&#x3D;&#39;$db_date&#39;)&quot;</span><br><span class="line">import_data &quot;user_info&quot; &quot;select</span><br><span class="line">id,</span><br><span class="line">name,</span><br><span class="line">birthday,</span><br><span class="line">gender,</span><br><span class="line">email,</span><br><span class="line">user_level,</span><br><span class="line">create_time,</span><br><span class="line">operate_time</span><br><span class="line">from user_info</span><br><span class="line">where (DATE_FORMAT(create_time,&#39;%Y-%m-%d&#39;)&#x3D;&#39;$db_date&#39;</span><br><span class="line">or DATE_FORMAT(operate_time,&#39;%Y-%m-%d&#39;)&#x3D;&#39;$db_date&#39;)&quot;</span><br><span class="line">import_data &quot;order_info&quot; &quot;select</span><br><span class="line">id,</span><br><span class="line">final_total_amount,</span><br><span class="line">order_status,</span><br><span class="line">user_id,</span><br><span class="line">out_trade_no,</span><br><span class="line">create_time,</span><br><span class="line">operate_time,</span><br><span class="line">province_id,</span><br><span class="line">benefit_reduce_amount,</span><br><span class="line">original_total_amount,</span><br><span class="line">feight_fee</span><br><span class="line">from order_info</span><br><span class="line">where (date_format(create_time,&#39;%Y-%m-%d&#39;)&#x3D;&#39;$db_date&#39;</span><br><span class="line">or date_format(operate_time,&#39;%Y-%m-%d&#39;)&#x3D;&#39;$db_date&#39;)&quot;</span><br></pre></td></tr></table></figure><p><a name="blogTitle33"></a></p><h3 id="8-3-ods层数据加载"><a href="#8-3-ods层数据加载" class="headerlink" title="8.3 ods层数据加载"></a>8.3 ods层数据加载</h3></li><li><p>脚本修改$table_name即可</p><blockquote><p>注意2张埋点日志表的数据导出目录</p></blockquote></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;ods</span><br><span class="line">table_name&#x3D;base_dic</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">load data inpath &#39;&#x2F;origin_data&#x2F;$APP1&#x2F;$table_name&#x2F;$db_date&#39; OVERWRITE into table $hive_table_name partition(dt&#x3D;&#39;$db_date&#39;);</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="blogTitle34"></a></p><h2 id="9-dwd层构建"><a href="#9-dwd层构建" class="headerlink" title="9 dwd层构建"></a>9 dwd层构建</h2><p><a name="blogTitle35"></a></p><h3 id="9-1-dwd层构建（启动-事件日志）"><a href="#9-1-dwd层构建（启动-事件日志）" class="headerlink" title="9.1 dwd层构建（启动-事件日志）"></a>9.1 dwd层构建（启动-事件日志）</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445446614-4652a8e0-0b0a-4e2a-910b-e90751aed058.png#align=left&display=inline&height=446&margin=%5Bobject%20Object%5D&originHeight=446&originWidth=951&size=0&status=done&style=none&width=951" alt><br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445749-02840e2e-dcb1-4a8a-8778-e6ee6b650936.png#align=left&display=inline&height=614&margin=%5Bobject%20Object%5D&originHeight=614&originWidth=1477&size=0&status=done&style=none&width=1477" alt><br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445567-5b7c6d42-4d24-4807-afb3-cdea023f4f90.png#align=left&display=inline&height=477&margin=%5Bobject%20Object%5D&originHeight=477&originWidth=951&size=0&status=done&style=none&width=951" alt><br><a name="65a81e92"></a></p><h4 id="9-1-1-启动日志表"><a href="#9-1-1-启动日志表" class="headerlink" title="9.1.1 启动日志表"></a>9.1.1 启动日志表</h4><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445612-d6f7562c-f0bb-430f-b4af-7b42344e971f.png#align=left&display=inline&height=730&margin=%5Bobject%20Object%5D&originHeight=730&originWidth=1437&size=0&status=done&style=none&width=1437" alt></p><ul><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__start_log</span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__start_log&#96;(</span><br><span class="line">  &#96;mid_id&#96; string COMMENT &#39;设备唯一标识&#39;,</span><br><span class="line">  &#96;user_id&#96; string COMMENT &#39;用户标识&#39;,</span><br><span class="line">  &#96;version_code&#96; string COMMENT &#39;程序版本号&#39;,</span><br><span class="line">  &#96;version_name&#96; string COMMENT &#39;程序版本名&#39;,</span><br><span class="line">  &#96;lang&#96; string COMMENT &#39;系统语言&#39;,</span><br><span class="line">  &#96;source&#96; string COMMENT &#39;渠道号&#39;,</span><br><span class="line">  &#96;os&#96; string COMMENT &#39;系统版本&#39;,</span><br><span class="line">  &#96;area&#96; string COMMENT &#39;区域&#39;,</span><br><span class="line">  &#96;model&#96; string COMMENT &#39;手机型号&#39;,</span><br><span class="line">  &#96;brand&#96; string COMMENT &#39;手机品牌&#39;,</span><br><span class="line">  &#96;sdk_version&#96; string COMMENT &#39;sdkVersion&#39;,</span><br><span class="line">  &#96;gmail&#96; string COMMENT &#39;gmail&#39;,</span><br><span class="line">  &#96;height_width&#96; string COMMENT &#39;屏幕宽高&#39;,</span><br><span class="line">  &#96;app_time&#96; string COMMENT &#39;客户端日志产生时的时间&#39;,</span><br><span class="line">  &#96;network&#96; string COMMENT &#39;网络模式&#39;,</span><br><span class="line">  &#96;lng&#96; string COMMENT &#39;经度&#39;,</span><br><span class="line">  &#96;lat&#96; string COMMENT &#39;纬度&#39;,</span><br><span class="line">  &#96;entry&#96; string COMMENT &#39;入口: push&#x3D;1,widget&#x3D;2,icon&#x3D;3,notification&#x3D;4,lockscreen_widget&#x3D;5&#39;,</span><br><span class="line">  &#96;open_ad_type&#96; string COMMENT &#39;开屏广告类型: 开屏原生广告&#x3D;1, 开屏插屏广告&#x3D;2&#39;,</span><br><span class="line">  &#96;action&#96; string COMMENT &#39;状态：成功&#x3D;1 失败&#x3D;2&#39;,</span><br><span class="line">  &#96;loading_time&#96; string COMMENT &#39;加载时长&#39;,</span><br><span class="line">  &#96;detail&#96; string COMMENT &#39;失败码&#39;,</span><br><span class="line">  &#96;extend1&#96; string COMMENT &#39;失败的 message&#39;</span><br><span class="line">  ) COMMENT &#39;启动日志表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;start_log&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">APP3&#x3D;ods</span><br><span class="line">table_name&#x3D;start_log</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line">hive_origin_table_name&#x3D;$APP3.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	get_json_object(line,&#39;$.mid&#39;) mid_id,</span><br><span class="line">	get_json_object(line,&#39;$.uid&#39;) user_id,</span><br><span class="line">	get_json_object(line,&#39;$.vc&#39;) version_code,</span><br><span class="line">	get_json_object(line,&#39;$.vn&#39;) version_name,</span><br><span class="line">	get_json_object(line,&#39;$.l&#39;) lang,</span><br><span class="line">	get_json_object(line,&#39;$.sr&#39;) source,</span><br><span class="line">	get_json_object(line,&#39;$.os&#39;) os,</span><br><span class="line">	get_json_object(line,&#39;$.ar&#39;) area,</span><br><span class="line">	get_json_object(line,&#39;$.md&#39;) model,</span><br><span class="line">	get_json_object(line,&#39;$.ba&#39;) brand,</span><br><span class="line">	get_json_object(line,&#39;$.sv&#39;) sdk_version,</span><br><span class="line">	get_json_object(line,&#39;$.g&#39;) gmail,</span><br><span class="line">	get_json_object(line,&#39;$.hw&#39;) height_width,</span><br><span class="line">	get_json_object(line,&#39;$.t&#39;) app_time,</span><br><span class="line">	get_json_object(line,&#39;$.nw&#39;) network,</span><br><span class="line">	get_json_object(line,&#39;$.ln&#39;) lng,</span><br><span class="line">	get_json_object(line,&#39;$.la&#39;) lat,</span><br><span class="line">	get_json_object(line,&#39;$.entry&#39;) entry,</span><br><span class="line">	get_json_object(line,&#39;$.open_ad_type&#39;) open_ad_type,</span><br><span class="line">	get_json_object(line,&#39;$.action&#39;) action,</span><br><span class="line">	get_json_object(line,&#39;$.loading_time&#39;) loading_time,</span><br><span class="line">	get_json_object(line,&#39;$.detail&#39;) detail,</span><br><span class="line">	get_json_object(line,&#39;$.extend1&#39;) extend1</span><br><span class="line">from $hive_origin_table_name</span><br><span class="line">where dt&#x3D;&#39;$db_date&#39;;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="396f2a2b"></a></p><h4 id="9-1-2-事件日志表"><a href="#9-1-2-事件日志表" class="headerlink" title="9.1.2 事件日志表"></a>9.1.2 事件日志表</h4><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445586-766cb2b8-d761-4c9a-a289-16f60a99ddcd.png#align=left&display=inline&height=477&margin=%5Bobject%20Object%5D&originHeight=477&originWidth=951&size=0&status=done&style=none&width=951" alt><br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445702-d1a78ffa-edf3-4d58-a3bb-dab7ac195815.png#align=left&display=inline&height=604&margin=%5Bobject%20Object%5D&originHeight=604&originWidth=1333&size=0&status=done&style=none&width=1333" alt><br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445677-bc019011-2053-412d-b4c8-bfd856f29547.png#align=left&display=inline&height=603&margin=%5Bobject%20Object%5D&originHeight=603&originWidth=1333&size=0&status=done&style=none&width=1333" alt><br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445698-37476ac6-25f3-4cea-86ac-f907a3cb1d1d.png#align=left&display=inline&height=621&margin=%5Bobject%20Object%5D&originHeight=621&originWidth=1376&size=0&status=done&style=none&width=1376" alt><br></p></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__event_log</span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__event_log&#96;(</span><br><span class="line">  &#96;mid_id&#96; string COMMENT &#39;设备唯一标识&#39;,</span><br><span class="line">  &#96;user_id&#96; string COMMENT &#39;用户标识&#39;,</span><br><span class="line">  &#96;version_code&#96; string COMMENT &#39;程序版本号&#39;,</span><br><span class="line">  &#96;version_name&#96; string COMMENT &#39;程序版本名&#39;,</span><br><span class="line">  &#96;lang&#96; string COMMENT &#39;系统语言&#39;,</span><br><span class="line">  &#96;source&#96; string COMMENT &#39;渠道号&#39;,</span><br><span class="line">  &#96;os&#96; string COMMENT &#39;系统版本&#39;,</span><br><span class="line">  &#96;area&#96; string COMMENT &#39;区域&#39;,</span><br><span class="line">  &#96;model&#96; string COMMENT &#39;手机型号&#39;,</span><br><span class="line">  &#96;brand&#96; string COMMENT &#39;手机品牌&#39;,</span><br><span class="line">  &#96;sdk_version&#96; string COMMENT &#39;sdkVersion&#39;,</span><br><span class="line">  &#96;gmail&#96; string COMMENT &#39;gmail&#39;,</span><br><span class="line">  &#96;height_width&#96; string COMMENT &#39;屏幕宽高&#39;,</span><br><span class="line">  &#96;app_time&#96; string COMMENT &#39;客户端日志产生时的时间&#39;,</span><br><span class="line">  &#96;network&#96; string COMMENT &#39;网络模式&#39;,</span><br><span class="line">  &#96;lng&#96; string COMMENT &#39;经度&#39;,</span><br><span class="line">  &#96;lat&#96; string COMMENT &#39;纬度&#39;,</span><br><span class="line">  &#96;event_name&#96; string COMMENT &#39;事件名称&#39;,</span><br><span class="line">  &#96;event_json&#96; string COMMENT &#39;事件详情&#39;,</span><br><span class="line">  &#96;server_time&#96; string COMMENT &#39;服务器时间&#39;</span><br><span class="line">  ) COMMENT &#39;事件日志表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;event_log&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure><p><a name="3a5115eb"></a></p><h5 id="9-2-1-制作-UDF-UDTF"><a href="#9-2-1-制作-UDF-UDTF" class="headerlink" title="9.2.1 制作 UDF UDTF"></a>9.2.1 制作 UDF UDTF</h5></li><li><p>udf</p></li></ul><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445696-3b581062-c5d4-427f-ba12-e6867d59b49c.png#align=left&display=inline&height=417&margin=%5Bobject%20Object%5D&originHeight=417&originWidth=1318&size=0&status=done&style=none&width=1318" alt><br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445883-e8c65772-697b-4f7a-9dd5-d454e8615019.png#align=left&display=inline&height=534&margin=%5Bobject%20Object%5D&originHeight=534&originWidth=1315&size=0&status=done&style=none&width=1315" alt></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.commons.lang.StringUtils;</span><br><span class="line">import org.apache.hadoop.hive.ql.exec.UDF;</span><br><span class="line">import org.json.JSONException;</span><br><span class="line">import org.json.JSONObject;</span><br><span class="line">public class BaseFieldUDF extends UDF &#123;</span><br><span class="line">    public String evaluate(String line, String key) throws JSONException &#123;</span><br><span class="line">        String[] log &#x3D; line.split(&quot;\\|&quot;);</span><br><span class="line">        if (log.length !&#x3D; 2 || StringUtils.isBlank(log[1])) &#123;</span><br><span class="line">            return &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        JSONObject baseJson &#x3D; new JSONObject(log[1].trim());</span><br><span class="line">        String result &#x3D; &quot;&quot;;</span><br><span class="line">        &#x2F;&#x2F; 获取服务器时间</span><br><span class="line">        if (&quot;st&quot;.equals(key)) &#123;</span><br><span class="line">            result &#x3D; log[0].trim();</span><br><span class="line">        &#125; else if (&quot;et&quot;.equals(key)) &#123;</span><br><span class="line">        &#x2F;&#x2F; 获取事件数组</span><br><span class="line">            if (baseJson.has(&quot;et&quot;)) &#123;</span><br><span class="line">                result &#x3D; baseJson.getString(&quot;et&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            JSONObject cm &#x3D; baseJson.getJSONObject(&quot;cm&quot;);</span><br><span class="line">        &#x2F;&#x2F; 获取 key 对应公共字段的 value</span><br><span class="line">            if (cm.has(key)) &#123;</span><br><span class="line">                result &#x3D; cm.getString(key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    public static void main(String[] args) throws JSONException &#123;</span><br><span class="line">        String line &#x3D; &quot;         1588319303710|&#123;\n&quot; +</span><br><span class="line">                &quot;        \&quot;cm\&quot;:&#123;\n&quot; +</span><br><span class="line">                &quot;            \&quot;ln\&quot;:\&quot;-51.5\&quot;,\&quot;sv\&quot;:\&quot;V2.0.7\&quot;,\&quot;os\&quot;:\&quot;8.0.8\&quot;,\&quot;g\&quot;:\&quot;L1470998@gmail.com\&quot;,\&quot;mid\&quot;:\&quot;13\&quot;,\n&quot; +</span><br><span class="line">                &quot;                    \&quot;nw\&quot;:\&quot;4G\&quot;,\&quot;l\&quot;:\&quot;en\&quot;,\&quot;vc\&quot;:\&quot;7\&quot;,\&quot;hw\&quot;:\&quot;640*960\&quot;,\&quot;ar\&quot;:\&quot;MX\&quot;,\&quot;uid\&quot;:\&quot;13\&quot;,\&quot;t\&quot;:\&quot;1588291826938\&quot;,\n&quot; +</span><br><span class="line">                &quot;                    \&quot;la\&quot;:\&quot;-38.2\&quot;,\&quot;md\&quot;:\&quot;Huawei-14\&quot;,\&quot;vn\&quot;:\&quot;1.3.6\&quot;,\&quot;ba\&quot;:\&quot;Huawei\&quot;,\&quot;sr\&quot;:\&quot;Y\&quot;\n&quot; +</span><br><span class="line">                &quot;        &#125;,\n&quot; +</span><br><span class="line">                &quot;        \&quot;ap\&quot;:\&quot;app\&quot;,\n&quot; +</span><br><span class="line">                &quot;                \&quot;et\&quot;:[&#123;\n&quot; +</span><br><span class="line">                &quot;            \&quot;ett\&quot;:\&quot;1588228193191\&quot;,\&quot;en\&quot;:\&quot;ad\&quot;,\&quot;kv\&quot;:&#123;\&quot;activityId\&quot;:\&quot;1\&quot;,\&quot;displayMills\&quot;:\&quot;113201\&quot;,\&quot;entry\&quot;:\&quot;3\&quot;,\&quot;action\&quot;:\&quot;5\&quot;,\&quot;contentType\&quot;:\&quot;0\&quot;&#125;\n&quot; +</span><br><span class="line">                &quot;        &#125;,&#123;\n&quot; +</span><br><span class="line">                &quot;            \&quot;ett\&quot;:\&quot;1588300304713\&quot;,\&quot;en\&quot;:\&quot;notification\&quot;,\&quot;kv\&quot;:&#123;\&quot;ap_time\&quot;:\&quot;1588277440794\&quot;,\&quot;action\&quot;:\&quot;2\&quot;,\&quot;type\&quot;:\&quot;3\&quot;,\&quot;content\&quot;:\&quot;\&quot;&#125;\n&quot; +</span><br><span class="line">                &quot;        &#125;,&#123;\n&quot; +</span><br><span class="line">                &quot;            \&quot;ett\&quot;:\&quot;1588249203743\&quot;,\&quot;en\&quot;:\&quot;active_background\&quot;,\&quot;kv\&quot;:&#123;\&quot;active_source\&quot;:\&quot;3\&quot;&#125;\n&quot; +</span><br><span class="line">                &quot;        &#125;,&#123;\n&quot; +</span><br><span class="line">                &quot;            \&quot;ett\&quot;:\&quot;1588225856101\&quot;,\&quot;en\&quot;:\&quot;comment\&quot;,\&quot;kv\&quot;:&#123;\&quot;p_comment_id\&quot;:0,\&quot;addtime\&quot;:\&quot;1588263895040\&quot;,\&quot;praise_count\&quot;:231,\&quot;other_id\&quot;:5,\&quot;comment_id\&quot;:5,\&quot;reply_count\&quot;:62,\&quot;userid\&quot;:7,\&quot;content\&quot;:\&quot;骸汞\&quot;&#125;\n&quot; +</span><br><span class="line">                &quot;        &#125;,&#123;\n&quot; +</span><br><span class="line">                &quot;            \&quot;ett\&quot;:\&quot;1588254200122\&quot;,\&quot;en\&quot;:\&quot;favorites\&quot;,\&quot;kv\&quot;:&#123;\&quot;course_id\&quot;:5,\&quot;id\&quot;:0,\&quot;add_time\&quot;:\&quot;1588264138625\&quot;,\&quot;userid\&quot;:0&#125;\n&quot; +</span><br><span class="line">                &quot;        &#125;,&#123;\n&quot; +</span><br><span class="line">                &quot;            \&quot;ett\&quot;:\&quot;1588281152824\&quot;,\&quot;en\&quot;:\&quot;praise\&quot;,\&quot;kv\&quot;:&#123;\&quot;target_id\&quot;:4,\&quot;id\&quot;:3,\&quot;type\&quot;:3,\&quot;add_time\&quot;:\&quot;1588307696417\&quot;,\&quot;userid\&quot;:8&#125;\n&quot; +</span><br><span class="line">                &quot;        &#125;]\n&quot; +</span><br><span class="line">                &quot;    &#125;&quot;;</span><br><span class="line">        String s &#x3D; new BaseFieldUDF().evaluate(line, &quot;mid&quot;);</span><br><span class="line">        String ss &#x3D; new BaseFieldUDF().evaluate(line, &quot;st&quot;);</span><br><span class="line">        String sss &#x3D; new BaseFieldUDF().evaluate(line, &quot;et&quot;);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">        System.out.println(ss);</span><br><span class="line">        System.out.println(sss);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果：<br>13<br>1588319303710<br>[{“ett”:”1588228193191”,”en”:”ad”,”kv”:{“activityId”:”1”,”displayMills”:”113201”,”entry”:”3”,”action”:”5”,”contentType”:”0”}},{“ett”:”1588300304713”,”en”:”notification”,”kv”:{“ap_time”:”1588277440794”,”action”:”2”,”type”:”3”,”content”:””}},{“ett”:”1588249203743”,”en”:”active_background”,”kv”:{“active_source”:”3”}},{“ett”:”1588225856101”,”en”:”comment”,”kv”:{“p_comment_id”:0,”addtime”:”1588263895040”,”praise_count”:231,”other_id”:5,”comment_id”:5,”reply_count”:62,”userid”:7,”content”:”骸汞”}},{“ett”:”1588254200122”,”en”:”favorites”,”kv”:{“course_id”:5,”id”:0,”add_time”:”1588264138625”,”userid”:0}},{“ett”:”1588281152824”,”en”:”praise”,”kv”:{“target_id”:4,”id”:3,”type”:3,”add_time”:”1588307696417”,”userid”:8}}]</p></blockquote><ul><li>udtf</li></ul><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445446239-9b99f151-4d88-4505-ab08-fb212a6d8ac7.png#align=left&display=inline&height=339&margin=%5Bobject%20Object%5D&originHeight=339&originWidth=1207&size=0&status=done&style=none&width=1207" alt><br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445446059-b20b058a-4006-4c97-bce2-84b85cd28599.png#align=left&display=inline&height=624&margin=%5Bobject%20Object%5D&originHeight=624&originWidth=1205&size=0&status=done&style=none&width=1205" alt></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.commons.lang.StringUtils;</span><br><span class="line">import org.apache.hadoop.hive.ql.exec.UDFArgumentException;</span><br><span class="line">import org.apache.hadoop.hive.ql.metadata.HiveException;</span><br><span class="line">import org.apache.hadoop.hive.ql.udf.generic.GenericUDTF;</span><br><span class="line">import org.apache.hadoop.hive.serde2.objectinspector.ObjectInspector;</span><br><span class="line">import org.apache.hadoop.hive.serde2.objectinspector.ObjectInspectorFactory;</span><br><span class="line">import org.apache.hadoop.hive.serde2.objectinspector.StructObjectInspector;</span><br><span class="line">import org.apache.hadoop.hive.serde2.objectinspector.primitive.PrimitiveObjectInspectorFactory;</span><br><span class="line">import org.json.JSONArray;</span><br><span class="line">import org.json.JSONException;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">public class EventJsonUDTF extends GenericUDTF &#123;</span><br><span class="line">    &#x2F;&#x2F;该方法中，我们将指定输出参数的名称和参数类型：</span><br><span class="line">    public StructObjectInspector initialize(StructObjectInspector argOIs) throws UDFArgumentException &#123;</span><br><span class="line">        ArrayList&lt;String&gt; fieldNames &#x3D; new ArrayList&lt;String&gt;();</span><br><span class="line">        ArrayList&lt;ObjectInspector&gt; fieldOIs &#x3D; new ArrayList&lt;ObjectInspector&gt;();</span><br><span class="line">        fieldNames.add(&quot;event_name&quot;);</span><br><span class="line">        fieldOIs.add(PrimitiveObjectInspectorFactory.javaStringObjectInspector);</span><br><span class="line">        fieldNames.add(&quot;event_json&quot;);</span><br><span class="line">        fieldOIs.add(PrimitiveObjectInspectorFactory.javaStringObjectInspector);</span><br><span class="line">        return ObjectInspectorFactory.getStandardStructObjectInspector(fieldNames,</span><br><span class="line">                fieldOIs);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;输入 1 条记录，输出若干条结果</span><br><span class="line">    @Override</span><br><span class="line">    public void process(Object[] objects) throws HiveException &#123;</span><br><span class="line">        &#x2F;&#x2F; 获取传入的 et</span><br><span class="line">        String input &#x3D; objects[0].toString();</span><br><span class="line">        &#x2F;&#x2F; 如果传进来的数据为空，直接返回过滤掉该数据</span><br><span class="line">        if (StringUtils.isBlank(input)) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                &#x2F;&#x2F; 获取一共有几个事件（ad&#x2F;facoriters）</span><br><span class="line">                JSONArray ja &#x3D; new JSONArray(input);</span><br><span class="line">                if (ja &#x3D;&#x3D; null)</span><br><span class="line">                    return;</span><br><span class="line">                &#x2F;&#x2F; 循环遍历每一个事件</span><br><span class="line">                for (int i &#x3D; 0; i &lt; ja.length(); i++) &#123;</span><br><span class="line">                    String[] result &#x3D; new String[2];</span><br><span class="line">                    try &#123;</span><br><span class="line">                        &#x2F;&#x2F; 取出每个的事件名称（ad&#x2F;facoriters）</span><br><span class="line">                        result[0] &#x3D; ja.getJSONObject(i).getString(&quot;en&quot;);</span><br><span class="line">                        &#x2F;&#x2F; 取出每一个事件整体</span><br><span class="line">                        result[1] &#x3D; ja.getString(i);</span><br><span class="line">                    &#125; catch (JSONException e) &#123;</span><br><span class="line">                        continue;</span><br><span class="line">                    &#125;</span><br><span class="line">                    &#x2F;&#x2F; 将结果返回</span><br><span class="line">                    forward(result);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (JSONException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;当没有记录处理的时候该方法会被调用，用来清理代码或者产生额外的输出</span><br><span class="line">    @Override</span><br><span class="line">    public void close() throws HiveException &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a name="86de846c"></a></p><h5 id="9-1-2-2-直接永久使用UDF"><a href="#9-1-2-2-直接永久使用UDF" class="headerlink" title="9.1.2.2 直接永久使用UDF"></a>9.1.2.2 直接永久使用UDF</h5><ul><li>上传UDF资源<blockquote><p>将hive-function-1.0-SNAPSHOT包传到HDFS 的/user/hive/jars下</p></blockquote></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hadoop dfs -mkdir  &#x2F;user&#x2F;hive&#x2F;jars</span><br><span class="line">hadoop dfs -put hive-function-1.0-SNAPSHOT.jar &#x2F;user&#x2F;hive&#x2F;jars&#x2F;hive-function-1.0-SNAPSHOT.jar</span><br></pre></td></tr></table></figure><blockquote><p>在hive中创建永久UDF</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create function base_analizer as &#39;com.heaton.bigdata.udf.BaseFieldUDF&#39; using jar &#39;hdfs:&#x2F;&#x2F;cdh01.cm:8020&#x2F;user&#x2F;hive&#x2F;jars&#x2F;hive-function-1.0-SNAPSHOT.jar&#39;;</span><br><span class="line">create function flat_analizer as &#39;com.heaton.bigdata.udtf.EventJsonUDTF&#39; using jar &#39;hdfs:&#x2F;&#x2F;cdh01.cm:8020&#x2F;user&#x2F;hive&#x2F;jars&#x2F;hive-function-1.0-SNAPSHOT.jar&#39;;</span><br></pre></td></tr></table></figure><p><a name="620b459a"></a></p><h5 id="9-1-2-3-Dolphin使用方式UDF"><a href="#9-1-2-3-Dolphin使用方式UDF" class="headerlink" title="9.1.2.3 Dolphin使用方式UDF"></a>9.1.2.3 Dolphin使用方式UDF</h5><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445818-d1c8fc14-e529-4591-805f-7345bab479e8.png#align=left&display=inline&height=330&margin=%5Bobject%20Object%5D&originHeight=330&originWidth=1906&size=0&status=done&style=none&width=1906" alt><br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445645-ab931a0b-bb10-4b9a-9c67-c42afdb4132d.png#align=left&display=inline&height=334&margin=%5Bobject%20Object%5D&originHeight=334&originWidth=1722&size=0&status=done&style=none&width=1722" alt></p><blockquote><p>在DAG图创建SQL工具中选择对应UDF函数即可使用，但是目前Dolphin1.2.0中关联函数操作保存无效。<br>大家可以使用UDF管理功能将JAR传入到HDFS上，这样通过脚本加入临时函数，也可以很好的完成功能。<br>临时函数语句：</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create temporary function base_analizer as &#39;com.heaton.bigdata.udf.BaseFieldUDF&#39; using jar &#39;hdfs:&#x2F;&#x2F;cdh01.cm:8020&#x2F;dolphinscheduler&#x2F;dolphinscheduler&#x2F;udfs&#x2F;hive-function-1.0-SNAPSHOT.jar&#39;;</span><br><span class="line">create temporary function flat_analizer as &#39;com.heaton.bigdata.udtf.EventJsonUDTF&#39; using jar &#39;hdfs:&#x2F;&#x2F;cdh01.cm:8020&#x2F;dolphinscheduler&#x2F;dolphinscheduler&#x2F;udfs&#x2F;hive-function-1.0-SNAPSHOT.jar&#39;;</span><br></pre></td></tr></table></figure><p><a name="29e0a488"></a></p><h5 id="9-2-4-数据导入"><a href="#9-2-4-数据导入" class="headerlink" title="9.2.4 数据导入"></a>9.2.4 数据导入</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">APP3&#x3D;ods</span><br><span class="line">table_name&#x3D;event_log</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line">hive_origin_table_name&#x3D;$APP3.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	base_analizer(line,&#39;mid&#39;) as mid_id,</span><br><span class="line">	base_analizer(line,&#39;uid&#39;) as user_id,</span><br><span class="line">	base_analizer(line,&#39;vc&#39;) as version_code,</span><br><span class="line">	base_analizer(line,&#39;vn&#39;) as version_name,</span><br><span class="line">	base_analizer(line,&#39;l&#39;) as lang,</span><br><span class="line">	base_analizer(line,&#39;sr&#39;) as source,</span><br><span class="line">	base_analizer(line,&#39;os&#39;) as os,</span><br><span class="line">	base_analizer(line,&#39;ar&#39;) as area,</span><br><span class="line">	base_analizer(line,&#39;md&#39;) as model,</span><br><span class="line">	base_analizer(line,&#39;ba&#39;) as brand,</span><br><span class="line">	base_analizer(line,&#39;sv&#39;) as sdk_version,</span><br><span class="line">	base_analizer(line,&#39;g&#39;) as gmail,</span><br><span class="line">	base_analizer(line,&#39;hw&#39;) as height_width,</span><br><span class="line">	base_analizer(line,&#39;t&#39;) as app_time,</span><br><span class="line">	base_analizer(line,&#39;nw&#39;) as network,</span><br><span class="line">	base_analizer(line,&#39;ln&#39;) as lng,</span><br><span class="line">	base_analizer(line,&#39;la&#39;) as lat,</span><br><span class="line">	event_name,</span><br><span class="line">	event_json,</span><br><span class="line">	base_analizer(line,&#39;st&#39;) as server_time</span><br><span class="line">from $hive_origin_table_name lateral view flat_analizer(base_analizer(line,&#39;et&#39;)) tmp_flat as event_name,event_json</span><br><span class="line">where dt&#x3D;&#39;$db_date&#39; and base_analizer(line,&#39;et&#39;)&lt;&gt;&#39;&#39;;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="44c27f4d"></a></p><h4 id="9-1-3-商品点击表"><a href="#9-1-3-商品点击表" class="headerlink" title="9.1.3 商品点击表"></a>9.1.3 商品点击表</h4><ul><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__display_log</span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__display_log&#96;(</span><br><span class="line">	&#96;mid_id&#96; string,</span><br><span class="line">	&#96;user_id&#96; string,</span><br><span class="line">	&#96;version_code&#96; string,</span><br><span class="line">	&#96;version_name&#96; string,</span><br><span class="line">	&#96;lang&#96; string,</span><br><span class="line">	&#96;source&#96; string,</span><br><span class="line">	&#96;os&#96; string,</span><br><span class="line">	&#96;area&#96; string,</span><br><span class="line">	&#96;model&#96; string,</span><br><span class="line">	&#96;brand&#96; string,</span><br><span class="line">	&#96;sdk_version&#96; string,</span><br><span class="line">	&#96;gmail&#96; string,</span><br><span class="line">	&#96;height_width&#96; string,</span><br><span class="line">	&#96;app_time&#96; string,</span><br><span class="line">	&#96;network&#96; string,</span><br><span class="line">	&#96;lng&#96; string,</span><br><span class="line">	&#96;lat&#96; string,</span><br><span class="line">	&#96;action&#96; string,</span><br><span class="line">	&#96;goodsid&#96; string,</span><br><span class="line">	&#96;place&#96; string,</span><br><span class="line">	&#96;extend1&#96; string,</span><br><span class="line">	&#96;category&#96; string,</span><br><span class="line">	&#96;server_time&#96; string</span><br><span class="line">  ) COMMENT &#39;商品点击表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;display_log&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">APP3&#x3D;ods</span><br><span class="line">table_name&#x3D;display_log</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line">hive_origin_table_name&#x3D;$APP3.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">	select</span><br><span class="line">	mid_id,</span><br><span class="line">	user_id,</span><br><span class="line">	version_code,</span><br><span class="line">	version_name,</span><br><span class="line">	lang,</span><br><span class="line">	source,</span><br><span class="line">	os,</span><br><span class="line">	area,</span><br><span class="line">	model,</span><br><span class="line">	brand,</span><br><span class="line">	sdk_version,</span><br><span class="line">	gmail,</span><br><span class="line">	height_width,</span><br><span class="line">	app_time,</span><br><span class="line">	network,</span><br><span class="line">	lng,</span><br><span class="line">	lat,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.action&#39;) action,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.goodsid&#39;) goodsid,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.place&#39;) place,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.extend1&#39;) extend1,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.category&#39;) category,</span><br><span class="line">	server_time</span><br><span class="line">from dwd.mall__event_log</span><br><span class="line">where dt&#x3D;&#39;$db_date&#39; and event_name&#x3D;&#39;display&#39;;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="9a570f18"></a></p><h4 id="9-1-4-商品列表表"><a href="#9-1-4-商品列表表" class="headerlink" title="9.1.4 商品列表表"></a>9.1.4 商品列表表</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__loading_log</span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__loading_log&#96;(</span><br><span class="line">	&#96;mid_id&#96; string,</span><br><span class="line">	&#96;user_id&#96; string,</span><br><span class="line">	&#96;version_code&#96; string,</span><br><span class="line">	&#96;version_name&#96; string,</span><br><span class="line">	&#96;lang&#96; string,</span><br><span class="line">	&#96;source&#96; string,</span><br><span class="line">	&#96;os&#96; string,</span><br><span class="line">	&#96;area&#96; string,</span><br><span class="line">	&#96;model&#96; string,</span><br><span class="line">	&#96;brand&#96; string,</span><br><span class="line">	&#96;sdk_version&#96; string,</span><br><span class="line">	&#96;gmail&#96; string,</span><br><span class="line">	&#96;height_width&#96; string,</span><br><span class="line">	&#96;app_time&#96; string,</span><br><span class="line">	&#96;network&#96; string,</span><br><span class="line">	&#96;lng&#96; string,</span><br><span class="line">	&#96;lat&#96; string,</span><br><span class="line">	&#96;action&#96; string,</span><br><span class="line">	&#96;loading_time&#96; string,</span><br><span class="line">	&#96;loading_way&#96; string,</span><br><span class="line">	&#96;extend1&#96; string,</span><br><span class="line">	&#96;extend2&#96; string,</span><br><span class="line">	&#96;type&#96; string,</span><br><span class="line">	&#96;type1&#96; string,</span><br><span class="line">	&#96;server_time&#96; string</span><br><span class="line">  ) COMMENT &#39;商品列表表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;loading_log&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">APP3&#x3D;ods</span><br><span class="line">table_name&#x3D;loading_log</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line">hive_origin_table_name&#x3D;$APP3.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	mid_id,</span><br><span class="line">	user_id,</span><br><span class="line">	version_code,</span><br><span class="line">	version_name,</span><br><span class="line">	lang,</span><br><span class="line">	source,</span><br><span class="line">	os,</span><br><span class="line">	area,</span><br><span class="line">	model,</span><br><span class="line">	brand,</span><br><span class="line">	sdk_version,</span><br><span class="line">	gmail,</span><br><span class="line">	height_width,</span><br><span class="line">	app_time,</span><br><span class="line">	network,</span><br><span class="line">	lng,</span><br><span class="line">	lat,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.action&#39;) action,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.loading_time&#39;) loading_time,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.loading_way&#39;) loading_way,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.extend1&#39;) extend1,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.extend2&#39;) extend2,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.type&#39;) type,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.type1&#39;) type1,</span><br><span class="line">	server_time</span><br><span class="line">from dwd.mall__event_log</span><br><span class="line">where dt&#x3D;&#39;$db_date&#39; and event_name&#x3D;&#39;loading&#39;;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="502f9d47"></a></p><h4 id="9-1-5-广告表"><a href="#9-1-5-广告表" class="headerlink" title="9.1.5 广告表"></a>9.1.5 广告表</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__ad_log</span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__ad_log&#96;(</span><br><span class="line">	&#96;mid_id&#96; string,</span><br><span class="line">	&#96;user_id&#96; string,</span><br><span class="line">	&#96;version_code&#96; string,</span><br><span class="line">	&#96;version_name&#96; string,</span><br><span class="line">	&#96;lang&#96; string,</span><br><span class="line">	&#96;source&#96; string,</span><br><span class="line">	&#96;os&#96; string,</span><br><span class="line">	&#96;area&#96; string,</span><br><span class="line">	&#96;model&#96; string,</span><br><span class="line">	&#96;brand&#96; string,</span><br><span class="line">	&#96;sdk_version&#96; string,</span><br><span class="line">	&#96;gmail&#96; string,</span><br><span class="line">	&#96;height_width&#96; string,</span><br><span class="line">	&#96;app_time&#96; string,</span><br><span class="line">	&#96;network&#96; string,</span><br><span class="line">	&#96;lng&#96; string,</span><br><span class="line">	&#96;lat&#96; string,</span><br><span class="line">	&#96;entry&#96; string,</span><br><span class="line">	&#96;action&#96; string,</span><br><span class="line">	&#96;contentType&#96; string,</span><br><span class="line">	&#96;displayMills&#96; string,</span><br><span class="line">	&#96;itemId&#96; string,</span><br><span class="line">	&#96;activityId&#96; string,</span><br><span class="line">	&#96;server_time&#96; string</span><br><span class="line">  ) COMMENT &#39;广告表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;ad_log&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">APP3&#x3D;ods</span><br><span class="line">table_name&#x3D;ad_log</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line">hive_origin_table_name&#x3D;$APP3.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	mid_id,</span><br><span class="line">	user_id,</span><br><span class="line">	version_code,</span><br><span class="line">	version_name,</span><br><span class="line">	lang,</span><br><span class="line">	source,</span><br><span class="line">	os,</span><br><span class="line">	area,</span><br><span class="line">	model,</span><br><span class="line">	brand,</span><br><span class="line">	sdk_version,</span><br><span class="line">	gmail,</span><br><span class="line">	height_width,</span><br><span class="line">	app_time,</span><br><span class="line">	network,</span><br><span class="line">	lng,</span><br><span class="line">	lat,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.entry&#39;) entry,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.action&#39;) action,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.contentType&#39;) contentType,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.displayMills&#39;) displayMills,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.itemId&#39;) itemId,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.activityId&#39;) activityId,</span><br><span class="line">	server_time</span><br><span class="line">from dwd.mall__event_log</span><br><span class="line">where dt&#x3D;&#39;db_date&#39; and event_name&#x3D;&#39;ad&#39;;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="a25a0ee7"></a></p><h4 id="9-1-6-消息通知表"><a href="#9-1-6-消息通知表" class="headerlink" title="9.1.6 消息通知表"></a>9.1.6 消息通知表</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__notification_log</span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__notification_log&#96;(</span><br><span class="line">	&#96;mid_id&#96; string,</span><br><span class="line">	&#96;user_id&#96; string,</span><br><span class="line">	&#96;version_code&#96; string,</span><br><span class="line">	&#96;version_name&#96; string,</span><br><span class="line">	&#96;lang&#96; string,</span><br><span class="line">	&#96;source&#96; string,</span><br><span class="line">	&#96;os&#96; string,</span><br><span class="line">	&#96;area&#96; string,</span><br><span class="line">	&#96;model&#96; string,</span><br><span class="line">	&#96;brand&#96; string,</span><br><span class="line">	&#96;sdk_version&#96; string,</span><br><span class="line">	&#96;gmail&#96; string,</span><br><span class="line">	&#96;height_width&#96; string,</span><br><span class="line">	&#96;app_time&#96; string,</span><br><span class="line">	&#96;network&#96; string,</span><br><span class="line">	&#96;lng&#96; string,</span><br><span class="line">	&#96;lat&#96; string,</span><br><span class="line">	&#96;action&#96; string,</span><br><span class="line">	&#96;noti_type&#96; string,</span><br><span class="line">	&#96;ap_time&#96; string,</span><br><span class="line">	&#96;content&#96; string,</span><br><span class="line">	&#96;server_time&#96; string</span><br><span class="line">  ) COMMENT &#39;消息通知表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;notification_log&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">APP3&#x3D;ods</span><br><span class="line">table_name&#x3D;notification_log</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line">hive_origin_table_name&#x3D;$APP3.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	mid_id,</span><br><span class="line">	user_id,</span><br><span class="line">	version_code,</span><br><span class="line">	version_name,</span><br><span class="line">	lang,</span><br><span class="line">	source,</span><br><span class="line">	os,</span><br><span class="line">	area,</span><br><span class="line">	model,</span><br><span class="line">	brand,</span><br><span class="line">	sdk_version,</span><br><span class="line">	gmail,</span><br><span class="line">	height_width,</span><br><span class="line">	app_time,</span><br><span class="line">	network,</span><br><span class="line">	lng,</span><br><span class="line">	lat,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.action&#39;) action,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.noti_type&#39;) noti_type,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.ap_time&#39;) ap_time,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.content&#39;) content,</span><br><span class="line">	server_time</span><br><span class="line">from dwd.mall__event_log</span><br><span class="line">where dt&#x3D;&#39;$db_date&#39; and event_name&#x3D;&#39;notification&#39;;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="e14d4ccf"></a></p><h4 id="9-1-7-用户后台活跃表"><a href="#9-1-7-用户后台活跃表" class="headerlink" title="9.1.7 用户后台活跃表"></a>9.1.7 用户后台活跃表</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__active_background_log</span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__active_background_log&#96;(</span><br><span class="line">	&#96;mid_id&#96; string,</span><br><span class="line">	&#96;user_id&#96; string,</span><br><span class="line">	&#96;version_code&#96; string,</span><br><span class="line">	&#96;version_name&#96; string,</span><br><span class="line">	&#96;lang&#96; string,</span><br><span class="line">	&#96;source&#96; string,</span><br><span class="line">	&#96;os&#96; string,</span><br><span class="line">	&#96;area&#96; string,</span><br><span class="line">	&#96;model&#96; string,</span><br><span class="line">	&#96;brand&#96; string,</span><br><span class="line">	&#96;sdk_version&#96; string,</span><br><span class="line">	&#96;gmail&#96; string,</span><br><span class="line">	&#96;height_width&#96; string,</span><br><span class="line">	&#96;app_time&#96; string,</span><br><span class="line">	&#96;network&#96; string,</span><br><span class="line">	&#96;lng&#96; string,</span><br><span class="line">	&#96;lat&#96; string,</span><br><span class="line">	&#96;active_source&#96; string,</span><br><span class="line">	&#96;server_time&#96; string</span><br><span class="line">  ) COMMENT &#39;用户后台活跃表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;active_background_log&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">APP3&#x3D;ods</span><br><span class="line">table_name&#x3D;active_background_log</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line">hive_origin_table_name&#x3D;$APP3.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	mid_id,</span><br><span class="line">	user_id,</span><br><span class="line">	version_code,</span><br><span class="line">	version_name,</span><br><span class="line">	lang,</span><br><span class="line">	source,</span><br><span class="line">	os,</span><br><span class="line">	area,</span><br><span class="line">	model,</span><br><span class="line">	brand,</span><br><span class="line">	sdk_version,</span><br><span class="line">	gmail,</span><br><span class="line">	height_width,</span><br><span class="line">	app_time,</span><br><span class="line">	network,</span><br><span class="line">	lng,</span><br><span class="line">	lat,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.active_source&#39;) active_source,</span><br><span class="line">	server_time</span><br><span class="line">from dwd.mall__event_log</span><br><span class="line">where dt&#x3D;&#39;$db_date&#39; and event_name&#x3D;&#39;active_background&#39;;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="9f615d68"></a></p><h4 id="9-1-8-评论表"><a href="#9-1-8-评论表" class="headerlink" title="9.1.8 评论表"></a>9.1.8 评论表</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__comment_log</span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__comment_log&#96;(</span><br><span class="line">	&#96;mid_id&#96; string,</span><br><span class="line">	&#96;user_id&#96; string,</span><br><span class="line">	&#96;version_code&#96; string,</span><br><span class="line">	&#96;version_name&#96; string,</span><br><span class="line">	&#96;lang&#96; string,</span><br><span class="line">	&#96;source&#96; string,</span><br><span class="line">	&#96;os&#96; string,</span><br><span class="line">	&#96;area&#96; string,</span><br><span class="line">	&#96;model&#96; string,</span><br><span class="line">	&#96;brand&#96; string,</span><br><span class="line">	&#96;sdk_version&#96; string,</span><br><span class="line">	&#96;gmail&#96; string,</span><br><span class="line">	&#96;height_width&#96; string,</span><br><span class="line">	&#96;app_time&#96; string,</span><br><span class="line">	&#96;network&#96; string,</span><br><span class="line">	&#96;lng&#96; string,</span><br><span class="line">	&#96;lat&#96; string,</span><br><span class="line">	&#96;comment_id&#96; int,</span><br><span class="line">	&#96;userid&#96; int,</span><br><span class="line">	&#96;p_comment_id&#96; int,</span><br><span class="line">	&#96;content&#96; string,</span><br><span class="line">	&#96;addtime&#96; string,</span><br><span class="line">	&#96;other_id&#96; int,</span><br><span class="line">	&#96;praise_count&#96; int,</span><br><span class="line">	&#96;reply_count&#96; int,</span><br><span class="line">	&#96;server_time&#96; string</span><br><span class="line">  ) COMMENT &#39;评论表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;comment_log&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">APP3&#x3D;ods</span><br><span class="line">table_name&#x3D;comment_log</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line">hive_origin_table_name&#x3D;$APP3.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	mid_id,</span><br><span class="line">	user_id,</span><br><span class="line">	version_code,</span><br><span class="line">	version_name,</span><br><span class="line">	lang,</span><br><span class="line">	source,</span><br><span class="line">	os,</span><br><span class="line">	area,</span><br><span class="line">	model,</span><br><span class="line">	brand,</span><br><span class="line">	sdk_version,</span><br><span class="line">	gmail,</span><br><span class="line">	height_width,</span><br><span class="line">	app_time,</span><br><span class="line">	network,</span><br><span class="line">	lng,</span><br><span class="line">	lat,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.comment_id&#39;) comment_id,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.userid&#39;) userid,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.p_comment_id&#39;) p_comment_id,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.content&#39;) content,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.addtime&#39;) addtime,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.other_id&#39;) other_id,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.praise_count&#39;) praise_count,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.reply_count&#39;) reply_count,</span><br><span class="line">	server_time</span><br><span class="line">from dwd.mall__event_log</span><br><span class="line">where dt&#x3D;&#39;$db_date&#39; and event_name&#x3D;&#39;comment&#39;;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="6448bc13"></a></p><h4 id="9-1-9-收藏表"><a href="#9-1-9-收藏表" class="headerlink" title="9.1.9 收藏表"></a>9.1.9 收藏表</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__favorites_log</span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__favorites_log&#96;(</span><br><span class="line">	&#96;mid_id&#96; string,</span><br><span class="line">	&#96;user_id&#96; string,</span><br><span class="line">	&#96;version_code&#96; string,</span><br><span class="line">	&#96;version_name&#96; string,</span><br><span class="line">	&#96;lang&#96; string,</span><br><span class="line">	&#96;source&#96; string,</span><br><span class="line">	&#96;os&#96; string,</span><br><span class="line">	&#96;area&#96; string,</span><br><span class="line">	&#96;model&#96; string,</span><br><span class="line">	&#96;brand&#96; string,</span><br><span class="line">	&#96;sdk_version&#96; string,</span><br><span class="line">	&#96;gmail&#96; string,</span><br><span class="line">	&#96;height_width&#96; string,</span><br><span class="line">	&#96;app_time&#96; string,</span><br><span class="line">	&#96;network&#96; string,</span><br><span class="line">	&#96;lng&#96; string,</span><br><span class="line">	&#96;lat&#96; string,</span><br><span class="line">	&#96;id&#96; int,</span><br><span class="line">	&#96;course_id&#96; int,</span><br><span class="line">	&#96;userid&#96; int,</span><br><span class="line">	&#96;add_time&#96; string,</span><br><span class="line">	&#96;server_time&#96; string</span><br><span class="line">  ) COMMENT &#39;收藏表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;favorites_log&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">APP3&#x3D;ods</span><br><span class="line">table_name&#x3D;favorites_log</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line">hive_origin_table_name&#x3D;$APP3.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	mid_id,</span><br><span class="line">	user_id,</span><br><span class="line">	version_code,</span><br><span class="line">	version_name,</span><br><span class="line">	lang,</span><br><span class="line">	source,</span><br><span class="line">	os,</span><br><span class="line">	area,</span><br><span class="line">	model,</span><br><span class="line">	brand,</span><br><span class="line">	sdk_version,</span><br><span class="line">	gmail,</span><br><span class="line">	height_width,</span><br><span class="line">	app_time,</span><br><span class="line">	network,</span><br><span class="line">	lng,</span><br><span class="line">	lat,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.id&#39;) id,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.course_id&#39;) course_id,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.userid&#39;) userid,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.add_time&#39;) add_time,</span><br><span class="line">	server_time</span><br><span class="line">from dwd.mall__event_log</span><br><span class="line">where dt&#x3D;&#39;$db_date&#39; and event_name&#x3D;&#39;favorites&#39;;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="9790b43b"></a></p><h4 id="9-1-10-点赞表"><a href="#9-1-10-点赞表" class="headerlink" title="9.1.10 点赞表"></a>9.1.10 点赞表</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__praise_log</span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__praise_log&#96;(</span><br><span class="line">	&#96;mid_id&#96; string,</span><br><span class="line">	&#96;user_id&#96; string,</span><br><span class="line">	&#96;version_code&#96; string,</span><br><span class="line">	&#96;version_name&#96; string,</span><br><span class="line">	&#96;lang&#96; string,</span><br><span class="line">	&#96;source&#96; string,</span><br><span class="line">	&#96;os&#96; string,</span><br><span class="line">	&#96;area&#96; string,</span><br><span class="line">	&#96;model&#96; string,</span><br><span class="line">	&#96;brand&#96; string,</span><br><span class="line">	&#96;sdk_version&#96; string,</span><br><span class="line">	&#96;gmail&#96; string,</span><br><span class="line">	&#96;height_width&#96; string,</span><br><span class="line">	&#96;app_time&#96; string,</span><br><span class="line">	&#96;network&#96; string,</span><br><span class="line">	&#96;lng&#96; string,</span><br><span class="line">	&#96;lat&#96; string,</span><br><span class="line">	&#96;id&#96; string,</span><br><span class="line">	&#96;userid&#96; string,</span><br><span class="line">	&#96;target_id&#96; string,</span><br><span class="line">	&#96;type&#96; string,</span><br><span class="line">	&#96;add_time&#96; string,</span><br><span class="line">	&#96;server_time&#96; string</span><br><span class="line">  ) COMMENT &#39;点赞表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;praise_log&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">APP3&#x3D;ods</span><br><span class="line">table_name&#x3D;praise_log</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line">hive_origin_table_name&#x3D;$APP3.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	mid_id,</span><br><span class="line">	user_id,</span><br><span class="line">	version_code,</span><br><span class="line">	version_name,</span><br><span class="line">	lang,</span><br><span class="line">	source,</span><br><span class="line">	os,</span><br><span class="line">	area,</span><br><span class="line">	model,</span><br><span class="line">	brand,</span><br><span class="line">	sdk_version,</span><br><span class="line">	gmail,</span><br><span class="line">	height_width,</span><br><span class="line">	app_time,</span><br><span class="line">	network,</span><br><span class="line">	lng,</span><br><span class="line">	lat,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.id&#39;) id,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.userid&#39;) userid,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.target_id&#39;) target_id,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.type&#39;) type,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.add_time&#39;) add_time,</span><br><span class="line">	server_time</span><br><span class="line">from dwd.mall__event_log</span><br><span class="line">where dt&#x3D;&#39;$db_date&#39; and event_name&#x3D;&#39;praise&#39;;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="ffc7fca0"></a></p><h4 id="9-1-11-错误日志表"><a href="#9-1-11-错误日志表" class="headerlink" title="9.1.11 错误日志表"></a>9.1.11 错误日志表</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__error_log</span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__error_log&#96;(</span><br><span class="line">	&#96;mid_id&#96; string,</span><br><span class="line">	&#96;user_id&#96; string,</span><br><span class="line">	&#96;version_code&#96; string,</span><br><span class="line">	&#96;version_name&#96; string,</span><br><span class="line">	&#96;lang&#96; string,</span><br><span class="line">	&#96;source&#96; string,</span><br><span class="line">	&#96;os&#96; string,</span><br><span class="line">	&#96;area&#96; string,</span><br><span class="line">	&#96;model&#96; string,</span><br><span class="line">	&#96;brand&#96; string,</span><br><span class="line">	&#96;sdk_version&#96; string,</span><br><span class="line">	&#96;gmail&#96; string,</span><br><span class="line">	&#96;height_width&#96; string,</span><br><span class="line">	&#96;app_time&#96; string,</span><br><span class="line">	&#96;network&#96; string,</span><br><span class="line">	&#96;lng&#96; string,</span><br><span class="line">	&#96;lat&#96; string,</span><br><span class="line">	&#96;errorBrief&#96; string,</span><br><span class="line">	&#96;errorDetail&#96; string,</span><br><span class="line">	&#96;server_time&#96; string</span><br><span class="line">  ) COMMENT &#39;错误日志表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;error_log&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">APP3&#x3D;ods</span><br><span class="line">table_name&#x3D;error_log</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line">hive_origin_table_name&#x3D;$APP3.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	mid_id,</span><br><span class="line">	user_id,</span><br><span class="line">	version_code,</span><br><span class="line">	version_name,</span><br><span class="line">	lang,</span><br><span class="line">	source,</span><br><span class="line">	os,</span><br><span class="line">	area,</span><br><span class="line">	model,</span><br><span class="line">	brand,</span><br><span class="line">	sdk_version,</span><br><span class="line">	gmail,</span><br><span class="line">	height_width,</span><br><span class="line">	app_time,</span><br><span class="line">	network,</span><br><span class="line">	lng,</span><br><span class="line">	lat,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.errorBrief&#39;) errorBrief,</span><br><span class="line">	get_json_object(event_json,&#39;$.kv.errorDetail&#39;) errorDetail,</span><br><span class="line">	server_time</span><br><span class="line">from dwd.mall__event_log</span><br><span class="line">where dt&#x3D;&#39;$db_date&#39; and event_name&#x3D;&#39;error&#39;;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="blogTitle36"></a></p><h3 id="9-2-dwd层构建-业务库"><a href="#9-2-dwd层构建-业务库" class="headerlink" title="9.2 dwd层构建(业务库)"></a>9.2 dwd层构建(业务库)</h3><blockquote><p>此层在构建之初，增量表需要动态分区来划分时间，将数据放入指定分区</p></blockquote></li></ul><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445674-85cdb9f6-3bc5-45af-a42c-260b856251c4.png#align=left&display=inline&height=727&margin=%5Bobject%20Object%5D&originHeight=727&originWidth=1200&size=0&status=done&style=none&width=1200" alt></p><table><thead><tr><th>事实/维度</th><th>时间</th><th>用户</th><th>地区</th><th>商品</th><th>优惠卷</th><th>活动</th><th>编码</th><th>度量</th></tr></thead><tbody><tr><td>订单</td><td>√</td><td>√</td><td>√</td><td></td><td></td><td>√</td><td></td><td>件数/金额</td></tr><tr><td>订单详情</td><td>√</td><td></td><td>√</td><td>√</td><td></td><td></td><td></td><td>件数/金额</td></tr><tr><td>支付</td><td>√</td><td></td><td>√</td><td></td><td></td><td></td><td></td><td>次数/金额</td></tr><tr><td>加入购物车</td><td>√</td><td>√</td><td></td><td>√</td><td></td><td></td><td></td><td>件数/金额</td></tr><tr><td>收藏</td><td>√</td><td>√</td><td></td><td>√</td><td></td><td></td><td></td><td>个数</td></tr><tr><td>评价</td><td>√</td><td>√</td><td></td><td>√</td><td></td><td></td><td></td><td>个数</td></tr><tr><td>退款</td><td>√</td><td>√</td><td></td><td>√</td><td></td><td></td><td></td><td>件数/金额</td></tr><tr><td>优惠卷领用</td><td>√</td><td>√</td><td></td><td></td><td>√</td><td></td><td></td><td>个数</td></tr></tbody></table><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445446714-5b66a38b-d703-4552-a3b2-78e2bb1093b0.png#align=left&display=inline&height=633&margin=%5Bobject%20Object%5D&originHeight=633&originWidth=1129&size=0&status=done&style=none&width=1129" alt><br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445779-c15f3dba-9e4f-4a43-aa6a-da30699cb8ae.png#align=left&display=inline&height=554&margin=%5Bobject%20Object%5D&originHeight=554&originWidth=1243&size=0&status=done&style=none&width=1243" alt><br><a name="04dcb13e"></a></p><h4 id="9-2-1-商品维度表-全量"><a href="#9-2-1-商品维度表-全量" class="headerlink" title="9.2.1 商品维度表(全量)"></a>9.2.1 商品维度表(全量)</h4><ul><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__dim_sku_info</span><br><span class="line">    </span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__dim_sku_info&#96;(</span><br><span class="line">&#96;id&#96; string COMMENT &#39;商品 id&#39;,</span><br><span class="line">&#96;spu_id&#96; string COMMENT &#39;spuid&#39;,</span><br><span class="line">&#96;price&#96; double COMMENT &#39;商品价格&#39;,</span><br><span class="line">&#96;sku_name&#96; string COMMENT &#39;商品名称&#39;,</span><br><span class="line">&#96;sku_desc&#96; string COMMENT &#39;商品描述&#39;,</span><br><span class="line">&#96;weight&#96; double COMMENT &#39;重量&#39;,</span><br><span class="line">&#96;tm_id&#96; string COMMENT &#39;品牌 id&#39;,</span><br><span class="line">&#96;tm_name&#96; string COMMENT &#39;品牌名称&#39;,</span><br><span class="line">&#96;category3_id&#96; string COMMENT &#39;三级分类 id&#39;,</span><br><span class="line">&#96;category2_id&#96; string COMMENT &#39;二级分类 id&#39;,</span><br><span class="line">&#96;category1_id&#96; string COMMENT &#39;一级分类 id&#39;,</span><br><span class="line">&#96;category3_name&#96; string COMMENT &#39;三级分类名称&#39;,</span><br><span class="line">&#96;category2_name&#96; string COMMENT &#39;二级分类名称&#39;,</span><br><span class="line">&#96;category1_name&#96; string COMMENT &#39;一级分类名称&#39;,</span><br><span class="line">&#96;spu_name&#96; string COMMENT &#39;spu 名称&#39;,</span><br><span class="line">&#96;create_time&#96; string COMMENT &#39;创建时间&#39;</span><br><span class="line">  ) COMMENT &#39;商品维度表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;dim_sku_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">table_name&#x3D;dim_sku_info</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	sku.id,</span><br><span class="line">	sku.spu_id,</span><br><span class="line">	sku.price,</span><br><span class="line">	sku.sku_name,</span><br><span class="line">	sku.sku_desc,</span><br><span class="line">	sku.weight,</span><br><span class="line">	sku.tm_id,</span><br><span class="line">	ob.tm_name,</span><br><span class="line">	sku.category3_id,</span><br><span class="line">	c2.id category2_id,</span><br><span class="line">	c1.id category1_id,</span><br><span class="line">	c3.name category3_name,</span><br><span class="line">	c2.name category2_name,</span><br><span class="line">	c1.name category1_name,</span><br><span class="line">	spu.spu_name,</span><br><span class="line">	from_unixtime(cast(sku.create_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) create_time</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">select * from ods.mall__sku_info where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">)sku</span><br><span class="line">join</span><br><span class="line">(</span><br><span class="line">select * from ods.mall__base_trademark where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">)ob on sku.tm_id&#x3D;ob.tm_id</span><br><span class="line">join</span><br><span class="line">(</span><br><span class="line">select * from ods.mall__spu_info where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">)spu on spu.id &#x3D; sku.spu_id</span><br><span class="line">join</span><br><span class="line">(</span><br><span class="line">select * from ods.mall__base_category3 where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">)c3 on sku.category3_id&#x3D;c3.id</span><br><span class="line">join</span><br><span class="line">(</span><br><span class="line">select * from ods.mall__base_category2 where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">)c2 on c3.category2_id&#x3D;c2.id</span><br><span class="line">join</span><br><span class="line">(</span><br><span class="line">select * from ods.mall__base_category1 where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">)c1 on c2.category1_id&#x3D;c1.id;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="f6fa4154"></a></p><h4 id="9-2-2-优惠券信息维度表-全量"><a href="#9-2-2-优惠券信息维度表-全量" class="headerlink" title="9.2.2 优惠券信息维度表(全量)"></a>9.2.2 优惠券信息维度表(全量)</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__dim_coupon_info</span><br><span class="line">    </span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__dim_coupon_info&#96;(</span><br><span class="line">&#96;id&#96; string COMMENT &#39;购物券编号&#39;,</span><br><span class="line">&#96;coupon_name&#96; string COMMENT &#39;购物券名称&#39;,</span><br><span class="line">&#96;coupon_type&#96; string COMMENT &#39;购物券类型 1 现金券 2 折扣券 3 满减券 4 满件打折券&#39;,</span><br><span class="line">&#96;condition_amount&#96; string COMMENT &#39;满额数&#39;,</span><br><span class="line">&#96;condition_num&#96; string COMMENT &#39;满件数&#39;,</span><br><span class="line">&#96;activity_id&#96; string COMMENT &#39;活动编号&#39;,</span><br><span class="line">&#96;benefit_amount&#96; string COMMENT &#39;减金额&#39;,</span><br><span class="line">&#96;benefit_discount&#96; string COMMENT &#39;折扣&#39;,</span><br><span class="line">&#96;create_time&#96; string COMMENT &#39;创建时间&#39;,</span><br><span class="line">&#96;range_type&#96; string COMMENT &#39;范围类型 1、商品 2、品类 3、品牌&#39;,</span><br><span class="line">&#96;spu_id&#96; string COMMENT &#39;商品 id&#39;,</span><br><span class="line">&#96;tm_id&#96; string COMMENT &#39;品牌 id&#39;,</span><br><span class="line">&#96;category3_id&#96; string COMMENT &#39;品类 id&#39;,</span><br><span class="line">&#96;limit_num&#96; string COMMENT &#39;最多领用次数&#39;,</span><br><span class="line">&#96;operate_time&#96; string COMMENT &#39;修改时间&#39;,</span><br><span class="line">&#96;expire_time&#96; string COMMENT &#39;过期时间&#39;</span><br><span class="line">  ) COMMENT &#39;优惠券信息维度表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;dim_coupon_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">table_name&#x3D;dim_coupon_info</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	id,</span><br><span class="line">	coupon_name,</span><br><span class="line">	coupon_type,</span><br><span class="line">	condition_amount,</span><br><span class="line">	condition_num,</span><br><span class="line">	activity_id,</span><br><span class="line">	benefit_amount,</span><br><span class="line">	benefit_discount,</span><br><span class="line">	from_unixtime(cast(create_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) create_time,</span><br><span class="line">	range_type,</span><br><span class="line">	spu_id,</span><br><span class="line">	tm_id,</span><br><span class="line">	category3_id,</span><br><span class="line">	limit_num,</span><br><span class="line">	from_unixtime(cast(operate_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) operate_time,</span><br><span class="line">	from_unixtime(cast(expire_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) expire_time</span><br><span class="line">from ods.mall__coupon_info</span><br><span class="line">where dt&#x3D;&#39;$db_date&#39;;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="e5a0afd7"></a></p><h4 id="9-2-3-活动维度表-全量"><a href="#9-2-3-活动维度表-全量" class="headerlink" title="9.2.3 活动维度表(全量)"></a>9.2.3 活动维度表(全量)</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__dim_activity_info</span><br><span class="line">    </span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__dim_activity_info&#96;(</span><br><span class="line">&#96;id&#96; string COMMENT &#39;编号&#39;,</span><br><span class="line">&#96;activity_name&#96; string COMMENT &#39;活动名称&#39;,</span><br><span class="line">&#96;activity_type&#96; string COMMENT &#39;活动类型&#39;,</span><br><span class="line">&#96;condition_amount&#96; string COMMENT &#39;满减金额&#39;,</span><br><span class="line">&#96;condition_num&#96; string COMMENT &#39;满减件数&#39;,</span><br><span class="line">&#96;benefit_amount&#96; string COMMENT &#39;优惠金额&#39;,</span><br><span class="line">&#96;benefit_discount&#96; string COMMENT &#39;优惠折扣&#39;,</span><br><span class="line">&#96;benefit_level&#96; string COMMENT &#39;优惠级别&#39;,</span><br><span class="line">&#96;start_time&#96; string COMMENT &#39;开始时间&#39;,</span><br><span class="line">&#96;end_time&#96; string COMMENT &#39;结束时间&#39;,</span><br><span class="line">&#96;create_time&#96; string COMMENT &#39;创建时间&#39;</span><br><span class="line">  ) COMMENT &#39;活动维度表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;dim_activity_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">table_name&#x3D;dim_activity_info</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	info.id,</span><br><span class="line">	info.activity_name,</span><br><span class="line">	info.activity_type,</span><br><span class="line">	rule.condition_amount,</span><br><span class="line">	rule.condition_num,</span><br><span class="line">	rule.benefit_amount,</span><br><span class="line">	rule.benefit_discount,</span><br><span class="line">	rule.benefit_level,</span><br><span class="line">	from_unixtime(cast(info.start_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) start_time,</span><br><span class="line">	from_unixtime(cast(info.end_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) end_time,</span><br><span class="line">	from_unixtime(cast(info.create_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) create_time</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">select * from ods.mall__activity_info where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">)info</span><br><span class="line">left join</span><br><span class="line">(</span><br><span class="line">select * from ods.mall__activity_rule where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">)rule on info.id &#x3D; rule.activity_id;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="40a2f40c"></a></p><h4 id="9-2-4-地区维度表-特殊"><a href="#9-2-4-地区维度表-特殊" class="headerlink" title="9.2.4 地区维度表(特殊)"></a>9.2.4 地区维度表(特殊)</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__dim_base_province</span><br><span class="line">    </span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__dim_base_province&#96;(</span><br><span class="line">&#96;id&#96; string COMMENT &#39;id&#39;,</span><br><span class="line">&#96;province_name&#96; string COMMENT &#39;省市名称&#39;,</span><br><span class="line">&#96;area_code&#96; string COMMENT &#39;地区编码&#39;,</span><br><span class="line">&#96;iso_code&#96; string COMMENT &#39;ISO 编码&#39;,</span><br><span class="line">&#96;region_id&#96; string COMMENT &#39;地区 id&#39;,</span><br><span class="line">&#96;region_name&#96; string COMMENT &#39;地区名称&#39;</span><br><span class="line">  ) COMMENT &#39;地区维度表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;dim_base_province&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">table_name&#x3D;dim_base_province</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	bp.id,</span><br><span class="line">	bp.name,</span><br><span class="line">	bp.area_code,</span><br><span class="line">	bp.iso_code,</span><br><span class="line">	bp.region_id,</span><br><span class="line">	br.region_name</span><br><span class="line">from ods.mall__base_province bp</span><br><span class="line">join ods.mall__base_region br</span><br><span class="line">on bp.region_id&#x3D;br.id;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="6dc38b01"></a></p><h4 id="9-2-5-时间维度表-特殊"><a href="#9-2-5-时间维度表-特殊" class="headerlink" title="9.2.5 时间维度表(特殊)"></a>9.2.5 时间维度表(特殊)</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__dim_date_info</span><br><span class="line">    </span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__dim_date_info&#96;(</span><br><span class="line">&#96;date_id&#96; string COMMENT &#39;日&#39;,</span><br><span class="line">&#96;week_id&#96; int COMMENT &#39;周&#39;,</span><br><span class="line">&#96;week_day&#96; int COMMENT &#39;周的第几天&#39;,</span><br><span class="line">&#96;day&#96; int COMMENT &#39;每月的第几天&#39;,</span><br><span class="line">&#96;month&#96; int COMMENT &#39;第几月&#39;,</span><br><span class="line">&#96;quarter&#96; int COMMENT &#39;第几季度&#39;,</span><br><span class="line">&#96;year&#96; int COMMENT &#39;年&#39;,</span><br><span class="line">&#96;is_workday&#96; int COMMENT &#39;是否是周末&#39;,</span><br><span class="line">&#96;holiday_id&#96; int COMMENT &#39;是否是节假日&#39;</span><br><span class="line">  ) COMMENT &#39;时间维度表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;dim_date_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">table_name&#x3D;dim_date_info</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	date_id,</span><br><span class="line">	week_id,</span><br><span class="line">	week_day,</span><br><span class="line">	day,</span><br><span class="line">	month,</span><br><span class="line">	quarter,</span><br><span class="line">	year,</span><br><span class="line">	is_workday,</span><br><span class="line">	holiday_id</span><br><span class="line">from ods.mall__date_info</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="2d4b2961"></a></p><h4 id="9-2-6-用户维度表-新增及变化-缓慢变化维-拉链表"><a href="#9-2-6-用户维度表-新增及变化-缓慢变化维-拉链表" class="headerlink" title="9.2.6 用户维度表(新增及变化-缓慢变化维-拉链表)"></a>9.2.6 用户维度表(新增及变化-缓慢变化维-拉链表)</h4><p><a name="467596bc"></a></p><h5 id="9-2-6-1-拉链表介绍"><a href="#9-2-6-1-拉链表介绍" class="headerlink" title="9.2.6.1 拉链表介绍"></a>9.2.6.1 拉链表介绍</h5><blockquote><p>拉链表，记录每条信息的生命周期，一旦一条记录的生命周期结束，就重新开始一条新的记录，并把当前日期放入生效开始日期。<br>如果当前信息至今有效，在生效结束日期中填入一个极大值（如:9999-99-99）,下表为张三的手机号变化例子</p></blockquote></li></ul><table><thead><tr><th>用户ID</th><th>姓名</th><th>手机号</th><th>开始日期</th><th>结束日期</th></tr></thead><tbody><tr><td>1</td><td>张三</td><td>134XXXX5050</td><td>2019-01-01</td><td>2019-01-02</td></tr><tr><td>1</td><td>张三</td><td>139XXXX3232</td><td>2019-01-03</td><td>2020-01-01</td></tr><tr><td>1</td><td>张三</td><td>137XXXX7676</td><td>2020-01-02</td><td>9999-99-99</td></tr></tbody></table><ul><li><p>适合场景：数据会发生变化，但是大部分不变（即：缓慢变化维）</p><blockquote><p>比如：用户信息发生变化，但是每天变化比例不高，按照每日全量，则效率低</p></blockquote></li><li><p>如何使用拉链表：通过–&gt;生效开始日期&lt;=某个日期 且 生效结束日期&gt;=某个日期，能够得到某个时间点的数据全量切片。</p></li></ul><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445711-5342c8ec-2d69-476f-bb7d-80084793cdc7.png#align=left&display=inline&height=699&margin=%5Bobject%20Object%5D&originHeight=699&originWidth=1309&size=0&status=done&style=none&width=1309" alt></p><ul><li>拉链表形成过程</li></ul><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445446108-d1824bc2-adf7-4c28-bc32-71e8ba274913.png#align=left&display=inline&height=806&margin=%5Bobject%20Object%5D&originHeight=806&originWidth=1435&size=0&status=done&style=none&width=1435" alt></p><ul><li>制作流程<blockquote><p>用户当日全部数据和MySQL中每天变化的数据拼接在一起，形成一个&lt;新的临时拉链表。<br>用临时拉链表覆盖旧的拉链表数据。<br>从而解决Hive中数据不能更新的问题</p></blockquote></li></ul><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445740-8f05faaa-a871-4d74-9b27-f4fa1da7e452.png#align=left&display=inline&height=771&margin=%5Bobject%20Object%5D&originHeight=771&originWidth=1437&size=0&status=done&style=none&width=1437" alt><br><a name="ded0213a"></a></p><h5 id="9-2-6-2-用户维度表"><a href="#9-2-6-2-用户维度表" class="headerlink" title="9.2.6.2 用户维度表"></a>9.2.6.2 用户维度表</h5><blockquote><p>用户表中的数据每日既有可能新增，也有可能修改，属于缓慢变化维度，此处采用拉链表存储用户维度数据。</p></blockquote><ul><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__dim_user_info_his</span><br><span class="line">    </span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__dim_user_info_his&#96;(</span><br><span class="line">&#96;id&#96; string COMMENT &#39;用户 id&#39;,</span><br><span class="line">&#96;name&#96; string COMMENT &#39;姓名&#39;,</span><br><span class="line">&#96;birthday&#96; string COMMENT &#39;生日&#39;,</span><br><span class="line">&#96;gender&#96; string COMMENT &#39;性别&#39;,</span><br><span class="line">&#96;email&#96; string COMMENT &#39;邮箱&#39;,</span><br><span class="line">&#96;user_level&#96; string COMMENT &#39;用户等级&#39;,</span><br><span class="line">&#96;create_time&#96; string COMMENT &#39;创建时间&#39;,</span><br><span class="line">&#96;operate_time&#96; string COMMENT &#39;操作时间&#39;,</span><br><span class="line">&#96;start_date&#96; string COMMENT &#39;有效开始日期&#39;,</span><br><span class="line">&#96;end_date&#96; string COMMENT &#39;有效结束日期&#39;</span><br><span class="line">  ) COMMENT &#39;用户拉链表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;dim_user_info_his&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>临时表建表(结构与主表相同)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__dim_user_info_his_tmp</span><br><span class="line">    </span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__dim_user_info_his_tmp&#96;(</span><br><span class="line">&#96;id&#96; string COMMENT &#39;用户 id&#39;,</span><br><span class="line">&#96;name&#96; string COMMENT &#39;姓名&#39;,</span><br><span class="line">&#96;birthday&#96; string COMMENT &#39;生日&#39;,</span><br><span class="line">&#96;gender&#96; string COMMENT &#39;性别&#39;,</span><br><span class="line">&#96;email&#96; string COMMENT &#39;邮箱&#39;,</span><br><span class="line">&#96;user_level&#96; string COMMENT &#39;用户等级&#39;,</span><br><span class="line">&#96;create_time&#96; string COMMENT &#39;创建时间&#39;,</span><br><span class="line">&#96;operate_time&#96; string COMMENT &#39;操作时间&#39;,</span><br><span class="line">&#96;start_date&#96; string COMMENT &#39;有效开始日期&#39;,</span><br><span class="line">&#96;end_date&#96; string COMMENT &#39;有效结束日期&#39;</span><br><span class="line">  ) COMMENT &#39;用户拉链表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;dim_user_info_his_tmp&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>首先（主表）数据初始化，只做一次</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">table_name&#x3D;dim_user_info_his</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	id,</span><br><span class="line">	name,</span><br><span class="line">	from_unixtime(cast(birthday&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) birthday,</span><br><span class="line">	gender,</span><br><span class="line">	email,</span><br><span class="line">	user_level,</span><br><span class="line">	from_unixtime(cast(create_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) create_time,</span><br><span class="line">	from_unixtime(cast(operate_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) operate_time,</span><br><span class="line">	&#39;$db_date&#39;,</span><br><span class="line">	&#39;9999-99-99&#39;</span><br><span class="line">from ods.mall__user_info oi</span><br><span class="line">where oi.dt&#x3D;&#39;$db_date&#39;;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure></li><li><p>临时表数据计算导入(在主表数据之后执行)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">table_name&#x3D;dim_user_info_his_tmp</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">select</span><br><span class="line">* </span><br><span class="line">from</span><br><span class="line">(      --查询当前时间的所有信息</span><br><span class="line">	select</span><br><span class="line">		cast(id as string) id,</span><br><span class="line">		name,</span><br><span class="line">		from_unixtime(cast(birthday&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) birthday,</span><br><span class="line">		gender,</span><br><span class="line">		email,</span><br><span class="line">		user_level,</span><br><span class="line">		from_unixtime(cast(create_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) create_time,</span><br><span class="line">		from_unixtime(cast(operate_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) operate_time,</span><br><span class="line">		&#39;$db_date&#39; start_date,</span><br><span class="line">		&#39;9999-99-99&#39; end_date</span><br><span class="line">	from ods.mall__user_info where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">	union all</span><br><span class="line">	 --查询当前变化了的数据，修改日期</span><br><span class="line">	select</span><br><span class="line">		uh.id,</span><br><span class="line">		uh.name,</span><br><span class="line">		from_unixtime(cast(uh.birthday&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) birthday,</span><br><span class="line">		uh.gender,</span><br><span class="line">		uh.email,</span><br><span class="line">		uh.user_level,</span><br><span class="line">		from_unixtime(cast(uh.create_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) create_time,</span><br><span class="line">		from_unixtime(cast(uh.operate_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) operate_time,</span><br><span class="line">		uh.start_date,</span><br><span class="line">		if(ui.id is not null and uh.end_date&#x3D;&#39;9999-99-99&#39;, date_add(ui.dt,-1),uh.end_date) end_date</span><br><span class="line">	from dwd.mall__dim_user_info_his uh left join</span><br><span class="line">	(</span><br><span class="line">        --查询当前时间的所有信息</span><br><span class="line">	select</span><br><span class="line">		cast(id as string) id,</span><br><span class="line">		name,</span><br><span class="line">		from_unixtime(cast(birthday&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) birthday,</span><br><span class="line">		gender,</span><br><span class="line">		email,</span><br><span class="line">		user_level,</span><br><span class="line">		from_unixtime(cast(create_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) create_time,</span><br><span class="line">		from_unixtime(cast(operate_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) operate_time,</span><br><span class="line">		dt</span><br><span class="line">	from ods.mall__user_info</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">	) ui on uh.id&#x3D;ui.id</span><br><span class="line">)his</span><br><span class="line">order by his.id, start_date;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">table_name&#x3D;dim_user_info_his</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">select * from dwd.mall__dim_user_info_his_tmp;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="7bac56d4"></a></p><h4 id="9-2-7-订单详情事实表-事务型快照事实表-新增"><a href="#9-2-7-订单详情事实表-事务型快照事实表-新增" class="headerlink" title="9.2.7 订单详情事实表(事务型快照事实表-新增)"></a>9.2.7 订单详情事实表(事务型快照事实表-新增)</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__fact_order_detail</span><br><span class="line">    </span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__fact_order_detail&#96;(</span><br><span class="line">  &#96;id&#96; bigint COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;order_id&#96; bigint COMMENT &#39;订单编号&#39;,</span><br><span class="line">  &#96;user_id&#96; bigint COMMENT &#39;用户id&#39;,</span><br><span class="line">  &#96;sku_id&#96; bigint COMMENT &#39;sku_id&#39;,</span><br><span class="line">  &#96;sku_name&#96; string COMMENT &#39;sku名称&#39;,</span><br><span class="line">  &#96;order_price&#96; decimal(10,2) COMMENT &#39;购买价格(下单时sku价格）&#39;,</span><br><span class="line">  &#96;sku_num&#96; string COMMENT &#39;购买个数&#39;,</span><br><span class="line">  &#96;create_time&#96; bigint COMMENT &#39;创建时间&#39;,</span><br><span class="line">  &#96;province_id&#96; string COMMENT &#39;省份ID&#39;,</span><br><span class="line">  &#96;total_amount&#96; decimal(20,2) COMMENT &#39;订单总金额&#39;</span><br><span class="line">  ) COMMENT &#39;订单明细表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;fact_order_detail&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">table_name&#x3D;fact_order_detail</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	od.id, </span><br><span class="line">	od.order_id, </span><br><span class="line">	od.user_id, </span><br><span class="line">	od.sku_id, </span><br><span class="line">	od.sku_name, </span><br><span class="line">	od.order_price, </span><br><span class="line">	od.sku_num, </span><br><span class="line">	od.create_time, </span><br><span class="line">	oi.province_id, </span><br><span class="line">	od.order_price*od.sku_num </span><br><span class="line">from (select * from ods.mall__order_detail where dt&#x3D;&#39;$db_date&#39; ) od </span><br><span class="line">join (select * from ods.mall__order_info where dt&#x3D;&#39;$db_date&#39; ) oi </span><br><span class="line">on od.order_id&#x3D;oi.id;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="038064ea"></a></p><h4 id="9-2-7-支付事实表-事务型快照事实表-新增"><a href="#9-2-7-支付事实表-事务型快照事实表-新增" class="headerlink" title="9.2.7 支付事实表(事务型快照事实表-新增)"></a>9.2.7 支付事实表(事务型快照事实表-新增)</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__fact_payment_info</span><br><span class="line">    </span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__fact_payment_info&#96;(</span><br><span class="line">&#96;id&#96; string COMMENT &#39;&#39;,</span><br><span class="line">&#96;out_trade_no&#96; string COMMENT &#39;对外业务编号&#39;,</span><br><span class="line">&#96;order_id&#96; string COMMENT &#39;订单编号&#39;,</span><br><span class="line">&#96;user_id&#96; string COMMENT &#39;用户编号&#39;,</span><br><span class="line">&#96;alipay_trade_no&#96; string COMMENT &#39;支付宝交易流水编号&#39;,</span><br><span class="line">&#96;payment_amount&#96; decimal(16,2) COMMENT &#39;支付金额&#39;,</span><br><span class="line">&#96;subject&#96; string COMMENT &#39;交易内容&#39;,</span><br><span class="line">&#96;payment_type&#96; string COMMENT &#39;支付类型&#39;,</span><br><span class="line">&#96;payment_time&#96; string COMMENT &#39;支付时间&#39;,</span><br><span class="line">&#96;province_id&#96; string COMMENT &#39;省份 ID&#39;</span><br><span class="line">  ) COMMENT &#39;支付事实表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;fact_payment_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">table_name&#x3D;fact_payment_info</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	pi.id,</span><br><span class="line">	pi.out_trade_no,</span><br><span class="line">	pi.order_id,</span><br><span class="line">	pi.user_id,</span><br><span class="line">	pi.alipay_trade_no,</span><br><span class="line">	pi.total_amount,</span><br><span class="line">	pi.subject,</span><br><span class="line">	pi.payment_type,</span><br><span class="line">	from_unixtime(cast(pi.payment_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) payment_time,</span><br><span class="line">	oi.province_id</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">select * from ods.mall__payment_info where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">)pi</span><br><span class="line">join</span><br><span class="line">(</span><br><span class="line">select id, province_id from ods.mall__order_info where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">)oi</span><br><span class="line">on pi.order_id &#x3D; oi.id;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="ab3a3670"></a></p><h4 id="9-2-8-退款事实表-事务型快照事实表-新增"><a href="#9-2-8-退款事实表-事务型快照事实表-新增" class="headerlink" title="9.2.8 退款事实表(事务型快照事实表-新增)"></a>9.2.8 退款事实表(事务型快照事实表-新增)</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__fact_order_refund_info</span><br><span class="line">    </span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__fact_order_refund_info&#96;(</span><br><span class="line">&#96;id&#96; string COMMENT &#39;编号&#39;,</span><br><span class="line">&#96;user_id&#96; string COMMENT &#39;用户 ID&#39;,</span><br><span class="line">&#96;order_id&#96; string COMMENT &#39;订单 ID&#39;,</span><br><span class="line">&#96;sku_id&#96; string COMMENT &#39;商品 ID&#39;,</span><br><span class="line">&#96;refund_type&#96; string COMMENT &#39;退款类型&#39;,</span><br><span class="line">&#96;refund_num&#96; bigint COMMENT &#39;退款件数&#39;,</span><br><span class="line">&#96;refund_amount&#96; decimal(16,2) COMMENT &#39;退款金额&#39;,</span><br><span class="line">&#96;refund_reason_type&#96; string COMMENT &#39;退款原因类型&#39;,</span><br><span class="line">&#96;create_time&#96; string COMMENT &#39;退款时间&#39;</span><br><span class="line">  ) COMMENT &#39;退款事实表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;fact_order_refund_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">table_name&#x3D;fact_order_refund_info</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	id,</span><br><span class="line">	user_id,</span><br><span class="line">	order_id,</span><br><span class="line">	sku_id,</span><br><span class="line">	refund_type,</span><br><span class="line">	refund_num,</span><br><span class="line">	refund_amount,</span><br><span class="line">	refund_reason_type,</span><br><span class="line">	from_unixtime(cast(create_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) create_time</span><br><span class="line">from ods.mall__order_refund_info</span><br><span class="line">where dt&#x3D;&#39;$db_date&#39;;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="6fc9b5b6"></a></p><h4 id="9-2-9-评价事实表-事务型快照事实表-新增"><a href="#9-2-9-评价事实表-事务型快照事实表-新增" class="headerlink" title="9.2.9 评价事实表(事务型快照事实表-新增)"></a>9.2.9 评价事实表(事务型快照事实表-新增)</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__fact_comment_info</span><br><span class="line">    </span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__fact_comment_info&#96;(</span><br><span class="line">&#96;id&#96; string COMMENT &#39;编号&#39;,</span><br><span class="line">&#96;user_id&#96; string COMMENT &#39;用户 ID&#39;,</span><br><span class="line">&#96;sku_id&#96; string COMMENT &#39;商品 sku&#39;,</span><br><span class="line">&#96;spu_id&#96; string COMMENT &#39;商品 spu&#39;,</span><br><span class="line">&#96;order_id&#96; string COMMENT &#39;订单 ID&#39;,</span><br><span class="line">&#96;appraise&#96; string COMMENT &#39;评价&#39;,</span><br><span class="line">&#96;create_time&#96; string COMMENT &#39;评价时间&#39;</span><br><span class="line">  ) COMMENT &#39;评价事实表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;fact_comment_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">table_name&#x3D;fact_comment_info</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	id,</span><br><span class="line">	user_id,</span><br><span class="line">	sku_id,</span><br><span class="line">	spu_id,</span><br><span class="line">	order_id,</span><br><span class="line">	appraise,</span><br><span class="line">	from_unixtime(cast(create_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) create_time</span><br><span class="line">from ods.mall__comment_info</span><br><span class="line">where dt&#x3D;&#39;$db_date&#39;;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="823e5d60"></a></p><h4 id="9-2-10-加购事实表-周期型快照事实表-全量"><a href="#9-2-10-加购事实表-周期型快照事实表-全量" class="headerlink" title="9.2.10 加购事实表(周期型快照事实表-全量)"></a>9.2.10 加购事实表(周期型快照事实表-全量)</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__fact_cart_info</span><br><span class="line">    </span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__fact_cart_info&#96;(</span><br><span class="line">&#96;id&#96; string COMMENT &#39;编号&#39;,</span><br><span class="line">&#96;user_id&#96; string COMMENT &#39;用户 id&#39;,</span><br><span class="line">&#96;sku_id&#96; string COMMENT &#39;skuid&#39;,</span><br><span class="line">&#96;cart_price&#96; string COMMENT &#39;放入购物车时价格&#39;,</span><br><span class="line">&#96;sku_num&#96; string COMMENT &#39;数量&#39;,</span><br><span class="line">&#96;sku_name&#96; string COMMENT &#39;sku 名称 (冗余)&#39;,</span><br><span class="line">&#96;create_time&#96; string COMMENT &#39;创建时间&#39;,</span><br><span class="line">&#96;operate_time&#96; string COMMENT &#39;修改时间&#39;,</span><br><span class="line">&#96;is_ordered&#96; string COMMENT &#39;是否已经下单。1 为已下单;0 为未下单&#39;,</span><br><span class="line">&#96;order_time&#96; string COMMENT &#39;下单时间&#39;</span><br><span class="line">  ) COMMENT &#39;加购事实表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;fact_cart_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">table_name&#x3D;fact_cart_info</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	id,</span><br><span class="line">	user_id,</span><br><span class="line">	sku_id,</span><br><span class="line">	cart_price,</span><br><span class="line">	sku_num,</span><br><span class="line">	sku_name,</span><br><span class="line">	from_unixtime(cast(create_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) create_time,</span><br><span class="line">	from_unixtime(cast(operate_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) operate_time,</span><br><span class="line">	is_ordered,</span><br><span class="line">	from_unixtime(cast(order_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) order_time</span><br><span class="line">from ods.mall__cart_info</span><br><span class="line">where dt&#x3D;&#39;$db_date&#39;;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="2797a2b5"></a></p><h4 id="9-2-11-收藏事实表-周期型快照事实表-全量"><a href="#9-2-11-收藏事实表-周期型快照事实表-全量" class="headerlink" title="9.2.11 收藏事实表(周期型快照事实表-全量)"></a>9.2.11 收藏事实表(周期型快照事实表-全量)</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__fact_favor_info</span><br><span class="line">    </span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__fact_favor_info&#96;(</span><br><span class="line">&#96;id&#96; string COMMENT &#39;编号&#39;,</span><br><span class="line">&#96;user_id&#96; string COMMENT &#39;用户 id&#39;,</span><br><span class="line">&#96;sku_id&#96; string COMMENT &#39;skuid&#39;,</span><br><span class="line">&#96;spu_id&#96; string COMMENT &#39;spuid&#39;,</span><br><span class="line">&#96;is_cancel&#96; string COMMENT &#39;是否取消&#39;,</span><br><span class="line">&#96;create_time&#96; string COMMENT &#39;收藏时间&#39;,</span><br><span class="line">&#96;cancel_time&#96; string COMMENT &#39;取消时间&#39;</span><br><span class="line">  ) COMMENT &#39;收藏事实表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;fact_favor_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">table_name&#x3D;fact_favor_info</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	id,</span><br><span class="line">	user_id,</span><br><span class="line">	sku_id,</span><br><span class="line">	spu_id,</span><br><span class="line">	is_cancel,</span><br><span class="line">	from_unixtime(cast(create_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) create_time,</span><br><span class="line">	from_unixtime(cast(cancel_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;) cancel_time</span><br><span class="line">from ods.mall__favor_info</span><br><span class="line">where dt&#x3D;&#39;$db_date&#39;;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="6f2874af"></a></p><h4 id="9-2-12-优惠券领用事实表-累积型快照事实表-新增及变化"><a href="#9-2-12-优惠券领用事实表-累积型快照事实表-新增及变化" class="headerlink" title="9.2.12 优惠券领用事实表(累积型快照事实表-新增及变化)"></a>9.2.12 优惠券领用事实表(累积型快照事实表-新增及变化)</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__fact_coupon_use</span><br><span class="line">    </span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__fact_coupon_use&#96;(</span><br><span class="line">&#96;&#96; string COMMENT &#39;编号&#39;,</span><br><span class="line">&#96;coupon_id&#96; string COMMENT &#39;优惠券 ID&#39;,</span><br><span class="line">&#96;user_id&#96; string COMMENT &#39;userid&#39;,</span><br><span class="line">&#96;order_id&#96; string COMMENT &#39;订单 id&#39;,</span><br><span class="line">&#96;coupon_status&#96; string COMMENT &#39;优惠券状态&#39;,</span><br><span class="line">&#96;get_time&#96; string COMMENT &#39;领取时间&#39;,</span><br><span class="line">&#96;using_time&#96; string COMMENT &#39;使用时间(下单)&#39;,</span><br><span class="line">&#96;used_time&#96; string COMMENT &#39;使用时间(支付)&#39;</span><br><span class="line">  ) COMMENT &#39;优惠券领用事实表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;fact_coupon_use&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure><blockquote><p>dt 是按照优惠卷领用时间 get_time 做为分区。<br>get_time 为领用时间，领用过后数据就需要存在，然后在下单和支付的时候叠加更新时间</p></blockquote></li></ul><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445877-2b94e8bb-aec2-445a-bea1-1e80c6f64ace.png#align=left&display=inline&height=836&margin=%5Bobject%20Object%5D&originHeight=836&originWidth=1647&size=0&status=done&style=none&width=1647" alt></p><ul><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">table_name&#x3D;fact_coupon_use</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">set hive.exec.dynamic.partition.mode&#x3D;nonstrict;</span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	if(new.id is null,old.id,new.id) id,</span><br><span class="line">	if(new.coupon_id is null,old.coupon_id,new.coupon_id) coupon_id,</span><br><span class="line">	if(new.user_id is null,old.user_id,new.user_id) user_id,</span><br><span class="line">	if(new.order_id is null,old.order_id,new.order_id) order_id,</span><br><span class="line">	if(new.coupon_status is null,old.coupon_status,new.coupon_status) coupon_status,</span><br><span class="line">	from_unixtime(cast(if(new.get_time is null,old.get_time,new.get_time)&#x2F;1000 as bigint),&#39;yyyy-MM-dd&#39;) get_time,</span><br><span class="line">	from_unixtime(cast(if(new.using_time is null,old.using_time,new.using_time)&#x2F;1000 as bigint),&#39;yyyy-MM-dd&#39;) using_time,</span><br><span class="line">	from_unixtime(cast(if(new.used_time is null,old.used_time,new.used_time)&#x2F;1000 as bigint),&#39;yyyy-MM-dd&#39;),</span><br><span class="line">	from_unixtime(cast(if(new.get_time is null,old.get_time,new.get_time)&#x2F;1000 as bigint),&#39;yyyy-MM-dd&#39;) </span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		id,</span><br><span class="line">		coupon_id,</span><br><span class="line">		user_id,</span><br><span class="line">		order_id,</span><br><span class="line">		coupon_status,</span><br><span class="line">		get_time,</span><br><span class="line">		using_time,</span><br><span class="line">		used_time</span><br><span class="line">	from dwd.mall__fact_coupon_use</span><br><span class="line">	where dt in</span><br><span class="line">	(</span><br><span class="line">	select</span><br><span class="line">		from_unixtime(cast(get_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd&#39;)</span><br><span class="line">	from ods.mall__coupon_use</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">	)</span><br><span class="line">)old</span><br><span class="line">full outer join</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		id,</span><br><span class="line">		coupon_id,</span><br><span class="line">		user_id,</span><br><span class="line">		order_id,</span><br><span class="line">		coupon_status,</span><br><span class="line">		get_time,</span><br><span class="line">		using_time,</span><br><span class="line">		used_time</span><br><span class="line">	from ods.mall__coupon_use</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">)new</span><br><span class="line">on old.id&#x3D;new.id;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="3f232bd5"></a></p><h4 id="9-2-13-订单事实表-累积型快照事实表-新增及变化"><a href="#9-2-13-订单事实表-累积型快照事实表-新增及变化" class="headerlink" title="9.2.13 订单事实表(累积型快照事实表-新增及变化)"></a>9.2.13 订单事实表(累积型快照事实表-新增及变化)</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwd.mall__fact_order_info</span><br><span class="line">    </span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwd.mall__fact_order_info&#96;(</span><br><span class="line">&#96;id&#96; string COMMENT &#39;订单编号&#39;,</span><br><span class="line">&#96;order_status&#96; string COMMENT &#39;订单状态&#39;,</span><br><span class="line">&#96;user_id&#96; string COMMENT &#39;用户 id&#39;,</span><br><span class="line">&#96;out_trade_no&#96; string COMMENT &#39;支付流水号&#39;,</span><br><span class="line">&#96;create_time&#96; string COMMENT &#39;创建时间(未支付状态)&#39;,</span><br><span class="line">&#96;payment_time&#96; string COMMENT &#39;支付时间(已支付状态)&#39;,</span><br><span class="line">&#96;cancel_time&#96; string COMMENT &#39;取消时间(已取消状态)&#39;,</span><br><span class="line">&#96;finish_time&#96; string COMMENT &#39;完成时间(已完成状态)&#39;,</span><br><span class="line">&#96;refund_time&#96; string COMMENT &#39;退款时间(退款中状态)&#39;,</span><br><span class="line">&#96;refund_finish_time&#96; string COMMENT &#39;退款完成时间(退款完成状态)&#39;,</span><br><span class="line">&#96;province_id&#96; string COMMENT &#39;省份 ID&#39;,</span><br><span class="line">&#96;activity_id&#96; string COMMENT &#39;活动 ID&#39;,</span><br><span class="line">&#96;original_total_amount&#96; string COMMENT &#39;原价金额&#39;,</span><br><span class="line">&#96;benefit_reduce_amount&#96; string COMMENT &#39;优惠金额&#39;,</span><br><span class="line">&#96;feight_fee&#96; string COMMENT &#39;运费&#39;,</span><br><span class="line">&#96;final_total_amount&#96; decimal(10,2) COMMENT &#39;订单金额&#39;</span><br><span class="line">  ) COMMENT &#39;订单事实表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwd&#x2F;mall&#x2F;fact_order_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445836-498738cf-a65f-4127-af18-9a1661eda52d.png#align=left&display=inline&height=522&margin=%5Bobject%20Object%5D&originHeight=522&originWidth=987&size=0&status=done&style=none&width=987" alt></p></li><li><p>数据导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwd</span><br><span class="line">table_name&#x3D;fact_order_info</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	if(new.id is null,old.id,new.id),</span><br><span class="line">	if(new.order_status is null,old.order_status,new.order_status),</span><br><span class="line">	if(new.user_id is null,old.user_id,new.user_id),</span><br><span class="line">	if(new.out_trade_no is null,old.out_trade_no,new.out_trade_no),</span><br><span class="line">	if(new.tms[&#39;1001&#39;] is null,from_unixtime(cast(old.create_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;),new.tms[&#39;1001&#39;]),--1001 对应未支付状态</span><br><span class="line">	if(new.tms[&#39;1002&#39;] is null,from_unixtime(cast(old.payment_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;),new.tms[&#39;1002&#39;]),</span><br><span class="line">	if(new.tms[&#39;1003&#39;] is null,from_unixtime(cast(old.cancel_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;),new.tms[&#39;1003&#39;]),</span><br><span class="line">	if(new.tms[&#39;1004&#39;] is null,from_unixtime(cast(old.finish_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;),new.tms[&#39;1004&#39;]),</span><br><span class="line">	if(new.tms[&#39;1005&#39;] is null,from_unixtime(cast(old.refund_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;),new.tms[&#39;1005&#39;]),</span><br><span class="line">	if(new.tms[&#39;1006&#39;] is null,from_unixtime(cast(old.refund_finish_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd HH:mm:ss&#39;),new.tms[&#39;1006&#39;]),</span><br><span class="line">	if(new.province_id is null,old.province_id,new.province_id),</span><br><span class="line">	if(new.activity_id is null,old.activity_id,new.activity_id),</span><br><span class="line">	if(new.original_total_amount is null,old.original_total_amount,new.original_total_amount),</span><br><span class="line">	if(new.benefit_reduce_amount is null,old.benefit_reduce_amount,new.benefit_reduce_amount),</span><br><span class="line">	if(new.feight_fee is null,old.feight_fee,new.feight_fee),</span><br><span class="line">	if(new.final_total_amount is null,old.final_total_amount,new.final_total_amount)</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		id,</span><br><span class="line">		order_status,</span><br><span class="line">		user_id,</span><br><span class="line">		out_trade_no,</span><br><span class="line">		create_time,</span><br><span class="line">		payment_time,</span><br><span class="line">		cancel_time,</span><br><span class="line">		finish_time,</span><br><span class="line">		refund_time,</span><br><span class="line">		refund_finish_time,</span><br><span class="line">		province_id,</span><br><span class="line">		activity_id,</span><br><span class="line">		original_total_amount,</span><br><span class="line">		benefit_reduce_amount,</span><br><span class="line">		feight_fee,</span><br><span class="line">		final_total_amount</span><br><span class="line">	from dwd.mall__fact_order_info</span><br><span class="line">	where dt in </span><br><span class="line">	(</span><br><span class="line">	select</span><br><span class="line">		from_unixtime(cast(create_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd&#39;)</span><br><span class="line">	from ods.mall__order_info</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">	)</span><br><span class="line">)old</span><br><span class="line">full outer join</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		info.id,</span><br><span class="line">		info.order_status,</span><br><span class="line">		info.user_id,</span><br><span class="line">		info.out_trade_no,</span><br><span class="line">		info.province_id,</span><br><span class="line">		act.activity_id,</span><br><span class="line">		log.tms,</span><br><span class="line">		info.original_total_amount,</span><br><span class="line">		info.benefit_reduce_amount,</span><br><span class="line">		info.feight_fee,</span><br><span class="line">		info.final_total_amount</span><br><span class="line">	from</span><br><span class="line">	(</span><br><span class="line">	select</span><br><span class="line">		order_id,</span><br><span class="line">		str_to_map(concat_ws(&#39;,&#39;,collect_set(concat(order_status,&#39;&#x3D;&#39;,from_unixtime(cast(operate_time&#x2F;1000 as bigint),&#39;yyyy-MM-dd&#39;)))),&#39;,&#39;,&#39;&#x3D;&#39;)</span><br><span class="line">		tms</span><br><span class="line">	from ods.mall__order_status_log</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">	group by order_id</span><br><span class="line">	)log</span><br><span class="line">	join</span><br><span class="line">	(</span><br><span class="line">	select * from ods.mall__order_info where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">	)info</span><br><span class="line">	on log.order_id&#x3D;info.id</span><br><span class="line">	left join</span><br><span class="line">	(</span><br><span class="line">	select * from ods.mall__activity_order where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">	)act</span><br><span class="line">	on log.order_id&#x3D;act.order_id</span><br><span class="line">)new</span><br><span class="line">on old.id&#x3D;new.id;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="blogTitle37"></a></p><h2 id="10-DWS层构建"><a href="#10-DWS层构建" class="headerlink" title="10 DWS层构建"></a>10 DWS层构建</h2><blockquote><p>不在进行压缩处理，因为压缩对于硬盘是好的，但是对于CPU计算是差的，对于DWS层的表，会被经常使用，那么讲究的是计算效率，此层主要处理每日主题行为</p></blockquote></li></ul><p><a name="blogTitle38"></a></p><h3 id="10-1-每日设备行为-用户行为"><a href="#10-1-每日设备行为-用户行为" class="headerlink" title="10.1 每日设备行为(用户行为)"></a>10.1 每日设备行为(用户行为)</h3><ul><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dws.mall__uv_detail_daycount</span><br><span class="line">CREATE EXTERNAL TABLE &#96;dws.mall__uv_detail_daycount&#96;(</span><br><span class="line">&#96;mid_id&#96; string COMMENT &#39;设备唯一标识&#39;,</span><br><span class="line">&#96;user_id&#96; string COMMENT &#39;用户标识&#39;,</span><br><span class="line">&#96;version_code&#96; string COMMENT &#39;程序版本号&#39;,</span><br><span class="line">&#96;version_name&#96; string COMMENT &#39;程序版本名&#39;,</span><br><span class="line">&#96;lang&#96; string COMMENT &#39;系统语言&#39;,</span><br><span class="line">&#96;source&#96; string COMMENT &#39;渠道号&#39;,</span><br><span class="line">&#96;os&#96; string COMMENT &#39;安卓系统版本&#39;,</span><br><span class="line">&#96;area&#96; string COMMENT &#39;区域&#39;,</span><br><span class="line">&#96;model&#96; string COMMENT &#39;手机型号&#39;,</span><br><span class="line">&#96;brand&#96; string COMMENT &#39;手机品牌&#39;,</span><br><span class="line">&#96;sdk_version&#96; string COMMENT &#39;sdkVersion&#39;,</span><br><span class="line">&#96;gmail&#96; string COMMENT &#39;gmail&#39;,</span><br><span class="line">&#96;height_width&#96; string COMMENT &#39;屏幕宽高&#39;,</span><br><span class="line">&#96;app_time&#96; string COMMENT &#39;客户端日志产生时的时间&#39;,</span><br><span class="line">&#96;network&#96; string COMMENT &#39;网络模式&#39;,</span><br><span class="line">&#96;lng&#96; string COMMENT &#39;经度&#39;,</span><br><span class="line">&#96;lat&#96; string COMMENT &#39;纬度&#39;,</span><br><span class="line">&#96;login_count&#96; bigint COMMENT &#39;活跃次数&#39;</span><br><span class="line">  ) COMMENT &#39;每日设备行为表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dws&#x2F;mall&#x2F;uv_detail_daycount&#x2F;&#39;</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dws</span><br><span class="line">table_name&#x3D;uv_detail_daycount</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">PARTITION (dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	mid_id,</span><br><span class="line">	concat_ws(&#39;|&#39;, collect_set(user_id)) user_id,</span><br><span class="line">	concat_ws(&#39;|&#39;, collect_set(version_code)) version_code,</span><br><span class="line">	concat_ws(&#39;|&#39;, collect_set(version_name)) version_name,</span><br><span class="line">	concat_ws(&#39;|&#39;, collect_set(lang))lang,</span><br><span class="line">	concat_ws(&#39;|&#39;, collect_set(source)) source,</span><br><span class="line">	concat_ws(&#39;|&#39;, collect_set(os)) os,</span><br><span class="line">	concat_ws(&#39;|&#39;, collect_set(area)) area,</span><br><span class="line">	concat_ws(&#39;|&#39;, collect_set(model)) model,</span><br><span class="line">	concat_ws(&#39;|&#39;, collect_set(brand)) brand,</span><br><span class="line">	concat_ws(&#39;|&#39;, collect_set(sdk_version)) sdk_version,</span><br><span class="line">	concat_ws(&#39;|&#39;, collect_set(gmail)) gmail,</span><br><span class="line">	concat_ws(&#39;|&#39;, collect_set(height_width)) height_width,</span><br><span class="line">	concat_ws(&#39;|&#39;, collect_set(app_time)) app_time,</span><br><span class="line">	concat_ws(&#39;|&#39;, collect_set(network)) network,</span><br><span class="line">	concat_ws(&#39;|&#39;, collect_set(lng)) lng,</span><br><span class="line">	concat_ws(&#39;|&#39;, collect_set(lat)) lat,</span><br><span class="line">	count(*) login_count</span><br><span class="line">from dwd.mall__start_log</span><br><span class="line">where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">group by mid_id;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="blogTitle39"></a></p><h3 id="10-2-每日会员行为-业务"><a href="#10-2-每日会员行为-业务" class="headerlink" title="10.2 每日会员行为(业务)"></a>10.2 每日会员行为(业务)</h3></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dws.mall__user_action_daycount</span><br><span class="line">CREATE EXTERNAL TABLE &#96;dws.mall__user_action_daycount&#96;(</span><br><span class="line">user_id string comment &#39;用户 id&#39;,</span><br><span class="line">login_count bigint comment &#39;登录次数&#39;,</span><br><span class="line">cart_count bigint comment &#39;加入购物车次数&#39;,</span><br><span class="line">cart_amount double comment &#39;加入购物车金额&#39;,</span><br><span class="line">order_count bigint comment &#39;下单次数&#39;,</span><br><span class="line">order_amount decimal(16,2) comment &#39;下单金额&#39;,</span><br><span class="line">payment_count bigint comment &#39;支付次数&#39;,</span><br><span class="line">payment_amount decimal(16,2) comment &#39;支付金额&#39;</span><br><span class="line">  ) COMMENT &#39;每日会员行为表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dws&#x2F;mall&#x2F;user_action_daycount&#x2F;&#39;</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dws</span><br><span class="line">table_name&#x3D;user_action_daycount</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">with</span><br><span class="line">tmp_login as</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		user_id,</span><br><span class="line">		count(*) login_count</span><br><span class="line">	from dwd.mall__start_log</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">	and user_id is not null</span><br><span class="line">	group by user_id</span><br><span class="line">),</span><br><span class="line">tmp_cart as</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		user_id,</span><br><span class="line">		count(*) cart_count,</span><br><span class="line">		sum(cart_price*sku_num) cart_amount</span><br><span class="line">	from dwd.mall__fact_cart_info</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">	and user_id is not null</span><br><span class="line">	and date_format(create_time,&#39;yyyy-MM-dd&#39;)&#x3D;&#39;$db_date&#39;</span><br><span class="line">	group by user_id</span><br><span class="line">),</span><br><span class="line">tmp_order as</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		user_id,</span><br><span class="line">		count(*) order_count,</span><br><span class="line">		sum(final_total_amount) order_amount</span><br><span class="line">	from dwd.mall__fact_order_info</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">	group by user_id</span><br><span class="line">) ,</span><br><span class="line">tmp_payment as</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		user_id,</span><br><span class="line">		count(*) payment_count,</span><br><span class="line">		sum(payment_amount) payment_amount</span><br><span class="line">	from dwd.mall__fact_payment_info</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">	group by user_id</span><br><span class="line">)</span><br><span class="line">insert overwrite table $hive_table_name partition(dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	user_actions.user_id,</span><br><span class="line">	sum(user_actions.login_count),</span><br><span class="line">	sum(user_actions.cart_count),</span><br><span class="line">	sum(user_actions.cart_amount),</span><br><span class="line">	sum(user_actions.order_count),</span><br><span class="line">	sum(user_actions.order_amount),</span><br><span class="line">	sum(user_actions.payment_count),</span><br><span class="line">	sum(user_actions.payment_amount)</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		user_id,</span><br><span class="line">		login_count,</span><br><span class="line">		0 cart_count,</span><br><span class="line">		0 cart_amount,</span><br><span class="line">		0 order_count,</span><br><span class="line">		0 order_amount,</span><br><span class="line">		0 payment_count,</span><br><span class="line">		0 payment_amount</span><br><span class="line">	from</span><br><span class="line">	tmp_login</span><br><span class="line">union all</span><br><span class="line">	select</span><br><span class="line">		user_id,</span><br><span class="line">		0 login_count,</span><br><span class="line">		cart_count,</span><br><span class="line">		cart_amount,</span><br><span class="line">		0 order_count,</span><br><span class="line">		0 order_amount,</span><br><span class="line">		0 payment_count,</span><br><span class="line">		0 payment_amount</span><br><span class="line">	from</span><br><span class="line">	tmp_cart</span><br><span class="line">union all</span><br><span class="line">	select</span><br><span class="line">		user_id,</span><br><span class="line">		0 login_count,</span><br><span class="line">		0 cart_count,</span><br><span class="line">		0 cart_amount,</span><br><span class="line">		order_count,</span><br><span class="line">		order_amount,</span><br><span class="line">		0 payment_count,</span><br><span class="line">		0 payment_amount</span><br><span class="line">	from tmp_order</span><br><span class="line">union all</span><br><span class="line">	select</span><br><span class="line">		user_id,</span><br><span class="line">		0 login_count,</span><br><span class="line">		0 cart_count,</span><br><span class="line">		0 cart_amount,</span><br><span class="line">		0 order_count,</span><br><span class="line">		0 order_amount,</span><br><span class="line">		payment_count,</span><br><span class="line">		payment_amount</span><br><span class="line">	from tmp_payment</span><br><span class="line">) user_actions</span><br><span class="line">group by user_id;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="blogTitle40"></a></p><h3 id="10-3-每日商品行为-业务"><a href="#10-3-每日商品行为-业务" class="headerlink" title="10.3 每日商品行为(业务)"></a>10.3 每日商品行为(业务)</h3></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dws.mall__sku_action_daycount</span><br><span class="line">CREATE EXTERNAL TABLE &#96;dws.mall__sku_action_daycount&#96;(</span><br><span class="line">sku_id string comment &#39;sku_id&#39;,</span><br><span class="line">order_count bigint comment &#39;被下单次数&#39;,</span><br><span class="line">order_num bigint comment &#39;被下单件数&#39;,</span><br><span class="line">order_amount decimal(16,2) comment &#39;被下单金额&#39;,</span><br><span class="line">payment_count bigint comment &#39;被支付次数&#39;,</span><br><span class="line">payment_num bigint comment &#39;被支付件数&#39;,</span><br><span class="line">payment_amount decimal(16,2) comment &#39;被支付金额&#39;,</span><br><span class="line">refund_count bigint comment &#39;被退款次数&#39;,</span><br><span class="line">refund_num bigint comment &#39;被退款件数&#39;,</span><br><span class="line">refund_amount decimal(16,2) comment &#39;被退款金额&#39;,</span><br><span class="line">cart_count bigint comment &#39;被加入购物车次数&#39;,</span><br><span class="line">cart_num bigint comment &#39;被加入购物车件数&#39;,</span><br><span class="line">favor_count bigint comment &#39;被收藏次数&#39;,</span><br><span class="line">appraise_good_count bigint comment &#39;好评数&#39;,</span><br><span class="line">appraise_mid_count bigint comment &#39;中评数&#39;,</span><br><span class="line">appraise_bad_count bigint comment &#39;差评数&#39;,</span><br><span class="line">appraise_default_count bigint comment &#39;默认评价数&#39;</span><br><span class="line">  ) COMMENT &#39;每日商品行为表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dws&#x2F;mall&#x2F;sku_action_daycount&#x2F;&#39;</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dws</span><br><span class="line">table_name&#x3D;sku_action_daycount</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">with</span><br><span class="line">tmp_order as</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		cast(sku_id as string) sku_id,</span><br><span class="line">		count(*) order_count,</span><br><span class="line">		sum(sku_num) order_num,</span><br><span class="line">		sum(total_amount) order_amount</span><br><span class="line">	from dwd.mall__fact_order_detail</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">	group by sku_id</span><br><span class="line">),</span><br><span class="line">tmp_payment as</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		cast(sku_id as string) sku_id,</span><br><span class="line">		count(*) payment_count,</span><br><span class="line">		sum(sku_num) payment_num,</span><br><span class="line">		sum(total_amount) payment_amount</span><br><span class="line">	from dwd.mall__fact_order_detail</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">	and order_id in</span><br><span class="line">	(</span><br><span class="line">	select</span><br><span class="line">		id</span><br><span class="line">	from dwd.mall__fact_order_info</span><br><span class="line">	where (dt&#x3D;&#39;$db_date&#39; or dt&#x3D;date_add(&#39;$db_date&#39;,-1))</span><br><span class="line">	and date_format(payment_time,&#39;yyyy-MM-dd&#39;)&#x3D;&#39;$db_date&#39;</span><br><span class="line">	)</span><br><span class="line">	group by sku_id</span><br><span class="line">),</span><br><span class="line">tmp_refund as</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		cast(sku_id as string) sku_id,</span><br><span class="line">		count(*) refund_count,</span><br><span class="line">		sum(refund_num) refund_num,</span><br><span class="line">		sum(refund_amount) refund_amount</span><br><span class="line">	from dwd.mall__fact_order_refund_info</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">	group by sku_id</span><br><span class="line">),</span><br><span class="line">tmp_cart as</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		cast(sku_id as string) sku_id,</span><br><span class="line">		count(*) cart_count,</span><br><span class="line">		sum(sku_num) cart_num</span><br><span class="line">	from dwd.mall__fact_cart_info</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">	and date_format(create_time,&#39;yyyy-MM-dd&#39;)&#x3D;&#39;$db_date&#39;</span><br><span class="line">	group by sku_id</span><br><span class="line">),</span><br><span class="line">tmp_favor as</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		cast(sku_id as string) sku_id,</span><br><span class="line">		count(*) favor_count</span><br><span class="line">	from dwd.mall__fact_favor_info</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">	and date_format(create_time,&#39;yyyy-MM-dd&#39;)&#x3D;&#39;$db_date&#39;</span><br><span class="line">	group by sku_id</span><br><span class="line">),</span><br><span class="line">tmp_appraise as</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		cast(sku_id as string) sku_id,</span><br><span class="line">		sum(if(appraise&#x3D;&#39;1201&#39;,1,0)) appraise_good_count,</span><br><span class="line">		sum(if(appraise&#x3D;&#39;1202&#39;,1,0)) appraise_mid_count,</span><br><span class="line">		sum(if(appraise&#x3D;&#39;1203&#39;,1,0)) appraise_bad_count,</span><br><span class="line">		sum(if(appraise&#x3D;&#39;1204&#39;,1,0)) appraise_default_count</span><br><span class="line">	from dwd.mall__fact_comment_info</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">	group by sku_id</span><br><span class="line">)</span><br><span class="line">insert overwrite table $hive_table_name partition(dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	sku_id,</span><br><span class="line">	sum(order_count),</span><br><span class="line">	sum(order_num),</span><br><span class="line">	sum(order_amount),</span><br><span class="line">	sum(payment_count),</span><br><span class="line">	sum(payment_num),</span><br><span class="line">	sum(payment_amount),</span><br><span class="line">	sum(refund_count),</span><br><span class="line">	sum(refund_num),</span><br><span class="line">	sum(refund_amount),</span><br><span class="line">	sum(cart_count),</span><br><span class="line">	sum(cart_num),</span><br><span class="line">	sum(favor_count),</span><br><span class="line">	sum(appraise_good_count),</span><br><span class="line">	sum(appraise_mid_count),</span><br><span class="line">	sum(appraise_bad_count),</span><br><span class="line">	sum(appraise_default_count)</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		sku_id,</span><br><span class="line">		order_count,</span><br><span class="line">		order_num,</span><br><span class="line">		order_amount,</span><br><span class="line">		0 payment_count,</span><br><span class="line">		0 payment_num,</span><br><span class="line">		0 payment_amount,</span><br><span class="line">		0 refund_count,</span><br><span class="line">		0 refund_num,</span><br><span class="line">		0 refund_amount,</span><br><span class="line">		0 cart_count,</span><br><span class="line">		0 cart_num,</span><br><span class="line">		0 favor_count,</span><br><span class="line">		0 appraise_good_count,</span><br><span class="line">		0 appraise_mid_count,</span><br><span class="line">		0 appraise_bad_count,</span><br><span class="line">		0 appraise_default_count</span><br><span class="line">	from tmp_order</span><br><span class="line">union all</span><br><span class="line">	select</span><br><span class="line">		sku_id,</span><br><span class="line">		0 order_count,</span><br><span class="line">		0 order_num,</span><br><span class="line">		0 order_amount,</span><br><span class="line">		payment_count,</span><br><span class="line">		payment_num,</span><br><span class="line">		payment_amount,</span><br><span class="line">		0 refund_count,</span><br><span class="line">		0 refund_num,</span><br><span class="line">		0 refund_amount,</span><br><span class="line">		0 cart_count,</span><br><span class="line">		0 cart_num,</span><br><span class="line">		0 favor_count,</span><br><span class="line">		0 appraise_good_count,</span><br><span class="line">		0 appraise_mid_count,</span><br><span class="line">		0 appraise_bad_count,</span><br><span class="line">		0 appraise_default_count</span><br><span class="line">	from tmp_payment</span><br><span class="line">union all</span><br><span class="line">	select</span><br><span class="line">		sku_id,</span><br><span class="line">		0 order_count,</span><br><span class="line">		0 order_num,</span><br><span class="line">		0 order_amount,</span><br><span class="line">		0 payment_count,</span><br><span class="line">		0 payment_num,</span><br><span class="line">		0 payment_amount,</span><br><span class="line">		refund_count,</span><br><span class="line">		refund_num,</span><br><span class="line">		refund_amount,</span><br><span class="line">		0 cart_count,</span><br><span class="line">		0 cart_num,</span><br><span class="line">		0 favor_count,</span><br><span class="line">		0 appraise_good_count,</span><br><span class="line">		0 appraise_mid_count,</span><br><span class="line">		0 appraise_bad_count,</span><br><span class="line">		0 appraise_default_count</span><br><span class="line">	from tmp_refund</span><br><span class="line">union all</span><br><span class="line">	select</span><br><span class="line">		sku_id,</span><br><span class="line">		0 order_count,</span><br><span class="line">		0 order_num,</span><br><span class="line">		0 order_amount,</span><br><span class="line">		0 payment_count,</span><br><span class="line">		0 payment_num,</span><br><span class="line">		0 payment_amount,</span><br><span class="line">		0 refund_count,</span><br><span class="line">		0 refund_num,</span><br><span class="line">		0 refund_amount,</span><br><span class="line">		cart_count,</span><br><span class="line">		cart_num,</span><br><span class="line">		0 favor_count,</span><br><span class="line">		0 appraise_good_count,</span><br><span class="line">		0 appraise_mid_count,</span><br><span class="line">		0 appraise_bad_count,</span><br><span class="line">		0 appraise_default_count</span><br><span class="line">	from tmp_cart</span><br><span class="line">union all</span><br><span class="line">	select</span><br><span class="line">		sku_id,</span><br><span class="line">		0 order_count,</span><br><span class="line">		0 order_num,</span><br><span class="line">		0 order_amount,</span><br><span class="line">		0 payment_count,</span><br><span class="line">		0 payment_num,</span><br><span class="line">		0 payment_amount,</span><br><span class="line">		0 refund_count,</span><br><span class="line">		0 refund_num,</span><br><span class="line">		0 refund_amount,</span><br><span class="line">		0 cart_count,</span><br><span class="line">		0 cart_num,</span><br><span class="line">		favor_count,</span><br><span class="line">		0 appraise_good_count,</span><br><span class="line">		0 appraise_mid_count,</span><br><span class="line">		0 appraise_bad_count,</span><br><span class="line">		0 appraise_default_count</span><br><span class="line">	from tmp_favor</span><br><span class="line">union all</span><br><span class="line">	select</span><br><span class="line">		sku_id,</span><br><span class="line">		0 order_count,</span><br><span class="line">		0 order_num,</span><br><span class="line">		0 order_amount,</span><br><span class="line">		0 payment_count,</span><br><span class="line">		0 payment_num,</span><br><span class="line">		0 payment_amount,</span><br><span class="line">		0 refund_count,</span><br><span class="line">		0 refund_num,</span><br><span class="line">		0 refund_amount,</span><br><span class="line">		0 cart_count,</span><br><span class="line">		0 cart_num,</span><br><span class="line">		0 favor_count,</span><br><span class="line">		appraise_good_count,</span><br><span class="line">		appraise_mid_count,</span><br><span class="line">		appraise_bad_count,</span><br><span class="line">		appraise_default_count</span><br><span class="line">	from tmp_appraise</span><br><span class="line">)tmp</span><br><span class="line">group by sku_id;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="blogTitle41"></a></p><h3 id="10-4-每日优惠券统计-业务"><a href="#10-4-每日优惠券统计-业务" class="headerlink" title="10.4 每日优惠券统计(业务)"></a>10.4 每日优惠券统计(业务)</h3></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dws.mall__coupon_use_daycount</span><br><span class="line">CREATE EXTERNAL TABLE &#96;dws.mall__coupon_use_daycount&#96;(</span><br><span class="line">&#96;coupon_id&#96; string COMMENT &#39;优惠券 ID&#39;,</span><br><span class="line">&#96;coupon_name&#96; string COMMENT &#39;购物券名称&#39;,</span><br><span class="line">&#96;coupon_type&#96; string COMMENT &#39;购物券类型 1 现金券 2 折扣券 3 满减券 4 满件打折券&#39;,</span><br><span class="line">&#96;condition_amount&#96; string COMMENT &#39;满额数&#39;,</span><br><span class="line">&#96;condition_num&#96; string COMMENT &#39;满件数&#39;,</span><br><span class="line">&#96;activity_id&#96; string COMMENT &#39;活动编号&#39;,</span><br><span class="line">&#96;benefit_amount&#96; string COMMENT &#39;减金额&#39;,</span><br><span class="line">&#96;benefit_discount&#96; string COMMENT &#39;折扣&#39;,</span><br><span class="line">&#96;create_time&#96; string COMMENT &#39;创建时间&#39;,</span><br><span class="line">&#96;range_type&#96; string COMMENT &#39;范围类型 1、商品 2、品类 3、品牌&#39;,</span><br><span class="line">&#96;spu_id&#96; string COMMENT &#39;商品 id&#39;,</span><br><span class="line">&#96;tm_id&#96; string COMMENT &#39;品牌 id&#39;,</span><br><span class="line">&#96;category3_id&#96; string COMMENT &#39;品类 id&#39;,</span><br><span class="line">&#96;limit_num&#96; string COMMENT &#39;最多领用次数&#39;,</span><br><span class="line">&#96;get_count&#96; bigint COMMENT &#39;领用次数&#39;,</span><br><span class="line">&#96;using_count&#96; bigint COMMENT &#39;使用(下单)次数&#39;,</span><br><span class="line">&#96;used_count&#96; bigint COMMENT &#39;使用(支付)次数&#39;</span><br><span class="line">  ) COMMENT &#39;每日优惠券统计表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dws&#x2F;mall&#x2F;coupon_use_daycount&#x2F;&#39;</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dws</span><br><span class="line">table_name&#x3D;coupon_use_daycount</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name partition(dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	cu.coupon_id,</span><br><span class="line">	ci.coupon_name,</span><br><span class="line">	ci.coupon_type,</span><br><span class="line">	ci.condition_amount,</span><br><span class="line">	ci.condition_num,</span><br><span class="line">	ci.activity_id,</span><br><span class="line">	ci.benefit_amount,</span><br><span class="line">	ci.benefit_discount,</span><br><span class="line">	ci.create_time,</span><br><span class="line">	ci.range_type,</span><br><span class="line">	ci.spu_id,</span><br><span class="line">	ci.tm_id,</span><br><span class="line">	ci.category3_id,</span><br><span class="line">	ci.limit_num,</span><br><span class="line">	cu.get_count,</span><br><span class="line">	cu.using_count,</span><br><span class="line">	cu.used_count</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		coupon_id,</span><br><span class="line">		sum(if(date_format(get_time,&#39;yyyy-MM-dd&#39;)&#x3D;&#39;$db_date&#39;,1,0))</span><br><span class="line">		get_count,</span><br><span class="line">		sum(if(date_format(using_time,&#39;yyyy-MM-dd&#39;)&#x3D;&#39;$db_date&#39;,1,0))</span><br><span class="line">		using_count,</span><br><span class="line">		sum(if(date_format(used_time,&#39;yyyy-MM-dd&#39;)&#x3D;&#39;$db_date&#39;,1,0))</span><br><span class="line">		used_count</span><br><span class="line">	from dwd.mall__fact_coupon_use</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">	group by coupon_id</span><br><span class="line">)cu</span><br><span class="line">left join</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		*</span><br><span class="line">	from dwd.mall__dim_coupon_info</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">)ci on cu.coupon_id&#x3D;ci.id;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="blogTitle42"></a></p><h3 id="10-5-每日活动统计-业务"><a href="#10-5-每日活动统计-业务" class="headerlink" title="10.5 每日活动统计(业务)"></a>10.5 每日活动统计(业务)</h3></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dws.mall__activity_info_daycount</span><br><span class="line">CREATE EXTERNAL TABLE &#96;dws.mall__activity_info_daycount&#96;(</span><br><span class="line">&#96;id&#96; string COMMENT &#39;编号&#39;,</span><br><span class="line">&#96;activity_name&#96; string COMMENT &#39;活动名称&#39;,</span><br><span class="line">&#96;activity_type&#96; string COMMENT &#39;活动类型&#39;,</span><br><span class="line">&#96;start_time&#96; string COMMENT &#39;开始时间&#39;,</span><br><span class="line">&#96;end_time&#96; string COMMENT &#39;结束时间&#39;,</span><br><span class="line">&#96;create_time&#96; string COMMENT &#39;创建时间&#39;,</span><br><span class="line">&#96;order_count&#96; bigint COMMENT &#39;下单次数&#39;,</span><br><span class="line">&#96;payment_count&#96; bigint COMMENT &#39;支付次数&#39;</span><br><span class="line">  ) COMMENT &#39;每日活动统计表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dws&#x2F;mall&#x2F;activity_info_daycount&#x2F;&#39;</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dws</span><br><span class="line">table_name&#x3D;activity_info_daycount</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name partition(dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	oi.activity_id,</span><br><span class="line">	ai.activity_name,</span><br><span class="line">	ai.activity_type,</span><br><span class="line">	ai.start_time,</span><br><span class="line">	ai.end_time,</span><br><span class="line">	ai.create_time,</span><br><span class="line">	oi.order_count,</span><br><span class="line">	oi.payment_count</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		activity_id,</span><br><span class="line">		sum(if(date_format(create_time,&#39;yyyy-MM-dd&#39;)&#x3D;&#39;$db_date&#39;,1,0))</span><br><span class="line">		order_count,</span><br><span class="line">		sum(if(date_format(payment_time,&#39;yyyy-MM-dd&#39;)&#x3D;&#39;$db_date&#39;,1,0))</span><br><span class="line">		payment_count</span><br><span class="line">	from dwd.mall__fact_order_info</span><br><span class="line">	where (dt&#x3D;&#39;$db_date&#39; or dt&#x3D;date_add(&#39;$db_date&#39;,-1))</span><br><span class="line">	and activity_id is not null</span><br><span class="line">	group by activity_id</span><br><span class="line">)oi</span><br><span class="line">join</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		*</span><br><span class="line">	from dwd.mall__dim_activity_info</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">)ai</span><br><span class="line">on oi.activity_id&#x3D;ai.id;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="blogTitle43"></a></p><h3 id="10-6-每日购买行为-业务"><a href="#10-6-每日购买行为-业务" class="headerlink" title="10.6 每日购买行为(业务)"></a>10.6 每日购买行为(业务)</h3></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dws.mall__sale_detail_daycount</span><br><span class="line">CREATE EXTERNAL TABLE &#96;dws.mall__sale_detail_daycount&#96;(</span><br><span class="line">user_id string comment &#39;用户 id&#39;,</span><br><span class="line">sku_id string comment &#39;商品 id&#39;,</span><br><span class="line">user_gender string comment &#39;用户性别&#39;,</span><br><span class="line">user_age string comment &#39;用户年龄&#39;,</span><br><span class="line">user_level string comment &#39;用户等级&#39;,</span><br><span class="line">order_price decimal(10,2) comment &#39;商品价格&#39;,</span><br><span class="line">sku_name string comment &#39;商品名称&#39;,</span><br><span class="line">sku_tm_id string comment &#39;品牌 id&#39;,</span><br><span class="line">sku_category3_id string comment &#39;商品三级品类 id&#39;,</span><br><span class="line">sku_category2_id string comment &#39;商品二级品类 id&#39;,</span><br><span class="line">sku_category1_id string comment &#39;商品一级品类 id&#39;,</span><br><span class="line">sku_category3_name string comment &#39;商品三级品类名称&#39;,</span><br><span class="line">sku_category2_name string comment &#39;商品二级品类名称&#39;,</span><br><span class="line">sku_category1_name string comment &#39;商品一级品类名称&#39;,</span><br><span class="line">spu_id string comment &#39;商品 spu&#39;,</span><br><span class="line">sku_num int comment &#39;购买个数&#39;,</span><br><span class="line">order_count bigint comment &#39;当日下单单数&#39;,</span><br><span class="line">order_amount decimal(16,2) comment &#39;当日下单金额&#39;</span><br><span class="line">  ) COMMENT &#39;每日购买行为表&#39;</span><br><span class="line">PARTITIONED BY (</span><br><span class="line">  &#96;dt&#96; String COMMENT &#39;partition&#39;</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dws&#x2F;mall&#x2F;sale_detail_daycount&#x2F;&#39;</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dws</span><br><span class="line">table_name&#x3D;sale_detail_daycount</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name partition(dt&#x3D;&#39;$db_date&#39;)</span><br><span class="line">select</span><br><span class="line">	op.user_id,</span><br><span class="line">	op.sku_id,</span><br><span class="line">	ui.gender,</span><br><span class="line">	months_between(&#39;$db_date&#39;, ui.birthday)&#x2F;12 age,</span><br><span class="line">	ui.user_level,</span><br><span class="line">	si.price,</span><br><span class="line">	si.sku_name,</span><br><span class="line">	si.tm_id,</span><br><span class="line">	si.category3_id,</span><br><span class="line">	si.category2_id,</span><br><span class="line">	si.category1_id,</span><br><span class="line">	si.category3_name,</span><br><span class="line">	si.category2_name,</span><br><span class="line">	si.category1_name,</span><br><span class="line">	si.spu_id,</span><br><span class="line">	op.sku_num,</span><br><span class="line">	op.order_count,</span><br><span class="line">	op.order_amount</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		user_id,</span><br><span class="line">		sku_id,</span><br><span class="line">		sum(sku_num) sku_num,</span><br><span class="line">		count(*) order_count,</span><br><span class="line">		sum(total_amount) order_amount</span><br><span class="line">	from dwd.mall__fact_order_detail</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">	group by user_id, sku_id</span><br><span class="line">)op</span><br><span class="line">join</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		*</span><br><span class="line">	from dwd.mall__dim_user_info_his</span><br><span class="line">	where end_date&#x3D;&#39;9999-99-99&#39;</span><br><span class="line">)ui on op.user_id &#x3D; ui.id</span><br><span class="line">join</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		*</span><br><span class="line">	from dwd.mall__dim_sku_info</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">)si on op.sku_id &#x3D; si.id;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="blogTitle44"></a></p><h2 id="11-DWT层构建"><a href="#11-DWT层构建" class="headerlink" title="11 DWT层构建"></a>11 DWT层构建</h2><blockquote><p>此层主要针对dws层每日数据进行汇总，不建立分区，不压缩，每日进行数据覆盖</p></blockquote></li></ul><p><a name="blogTitle45"></a></p><h3 id="11-1-设备主题宽表"><a href="#11-1-设备主题宽表" class="headerlink" title="11.1 设备主题宽表"></a>11.1 设备主题宽表</h3><ul><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwt.mall__uv_topic</span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwt.mall__uv_topic&#96;(</span><br><span class="line">&#96;mid_id&#96; string COMMENT &#39;设备唯一标识&#39;,</span><br><span class="line">&#96;user_id&#96; string COMMENT &#39;用户标识&#39;,</span><br><span class="line">&#96;version_code&#96; string COMMENT &#39;程序版本号&#39;,</span><br><span class="line">&#96;version_name&#96; string COMMENT &#39;程序版本名&#39;,</span><br><span class="line">&#96;lang&#96; string COMMENT &#39;系统语言&#39;,</span><br><span class="line">&#96;source&#96; string COMMENT &#39;渠道号&#39;,</span><br><span class="line">&#96;os&#96; string COMMENT &#39;安卓系统版本&#39;,</span><br><span class="line">&#96;area&#96; string COMMENT &#39;区域&#39;,</span><br><span class="line">&#96;model&#96; string COMMENT &#39;手机型号&#39;,</span><br><span class="line">&#96;brand&#96; string COMMENT &#39;手机品牌&#39;,</span><br><span class="line">&#96;sdk_version&#96; string COMMENT &#39;sdkVersion&#39;,</span><br><span class="line">&#96;gmail&#96; string COMMENT &#39;gmail&#39;,</span><br><span class="line">&#96;height_width&#96; string COMMENT &#39;屏幕宽高&#39;,</span><br><span class="line">&#96;app_time&#96; string COMMENT &#39;客户端日志产生时的时间&#39;,</span><br><span class="line">&#96;network&#96; string  COMMENT &#39;网络模式&#39;,</span><br><span class="line">&#96;lng&#96; string COMMENT &#39;经度&#39;,</span><br><span class="line">&#96;lat&#96; string COMMENT &#39;纬度&#39;,</span><br><span class="line">&#96;login_date_first&#96; string comment &#39;首次活跃时间&#39;,</span><br><span class="line">&#96;login_date_last&#96; string comment &#39;末次活跃时间&#39;,</span><br><span class="line">&#96;login_day_count&#96; bigint comment &#39;当日活跃次数&#39;,</span><br><span class="line">&#96;login_count&#96; bigint comment &#39;累积活跃天数&#39;</span><br><span class="line">  ) COMMENT &#39;设备主题宽表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwt&#x2F;mall&#x2F;uv_topic&#x2F;&#39;</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwt</span><br><span class="line">table_name&#x3D;uv_topic</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	nvl(new.mid_id,old.mid_id),</span><br><span class="line">	nvl(new.user_id,old.user_id),</span><br><span class="line">	nvl(new.version_code,old.version_code),</span><br><span class="line">	nvl(new.version_name,old.version_name),</span><br><span class="line">	nvl(new.lang,old.lang),</span><br><span class="line">	nvl(new.source,old.source),</span><br><span class="line">	nvl(new.os,old.os),</span><br><span class="line">	nvl(new.area,old.area),</span><br><span class="line">	nvl(new.model,old.model),</span><br><span class="line">	nvl(new.brand,old.brand),</span><br><span class="line">	nvl(new.sdk_version,old.sdk_version),</span><br><span class="line">	nvl(new.gmail,old.gmail),</span><br><span class="line">	nvl(new.height_width,old.height_width),</span><br><span class="line">	nvl(new.app_time,old.app_time),</span><br><span class="line">	nvl(new.network,old.network),</span><br><span class="line">	nvl(new.lng,old.lng),</span><br><span class="line">	nvl(new.lat,old.lat),</span><br><span class="line">	if(old.mid_id is null,&#39;2020-03-10&#39;,old.login_date_first),</span><br><span class="line">	if(new.mid_id is not null,&#39;2020-03-10&#39;,old.login_date_last),</span><br><span class="line">	if(new.mid_id is not null, new.login_count,0),</span><br><span class="line">	nvl(old.login_count,0)+if(new.login_count&gt;0,1,0)</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		*</span><br><span class="line">	from dwt.mall__uv_topic</span><br><span class="line">)old</span><br><span class="line">full outer join</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		*</span><br><span class="line">	from dws.mall__uv_detail_daycount</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">)new</span><br><span class="line">on old.mid_id&#x3D;new.mid_id;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="blogTitle46"></a></p><h3 id="11-2-会员主题宽表"><a href="#11-2-会员主题宽表" class="headerlink" title="11.2 会员主题宽表"></a>11.2 会员主题宽表</h3></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwt.mall__user_topic</span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwt.mall__user_topic&#96;(</span><br><span class="line">user_id string comment &#39;用户 id&#39;,</span><br><span class="line">login_date_first string comment &#39;首次登录时间&#39;,</span><br><span class="line">login_date_last string comment &#39;末次登录时间&#39;,</span><br><span class="line">login_count bigint comment &#39;累积登录天数&#39;,</span><br><span class="line">login_last_30d_count bigint comment &#39;最近 30 日登录天数&#39;,</span><br><span class="line">order_date_first string comment &#39;首次下单时间&#39;,</span><br><span class="line">order_date_last string comment &#39;末次下单时间&#39;,</span><br><span class="line">order_count bigint comment &#39;累积下单次数&#39;,</span><br><span class="line">order_amount decimal(16,2) comment &#39;累积下单金额&#39;,</span><br><span class="line">order_last_30d_count bigint comment &#39;最近 30 日下单次数&#39;,</span><br><span class="line">order_last_30d_amount bigint comment &#39;最近 30 日下单金额&#39;,</span><br><span class="line">payment_date_first string comment &#39;首次支付时间&#39;,</span><br><span class="line">payment_date_last string comment &#39;末次支付时间&#39;,</span><br><span class="line">payment_count decimal(16,2) comment &#39;累积支付次数&#39;,</span><br><span class="line">payment_amount decimal(16,2) comment &#39;累积支付金额&#39;,</span><br><span class="line">payment_last_30d_count decimal(16,2) comment &#39;最近 30 日支付次数&#39;,</span><br><span class="line">payment_last_30d_amount decimal(16,2) comment &#39;最近 30 日支付金额&#39;</span><br><span class="line">  ) COMMENT &#39;会员主题宽表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwt&#x2F;mall&#x2F;user_topic&#x2F;&#39;</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwt</span><br><span class="line">table_name&#x3D;user_topic</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	nvl(new.user_id,old.user_id),</span><br><span class="line">	if(old.login_date_first is null and</span><br><span class="line">	new.login_count&gt;0,&#39;$db_date&#39;,old.login_date_first),</span><br><span class="line">	if(new.login_count&gt;0,&#39;$db_date&#39;,old.login_date_last),</span><br><span class="line">	nvl(old.login_count,0)+if(new.login_count&gt;0,1,0),</span><br><span class="line">	nvl(new.login_last_30d_count,0),</span><br><span class="line">	if(old.order_date_first is null and</span><br><span class="line">	new.order_count&gt;0,&#39;$db_date&#39;,old.order_date_first),</span><br><span class="line">	if(new.order_count&gt;0,&#39;$db_date&#39;,old.order_date_last),</span><br><span class="line">	nvl(old.order_count,0)+nvl(new.order_count,0),</span><br><span class="line">	nvl(old.order_amount,0)+nvl(new.order_amount,0),</span><br><span class="line">	nvl(new.order_last_30d_count,0),</span><br><span class="line">	nvl(new.order_last_30d_amount,0),</span><br><span class="line">	if(old.payment_date_first is null and</span><br><span class="line">	new.payment_count&gt;0,&#39;$db_date&#39;,old.payment_date_first),</span><br><span class="line">	if(new.payment_count&gt;0,&#39;$db_date&#39;,old.payment_date_last),</span><br><span class="line">	nvl(old.payment_count,0)+nvl(new.payment_count,0),</span><br><span class="line">	nvl(old.payment_amount,0)+nvl(new.payment_amount,0),</span><br><span class="line">	nvl(new.payment_last_30d_count,0),</span><br><span class="line">	nvl(new.payment_last_30d_amount,0)</span><br><span class="line">from</span><br><span class="line">dwt.mall__user_topic old</span><br><span class="line">full outer join</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		user_id,</span><br><span class="line">		sum(if(dt&#x3D;&#39;$db_date&#39;,login_count,0)) login_count,</span><br><span class="line">		sum(if(dt&#x3D;&#39;$db_date&#39;,order_count,0)) order_count,</span><br><span class="line">		sum(if(dt&#x3D;&#39;$db_date&#39;,order_amount,0)) order_amount,</span><br><span class="line">		sum(if(dt&#x3D;&#39;$db_date&#39;,payment_count,0)) payment_count,</span><br><span class="line">		sum(if(dt&#x3D;&#39;$db_date&#39;,payment_amount,0)) payment_amount,</span><br><span class="line">		sum(if(login_count&gt;0,1,0)) login_last_30d_count,</span><br><span class="line">		sum(order_count) order_last_30d_count,</span><br><span class="line">		sum(order_amount) order_last_30d_amount,</span><br><span class="line">		sum(payment_count) payment_last_30d_count,</span><br><span class="line">		sum(payment_amount) payment_last_30d_amount</span><br><span class="line">	from dws.mall__user_action_daycount</span><br><span class="line">	where dt&gt;&#x3D;date_add( &#39;$db_date&#39;,-30)</span><br><span class="line">	group by user_id</span><br><span class="line">)new</span><br><span class="line">on old.user_id&#x3D;new.user_id;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="blogTitle47"></a></p><h3 id="11-3-商品主题宽表"><a href="#11-3-商品主题宽表" class="headerlink" title="11.3 商品主题宽表"></a>11.3 商品主题宽表</h3></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwt.mall__sku_topic</span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwt.mall__sku_topic&#96;(</span><br><span class="line">sku_id string comment &#39;sku_id&#39;,</span><br><span class="line">spu_id string comment &#39;spu_id&#39;,</span><br><span class="line">order_last_30d_count bigint comment &#39;最近 30 日被下单次数&#39;,</span><br><span class="line">order_last_30d_num bigint comment &#39;最近 30 日被下单件数&#39;,</span><br><span class="line">order_last_30d_amount decimal(16,2) comment &#39;最近 30 日被下单金额&#39;,</span><br><span class="line">order_count bigint comment &#39;累积被下单次数&#39;,</span><br><span class="line">order_num bigint comment &#39;累积被下单件数&#39;,</span><br><span class="line">order_amount decimal(16,2) comment &#39;累积被下单金额&#39;,</span><br><span class="line">payment_last_30d_count bigint comment &#39;最近 30 日被支付次数&#39;,</span><br><span class="line">payment_last_30d_num bigint comment &#39;最近 30 日被支付件数&#39;,</span><br><span class="line">payment_last_30d_amount decimal(16,2) comment &#39;最近 30 日被支付金额&#39;,</span><br><span class="line">payment_count bigint comment &#39;累积被支付次数&#39;,</span><br><span class="line">payment_num bigint comment &#39;累积被支付件数&#39;,</span><br><span class="line">payment_amount decimal(16,2) comment &#39;累积被支付金额&#39;,</span><br><span class="line">refund_last_30d_count bigint comment &#39;最近三十日退款次数&#39;,</span><br><span class="line">refund_last_30d_num bigint comment &#39;最近三十日退款件数&#39;,</span><br><span class="line">refund_last_30d_amount decimal(10,2) comment &#39;最近三十日退款金额&#39;,</span><br><span class="line">refund_count bigint comment &#39;累积退款次数&#39;,</span><br><span class="line">refund_num bigint comment &#39;累积退款件数&#39;,</span><br><span class="line">refund_amount decimal(10,2) comment &#39;累积退款金额&#39;,</span><br><span class="line">cart_last_30d_count bigint comment &#39;最近 30 日被加入购物车次数&#39;,</span><br><span class="line">cart_last_30d_num bigint comment &#39;最近 30 日被加入购物车件数&#39;,</span><br><span class="line">cart_count bigint comment &#39;累积被加入购物车次数&#39;,</span><br><span class="line">cart_num bigint comment &#39;累积被加入购物车件数&#39;,</span><br><span class="line">favor_last_30d_count bigint comment &#39;最近 30 日被收藏次数&#39;,</span><br><span class="line">favor_count bigint comment &#39;累积被收藏次数&#39;,</span><br><span class="line">appraise_last_30d_good_count bigint comment &#39;最近 30 日好评数&#39;,</span><br><span class="line">appraise_last_30d_mid_count bigint comment &#39;最近 30 日中评数&#39;,</span><br><span class="line">appraise_last_30d_bad_count bigint comment &#39;最近 30 日差评数&#39;,</span><br><span class="line">appraise_last_30d_default_count bigint comment &#39;最近 30 日默认评价数&#39;,</span><br><span class="line">appraise_good_count bigint comment &#39;累积好评数&#39;,</span><br><span class="line">appraise_mid_count bigint comment &#39;累积中评数&#39;,</span><br><span class="line">appraise_bad_count bigint comment &#39;累积差评数&#39;,</span><br><span class="line">appraise_default_count bigint comment &#39;累积默认评价数&#39;</span><br><span class="line">  ) COMMENT &#39;商品主题宽表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwt&#x2F;mall&#x2F;sku_topic&#x2F;&#39;</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwt</span><br><span class="line">table_name&#x3D;sku_topic</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	nvl(new.sku_id,old.sku_id), sku_info.spu_id,</span><br><span class="line">	nvl(new.order_count30,0),</span><br><span class="line">	nvl(new.order_num30,0),</span><br><span class="line">	nvl(new.order_amount30,0),</span><br><span class="line">	nvl(old.order_count,0) + nvl(new.order_count,0),</span><br><span class="line">	nvl(old.order_num,0) + nvl(new.order_num,0),</span><br><span class="line">	nvl(old.order_amount,0) + nvl(new.order_amount,0),</span><br><span class="line">	nvl(new.payment_count30,0),</span><br><span class="line">	nvl(new.payment_num30,0),</span><br><span class="line">	nvl(new.payment_amount30,0),</span><br><span class="line">	nvl(old.payment_count,0) + nvl(new.payment_count,0),</span><br><span class="line">	nvl(old.payment_num,0) + nvl(new.payment_count,0),</span><br><span class="line">	nvl(old.payment_amount,0) + nvl(new.payment_count,0),</span><br><span class="line">	nvl(new.refund_count30,0),</span><br><span class="line">	nvl(new.refund_num30,0),</span><br><span class="line">	nvl(new.refund_amount30,0),</span><br><span class="line">	nvl(old.refund_count,0) + nvl(new.refund_count,0),</span><br><span class="line">	nvl(old.refund_num,0) + nvl(new.refund_num,0),</span><br><span class="line">	nvl(old.refund_amount,0) + nvl(new.refund_amount,0),</span><br><span class="line">	nvl(new.cart_count30,0),</span><br><span class="line">	nvl(new.cart_num30,0),</span><br><span class="line">	nvl(old.cart_count,0) + nvl(new.cart_count,0),</span><br><span class="line">	nvl(old.cart_num,0) + nvl(new.cart_num,0),</span><br><span class="line">	nvl(new.favor_count30,0),</span><br><span class="line">	nvl(old.favor_count,0) + nvl(new.favor_count,0),</span><br><span class="line">	nvl(new.appraise_good_count30,0),</span><br><span class="line">	nvl(new.appraise_mid_count30,0),</span><br><span class="line">	nvl(new.appraise_bad_count30,0),</span><br><span class="line">	nvl(new.appraise_default_count30,0) ,</span><br><span class="line">	nvl(old.appraise_good_count,0) + nvl(new.appraise_good_count,0),</span><br><span class="line">	nvl(old.appraise_mid_count,0) + nvl(new.appraise_mid_count,0),</span><br><span class="line">	nvl(old.appraise_bad_count,0) + nvl(new.appraise_bad_count,0),</span><br><span class="line">	nvl(old.appraise_default_count,0) + nvl(new.appraise_default_count,0)</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		sku_id,</span><br><span class="line">		spu_id,</span><br><span class="line">		order_last_30d_count,</span><br><span class="line">		order_last_30d_num,</span><br><span class="line">		order_last_30d_amount,</span><br><span class="line">		order_count,</span><br><span class="line">		order_num,</span><br><span class="line">		order_amount ,</span><br><span class="line">		payment_last_30d_count,</span><br><span class="line">		payment_last_30d_num,</span><br><span class="line">		payment_last_30d_amount,</span><br><span class="line">		payment_count,</span><br><span class="line">		payment_num,</span><br><span class="line">		payment_amount,</span><br><span class="line">		refund_last_30d_count,</span><br><span class="line">		refund_last_30d_num,</span><br><span class="line">		refund_last_30d_amount,</span><br><span class="line">		refund_count,</span><br><span class="line">		refund_num,</span><br><span class="line">		refund_amount,</span><br><span class="line">		cart_last_30d_count,</span><br><span class="line">		cart_last_30d_num,</span><br><span class="line">		cart_count,</span><br><span class="line">		cart_num,</span><br><span class="line">		favor_last_30d_count,</span><br><span class="line">		favor_count,</span><br><span class="line">		appraise_last_30d_good_count,</span><br><span class="line">		appraise_last_30d_mid_count,</span><br><span class="line">		appraise_last_30d_bad_count,</span><br><span class="line">		appraise_last_30d_default_count,</span><br><span class="line">		appraise_good_count,</span><br><span class="line">		appraise_mid_count,</span><br><span class="line">		appraise_bad_count,</span><br><span class="line">		appraise_default_count</span><br><span class="line">	from dwt.mall__sku_topic</span><br><span class="line">)old</span><br><span class="line">full outer join</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		sku_id,</span><br><span class="line">		sum(if(dt&#x3D;&#39;$db_date&#39;, order_count,0 )) order_count,</span><br><span class="line">		sum(if(dt&#x3D;&#39;$db_date&#39;,order_num ,0 )) order_num,</span><br><span class="line">		sum(if(dt&#x3D;&#39;$db_date&#39;,order_amount,0 )) order_amount ,</span><br><span class="line">		sum(if(dt&#x3D;&#39;$db_date&#39;,payment_count,0 )) payment_count,</span><br><span class="line">		sum(if(dt&#x3D;&#39;$db_date&#39;,payment_num,0 )) payment_num,</span><br><span class="line">		sum(if(dt&#x3D;&#39;$db_date&#39;,payment_amount,0 )) payment_amount,</span><br><span class="line">		sum(if(dt&#x3D;&#39;$db_date&#39;,refund_count,0 )) refund_count,</span><br><span class="line">		sum(if(dt&#x3D;&#39;$db_date&#39;,refund_num,0 )) refund_num,</span><br><span class="line">		sum(if(dt&#x3D;&#39;$db_date&#39;,refund_amount,0 )) refund_amount,</span><br><span class="line">		sum(if(dt&#x3D;&#39;$db_date&#39;,cart_count,0 )) cart_count,</span><br><span class="line">		sum(if(dt&#x3D;&#39;$db_date&#39;,cart_num,0 )) cart_num,</span><br><span class="line">		sum(if(dt&#x3D;&#39;$db_date&#39;,favor_count,0 )) favor_count,</span><br><span class="line">		sum(if(dt&#x3D;&#39;$db_date&#39;,appraise_good_count,0 )) appraise_good_count,</span><br><span class="line">		sum(if(dt&#x3D;&#39;$db_date&#39;,appraise_mid_count,0 ) ) appraise_mid_count ,</span><br><span class="line">		sum(if(dt&#x3D;&#39;$db_date&#39;,appraise_bad_count,0 )) appraise_bad_count,</span><br><span class="line">		sum(if(dt&#x3D;&#39;$db_date&#39;,appraise_default_count,0 )) appraise_default_count,</span><br><span class="line">		sum(order_count) order_count30 ,</span><br><span class="line">		sum(order_num) order_num30,</span><br><span class="line">		sum(order_amount) order_amount30,</span><br><span class="line">		sum(payment_count) payment_count30,</span><br><span class="line">		sum(payment_num) payment_num30,</span><br><span class="line">		sum(payment_amount) payment_amount30,</span><br><span class="line">		sum(refund_count) refund_count30,</span><br><span class="line">		sum(refund_num) refund_num30,</span><br><span class="line">		sum(refund_amount) refund_amount30,</span><br><span class="line">		sum(cart_count) cart_count30,</span><br><span class="line">		sum(cart_num) cart_num30,</span><br><span class="line">		sum(favor_count) favor_count30,</span><br><span class="line">		sum(appraise_good_count) appraise_good_count30,</span><br><span class="line">		sum(appraise_mid_count) appraise_mid_count30,</span><br><span class="line">		sum(appraise_bad_count) appraise_bad_count30,</span><br><span class="line">		sum(appraise_default_count) appraise_default_count30</span><br><span class="line">	from dws.mall__sku_action_daycount</span><br><span class="line">	where dt &gt;&#x3D; date_add (&#39;$db_date&#39;, -30)</span><br><span class="line">	group by sku_id</span><br><span class="line">)new</span><br><span class="line">on new.sku_id &#x3D; old.sku_id</span><br><span class="line">left join</span><br><span class="line">(</span><br><span class="line">	select * from dwd.mall__dim_sku_info where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">) sku_info</span><br><span class="line">on nvl(new.sku_id,old.sku_id)&#x3D; sku_info.id;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="blogTitle48"></a></p><h3 id="11-4-优惠卷主题宽表"><a href="#11-4-优惠卷主题宽表" class="headerlink" title="11.4 优惠卷主题宽表"></a>11.4 优惠卷主题宽表</h3></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwt.mall__coupon_topic</span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwt.mall__coupon_topic&#96;(</span><br><span class="line">&#96;coupon_id&#96; string COMMENT &#39;优惠券 ID&#39;,</span><br><span class="line">&#96;get_day_count&#96; bigint COMMENT &#39;当日领用次数&#39;,</span><br><span class="line">&#96;using_day_count&#96; bigint COMMENT &#39;当日使用(下单)次数&#39;,</span><br><span class="line">&#96;used_day_count&#96; bigint COMMENT &#39;当日使用(支付)次数&#39;,</span><br><span class="line">&#96;get_count&#96; bigint COMMENT &#39;累积领用次数&#39;,</span><br><span class="line">&#96;using_count&#96; bigint COMMENT &#39;累积使用(下单)次数&#39;,</span><br><span class="line">&#96;used_count&#96; bigint COMMENT &#39;累积使用(支付)次数&#39;</span><br><span class="line">  ) COMMENT &#39;优惠券主题宽表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwt&#x2F;mall&#x2F;coupon_topic&#x2F;&#39;</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwt</span><br><span class="line">table_name&#x3D;coupon_topic</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	nvl(new.coupon_id,old.coupon_id),</span><br><span class="line">	nvl(new.get_count,0),</span><br><span class="line">	nvl(new.using_count,0),</span><br><span class="line">	nvl(new.used_count,0),</span><br><span class="line">	nvl(old.get_count,0)+nvl(new.get_count,0),</span><br><span class="line">	nvl(old.using_count,0)+nvl(new.using_count,0),</span><br><span class="line">	nvl(old.used_count,0)+nvl(new.used_count,0)</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		*</span><br><span class="line">	from dwt.mall__coupon_topic</span><br><span class="line">)old</span><br><span class="line">full outer join</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		coupon_id,</span><br><span class="line">		get_count,</span><br><span class="line">		using_count,</span><br><span class="line">		used_count</span><br><span class="line">	from dws.mall__coupon_use_daycount</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">)new</span><br><span class="line">on old.coupon_id&#x3D;new.coupon_id;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="blogTitle49"></a></p><h3 id="11-5-活动主题宽表"><a href="#11-5-活动主题宽表" class="headerlink" title="11.5 活动主题宽表"></a>11.5 活动主题宽表</h3></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists dwt.mall__activity_topic</span><br><span class="line">CREATE EXTERNAL TABLE &#96;dwt.mall__activity_topic&#96;(</span><br><span class="line">&#96;id&#96; string COMMENT &#39;活动 id&#39;,</span><br><span class="line">&#96;activity_name&#96; string COMMENT &#39;活动名称&#39;,</span><br><span class="line">&#96;order_day_count&#96; bigint COMMENT &#39;当日日下单次数&#39;,</span><br><span class="line">&#96;payment_day_count&#96; bigint COMMENT &#39;当日支付次数&#39;,</span><br><span class="line">&#96;order_count&#96; bigint COMMENT &#39;累积下单次数&#39;,</span><br><span class="line">&#96;payment_count&#96; bigint COMMENT &#39;累积支付次数&#39;</span><br><span class="line">  ) COMMENT &#39;活动主题宽表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;dwt&#x2F;mall&#x2F;activity_topic&#x2F;&#39;</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;dwt</span><br><span class="line">table_name&#x3D;activity_topic</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert overwrite table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	nvl(new.id,old.id),</span><br><span class="line">	nvl(new.activity_name,old.activity_name),</span><br><span class="line">	nvl(new.order_count,0),</span><br><span class="line">	nvl(new.payment_count,0),</span><br><span class="line">	nvl(old.order_count,0)+nvl(new.order_count,0),</span><br><span class="line">	nvl(old.payment_count,0)+nvl(new.payment_count,0)</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		*</span><br><span class="line">	from dwt.mall__activity_topic</span><br><span class="line">)old</span><br><span class="line">full outer join</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		id,</span><br><span class="line">		activity_name,</span><br><span class="line">		order_count,</span><br><span class="line">		payment_count</span><br><span class="line">	from dws.mall__activity_info_daycount</span><br><span class="line">where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">)new</span><br><span class="line">on old.id&#x3D;new.id;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="blogTitle50"></a></p><h2 id="12-ADS层构建"><a href="#12-ADS层构建" class="headerlink" title="12 ADS层构建"></a>12 ADS层构建</h2><blockquote><p>此层为最终数据需求层，考虑数据导出和数据数量决定是否需要压缩，不需要分区，每天刷写</p></blockquote></li></ul><p><a name="blogTitle51"></a></p><h3 id="12-1-设备主题"><a href="#12-1-设备主题" class="headerlink" title="12.1 设备主题"></a>12.1 设备主题</h3><p><a name="39d05c99"></a></p><h4 id="12-1-1-活跃设备数（日、周、月）"><a href="#12-1-1-活跃设备数（日、周、月）" class="headerlink" title="12.1.1 活跃设备数（日、周、月）"></a>12.1.1 活跃设备数（日、周、月）</h4><blockquote><p>日活：当日活跃的设备数<br>周活：当周活跃的设备数<br>月活：当月活跃的设备数</p></blockquote><ul><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ads.mall__uv_count</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ads.mall__uv_count&#96;(</span><br><span class="line">&#96;dt&#96; string COMMENT &#39;统计日期&#39;,</span><br><span class="line">&#96;day_count&#96; bigint COMMENT &#39;当日用户数量&#39;,</span><br><span class="line">&#96;wk_count&#96; bigint COMMENT &#39;当周用户数量&#39;,</span><br><span class="line">&#96;mn_count&#96; bigint COMMENT &#39;当月用户数量&#39;,</span><br><span class="line">&#96;is_weekend&#96; string COMMENT &#39;Y,N 是否是周末,用于得到本周最终结果&#39;,</span><br><span class="line">&#96;is_monthend&#96; string COMMENT &#39;Y,N 是否是月末,用于得到本月最终结果&#39;</span><br><span class="line">  ) COMMENT &#39;活跃设备数表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ads&#x2F;mall&#x2F;uv_count&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;ads</span><br><span class="line">table_name&#x3D;uv_count</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert into table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	&#39;$db_date&#39; dt,</span><br><span class="line">	daycount.ct,</span><br><span class="line">	wkcount.ct,</span><br><span class="line">	mncount.ct,</span><br><span class="line">	if(date_add(next_day(&#39;$db_date&#39;,&#39;MO&#39;),-1)&#x3D;&#39;$db_date&#39;,&#39;Y&#39;,&#39;N&#39;) ,</span><br><span class="line">	if(last_day(&#39;$db_date&#39;)&#x3D;&#39;$db_date&#39;,&#39;Y&#39;,&#39;N&#39;)</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		&#39;$db_date&#39; dt,</span><br><span class="line">		count(*) ct</span><br><span class="line">	from dwt.mall__uv_topic</span><br><span class="line">	where login_date_last&#x3D;&#39;$db_date&#39;</span><br><span class="line">)daycount join</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">	&#39;$db_date&#39; dt,</span><br><span class="line">	count (*) ct</span><br><span class="line">	from dwt.mall__uv_topic</span><br><span class="line">	where login_date_last&gt;&#x3D;date_add(next_day(&#39;$db_date&#39;,&#39;MO&#39;),-7)</span><br><span class="line">	and login_date_last&lt;&#x3D; date_add(next_day(&#39;$db_date&#39;,&#39;MO&#39;),-1)</span><br><span class="line">) wkcount on daycount.dt&#x3D;wkcount.dt</span><br><span class="line">join</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		&#39;$db_date&#39; dt,</span><br><span class="line">		count (*) ct</span><br><span class="line">	from dwt.mall__uv_topic</span><br><span class="line">	where</span><br><span class="line">	date_format(login_date_last,&#39;yyyy-MM&#39;)&#x3D;date_format(&#39;$db_date&#39;,&#39;yyyy-MM&#39;)</span><br><span class="line">)mncount on daycount.dt&#x3D;mncount.dt;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="28015fa8"></a></p><h4 id="12-1-2-每日新增设备"><a href="#12-1-2-每日新增设备" class="headerlink" title="12.1.2 每日新增设备"></a>12.1.2 每日新增设备</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ads.mall__new_mid_count</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ads.mall__new_mid_count&#96;(</span><br><span class="line">&#96;create_date&#96; string comment &#39;创建时间&#39; ,</span><br><span class="line">&#96;new_mid_count&#96; bigint comment &#39;新增设备数量&#39;</span><br><span class="line">  ) COMMENT &#39;每日新增设备表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ads&#x2F;mall&#x2F;new_mid_count&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;ads</span><br><span class="line">table_name&#x3D;new_mid_count</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert into table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	login_date_first,</span><br><span class="line">	count(*)</span><br><span class="line">from dwt.mall__uv_topic</span><br><span class="line">where login_date_first&#x3D;&#39;$db_date&#39;</span><br><span class="line">group by login_date_first;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="cc741d26"></a></p><h4 id="12-1-3-沉默用户数"><a href="#12-1-3-沉默用户数" class="headerlink" title="12.1.3 沉默用户数"></a>12.1.3 沉默用户数</h4><blockquote><p>沉默用户：只在安装当天启动过，且启动时间是在 7 天前</p></blockquote></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ads.mall__silent_count</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ads.mall__silent_count&#96;(</span><br><span class="line">&#96;dt&#96; string COMMENT &#39;统计日期&#39;,</span><br><span class="line">&#96;silent_count&#96; bigint COMMENT &#39;沉默设备数&#39;</span><br><span class="line">  ) COMMENT &#39;沉默用户数表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ads&#x2F;mall&#x2F;silent_count&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;ads</span><br><span class="line">table_name&#x3D;silent_count</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert into table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	&#39;$db_date&#39;,</span><br><span class="line">	count(*)</span><br><span class="line">from dwt.mall__uv_topic</span><br><span class="line">where login_date_first&#x3D;login_date_last</span><br><span class="line">and login_date_last&lt;&#x3D;date_add(&#39;$db_date&#39;,-7);</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="1cb2adbb"></a></p><h4 id="12-1-4-本周回流用户数"><a href="#12-1-4-本周回流用户数" class="headerlink" title="12.1.4 本周回流用户数"></a>12.1.4 本周回流用户数</h4><blockquote><p>本周回流用户：上周未活跃，本周活跃的设备，且不是本周新增设备</p></blockquote></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ads.mall__back_count</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ads.mall__back_count&#96;(</span><br><span class="line">&#96;wk_dt&#96; string COMMENT &#39;统计日期所在周&#39;,</span><br><span class="line">&#96;wastage_count&#96; bigint COMMENT &#39;回流设备数&#39;</span><br><span class="line">  ) COMMENT &#39;本周回流用户数表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ads&#x2F;mall&#x2F;back_count&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;ads</span><br><span class="line">table_name&#x3D;back_count</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert into table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	&#39;$db_date&#39;,</span><br><span class="line">	count(*)</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		mid_id</span><br><span class="line">	from dwt.mall__uv_topic</span><br><span class="line">	where login_date_last&gt;&#x3D;date_add(next_day(&#39;$db_date&#39;,&#39;MO&#39;),-7)</span><br><span class="line">	and login_date_last&lt;&#x3D; date_add(next_day(&#39;$db_date&#39;,&#39;MO&#39;),-1)</span><br><span class="line">	and login_date_first&lt;date_add(next_day(&#39;$db_date&#39;,&#39;MO&#39;),-7)</span><br><span class="line">)current_wk</span><br><span class="line">left join</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		mid_id</span><br><span class="line">	from dws.mall__uv_detail_daycount</span><br><span class="line">	where dt&gt;&#x3D;date_add(next_day(&#39;$db_date&#39;,&#39;MO&#39;),-7*2)</span><br><span class="line">	and dt&lt;&#x3D; date_add(next_day(&#39;$db_date&#39;,&#39;MO&#39;),-7-1)</span><br><span class="line">	group by mid_id</span><br><span class="line">)last_wk</span><br><span class="line">on current_wk.mid_id&#x3D;last_wk.mid_id</span><br><span class="line">where last_wk.mid_id is null;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="30889b3f"></a></p><h4 id="12-1-5-流失用户数"><a href="#12-1-5-流失用户数" class="headerlink" title="12.1.5 流失用户数"></a>12.1.5 流失用户数</h4><blockquote><p>流失用户：最近 7 天未活跃的设备</p></blockquote></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ads.mall__wastage_count</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ads.mall__wastage_count&#96;(</span><br><span class="line">&#96;dt&#96; string COMMENT &#39;统计日期&#39;,</span><br><span class="line">&#96;wastage_count&#96; bigint COMMENT &#39;流失设备数&#39;</span><br><span class="line">  ) COMMENT &#39;流失用户数表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ads&#x2F;mall&#x2F;wastage_count&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;ads</span><br><span class="line">table_name&#x3D;wastage_count</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert into table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	&#39;$db_date&#39;,</span><br><span class="line">	count(*)</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		mid_id</span><br><span class="line">	from dwt.mall__uv_topic</span><br><span class="line">	where login_date_last&lt;&#x3D;date_add(&#39;$db_date&#39;,-7)</span><br><span class="line">	group by mid_id</span><br><span class="line">)t1;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="f3ba6663"></a></p><h4 id="12-1-6-留存率"><a href="#12-1-6-留存率" class="headerlink" title="12.1.6 留存率"></a>12.1.6 留存率</h4><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1596445445739-01d3c47c-ce57-475d-9b12-238c669b7f15.png#align=left&display=inline&height=412&margin=%5Bobject%20Object%5D&originHeight=412&originWidth=963&size=0&status=done&style=none&width=963" alt></p></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ads.mall__user_retention_day_rate</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ads.mall__user_retention_day_rate&#96;(</span><br><span class="line">&#96;stat_date&#96; string comment &#39;统计日期&#39;,</span><br><span class="line">&#96;create_date&#96; string comment &#39;设备新增日期&#39;,</span><br><span class="line">&#96;retention_day&#96; int comment &#39;截止当前日期留存天数&#39;,</span><br><span class="line">&#96;retention_count&#96; bigint comment &#39;留存数量&#39;,</span><br><span class="line">&#96;new_mid_count&#96; bigint comment &#39;设备新增数量&#39;,</span><br><span class="line">&#96;retention_ratio&#96; decimal(10,2) comment &#39;留存率&#39;</span><br><span class="line">  ) COMMENT &#39;留存率表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ads&#x2F;mall&#x2F;user_retention_day_rate&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;ads</span><br><span class="line">table_name&#x3D;user_retention_day_rate</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert into table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	&#39;$db_date&#39;,--统计日期</span><br><span class="line">	date_add(&#39;$db_date&#39;,-1),--新增日期</span><br><span class="line">	1,--留存天数</span><br><span class="line">	sum(if(login_date_first&#x3D;date_add(&#39;$db_date&#39;,-1) and</span><br><span class="line">	login_date_last&#x3D;&#39;$db_date&#39;,1,0)),--2020-03-09 的 1 日留存数</span><br><span class="line">	sum(if(login_date_first&#x3D;date_add(&#39;$db_date&#39;,-1),1,0)),--2020-03-09 新增</span><br><span class="line">	sum(if(login_date_first&#x3D;date_add(&#39;$db_date&#39;,-1) and</span><br><span class="line">	login_date_last&#x3D;&#39;$db_date&#39;,1,0))&#x2F;sum(if(login_date_first&#x3D;date_add(&#39;$db_date&#39;,-1),1,0))*100</span><br><span class="line">from dwt.mall__uv_topic</span><br><span class="line">union all</span><br><span class="line">select</span><br><span class="line">	&#39;$db_date&#39;,--统计日期</span><br><span class="line">	date_add(&#39;$db_date&#39;,-2),--新增日期</span><br><span class="line">	2,--留存天数</span><br><span class="line">	sum(if(login_date_first&#x3D;date_add(&#39;$db_date&#39;,-2) and</span><br><span class="line">	login_date_last&#x3D;&#39;$db_date&#39;,1,0)),--2020-03-08 的 2 日留存数</span><br><span class="line">	sum(if(login_date_first&#x3D;date_add(&#39;$db_date&#39;,-2),1,0)),--2020-03-08 新增</span><br><span class="line">	sum(if(login_date_first&#x3D;date_add(&#39;$db_date&#39;,-2) and</span><br><span class="line">	login_date_last&#x3D;&#39;$db_date&#39;,1,0))&#x2F;sum(if(login_date_first&#x3D;date_add(&#39;$db_date&#39;,-2),1,0))*100</span><br><span class="line">from dwt.mall__uv_topic</span><br><span class="line">union all</span><br><span class="line">select</span><br><span class="line">	&#39;$db_date&#39;,--统计日期</span><br><span class="line">	date_add(&#39;$db_date&#39;,-3),--新增日期</span><br><span class="line">	3,--留存天数</span><br><span class="line">	sum(if(login_date_first&#x3D;date_add(&#39;$db_date&#39;,-3) and</span><br><span class="line">	login_date_last&#x3D;&#39;$db_date&#39;,1,0)),--2020-03-07 的 3 日留存数</span><br><span class="line">	sum(if(login_date_first&#x3D;date_add(&#39;$db_date&#39;,-3),1,0)),--2020-03-07 新增</span><br><span class="line">	sum(if(login_date_first&#x3D;date_add(&#39;$db_date&#39;,-3) and</span><br><span class="line">	login_date_last&#x3D;&#39;$db_date&#39;,1,0))&#x2F;sum(if(login_date_first&#x3D;date_add(&#39;$db_date&#39;,-3),1,0))*100</span><br><span class="line">from dwt.mall__uv_topic;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="06478dde"></a></p><h4 id="12-1-7-最近连续三周活跃用户数"><a href="#12-1-7-最近连续三周活跃用户数" class="headerlink" title="12.1.7 最近连续三周活跃用户数"></a>12.1.7 最近连续三周活跃用户数</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ads.mall__continuity_wk_count</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ads.mall__continuity_wk_count&#96;(</span><br><span class="line">&#96;dt&#96; string COMMENT &#39;统计日期,一般用结束周周日日期,如果每天计算一次,可用当天日期&#39;,</span><br><span class="line">&#96;wk_dt&#96; string COMMENT &#39;持续时间&#39;,</span><br><span class="line">&#96;continuity_count&#96; bigint COMMENT &#39;活跃次数&#39;</span><br><span class="line">  ) COMMENT &#39;最近连续三周活跃用户数表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ads&#x2F;mall&#x2F;continuity_wk_count&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;ads</span><br><span class="line">table_name&#x3D;continuity_wk_count</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert into table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	&#39;$db_date&#39;,</span><br><span class="line">	concat(date_add(next_day(&#39;$db_date&#39;,&#39;MO&#39;),-7*3),&#39;_&#39;,date_add(next_day(&#39;$db_date&#39;,&#39;MO&#39;),-1)),</span><br><span class="line">	count(*)</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		mid_id</span><br><span class="line">	from</span><br><span class="line">	(</span><br><span class="line">		select</span><br><span class="line">			mid_id</span><br><span class="line">		from dws.mall__uv_detail_daycount</span><br><span class="line">		where dt&gt;&#x3D;date_add(next_day(&#39;$db_date&#39;,&#39;monday&#39;),-7)</span><br><span class="line">		and dt&lt;&#x3D;date_add(next_day(&#39;$db_date&#39;,&#39;monday&#39;),-1)</span><br><span class="line">		group by mid_id</span><br><span class="line">		union all</span><br><span class="line">		select</span><br><span class="line">			mid_id</span><br><span class="line">		from dws.mall__uv_detail_daycount</span><br><span class="line">		where dt&gt;&#x3D;date_add(next_day(&#39;$db_date&#39;,&#39;monday&#39;),-7*2)</span><br><span class="line">		and dt&lt;&#x3D;date_add(next_day(&#39;$db_date&#39;,&#39;monday&#39;),-7-1)</span><br><span class="line">		group by mid_id</span><br><span class="line">		union all</span><br><span class="line">		select</span><br><span class="line">			mid_id</span><br><span class="line">		from dws.mall__uv_detail_daycount</span><br><span class="line">		where dt&gt;&#x3D;date_add(next_day(&#39;$db_date&#39;,&#39;monday&#39;),-7*3)</span><br><span class="line">		and dt&lt;&#x3D;date_add(next_day(&#39;$db_date&#39;,&#39;monday&#39;),-7*2-1)</span><br><span class="line">		group by mid_id</span><br><span class="line">	)t1</span><br><span class="line">	group by mid_id</span><br><span class="line">	having count(*)&#x3D;3</span><br><span class="line">)t2</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="34c5f2dd"></a></p><h4 id="12-1-8-最近七天内连续三天活跃用户数"><a href="#12-1-8-最近七天内连续三天活跃用户数" class="headerlink" title="12.1.8 最近七天内连续三天活跃用户数"></a>12.1.8 最近七天内连续三天活跃用户数</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ads.mall__continuity_uv_count</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ads.mall__continuity_uv_count&#96;(</span><br><span class="line">&#96;dt&#96; string COMMENT &#39;统计日期&#39;,</span><br><span class="line">&#96;wk_dt&#96; string COMMENT &#39;最近 7 天日期&#39;,</span><br><span class="line">&#96;continuity_count&#96; bigint</span><br><span class="line">  ) COMMENT &#39;最近七天内连续三天活跃用户数表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ads&#x2F;mall&#x2F;continuity_uv_count&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;ads</span><br><span class="line">table_name&#x3D;continuity_uv_count</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert into table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	&#39;$db_date&#39;,</span><br><span class="line">	concat(date_add(&#39;db_date&#39;,-6),&#39;_&#39;,&#39;db_date&#39;),</span><br><span class="line">	count(*)</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">	select </span><br><span class="line">		mid_id</span><br><span class="line">	from</span><br><span class="line">	(</span><br><span class="line">		select </span><br><span class="line">			mid_id</span><br><span class="line">		from</span><br><span class="line">		(</span><br><span class="line">			select</span><br><span class="line">				mid_id,</span><br><span class="line">				date_sub(dt,rank) date_dif</span><br><span class="line">			from</span><br><span class="line">			(</span><br><span class="line">				select</span><br><span class="line">					mid_id,</span><br><span class="line">					dt,</span><br><span class="line">					rank() over(partition by mid_id order by dt) rank</span><br><span class="line">				from dws.mall__uv_detail_daycount</span><br><span class="line">				where dt&gt;&#x3D;date_add(&#39;db_date&#39;,-6) and</span><br><span class="line">				dt&lt;&#x3D;&#39;db_date&#39;</span><br><span class="line">			)t1</span><br><span class="line">		)t2</span><br><span class="line">		group by mid_id,date_dif</span><br><span class="line">		having count(*)&gt;&#x3D;3</span><br><span class="line">	)t3</span><br><span class="line">	group by mid_id</span><br><span class="line">)t4;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="blogTitle52"></a></p><h3 id="12-2-会员主题"><a href="#12-2-会员主题" class="headerlink" title="12.2 会员主题"></a>12.2 会员主题</h3><p><a name="497e0770"></a></p><h4 id="12-2-1-会员主题信息"><a href="#12-2-1-会员主题信息" class="headerlink" title="12.2.1 会员主题信息"></a>12.2.1 会员主题信息</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ads.mall__user_topic</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ads.mall__user_topic&#96;(</span><br><span class="line">&#96;dt&#96; string COMMENT &#39;统计日期&#39;,</span><br><span class="line">&#96;day_users&#96; string COMMENT &#39;活跃会员数&#39;,</span><br><span class="line">&#96;day_new_users&#96; string COMMENT &#39;新增会员数&#39;,</span><br><span class="line">&#96;day_new_payment_users&#96; string COMMENT &#39;新增消费会员数&#39;,</span><br><span class="line">&#96;payment_users&#96; string COMMENT &#39;总付费会员数&#39;,</span><br><span class="line">&#96;users&#96; string COMMENT &#39;总会员数&#39;,</span><br><span class="line">&#96;day_users2users&#96; decimal(10,2) COMMENT &#39;会员活跃率&#39;,</span><br><span class="line">&#96;payment_users2users&#96; decimal(10,2) COMMENT &#39;会员付费率&#39;,</span><br><span class="line">&#96;day_new_users2users&#96; decimal(10,2) COMMENT &#39;会员新鲜度&#39;</span><br><span class="line">  ) COMMENT &#39;会员主题信息表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ads&#x2F;mall&#x2F;user_topic&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;ads</span><br><span class="line">table_name&#x3D;user_topic</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert into table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	&#39;$db_date&#39;,</span><br><span class="line">	sum(if(login_date_last&#x3D;&#39;$db_date&#39;,1,0)),</span><br><span class="line">	sum(if(login_date_first&#x3D;&#39;$db_date&#39;,1,0)),</span><br><span class="line">	sum(if(payment_date_first&#x3D;&#39;$db_date&#39;,1,0)),</span><br><span class="line">	sum(if(payment_count&gt;0,1,0)),</span><br><span class="line">	count(*),</span><br><span class="line">	sum(if(login_date_last&#x3D;&#39;$db_date&#39;,1,0))&#x2F;count(*),</span><br><span class="line">	sum(if(payment_count&gt;0,1,0))&#x2F;count(*),</span><br><span class="line">	sum(if(login_date_first&#x3D;&#39;$db_date&#39;,1,0))&#x2F;sum(if(login_date_last&#x3D;&#39;$db_date&#39;,1,0))</span><br><span class="line">from dwt.mall__user_topic</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="c44b12bf"></a></p><h4 id="12-2-2-漏斗分析"><a href="#12-2-2-漏斗分析" class="headerlink" title="12.2.2 漏斗分析"></a>12.2.2 漏斗分析</h4><blockquote><p>统计“浏览-&gt;购物车-&gt;下单-&gt;支付”的转化率<br>思路：统计各个行为的人数，然后计算比值。</p></blockquote></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ads.mall__user_action_convert_day</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ads.mall__user_action_convert_day&#96;(</span><br><span class="line">&#96;dt&#96; string COMMENT &#39;统计日期&#39;,</span><br><span class="line">&#96;total_visitor_m_count&#96; bigint COMMENT &#39;总访问人数&#39;,</span><br><span class="line">&#96;cart_u_count&#96; bigint COMMENT &#39;加入购物车的人数&#39;,</span><br><span class="line">&#96;visitor2cart_convert_ratio&#96; decimal(10,2) COMMENT &#39;访问到加入购物车转化率&#39;,</span><br><span class="line">&#96;order_u_count&#96; bigint COMMENT &#39;下单人数&#39;,</span><br><span class="line">&#96;cart2order_convert_ratio&#96; decimal(10,2) COMMENT &#39;加入购物车到下单转化率&#39;,</span><br><span class="line">&#96;payment_u_count&#96; bigint COMMENT &#39;支付人数&#39;,</span><br><span class="line">&#96;order2payment_convert_ratio&#96; decimal(10,2) COMMENT &#39;下单到支付的转化率&#39;</span><br><span class="line">  ) COMMENT &#39;漏斗分析表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ads&#x2F;mall&#x2F;user_action_convert_day&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;ads</span><br><span class="line">table_name&#x3D;user_action_convert_day</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert into table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	&#39;$db_date&#39;,</span><br><span class="line">	uv.day_count,</span><br><span class="line">	ua.cart_count,</span><br><span class="line">	cast(ua.cart_count&#x2F;uv.day_count as decimal(10,2)) visitor2cart_convert_ratio,</span><br><span class="line">	ua.order_count,</span><br><span class="line">	cast(ua.order_count&#x2F;ua.cart_count as decimal(10,2)) visitor2order_convert_ratio,</span><br><span class="line">	ua.payment_count,</span><br><span class="line">	cast(ua.payment_count&#x2F;ua.order_count as decimal(10,2)) order2payment_convert_ratio</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		dt,</span><br><span class="line">		sum(if(cart_count&gt;0,1,0)) cart_count,</span><br><span class="line">		sum(if(order_count&gt;0,1,0)) order_count,</span><br><span class="line">		sum(if(payment_count&gt;0,1,0)) payment_count</span><br><span class="line">	from dws.mall__user_action_daycount</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">	group by dt</span><br><span class="line">)ua join ads.mall__uv_count uv on uv.dt&#x3D;ua.dt;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="blogTitle53"></a></p><h3 id="12-3-商品主题"><a href="#12-3-商品主题" class="headerlink" title="12.3 商品主题"></a>12.3 商品主题</h3><p><a name="732a2a9a"></a></p><h4 id="12-3-1-商品个数信息"><a href="#12-3-1-商品个数信息" class="headerlink" title="12.3.1 商品个数信息"></a>12.3.1 商品个数信息</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ads.mall__product_info</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ads.mall__product_info&#96;(</span><br><span class="line">&#96;dt&#96; string COMMENT &#39;统计日期&#39;,</span><br><span class="line">&#96;sku_num&#96; string COMMENT &#39;sku 个数&#39;,</span><br><span class="line">&#96;spu_num&#96; string COMMENT &#39;spu 个数&#39;</span><br><span class="line">  ) COMMENT &#39;商品个数信息表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ads&#x2F;mall&#x2F;product_info&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;ads</span><br><span class="line">table_name&#x3D;product_info</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert into table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	&#39;$db_date&#39; dt,</span><br><span class="line">	sku_num,</span><br><span class="line">	spu_num</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		&#39;$db_date&#39; dt,</span><br><span class="line">		count(*) sku_num</span><br><span class="line">	from</span><br><span class="line">	dwt.mall__sku_topic</span><br><span class="line">) tmp_sku_num</span><br><span class="line">join</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		&#39;$db_date&#39; dt,</span><br><span class="line">		count(*) spu_num</span><br><span class="line">	from</span><br><span class="line">	(</span><br><span class="line">		select</span><br><span class="line">			spu_id</span><br><span class="line">		from</span><br><span class="line">		dwt.mall__sku_topic</span><br><span class="line">		group by</span><br><span class="line">		spu_id</span><br><span class="line">	) tmp_spu_id</span><br><span class="line">) tmp_spu_num</span><br><span class="line">on</span><br><span class="line">tmp_sku_num.dt&#x3D;tmp_spu_num.dt;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="be51cd91"></a></p><h4 id="12-3-2-商品销量排行"><a href="#12-3-2-商品销量排行" class="headerlink" title="12.3.2 商品销量排行"></a>12.3.2 商品销量排行</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ads.mall__product_sale_topN</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ads.mall__product_sale_topN&#96;(</span><br><span class="line">&#96;dt&#96; string COMMENT &#39;统计日期&#39;,</span><br><span class="line">&#96;sku_num&#96; string COMMENT &#39;sku 个数&#39;,</span><br><span class="line">&#96;spu_num&#96; string COMMENT &#39;spu 个数&#39;</span><br><span class="line">  ) COMMENT &#39;商品销量排名表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ads&#x2F;mall&#x2F;product_sale_topN&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;ads</span><br><span class="line">table_name&#x3D;product_sale_topN</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert into table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	&#39;$db_date&#39; dt,</span><br><span class="line">	sku_id,</span><br><span class="line">	payment_amount</span><br><span class="line">from</span><br><span class="line">dws.mall__sku_action_daycount</span><br><span class="line">where</span><br><span class="line">dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">order by payment_amount desc</span><br><span class="line">limit 10;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="06076ff3"></a></p><h4 id="12-3-3-商品收藏排名"><a href="#12-3-3-商品收藏排名" class="headerlink" title="12.3.3 商品收藏排名"></a>12.3.3 商品收藏排名</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ads.mall__product_favor_topN</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ads.mall__product_favor_topN&#96;(</span><br><span class="line">&#96;dt&#96; string COMMENT &#39;统计日期&#39;,</span><br><span class="line">&#96;sku_id&#96; string COMMENT &#39;商品 ID&#39;,</span><br><span class="line">&#96;favor_count&#96; bigint COMMENT &#39;收藏量&#39;</span><br><span class="line">  ) COMMENT &#39;商品收藏排名表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ads&#x2F;mall&#x2F;product_favor_topN&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;ads</span><br><span class="line">table_name&#x3D;product_favor_topN</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert into table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	&#39;$db_date&#39; dt,</span><br><span class="line">	sku_id,</span><br><span class="line">	favor_count</span><br><span class="line">from</span><br><span class="line">dws.mall__sku_action_daycount</span><br><span class="line">where</span><br><span class="line">dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">order by favor_count desc</span><br><span class="line">limit 10;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="3a119480"></a></p><h4 id="12-3-4-商品加入购物车排名"><a href="#12-3-4-商品加入购物车排名" class="headerlink" title="12.3.4 商品加入购物车排名"></a>12.3.4 商品加入购物车排名</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ads.mall__product_cart_topN</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ads.mall__product_cart_topN&#96;(</span><br><span class="line">&#96;dt&#96; string COMMENT &#39;统计日期&#39;,</span><br><span class="line">&#96;sku_id&#96; string COMMENT &#39;商品 ID&#39;,</span><br><span class="line">&#96;cart_num&#96; bigint COMMENT &#39;加入购物车数量&#39;</span><br><span class="line">  ) COMMENT &#39;商品加入购物车排名表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ads&#x2F;mall&#x2F;product_cart_topN&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;ads</span><br><span class="line">table_name&#x3D;product_cart_topN</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert into table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	&#39;$db_date&#39; dt,</span><br><span class="line">	sku_id,</span><br><span class="line">	cart_num</span><br><span class="line">from</span><br><span class="line">dws.mall__sku_action_daycount</span><br><span class="line">where</span><br><span class="line">dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">order by cart_num desc</span><br><span class="line">limit 10;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="1f46c297"></a></p><h4 id="12-3-5-商品退款率排名（近30天）"><a href="#12-3-5-商品退款率排名（近30天）" class="headerlink" title="12.3.5 商品退款率排名（近30天）"></a>12.3.5 商品退款率排名（近30天）</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ads.mall__product_refund_topN</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ads.mall__product_refund_topN&#96;(</span><br><span class="line">&#96;dt&#96; string COMMENT &#39;统计日期&#39;,</span><br><span class="line">&#96;sku_id&#96; string COMMENT &#39;商品 ID&#39;,</span><br><span class="line">&#96;refund_ratio&#96; decimal(10,2) COMMENT &#39;退款率&#39;</span><br><span class="line">  ) COMMENT &#39;商品退款率排名(最近 30 天)表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ads&#x2F;mall&#x2F;product_refund_topN&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;ads</span><br><span class="line">table_name&#x3D;product_refund_topN</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert into table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	&#39;$db_date&#39;,</span><br><span class="line">	sku_id,</span><br><span class="line">	refund_last_30d_count&#x2F;payment_last_30d_count*100 refund_ratio</span><br><span class="line">from dwt.mall__sku_topic</span><br><span class="line">order by refund_ratio desc</span><br><span class="line">limit 10;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="e3f57ae4"></a></p><h4 id="12-3-6-商品差评率"><a href="#12-3-6-商品差评率" class="headerlink" title="12.3.6 商品差评率"></a>12.3.6 商品差评率</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ads.mall__appraise_bad_topN</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ads.mall__appraise_bad_topN&#96;(</span><br><span class="line">&#96;dt&#96; string COMMENT &#39;统计日期&#39;,</span><br><span class="line">&#96;sku_id&#96; string COMMENT &#39;商品 ID&#39;,</span><br><span class="line">&#96;appraise_bad_ratio&#96; decimal(10,2) COMMENT &#39;差评率&#39;</span><br><span class="line">  ) COMMENT &#39;商品差评率表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ads&#x2F;mall&#x2F;appraise_bad_topN&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;ads</span><br><span class="line">table_name&#x3D;appraise_bad_topN</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert into table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	&#39;$db_date&#39; dt,</span><br><span class="line">	sku_id,</span><br><span class="line">	appraise_bad_count&#x2F;(appraise_good_count+appraise_mid_count+appraise_bad_count+appraise_default_count) appraise_bad_ratio</span><br><span class="line">from</span><br><span class="line">dws.mall__sku_action_daycount</span><br><span class="line">where</span><br><span class="line">dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">order by appraise_bad_ratio desc</span><br><span class="line">limit 10;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="blogTitle54"></a></p><h3 id="12-4-营销主题"><a href="#12-4-营销主题" class="headerlink" title="12.4 营销主题"></a>12.4 营销主题</h3><p><a name="8caa923f"></a></p><h4 id="12-4-1-下单数目统计"><a href="#12-4-1-下单数目统计" class="headerlink" title="12.4.1 下单数目统计"></a>12.4.1 下单数目统计</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ads.mall__order_daycount</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ads.mall__order_daycount&#96;(</span><br><span class="line">dt string comment &#39;统计日期&#39;,</span><br><span class="line">order_count bigint comment &#39;单日下单笔数&#39;,</span><br><span class="line">order_amount bigint comment &#39;单日下单金额&#39;,</span><br><span class="line">order_users bigint comment &#39;单日下单用户数&#39;</span><br><span class="line">  ) COMMENT &#39;下单数目统计表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ads&#x2F;mall&#x2F;order_daycount&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;ads</span><br><span class="line">table_name&#x3D;order_daycount</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert into table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	&#39;$db_date&#39;,</span><br><span class="line">	sum(order_count),</span><br><span class="line">	sum(order_amount),</span><br><span class="line">	sum(if(order_count&gt;0,1,0))</span><br><span class="line">from dws.mall__user_action_daycount</span><br><span class="line">where dt&#x3D;&#39;$db_date&#39;;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="4e99b63e"></a></p><h4 id="12-4-2-支付信息统计"><a href="#12-4-2-支付信息统计" class="headerlink" title="12.4.2 支付信息统计"></a>12.4.2 支付信息统计</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ads.mall__payment_daycount</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ads.mall__payment_daycount&#96;(</span><br><span class="line">dt string comment &#39;统计日期&#39;,</span><br><span class="line">order_count bigint comment &#39;单日支付笔数&#39;,</span><br><span class="line">order_amount bigint comment &#39;单日支付金额&#39;,</span><br><span class="line">payment_user_count bigint comment &#39;单日支付人数&#39;,</span><br><span class="line">payment_sku_count bigint comment &#39;单日支付商品数&#39;,</span><br><span class="line">payment_avg_time double comment &#39;下单到支付的平均时长，取分钟数&#39;</span><br><span class="line">  ) COMMENT &#39;支付信息统计表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ads&#x2F;mall&#x2F;payment_daycount&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;ads</span><br><span class="line">table_name&#x3D;payment_daycount</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert into table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	tmp_payment.dt,</span><br><span class="line">	tmp_payment.payment_count,</span><br><span class="line">	tmp_payment.payment_amount,</span><br><span class="line">	tmp_payment.payment_user_count,</span><br><span class="line">	tmp_skucount.payment_sku_count,</span><br><span class="line">	tmp_time.payment_avg_time</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		&#39;$db_date&#39; dt,</span><br><span class="line">		sum(payment_count) payment_count,</span><br><span class="line">		sum(payment_amount) payment_amount,</span><br><span class="line">		sum(if(payment_count&gt;0,1,0)) payment_user_count</span><br><span class="line">	from dws.mall__user_action_daycount</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">)tmp_payment</span><br><span class="line">join</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		&#39;$db_date&#39; dt,</span><br><span class="line">		sum(if(payment_count&gt;0,1,0)) payment_sku_count</span><br><span class="line">	from dws.mall__sku_action_daycount</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">)tmp_skucount on tmp_payment.dt&#x3D;tmp_skucount.dt</span><br><span class="line">join</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		&#39;$db_date&#39; dt,</span><br><span class="line">		sum(unix_timestamp(payment_time)-unix_timestamp(create_time))&#x2F;count(*)&#x2F;60</span><br><span class="line">		payment_avg_time</span><br><span class="line">	from dwd.mall__fact_order_info</span><br><span class="line">	where dt&#x3D;&#39;$db_date&#39;</span><br><span class="line">	and payment_time is not null</span><br><span class="line">)tmp_time on tmp_payment.dt&#x3D;tmp_time.dt</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure><p><a name="c20ec38b"></a></p><h4 id="12-4-3-复购率"><a href="#12-4-3-复购率" class="headerlink" title="12.4.3 复购率"></a>12.4.3 复购率</h4></li><li><p>建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ads.mall__sale_tm_category1_stat_mn</span><br><span class="line">CREATE EXTERNAL TABLE &#96;ads.mall__sale_tm_category1_stat_mn&#96;(</span><br><span class="line">tm_id string comment &#39;品牌 id&#39;,</span><br><span class="line">category1_id string comment &#39;1 级品类 id &#39;,</span><br><span class="line">category1_name string comment &#39;1 级品类名称 &#39;,</span><br><span class="line">buycount bigint comment &#39;购买人数&#39;,</span><br><span class="line">buy_twice_last bigint comment &#39;两次以上购买人数&#39;,</span><br><span class="line">buy_twice_last_ratio decimal(10,2) comment &#39;单次复购率&#39;,</span><br><span class="line">buy_3times_last bigint comment &#39;三次以上购买人数&#39;,</span><br><span class="line">buy_3times_last_ratio decimal(10,2) comment &#39;多次复购率&#39;,</span><br><span class="line">stat_mn string comment &#39;统计月份&#39;,</span><br><span class="line">stat_date string comment &#39;统计日期&#39;</span><br><span class="line">  ) COMMENT &#39;复购率表&#39;</span><br><span class="line">row format delimited fields terminated by &#39;\t&#39;</span><br><span class="line">stored as parquet</span><br><span class="line">location &#39;&#x2F;warehouse&#x2F;ads&#x2F;mall&#x2F;sale_tm_category1_stat_mn&#x2F;&#39;</span><br><span class="line">tblproperties (&quot;parquet.compression&quot;&#x3D;&quot;snappy&quot;)</span><br></pre></td></tr></table></figure></li><li><p>导入数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">db_date&#x3D;$&#123;date&#125;</span><br><span class="line">hive&#x3D;&#x2F;opt&#x2F;cloudera&#x2F;parcels&#x2F;CDH-6.2.0-1.cdh6.2.0.p0.967373&#x2F;bin&#x2F;hive</span><br><span class="line">APP1&#x3D;mall</span><br><span class="line">APP2&#x3D;ads</span><br><span class="line">table_name&#x3D;sale_tm_category1_stat_mn</span><br><span class="line">hive_table_name&#x3D;$APP2.mall__$table_name</span><br><span class="line"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span><br><span class="line">if [ -n &quot;$&#123;date&#125;&quot; ] ;then</span><br><span class="line">        db_date&#x3D;$&#123;date&#125;</span><br><span class="line">else </span><br><span class="line">        db_date&#x3D;&#96;date -d &quot;-1 day&quot; +%F&#96;</span><br><span class="line">fi</span><br><span class="line">sql&#x3D;&quot; </span><br><span class="line">insert into table $hive_table_name</span><br><span class="line">select</span><br><span class="line">	mn.sku_tm_id,</span><br><span class="line">	mn.sku_category1_id,</span><br><span class="line">	mn.sku_category1_name,</span><br><span class="line">	sum(if(mn.order_count&gt;&#x3D;1,1,0)) buycount,</span><br><span class="line">	sum(if(mn.order_count&gt;&#x3D;2,1,0)) buyTwiceLast,</span><br><span class="line">	sum(if(mn.order_count&gt;&#x3D;2,1,0))&#x2F;sum( if(mn.order_count&gt;&#x3D;1,1,0)) buyTwiceLastRatio,</span><br><span class="line">	sum(if(mn.order_count&gt;&#x3D;3,1,0)) buy3timeLast ,</span><br><span class="line">	sum(if(mn.order_count&gt;&#x3D;3,1,0))&#x2F;sum( if(mn.order_count&gt;&#x3D;1,1,0)) buy3timeLastRatio,</span><br><span class="line">	date_format(&#39;$db_date&#39; ,&#39;yyyy-MM&#39;) stat_mn,</span><br><span class="line">	&#39;$db_date&#39; stat_date</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">	select</span><br><span class="line">		user_id,</span><br><span class="line">		sd.sku_tm_id,</span><br><span class="line">		sd.sku_category1_id,</span><br><span class="line">		sd.sku_category1_name,</span><br><span class="line">		sum(order_count) order_count</span><br><span class="line">	from dws.mall__sale_detail_daycount sd</span><br><span class="line">	where date_format(dt,&#39;yyyy-MM&#39;)&#x3D;date_format(&#39;$db_date&#39; ,&#39;yyyy-MM&#39;)</span><br><span class="line">	group by user_id, sd.sku_tm_id, sd.sku_category1_id, sd.sku_category1_name</span><br><span class="line">) mn</span><br><span class="line">group by mn.sku_tm_id, mn.sku_category1_id, mn.sku_category1_name;</span><br><span class="line">&quot;</span><br><span class="line">$hive -e &quot;$sql&quot;</span><br></pre></td></tr></table></figure></li></ul></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="cpeixin.cn/2020/07/07/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E8%B6%85%E8%AF%A6%E7%BB%86%E6%A1%88%E4%BE%8B/" title="数据仓库超详细案例" target="_blank" rel="external">cpeixin.cn/2020/07/07/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E8%B6%85%E8%AF%A6%E7%BB%86%E6%A1%88%E4%BE%8B/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external nofollow noopener noreferrer">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://github.com/cpeixin" target="_blank" class="img-burn thumb-sm visible-lg" rel="external nofollow noopener noreferrer"><img src="/images/avatar.jpg" class="img-rounded w-full" alt></a></div><div class="media-body"><h3 class="media-heading"><a href="https://github.com/cpeixin" target="_blank" rel="external nofollow noopener noreferrer"><span class="text-dark">Brent</span><small class="ml-1x">大数据工程师 &amp; 机器学习</small></a></h3><div>一心九用的工程师</div></div></figure></div></div></div></article><section id="comments"><div id="vcomments"></div></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/2020/07/21/HBase-RowKey%E8%AE%BE%E8%AE%A1/" title="HBase RowKey设计"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a></li><li class="next"><a href="/2020/06/18/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B4%A2%E5%BC%95-B-%E6%A0%91/" title="MySQL数据库索引-B+树"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li></ul><button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div></div></div></nav><div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content donate"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><div class="modal-body"><div class="donate-box"><div class="donate-head"><p>感谢您的支持，我会继续努力的!</p></div><div class="tab-content"><div role="tabpanel" class="tab-pane fade active in" id="alipay"><div class="donate-payimg"><img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p></div><div role="tabpanel" class="tab-pane fade" id="wechatpay"><div class="donate-payimg"><img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p></div></div><div class="donate-footer"><ul class="nav nav-tabs nav-justified" role="tablist"><li role="presentation" class="active"><a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a></li><li role="presentation"><a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a></li></ul></div></div></div></div></div></div></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/cpeixin" target="_blank" title="Github" data-toggle="tooltip" data-placement="top" rel="external nofollow noopener noreferrer"><i class="icon icon-github"></i></a></li><li><a href="https://www.weibo.com/u/1970875963" target="_blank" title="Weibo" data-toggle="tooltip" data-placement="top" rel="external nofollow noopener noreferrer"><i class="icon icon-weibo"></i></a></li><li><a href="https://twitter.com/iwebued" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top" rel="external nofollow noopener noreferrer"><i class="icon icon-twitter"></i></a></li><li><a href="https://www.behance.net/cofess" target="_blank" title="Behance" data-toggle="tooltip" data-placement="top" rel="external nofollow noopener noreferrer"><i class="icon icon-behance"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul><div class="copyright"><div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank" rel="external nofollow noopener noreferrer">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank" rel="external nofollow noopener noreferrer">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>!function(T){var N={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"};T.INSIGHT_CONFIG=N}(window)</script><script src="/js/insight.js"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine"></script><script type="text/javascript">var GUEST=["nick","mail","link"],meta="nick,mail,link";meta=meta.split(",").filter(function(e){return GUEST.indexOf(e)>-1}),new Valine({el:"#vcomments",verify:!1,notify:!1,appId:"SsxmBzBQ3R2S2zWTv0FrONel-gzGzoHsz",appKey:"w0K528Ye7NhOr07RHrzVzHbW",placeholder:"说点什么呢？",avatar:"mm",meta:meta,pageSize:"10",visitor:!0})</script><script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.js"></script><script>$(document).ready(function(){$("article img").not("[hidden]").not(".panel-body img").each(function(){var a=$(this),t=a.attr("alt"),n=a.parent("a");if(n.length<1){var e=this.getAttribute("src"),r=e.lastIndexOf("?");-1!=r&&(e=e.substring(0,r)),n=a.wrap('<a href="'+e+'"></a>').parent("a")}n.attr("data-fancybox","images"),t&&n.attr("data-caption",t)}),$().fancybox({selector:'[data-fancybox="images"]',hash:!1,loop:!1})})</script></body></html><script type="text/javascript" src="//cdn.jsdelivr.net/gh/ygbhf/clicklove/clicklove.js"></script><!-- rebuild by neat -->