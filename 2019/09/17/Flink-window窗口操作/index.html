<!-- build time:Tue Oct 06 2020 21:56:12 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta name="referrer" content="no-referrer"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>Flink window窗口操作 | 布兰特 | 不忘初心</title><meta name="description" content="前言Flink中的window窗口概念和Spark Streaming中的window是一样的。对一直流动的数据划定一个固定的窗口。以交通传感器为例，该传感器每15秒统计通过某个位置的车辆数量。结果流看起来像：如果您想知道有多少辆车经过该位置，您只需将各个计数相加即可。但是，传感器流的本质是它连续产生数据。这样的流永远不会结束，并且不可能计算可以返回的最终和。相反，可以计算滚动总和，即为每个输入事"><meta property="og:type" content="article"><meta property="og:title" content="Flink window窗口操作"><meta property="og:url" content="cpeixin.cn/2019/09/17/Flink-window%E7%AA%97%E5%8F%A3%E6%93%8D%E4%BD%9C/index.html"><meta property="og:site_name" content="布兰特 | 不忘初心"><meta property="og:description" content="前言Flink中的window窗口概念和Spark Streaming中的window是一样的。对一直流动的数据划定一个固定的窗口。以交通传感器为例，该传感器每15秒统计通过某个位置的车辆数量。结果流看起来像：如果您想知道有多少辆车经过该位置，您只需将各个计数相加即可。但是，传感器流的本质是它连续产生数据。这样的流永远不会结束，并且不可能计算可以返回的最终和。相反，可以计算滚动总和，即为每个输入事"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1590165098824-fcf8cd70-73ef-47f4-bd4c-21a0b21b2610.png#align=left&display=inline&height=46&margin=%5Bobject%20Object%5D&originHeight=101&originWidth=1390&size=0&status=done&style=none&width=635"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1590165100266-351997f6-a66e-4921-8265-a527f5698f91.png#align=left&display=inline&height=94&margin=%5Bobject%20Object%5D&originHeight=210&originWidth=1422&size=0&status=done&style=none&width=635"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1590165101217-034de23a-c00f-4292-8185-e952c46f2d72.png#align=left&display=inline&height=139&margin=%5Bobject%20Object%5D&originHeight=319&originWidth=1461&size=0&status=done&style=none&width=635"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1590165100380-6eb861b1-dbfd-470a-b172-fa969a70258f.png#align=left&display=inline&height=173&margin=%5Bobject%20Object%5D&originHeight=387&originWidth=1420&size=0&status=done&style=none&width=635"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1590165102185-8bcef020-bebb-4fc2-bb97-96a31b53644f.png#align=left&display=inline&height=211&margin=%5Bobject%20Object%5D&originHeight=528&originWidth=1586&size=0&status=done&style=none&width=635"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/svg/1072113/1590200868583-aa33a60f-378b-416f-94af-015f37aedf8e.svg#align=left&display=inline&height=387&margin=%5Bobject%20Object%5D&name=tumbling-windows.svg&originHeight=150&originWidth=244&size=45402&status=done&style=none&width=630"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/svg/1072113/1590285475767-11343f13-bc63-4e23-bc1d-b53777f676f7.svg#align=left&display=inline&height=414&margin=%5Bobject%20Object%5D&name=sliding-windows.svg&originHeight=150&originWidth=244&size=48598&status=done&style=none&width=673"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1590221962421-70f5a80f-f550-4b27-b5f5-cbac9439c013.png#align=left&display=inline&height=1846&margin=%5Bobject%20Object%5D&name=%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202020-05-23%20%E4%B8%8B%E5%8D%882.09.25.png&originHeight=1846&originWidth=3330&size=3843214&status=done&style=none&width=3330"><meta property="article:published_time" content="2019-09-17T13:10:54.000Z"><meta property="article:modified_time" content="2020-09-06T09:04:37.715Z"><meta property="article:author" content="Brent"><meta property="article:tag" content="Flink"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2020/png/1072113/1590165098824-fcf8cd70-73ef-47f4-bd4c-21a0b21b2610.png#align=left&display=inline&height=46&margin=%5Bobject%20Object%5D&originHeight=101&originWidth=1390&size=0&status=done&style=none&width=635"><link rel="canonical" href="cpeixin.cn/2019/09/17/Flink-window%E7%AA%97%E5%8F%A3%E6%93%8D%E4%BD%9C/index.html"><link rel="alternate" href="/atom.xml" title="布兰特 | 不忘初心" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.css" rel="stylesheet"><meta name="generator" content="Hexo 4.2.0"></head><body class="main-center" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/cpeixin" target="_blank" rel="external nofollow noopener noreferrer"><img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">Brent</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">大数据工程师 &amp; 机器学习</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Malaysia</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">分类</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">标签</span></a></li><li class="menu-item menu-item-repository"><a href="/repository"><i class="icon icon-project"></i> <span class="menu-title">项目</span></a></li><li class="menu-item menu-item-books"><a href="/books"><i class="icon icon-book-fill"></i> <span class="menu-title">书单</span></a></li><li class="menu-item menu-item-links"><a href="/links"><i class="icon icon-friendship"></i> <span class="menu-title">友链</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-cup-fill"></i> <span class="menu-title">关于</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/cpeixin" target="_blank" title="Github" data-toggle="tooltip" data-placement="top" rel="external nofollow noopener noreferrer"><i class="icon icon-github"></i></a></li><li><a href="https://www.weibo.com/u/1970875963" target="_blank" title="Weibo" data-toggle="tooltip" data-placement="top" rel="external nofollow noopener noreferrer"><i class="icon icon-weibo"></i></a></li><li><a href="https://twitter.com/iwebued" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top" rel="external nofollow noopener noreferrer"><i class="icon icon-twitter"></i></a></li><li><a href="https://www.behance.net/cofess" target="_blank" title="Behance" data-toggle="tooltip" data-placement="top" rel="external nofollow noopener noreferrer"><i class="icon icon-behance"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><p>人处在一种默默奋斗的状态，精神就会从琐碎生活中得到升华</p></div></div></div></div><div class="widget"><h3 class="widget-title">分类</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/DataBase/">DataBase</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/DataBases/">DataBases</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/NLP/">NLP</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tools/">Tools</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a><span class="category-list-count">100</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">开发工具</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a><span class="category-list-count">31</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9E%B6%E6%9E%84/">架构</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">深度学习</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a><span class="category-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签</h3><div class="widget-body"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Apriori/" rel="tag">Apriori</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Decision-Tree/" rel="tag">Decision Tree</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EM/" rel="tag">EM</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ETL/" rel="tag">ETL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flink/" rel="tag">Flink</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GPT-2/" rel="tag">GPT-2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HBase/" rel="tag">HBase</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HashMap/" rel="tag">HashMap</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IDEA/" rel="tag">IDEA</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K-Means/" rel="tag">K-Means</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KNN/" rel="tag">KNN</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LRU%E6%B7%98%E6%B1%B0%E7%AE%97%E6%B3%95/" rel="tag">LRU淘汰算法</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Naive-Bayes/" rel="tag">Naive Bayes</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OLAP/" rel="tag">OLAP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PageRank/" rel="tag">PageRank</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Parquet/" rel="tag">Parquet</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Random-Forest/" rel="tag">Random Forest</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SVM/" rel="tag">SVM</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flask/" rel="tag">flask</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flink/" rel="tag">flink</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hdfs/" rel="tag">hdfs</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hive/" rel="tag">hive</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafka/" rel="tag">kafka</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kali/" rel="tag">kali</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mapreduce/" rel="tag">mapreduce</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/paxos/" rel="tag">paxos</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scala/" rel="tag">scala</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shadowsock/" rel="tag">shadowsock</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/skipList/" rel="tag">skipList</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sklearn/" rel="tag">sklearn</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spark/" rel="tag">spark</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/yarn/" rel="tag">yarn</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE/" rel="tag">二分查找</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/" rel="tag">二叉树</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" rel="tag">动态规划</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" rel="tag">单例模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9B%9E%E6%BA%AF/" rel="tag">回溯</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A0%86/" rel="tag">堆</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/" rel="tag">布隆过滤器</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8E%92%E5%BA%8F/" rel="tag">排序</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%A3%E5%88%97%E8%A1%A8/" rel="tag">散列表</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/" rel="tag">数据仓库</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97/" rel="tag">数据清洗</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86/" rel="tag">数据采集</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E7%BB%84/" rel="tag">数组</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97/" rel="tag">时间序列</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%89%E5%85%A8/" rel="tag">服务器安全</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A0%88/" rel="tag">栈</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" rel="tag">深度学习</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%88%AC%E8%99%AB/" rel="tag">爬虫</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%89%B9%E5%BE%81%E5%B7%A5%E7%A8%8B/" rel="tag">特征工程</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%94%A8%E6%88%B7%E7%94%BB%E5%83%8F/" rel="tag">用户画像</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%A2%E9%BB%91%E6%A0%91/" rel="tag">红黑树</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E6%80%A7%E8%A1%A8/" rel="tag">线性表</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%8D%E5%90%91%E9%87%8F/" rel="tag">词向量</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%92%E5%BD%92/" rel="tag">递归</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92/" rel="tag">逻辑回归</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%93%BE%E8%A1%A8/" rel="tag">链表</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%98%9F%E5%88%97/" rel="tag">队列</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签云</h3><div class="widget-body tagcloud"><a href="/tags/Apriori/" style="font-size:13.13px">Apriori</a> <a href="/tags/Decision-Tree/" style="font-size:13.5px">Decision Tree</a> <a href="/tags/EM/" style="font-size:13.13px">EM</a> <a href="/tags/ETL/" style="font-size:13px">ETL</a> <a href="/tags/Flink/" style="font-size:14px">Flink</a> <a href="/tags/GPT-2/" style="font-size:13px">GPT-2</a> <a href="/tags/HBase/" style="font-size:13.25px">HBase</a> <a href="/tags/HashMap/" style="font-size:13px">HashMap</a> <a href="/tags/IDEA/" style="font-size:13px">IDEA</a> <a href="/tags/K-Means/" style="font-size:13px">K-Means</a> <a href="/tags/KNN/" style="font-size:13.13px">KNN</a> <a href="/tags/LRU%E6%B7%98%E6%B1%B0%E7%AE%97%E6%B3%95/" style="font-size:13px">LRU淘汰算法</a> <a href="/tags/Naive-Bayes/" style="font-size:13.13px">Naive Bayes</a> <a href="/tags/OLAP/" style="font-size:13px">OLAP</a> <a href="/tags/PageRank/" style="font-size:13.13px">PageRank</a> <a href="/tags/Parquet/" style="font-size:13px">Parquet</a> <a href="/tags/Random-Forest/" style="font-size:13px">Random Forest</a> <a href="/tags/SVM/" style="font-size:13.13px">SVM</a> <a href="/tags/docker/" style="font-size:13.13px">docker</a> <a href="/tags/flask/" style="font-size:13.13px">flask</a> <a href="/tags/flink/" style="font-size:13px">flink</a> <a href="/tags/hdfs/" style="font-size:13.38px">hdfs</a> <a href="/tags/hive/" style="font-size:13.38px">hive</a> <a href="/tags/java/" style="font-size:13px">java</a> <a href="/tags/kafka/" style="font-size:13.75px">kafka</a> <a href="/tags/kali/" style="font-size:13px">kali</a> <a href="/tags/mapreduce/" style="font-size:13px">mapreduce</a> <a href="/tags/mysql/" style="font-size:13.25px">mysql</a> <a href="/tags/paxos/" style="font-size:13.13px">paxos</a> <a href="/tags/python/" style="font-size:13.63px">python</a> <a href="/tags/redis/" style="font-size:13.38px">redis</a> <a href="/tags/scala/" style="font-size:13.38px">scala</a> <a href="/tags/shadowsock/" style="font-size:13px">shadowsock</a> <a href="/tags/skipList/" style="font-size:13px">skipList</a> <a href="/tags/sklearn/" style="font-size:13px">sklearn</a> <a href="/tags/spark/" style="font-size:14px">spark</a> <a href="/tags/yarn/" style="font-size:13px">yarn</a> <a href="/tags/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE/" style="font-size:13.13px">二分查找</a> <a href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/" style="font-size:13.25px">二叉树</a> <a href="/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" style="font-size:13px">动态规划</a> <a href="/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" style="font-size:13px">单例模式</a> <a href="/tags/%E5%9B%9E%E6%BA%AF/" style="font-size:13px">回溯</a> <a href="/tags/%E5%A0%86/" style="font-size:13px">堆</a> <a href="/tags/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/" style="font-size:13px">布隆过滤器</a> <a href="/tags/%E6%8E%92%E5%BA%8F/" style="font-size:13.88px">排序</a> <a href="/tags/%E6%95%A3%E5%88%97%E8%A1%A8/" style="font-size:13px">散列表</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/" style="font-size:13.88px">数据仓库</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97/" style="font-size:13px">数据清洗</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86/" style="font-size:13px">数据采集</a> <a href="/tags/%E6%95%B0%E7%BB%84/" style="font-size:13px">数组</a> <a href="/tags/%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97/" style="font-size:13px">时间序列</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%89%E5%85%A8/" style="font-size:13.13px">服务器安全</a> <a href="/tags/%E6%A0%88/" style="font-size:13px">栈</a> <a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" style="font-size:13px">深度学习</a> <a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size:13px">爬虫</a> <a href="/tags/%E7%89%B9%E5%BE%81%E5%B7%A5%E7%A8%8B/" style="font-size:13.38px">特征工程</a> <a href="/tags/%E7%94%A8%E6%88%B7%E7%94%BB%E5%83%8F/" style="font-size:13.13px">用户画像</a> <a href="/tags/%E7%BA%A2%E9%BB%91%E6%A0%91/" style="font-size:13px">红黑树</a> <a href="/tags/%E7%BA%BF%E6%80%A7%E8%A1%A8/" style="font-size:13px">线性表</a> <a href="/tags/%E8%AF%8D%E5%90%91%E9%87%8F/" style="font-size:13px">词向量</a> <a href="/tags/%E9%80%92%E5%BD%92/" style="font-size:13px">递归</a> <a href="/tags/%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92/" style="font-size:13px">逻辑回归</a> <a href="/tags/%E9%93%BE%E8%A1%A8/" style="font-size:13.13px">链表</a> <a href="/tags/%E9%98%9F%E5%88%97/" style="font-size:13px">队列</a></div></div><div class="widget"><h3 class="widget-title">归档</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a><span class="archive-list-count">16</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">22</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a><span class="archive-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">最新文章</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></p><p class="item-title"><a href="/2020/09/13/Kafka-%E5%8E%8B%E7%BC%A9%E7%AE%97%E6%B3%95/" class="title">Kafka 压缩算法</a></p><p class="item-date"><time datetime="2020-09-13T13:58:54.000Z" itemprop="datePublished">2020-09-13</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></p><p class="item-title"><a href="/2020/09/03/%E5%BA%8F%E5%88%97%E5%8C%96%E5%9C%A8Spark%E4%B8%AD%E8%8A%82%E7%BA%A6%E7%A9%BA%E9%97%B4%E4%BA%86%E4%B9%88%EF%BC%9F/" class="title">序列化在Spark中节约空间了么？</a></p><p class="item-date"><time datetime="2020-09-03T15:58:14.000Z" itemprop="datePublished">2020-09-03</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></p><p class="item-title"><a href="/2020/08/30/Redis%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" class="title">Redis底层数据结构</a></p><p class="item-date"><time datetime="2020-08-30T06:47:56.000Z" itemprop="datePublished">2020-08-30</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></p><p class="item-title"><a href="/2020/08/30/%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95-Paxos%EF%BC%882%EF%BC%89/" class="title">分布式一致性算法 - Paxos（2）</a></p><p class="item-date"><time datetime="2020-08-30T05:10:05.000Z" itemprop="datePublished">2020-08-30</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></p><p class="item-title"><a href="/2020/08/29/%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95-Paxos%EF%BC%881%EF%BC%89/" class="title">分布式一致性算法 - Paxos（1）</a></p><p class="item-date"><time datetime="2020-08-28T16:54:44.000Z" itemprop="datePublished">2020-08-29</time></p></div></li></ul></div></div></div></aside><main class="main" role="main"><div class="content"><article id="post-Flink-window窗口操作" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">Flink window窗口操作</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2019/09/17/Flink-window%E7%AA%97%E5%8F%A3%E6%93%8D%E4%BD%9C/" class="article-date"><time datetime="2019-09-17T13:10:54.000Z" itemprop="datePublished">2019-09-17</time></a></span> <span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></span> <span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link" href="/tags/Flink/" rel="tag">Flink</a></span> <span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="/2019/09/17/Flink-window%E7%AA%97%E5%8F%A3%E6%93%8D%E4%BD%9C/" class="leancloud_visitors" data-flag-title="Flink window窗口操作">0</span></span> <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2019/09/17/Flink-window%E7%AA%97%E5%8F%A3%E6%93%8D%E4%BD%9C/#comments" class="article-comment-link">评论</a></span> <span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 7.6k(字)</span> <span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 35(分)</span></div></div><div class="article-entry marked-body" itemprop="articleBody"><p><a name="pfEqf"></a></p><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><hr><p>Flink中的window窗口概念和Spark Streaming中的window是一样的。对一直流动的数据划定一个固定的窗口。<br><br><br>以交通传感器为例，该传感器每15秒统计通过某个位置的车辆数量。结果流看起来像：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1590165098824-fcf8cd70-73ef-47f4-bd4c-21a0b21b2610.png#align=left&display=inline&height=46&margin=%5Bobject%20Object%5D&originHeight=101&originWidth=1390&size=0&status=done&style=none&width=635" alt><br><br><br><br><br>如果您想知道有多少辆车经过该位置，您只需将各个计数相加即可。但是，传感器流的本质是它连续产生数据。这样的流永远不会结束，并且不可能计算可以返回的最终和。相反，可以计算滚动总和，即为每个输入事件返回更新的总和记录。这将产生新的部分和流。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1590165100266-351997f6-a66e-4921-8265-a527f5698f91.png#align=left&display=inline&height=94&margin=%5Bobject%20Object%5D&originHeight=210&originWidth=1422&size=0&status=done&style=none&width=635" alt><br><br><br><br><br>但是，部分求和流可能不是我们想要的，因为它会不断更新计数，更重要的是，某些信息（例如随时间变化）会丢失。因此，我们可能想改一下我们的问题，并询问每分钟通过该位置的汽车数量。这要求我们将流的元素分组为有限的集合，每个集合对应于60秒。此操作称为<strong>_滚动Windows_操作。（不重叠）</strong><br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1590165101217-034de23a-c00f-4292-8185-e952c46f2d72.png#align=left&display=inline&height=139&margin=%5Bobject%20Object%5D&originHeight=319&originWidth=1461&size=0&status=done&style=none&width=635" alt><br><br><br><br><br>滚动窗口将流离散化为不重叠的窗口。对于某些应用程序，重要的是窗口不可分离，因为应用程序可能需要平滑的聚合。例如，我们可以每30秒计算最后一分钟通过的汽车数量。这种窗户称为<strong>_滑动窗户_。（重叠）</strong><br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1590165100380-6eb861b1-dbfd-470a-b172-fa969a70258f.png#align=left&display=inline&height=173&margin=%5Bobject%20Object%5D&originHeight=387&originWidth=1420&size=0&status=done&style=none&width=635" alt><br><br><br><br><br>如前所述，在数据流上定义窗口是非并行操作。这是因为流的每个元素必须由决定该元素应添加到哪个窗口的同一窗口运算符处理。完整流中的Windows 在Flink 中称为_AllWindows_。对于许多应用程序，数据流需要分组为多个逻辑流，每个逻辑流都可以应用窗口运算符。<br><br><br>例如，考虑来自多个交通传感器（而不是像前面的示例中的一个传感器）的车辆计数流，其中每个传感器监视一个不同的位置。通过按传感器ID对流进行分组，我们可以并行计算每个位置的窗口流量统计信息。在Flink中，我们称此类分区窗口为_Windows_，因为它们是分布式流的常见情况。下图显示了翻转窗口，该窗口收集了<code>(sensorId, count)</code>成对元素流中的两个元素。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1590165102185-8bcef020-bebb-4fc2-bb97-96a31b53644f.png#align=left&display=inline&height=211&margin=%5Bobject%20Object%5D&originHeight=528&originWidth=1586&size=0&status=done&style=none&width=635" alt><br><br><br><br><br>一般来说，<strong>窗口在无界流上定义了一组有限的元素。</strong>该集合可以基于时间（如我们前面的示例中所示），元素计数，计数和时间的组合，或一些将元素分配给窗口的自定义逻辑。Flink的DataStream API为最常见的窗口操作提供了简洁的运算符，并提供了一种通用的窗口机制，该机制允许用户定义非常自定义的窗口逻辑。在下面的内容中，我们将介绍Flink的时间和计数窗口，然后再详细讨论其窗口机制。<br></p><p><a name="qNlhu"></a></p><h3 id="Window"><a href="#Window" class="headerlink" title="Window"></a>Window</h3><hr><p><br>Windows是处理无限流的核心。Windows将流分成有限大小的“buckets”，我们可以在其上应用计算。<br><br><br>Flink window窗口程序的一般结构如下所示。第一段指的是<strong>KeyedStream[T]</strong>流，第二段指的是<strong><em>non-keyed</em>**</strong>DataStream[T]<strong>流。以下两段代码对比，唯一的区别是数据流stream经过</strong>keyBy(…)<strong>后，需要调用window(…)来创建窗口，而non-keyed stream则需要调用windowAll(…)创建窗口。<br><br><br></strong>Keyed window**</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">stream</span><br><span class="line">       .keyBy(...)               &lt;-  keyed versus non-keyed windows</span><br><span class="line">       .window(...)              &lt;-  required: <span class="string">"assigner"</span></span><br><span class="line">      [.trigger(...)]            &lt;-  optional: <span class="string">"trigger"</span> (<span class="keyword">else</span> <span class="keyword">default</span> trigger)</span><br><span class="line">      [.evictor(...)]            &lt;-  optional: <span class="string">"evictor"</span> (<span class="keyword">else</span> no evictor)</span><br><span class="line">      [.allowedLateness(...)]    &lt;-  optional: <span class="string">"lateness"</span> (<span class="keyword">else</span> zero)</span><br><span class="line">      [.sideOutputLateData(...)] &lt;-  optional: <span class="string">"output tag"</span> (<span class="keyword">else</span> no side output <span class="keyword">for</span> late data)</span><br><span class="line">       .reduce/aggregate/fold/apply()      &lt;-  required: <span class="string">"function"</span></span><br><span class="line">      [.getSideOutput(...)]      &lt;-  optional: <span class="string">"output tag"</span></span><br></pre></td></tr></table></figure><p><strong><br></strong>Non-Keyed Windows**</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stream</span><br><span class="line">       .windowAll(...)           &lt;-  required: <span class="string">"assigner"</span></span><br><span class="line">      [.trigger(...)]            &lt;-  optional: <span class="string">"trigger"</span> (<span class="keyword">else</span> <span class="keyword">default</span> trigger)</span><br><span class="line">      [.evictor(...)]            &lt;-  optional: <span class="string">"evictor"</span> (<span class="keyword">else</span> no evictor)</span><br><span class="line">      [.allowedLateness(...)]    &lt;-  optional: <span class="string">"lateness"</span> (<span class="keyword">else</span> zero)</span><br><span class="line">      [.sideOutputLateData(...)] &lt;-  optional: <span class="string">"output tag"</span> (<span class="keyword">else</span> no side output <span class="keyword">for</span> late data)</span><br><span class="line">       .reduce/aggregate/fold/apply()      &lt;-  required: <span class="string">"function"</span></span><br><span class="line">      [.getSideOutput(...)]      &lt;-  optional: <span class="string">"output tag"</span></span><br></pre></td></tr></table></figure><p><br>在上面，方括号（[…]）中的命令是可选的。这表明Flink允许您以多种不同方式自定义窗口逻辑，从而使其最适合您的需求。<br></p><p><a name="OG1Eh"></a></p><h3 id="window生命周期"><a href="#window生命周期" class="headerlink" title="window生命周期"></a>window生命周期</h3><hr><p>简而言之，一旦应属于该窗口的第一个元素到达，就会<strong>创建</strong>一个窗口，并且当时间（event or processing time）超过其结束时间戳加上用户指定的延迟时间，该窗口将被<strong>完全删除</strong>。Flink保证只删除基于时间（time-based windows）的窗口，而不保证其他类型（_例如 _global windows）的<a href="https://ci.apache.org/projects/flink/flink-docs-stable/dev/stream/operators/windows.html#window-assigners" target="_blank" rel="external nofollow noopener noreferrer">删除</a>。<br><br><br>例如，采用基于event time的窗口化策略，该策略每5分钟创建一次不重叠的滚动窗口，并允许延迟1分钟，因此Flink将会创建一个时间在12:00～12:05之间的串口，当带有时间戳的第一个元素落入此间隔时，当水印通过12:06 时间戳时，它将删除它。<br><br><br>此外，每个窗口将具有Trigger<a href="https://ci.apache.org/projects/flink/flink-docs-stable/dev/stream/operators/windows.html#triggers" target="_blank" rel="external nofollow noopener noreferrer">触发器</a> 和一个函数（ProcessWindowFunction，ReduceFunction， AggregateFunction或FoldFunction等<a href="https://ci.apache.org/projects/flink/flink-docs-stable/dev/stream/operators/windows.html#window-functions" target="_blank" rel="external nofollow noopener noreferrer">窗口功能</a>。该函数将包含要应用于窗口内容的计算，而则Trigger指定了在什么条件下可以将窗口视为要应用该函数的条件。触发策略可能类似于“当窗口中的元素数大于4时”或“当watermark水印通过窗口末尾时”。触发器还可以决定在创建和删除窗口之间的任何时间清除窗口的内容。在这种情况下，清除仅是指窗口中的元素，而不是窗口元数据。这意味着仍可以将新数据添加到该窗口。<br><br><br>除上述内容外，您还可以指定一个Evictor（请参阅<a href="https://ci.apache.org/projects/flink/flink-docs-stable/dev/stream/operators/windows.html#evictors" target="_blank" rel="external nofollow noopener noreferrer">Evictors</a>），它将在触发触发器后以及应用此功能之前和/或之后从窗口中删除元素。<br><br><br>在下文中，我们将对上述每个组件进行更详细的介绍。我们先从上面的代码片段中的必需部分开始（请参见<a href="https://ci.apache.org/projects/flink/flink-docs-stable/dev/stream/operators/windows.html#window-assigner" target="_blank" rel="external nofollow noopener noreferrer">Keyed </a><a href="https://ci.apache.org/projects/flink/flink-docs-stable/dev/stream/operators/windows.html#keyed-vs-non-keyed-windows" target="_blank" rel="external nofollow noopener noreferrer">vs Non- </a><a href="https://ci.apache.org/projects/flink/flink-docs-stable/dev/stream/operators/windows.html#window-assigner" target="_blank" rel="external nofollow noopener noreferrer">Keyed </a><a href="https://ci.apache.org/projects/flink/flink-docs-stable/dev/stream/operators/windows.html#keyed-vs-non-keyed-windows" target="_blank" rel="external nofollow noopener noreferrer">Windows</a>，<a href="https://ci.apache.org/projects/flink/flink-docs-stable/dev/stream/operators/windows.html#window-assigner" target="_blank" rel="external nofollow noopener noreferrer">Window Assigner</a>和 <a href="https://ci.apache.org/projects/flink/flink-docs-stable/dev/stream/operators/windows.html#window-function" target="_blank" rel="external nofollow noopener noreferrer">Window Function</a>）。<br></p><p><a name="9DJS6"></a></p><h3 id="Keyed-vs-Non-Keyed-Windows"><a href="#Keyed-vs-Non-Keyed-Windows" class="headerlink" title="Keyed vs Non-Keyed Windows"></a>Keyed vs Non-Keyed Windows</h3><hr><p><br>在我们接入流数据后，第一件事情就是我们要在定义window函数前，需要决定你的数据流是否需要进行 keyed。<br>如果我们使用了keyBy()，那么输入的数据流将会被切分成logical keyed streams，否则，将不会对数据流进行切分，</p><p>在使用 keyed streams的情况下，<strong>传入事件的任何属性都可以用作key</strong>。拥有keyed streams将使您的窗口化计算可以由多个任务并行执行，因为logical keyed streams都可以独立于其余logical keyed streams进行处理。引用同一键的所有元素将被发送到同一并行任务task中。<br><br><br>对于non-keyed streams，您的原始流将不会拆分为多个逻辑流，并且所有窗口逻辑将由单个任务执行，<em>即</em><strong>并行度为1</strong>。<br></p><p><a name="aqsyU"></a></p><h3 id="Window-Assigners窗口分配器"><a href="#Window-Assigners窗口分配器" class="headerlink" title="Window Assigners窗口分配器"></a>Window Assigners窗口分配器</h3><hr><p>在决定是否要对数据流keyed后，下一步则是定义window assigners窗口分配器，window assigners定义了数据流元素怎样通过窗口，这完全取决于你的window assigners的选择，window()还是windowAll()</p><p>WindowAssigner负责将每个传入元素分配给一个或多个窗口。Flink带有针对最常见用例的预定义窗口分配器，即<em>tumbling windows</em>,滚动窗口， sliding windows滑动窗口，session windows会话窗口和global windows全局窗口 。您还可以通过扩展WindowAssigner类来实现自定义窗口分配器。所有内置窗口分配器（<strong>global windows**</strong>全局窗口除外**）均基于时间将元素分配给窗口，时间可以是process time，也可以是event time。process time和event time之间的差异以及timestamps和watermarks的生成方式稍后再讲。<br><br><br>基于时间的窗口具有开始时间戳（包括端点）和结束时间戳（包括端点），它们共同描述了窗口的大小。在代码中，Flink在使用TimeWindow基于时间的窗口时使用，该方法具有查询开始和结束时间戳记的方法maxTimestamp()，还具有返回给定窗口允许的最大时间戳的附加方法。<br><br><br>在下面，我们展示Flink的预定义窗口分配器如何工作以及如何在DataStream程序中使用它们。下图显示了每个分配器的工作情况。紫色圆圈表示流的元素，这些元素由某个键（在这种情况下为用户1，用户2和用户3）划分。x轴显示时间进度。<br><br><br></p><p><a name="tumbling-windows"></a></p><h3 id="Tumbling-Windows滚动窗口"><a href="#Tumbling-Windows滚动窗口" class="headerlink" title="Tumbling Windows滚动窗口"></a>Tumbling Windows滚动窗口</h3><p>滚动_窗口_分配器分配每个元素到指定_窗口大小_的窗口。滚动窗口具有固定的大小，并且不重叠。例如，如果您指定大小为5分钟的滚动窗口，则将评估当前窗口，并且每五分钟将启动一个新窗口。<br><br><br>那么在滚动窗口上的实现，Spark Streming和Flink有明显的不同，最大的区别是spark streaming在一开始便指定了切分流数据的方式val ssc = new StreamingContext(conf, Seconds(10)) 即10秒切分一次，然后对这一批进行处理。<br><br><br>而Flink是后面自己通过Window算子timeWindow(Time.seconds(10))来指定每10秒作为一个数据窗口进行处理。<br>以上可以看出Spark Streaming的底层为micro batch处理方式，Flink为流处理方式。<br><br><br>Flink滚动窗口如下图所示。<br><img src="https://cdn.nlark.com/yuque/0/2020/svg/1072113/1590200868583-aa33a60f-378b-416f-94af-015f37aedf8e.svg#align=left&display=inline&height=387&margin=%5Bobject%20Object%5D&name=tumbling-windows.svg&originHeight=150&originWidth=244&size=45402&status=done&style=none&width=630" alt="tumbling-windows.svg"><br>为了更好的演示Flink的各种窗口操作，我花了一点时间用python写了一个模拟实时产生用户数据的程序，随后将产生的数据写入kafka中，顺便提一下Faker这个python中的第三方库，模拟数据很好用，以前只在爬虫程序中，用过模拟浏览器信息。<br><br><br>Flink tumbling window 代码结构</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> input: <span class="type">DataStream</span>[<span class="type">T</span>] = ...</span><br><span class="line"></span><br><span class="line"><span class="comment">// tumbling event-time windows</span></span><br><span class="line">input</span><br><span class="line">    .keyBy(&lt;key selector&gt;)</span><br><span class="line">    .window(<span class="type">TumblingEventTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">5</span>)))</span><br><span class="line">    .&lt;windowed transformation&gt;(&lt;window function&gt;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// tumbling processing-time windows</span></span><br><span class="line">input</span><br><span class="line">    .keyBy(&lt;key selector&gt;)</span><br><span class="line">    .window(<span class="type">TumblingProcessingTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">5</span>)))</span><br><span class="line">    .&lt;windowed transformation&gt;(&lt;window function&gt;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// daily tumbling event-time windows offset by -8 hours.</span></span><br><span class="line">input</span><br><span class="line">    .keyBy(&lt;key selector&gt;)</span><br><span class="line">    .window(<span class="type">TumblingEventTimeWindows</span>.of(<span class="type">Time</span>.days(<span class="number">1</span>), <span class="type">Time</span>.hours(<span class="number">-8</span>)))</span><br><span class="line">    .&lt;windowed transformation&gt;(&lt;window function&gt;)</span><br></pre></td></tr></table></figure><p>窗口函数，这里也可以使用timeWindow(Time.<em>seconds</em>(5))，时间间隔可以通过使用一个指定<code>Time.milliseconds(x)</code>，<code>Time.seconds(x)</code>， <code>Time.minutes(x)</code>，等等。<br><br><br>如最后一个示例所示，滚动窗口分配器还采用一个可选offset 参数，该参数可用于更改窗口的对齐方式。例如，如果没有偏移，则每小时滚动窗口与epoch对齐，即您将获得诸如的窗口 1:00:00.000 - 1:59:59.999，2:00:00.000 - 2:59:59.999依此类推。如果要更改，可以提供一个偏移量。随着15分钟的偏移量，你会，例如，拿 1:15:00.000 - 2:14:59.999，2:15:00.000 - 3:14:59.999等。一个重要的用例的偏移是窗口调整到比UTC-0时区等。例如，在中国，您必须指定的偏移量Time.hours(-8)。<br></p><p><a name="sliding-windows"></a></p><h3 id="Sliding-Windows-滑动窗口"><a href="#Sliding-Windows-滑动窗口" class="headerlink" title="Sliding Windows_滑动窗口_"></a>Sliding Windows_滑动窗口_</h3><p>这个滑动窗口概念和Spark Streaming中的也是一样的，在Spark Streaming中是这样实现的</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> window_dstream: <span class="type">DStream</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = wordcount_dstream.reduceByKeyAndWindow((x: <span class="type">Int</span>,y: <span class="type">Int</span>)=&gt;x+y,<span class="type">Seconds</span>(<span class="number">30</span>), <span class="type">Seconds</span>(<span class="number">10</span>))</span><br></pre></td></tr></table></figure><p>_滑动窗口_分配器让元素以固定长度的窗口通过。类似于滚动窗口分配器，_窗口的大小<em>由</em>窗口大小_参数配置。附加的_窗口滑动_参数控制滑动窗口启动的频率。因此，如果滑动参数小于窗口大小，则滑动窗口会重叠。在这种情况下，元素被分配给多个窗口。<br><br><br>例如，您可以将大小为10分钟的窗口滑动5分钟。这样，您每隔5分钟就会得到一个窗口，其中包含最近10分钟内到达的事件，如下图所示。<br><br><br><img src="https://cdn.nlark.com/yuque/0/2020/svg/1072113/1590285475767-11343f13-bc63-4e23-bc1d-b53777f676f7.svg#align=left&display=inline&height=414&margin=%5Bobject%20Object%5D&name=sliding-windows.svg&originHeight=150&originWidth=244&size=48598&status=done&style=none&width=673" alt="sliding-windows.svg"><br><strong>sliding windows滑动窗口代码结构</strong><br>**</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> input: <span class="type">DataStream</span>[<span class="type">T</span>] = ...</span><br><span class="line"><span class="comment">// sliding event-time windows</span></span><br><span class="line">input</span><br><span class="line">    .keyBy(&lt;key selector&gt;)</span><br><span class="line">    .window(<span class="type">SlidingEventTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>), <span class="type">Time</span>.seconds(<span class="number">5</span>)))</span><br><span class="line">    .&lt;windowed transformation&gt;(&lt;window function&gt;)</span><br><span class="line"><span class="comment">// sliding processing-time windows</span></span><br><span class="line">input</span><br><span class="line">    .keyBy(&lt;key selector&gt;)</span><br><span class="line">    .window(<span class="type">SlidingProcessingTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>), <span class="type">Time</span>.seconds(<span class="number">5</span>)))</span><br><span class="line">    .&lt;windowed transformation&gt;(&lt;window function&gt;)</span><br><span class="line"><span class="comment">// sliding processing-time windows offset by -8 hours</span></span><br><span class="line">input</span><br><span class="line">    .keyBy(&lt;key selector&gt;)</span><br><span class="line">    .window(<span class="type">SlidingProcessingTimeWindows</span>.of(<span class="type">Time</span>.hours(<span class="number">12</span>), <span class="type">Time</span>.hours(<span class="number">1</span>), <span class="type">Time</span>.hours(<span class="number">-8</span>)))</span><br><span class="line">    .&lt;windowed transformation&gt;(&lt;window function&gt;)</span><br></pre></td></tr></table></figure><p><br>窗口函数，这里也可以使用timeWindow(Time.<em>seconds</em>(10), Time.<em>seconds</em>(5))，时间间隔可以通过使用一个指定Time.milliseconds(x)，Time.seconds(x)， Time.minutes(x)，等等。<br><br><br>如最后一个示例所示，滑动窗口分配器还采用一个可选offset参数，该参数可用于更改窗口的对齐方式。例如，在没有偏移的情况下，每小时滑动30分钟的窗口将与epoch对齐，即您将获得诸如的窗口 1:00:00.000 - 1:59:59.999，1:30:00.000 - 2:29:59.999依此类推。如果要更改，可以提供一个偏移量。随着15分钟的偏移量，你会，例如，拿 1:15:00.000 - 2:14:59.999，1:45:00.000 - 2:44:59.999等一个重要的用例的偏移是窗口调整到比UTC-0时区等。例如，在中国，您必须指定的偏移量Time.hours(-8)。<br></p><p><a name="session-windows"></a></p><h3 id="Session-Windows会话窗口"><a href="#Session-Windows会话窗口" class="headerlink" title="Session Windows会话窗口"></a>Session Windows会话窗口</h3><p><br>会话窗口中的元素是正在活跃的会话产生的数据。与滚动窗口和滑动窗口相比，会话窗口不重叠且没有固定的窗口开始和结束时间。相反，当会话窗口在一定时间段内未收到元素时（即不发生活动数据间隙时），它将关闭。会话窗口分配器配置静态会话间隔，其限定当会话不活动周期有多长。当此时间段到期时，当前会话将关闭，随后的元素将分配给新的会话窗口。<br><br><br>在现实中的意义就是，当数据处于连续活跃的状态下，并不划分窗口，但是当数据处于不活跃的状态，相邻数据的时间超过了设定的gap，则划定一个新窗口。<br></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> input: <span class="type">DataStream</span>[<span class="type">T</span>] = ...</span><br><span class="line"></span><br><span class="line"><span class="comment">// event-time session windows with static gap</span></span><br><span class="line">input</span><br><span class="line">    .keyBy(&lt;key selector&gt;)</span><br><span class="line">    .window(<span class="type">EventTimeSessionWindows</span>.withGap(<span class="type">Time</span>.minutes(<span class="number">10</span>)))</span><br><span class="line">    .&lt;windowed transformation&gt;(&lt;window function&gt;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// event-time session windows with dynamic gap</span></span><br><span class="line">input</span><br><span class="line">    .keyBy(&lt;key selector&gt;)</span><br><span class="line">    .window(<span class="type">EventTimeSessionWindows</span>.withDynamicGap(<span class="keyword">new</span> <span class="type">SessionWindowTimeGapExtractor</span>[<span class="type">String</span>] &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extract</span></span>(element: <span class="type">String</span>): <span class="type">Long</span> = &#123;</span><br><span class="line">        <span class="comment">// determine and return session gap</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;))</span><br><span class="line">    .&lt;windowed transformation&gt;(&lt;window function&gt;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// processing-time session windows with static gap</span></span><br><span class="line">input</span><br><span class="line">    .keyBy(&lt;key selector&gt;)</span><br><span class="line">    .window(<span class="type">ProcessingTimeSessionWindows</span>.withGap(<span class="type">Time</span>.minutes(<span class="number">10</span>)))</span><br><span class="line">    .&lt;windowed transformation&gt;(&lt;window function&gt;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// processing-time session windows with dynamic gap</span></span><br><span class="line">input</span><br><span class="line">    .keyBy(&lt;key selector&gt;)</span><br><span class="line">    .window(<span class="type">DynamicProcessingTimeSessionWindows</span>.withDynamicGap(<span class="keyword">new</span> <span class="type">SessionWindowTimeGapExtractor</span>[<span class="type">String</span>] &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extract</span></span>(element: <span class="type">String</span>): <span class="type">Long</span> = &#123;</span><br><span class="line">        <span class="comment">// determine and return session gap</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;))</span><br><span class="line">    .&lt;windowed transformation&gt;(&lt;window function&gt;)</span><br></pre></td></tr></table></figure><p>静态间隙可以通过使用中的一个来指定Time.milliseconds(x)，Time.seconds(x)， Time.minutes(x)。<br><br><br>动态间隙是通过实现SessionWindowTimeGapExtractor接口指定的。<br><br><br>由于会话窗口没有固定的开始和结束，因此对它们的评估不同于滚动窗口和滑动窗口。在内部，会话窗口运算符会为每个到达的记录创建一个新窗口，如果窗口彼此之间的距离比已定义的间隔小，则将它们合并在一起。为了可以将数据合并，会话窗口需要一个合并<a href="https://ci.apache.org/projects/flink/flink-docs-stable/dev/stream/operators/windows.html#triggers" target="_blank" rel="external nofollow noopener noreferrer">触发器</a>以及合并<a href="https://ci.apache.org/projects/flink/flink-docs-stable/dev/stream/operators/windows.html#window-functions" target="_blank" rel="external nofollow noopener noreferrer">窗口函数</a>，如ReduceFunction，AggregateFunction，或ProcessWindowFunction （FoldFunction不能合并。）<br></p><hr><p>接下来，所有的窗口函数操作的数据，都是基于下面我用python下的模拟生产用户数据。<br><br><br><strong>python模拟数据代码</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> faker <span class="keyword">import</span> Faker</span><br><span class="line"><span class="keyword">from</span> kafka <span class="keyword">import</span> KafkaProducer</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化</span></span><br><span class="line">fake = Faker(locale=<span class="string">'zh_CN'</span>)</span><br><span class="line"></span><br><span class="line">producer = KafkaProducer(</span><br><span class="line">value_serializer=<span class="keyword">lambda</span> v: json.dumps(v).encode(<span class="string">'utf-8'</span>),</span><br><span class="line">bootstrap_servers=[<span class="string">'localhost:9092'</span>]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="string">"""生成随机时间（注册时间和最近登陆时间）"""</span></span><br><span class="line">register_start = <span class="string">'2017-06-02 12:12:12'</span></span><br><span class="line">register_end = <span class="string">'2017-11-01 00:00:00'</span></span><br><span class="line"></span><br><span class="line">login_start = <span class="string">'2018-05-01 12:12:12'</span></span><br><span class="line">login_end = <span class="string">'2018-12-01 00:00:00'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">strTimeProp</span><span class="params">(start, end, prop, frmt)</span>:</span></span><br><span class="line">    stime = time.mktime(time.strptime(start, frmt))</span><br><span class="line">    etime = time.mktime(time.strptime(end, frmt))</span><br><span class="line">    ptime = stime + prop * (etime - stime)</span><br><span class="line">    <span class="keyword">return</span> int(ptime)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_randomDate</span><span class="params">(register_start, register_end, frmt=<span class="string">'%Y-%m-%d %H:%M:%S'</span>)</span>:</span></span><br><span class="line">    register_time = time.strftime(frmt, time.localtime(strTimeProp(register_start, register_end, random.random(), frmt)))</span><br><span class="line">    <span class="keyword">return</span> register_time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_randomDate</span><span class="params">(login_start, login_end, frmt=<span class="string">'%Y-%m-%d %H:%M:%S'</span>)</span>:</span></span><br><span class="line">    login_time = time.strftime(frmt, time.localtime(strTimeProp(login_start, login_end, random.random(), frmt)))</span><br><span class="line">    <span class="keyword">return</span> login_time</span><br><span class="line"></span><br><span class="line"><span class="string">"""生成渠道，设备"""</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_device</span><span class="params">()</span>:</span></span><br><span class="line">    web_devices = [<span class="string">'Chrome'</span>, <span class="string">'360_browser'</span>, <span class="string">'QQ_browser'</span>, <span class="string">'Firefox'</span>, <span class="string">'Opera'</span>, <span class="string">'UC_browser'</span>]</span><br><span class="line">    app_devices = [<span class="string">'xiaomi'</span>, <span class="string">'iphone'</span>, <span class="string">'Samsung'</span>, <span class="string">'meizu'</span>, <span class="string">'1+'</span>, <span class="string">'huawei'</span>,<span class="string">'vivo'</span>, <span class="string">'oppo'</span>]</span><br><span class="line">    pc_devices = [<span class="string">'Windows'</span>,<span class="string">'Mac'</span>]</span><br><span class="line">    channels = &#123;<span class="string">'web'</span>:web_devices, <span class="string">'app'</span>: app_devices, <span class="string">'pc'</span>: pc_devices&#125;</span><br><span class="line">    channel = random.choice(list(channels.keys()))</span><br><span class="line">    device = random.choice(channels[channel])</span><br><span class="line">    <span class="keyword">return</span> channel, device</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    sex_list = [<span class="string">'male'</span>, <span class="string">'female'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        channel, device = get_device()</span><br><span class="line">        register_date_time = register_randomDate(register_start, register_end, frmt=<span class="string">'%Y-%m-%d %H:%M:%S'</span>)</span><br><span class="line">        last_login_time = login_randomDate(login_start, login_end, frmt=<span class="string">'%Y-%m-%d %H:%M:%S'</span>)</span><br><span class="line">        real_name, user_name, age, sex, phone_number, province, email, ip_address, company, channel, device, register_date_time, last_login_time = fake.name(), fake.user_name(), random.choice(range(<span class="number">18</span>,<span class="number">65</span>)) ,random.choice(sex_list), fake.phone_number(), fake.province(), fake.ascii_free_email(), fake.ipv4(), fake.company(), channel, device, register_date_time, last_login_time</span><br><span class="line">        raw_data = &#123;<span class="string">'real_name'</span>: real_name, <span class="string">'user_name'</span>: user_name, <span class="string">'age'</span>:age, <span class="string">'sex'</span>:sex, <span class="string">'phone_number'</span>:phone_number,<span class="string">'province'</span>:province, <span class="string">'email'</span>:email, <span class="string">'ip_address'</span>:ip_address, <span class="string">'company'</span>:company, <span class="string">'channel'</span>:channel, <span class="string">'device'</span>:device, <span class="string">'register_date_time'</span>:register_date_time, <span class="string">'last_login_time'</span>:last_login_time&#125;</span><br><span class="line">        print(raw_data)</span><br><span class="line">        producer.send(<span class="string">'user_information'</span>, raw_data)</span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p><strong>数据样式</strong><br><strong><img src="https://cdn.nlark.com/yuque/0/2020/png/1072113/1590221962421-70f5a80f-f550-4b27-b5f5-cbac9439c013.png#align=left&display=inline&height=1846&margin=%5Bobject%20Object%5D&name=%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202020-05-23%20%E4%B8%8B%E5%8D%882.09.25.png&originHeight=1846&originWidth=3330&size=3843214&status=done&style=none&width=3330" alt="屏幕快照 2020-05-23 下午2.09.25.png"></strong><br></p><p><a name="reducefunction"></a></p><h3 id="ReduceFunction"><a href="#ReduceFunction" class="headerlink" title="ReduceFunction"></a>ReduceFunction</h3><p><br>ReduceFunction指定如何将输入中的两个元素组合在一起以产生相同类型的输出元素。Flink使用a ReduceFunction来逐步增量的聚合窗口元素。ReduceFunction的源码：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Applies a reduce function to the window. The window function is called for each evaluation</span></span><br><span class="line"><span class="comment"> * of the window for each key individually. The output of the reduce function is interpreted</span></span><br><span class="line"><span class="comment"> * as a regular non-windowed stream.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This window will try and pre-aggregate data as much as the window policies permit. For example,</span></span><br><span class="line"><span class="comment"> * tumbling time windows can perfectly pre-aggregate the data, meaning that only one element per</span></span><br><span class="line"><span class="comment"> * key is stored. Sliding time windows will pre-aggregate on the granularity of the slide</span></span><br><span class="line"><span class="comment"> * interval, so a few elements are stored per key (one per slide interval).</span></span><br><span class="line"><span class="comment"> * Custom windows may not be able to pre-aggregate, or may need to store extra values in an</span></span><br><span class="line"><span class="comment"> * aggregation tree.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param function The reduce function.</span></span><br><span class="line"><span class="comment"> * @return The data stream that is the result of applying the reduce function to the window.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reduce</span></span>(function: <span class="type">ReduceFunction</span>[<span class="type">T</span>]): <span class="type">DataStream</span>[<span class="type">T</span>] = &#123;</span><br><span class="line">  asScalaStream(javaStream.reduce(clean(function)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br>利用tumbling window举例</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> data_stream.window</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Properties</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.&#123;<span class="type">JSON</span>, <span class="type">JSONObject</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.runtime.state.filesystem.<span class="type">FsStateBackend</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.<span class="type">CheckpointingMode</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.&#123;<span class="type">DataStream</span>, <span class="type">StreamExecutionEnvironment</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.<span class="type">TimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.kafka.<span class="type">FlinkKafkaConsumerBase</span></span><br><span class="line"><span class="keyword">import</span> utils.<span class="type">KafkaUtil</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * reduce Function</span></span><br><span class="line"><span class="comment">  * 增量累加</span></span><br><span class="line"><span class="comment">  * 输入输出类型要一致</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">window_function_reduce</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">UserLogData</span>(<span class="params">real_name: <span class="type">String</span>, user_name: <span class="type">String</span>, age: <span class="type">Int</span>, sex: <span class="type">String</span>, phone_number: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">                         province: <span class="type">String</span>, email: <span class="type">String</span>, ip_address: <span class="type">String</span>, company: <span class="type">String</span>, channel: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">                         device: <span class="type">String</span>, register_date_time: <span class="type">String</span>, last_login_time: <span class="type">String</span></span>)</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  <span class="title">private</span> <span class="title">val</span> <span class="title">KAFKA_TOPIC</span></span>: <span class="type">String</span> = <span class="string">"user_information"</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> properties: <span class="type">Properties</span> = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">    properties.setProperty(<span class="string">"bootstrap.servers"</span>, <span class="string">"localhost:9092"</span>)</span><br><span class="line">    properties.setProperty(<span class="string">"group.id"</span>, <span class="string">"kafka_consumer"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    <span class="comment">// exactly-once 语义保证整个应用内端到端的数据一致性</span></span><br><span class="line">    env.getCheckpointConfig.setCheckpointingMode(<span class="type">CheckpointingMode</span>.<span class="type">EXACTLY_ONCE</span>)</span><br><span class="line">    <span class="comment">// 开启检查点并指定检查点时间间隔为5s</span></span><br><span class="line">    env.enableCheckpointing(<span class="number">5000</span>) <span class="comment">// checkpoint every 5000 msecs</span></span><br><span class="line">    <span class="comment">// 设置StateBackend，并指定状态数据存储位置</span></span><br><span class="line">    env.setStateBackend(<span class="keyword">new</span> <span class="type">FsStateBackend</span>(<span class="string">"file:///Users/cpeixin/IdeaProjects/code_warehouse/data/KafkaSource/tumbling"</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> kafkaSource: <span class="type">FlinkKafkaConsumerBase</span>[<span class="type">String</span>] = <span class="type">KafkaUtil</span>.getKafkaSource(<span class="type">KAFKA_TOPIC</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算窗口内5秒的数据</span></span><br><span class="line">    <span class="keyword">val</span> original_stream: <span class="type">DataStream</span>[<span class="type">String</span>] = env.addSource(kafkaSource)</span><br><span class="line">    <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">      |original_stream&gt; UserLogData(纪淑兰,ehao,37,female,18529008264,辽宁省,apeng@gmail.com,110.75.179.140,易动力科技有限公司,app,xiaomi,2017-08-18 12:29:29,2018-09-02 05:05:56)</span></span><br><span class="line"><span class="string">      |original_stream&gt; UserLogData(刘玉英,caojing,42,male,15647635274,香港特别行政区,houwei@hotmail.com,50.188.173.136,同兴万点传媒有限公司,web,Firefox,2017-10-27 12:20:20,2018-10-11 09:26:20)</span></span><br><span class="line"><span class="string">      |original_stream&gt; UserLogData(薛萍,leizhong,32,male,18928404956,云南省,xxiao@yahoo.com,115.123.146.193,网新恒天传媒有限公司,web,360_browser,2017-06-17 16:42:24,2018-09-19 19:36:39)</span></span><br><span class="line"><span class="string">    "</span><span class="string">""</span>.stripMargin</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 这里我们设定一个具体的需求，统计过去的5秒内，各省份访问的用户数量统计</span></span><br><span class="line"><span class="comment">      * 下面第二次map操作=》(String, Int)，是因为接下来要使用reduce函数</span></span><br><span class="line"><span class="comment">      * reduce函数聚合是要求输入和输出格式相同的。</span></span><br><span class="line"><span class="comment">      *</span></span><br><span class="line"><span class="comment">      * 以下的转换步骤可以串联的写在一起，但是在这里分开写是想清晰的展示每一步转换后，Stream的类型变换</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> original_format_stream: <span class="type">DataStream</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = original_stream</span><br><span class="line">      .map(match_data(_: <span class="type">String</span>))</span><br><span class="line">      .map((raw: <span class="type">UserLogData</span>) =&gt;(raw.province, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> province_window_stream: <span class="type">WindowedStream</span>[(<span class="type">String</span>, <span class="type">Int</span>), <span class="type">String</span>, <span class="type">TimeWindow</span>] = original_format_stream</span><br><span class="line">      .keyBy((_: (<span class="type">String</span>, <span class="type">Int</span>))._1)</span><br><span class="line">      .timeWindow(<span class="type">Time</span>.seconds(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> result_stream: <span class="type">DataStream</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = province_window_stream</span><br><span class="line">      .reduce((p1: (<span class="type">String</span>, <span class="type">Int</span>), p2: (<span class="type">String</span>, <span class="type">Int</span>)) =&gt; (p1._1, p1._2 + p2._2))</span><br><span class="line">    </span><br><span class="line">    result_stream.print(<span class="string">"province_count"</span>).setParallelism(<span class="number">1</span>)</span><br><span class="line">    env.execute(<span class="string">"province count stream"</span>)</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">match_data</span></span>(original_str: <span class="type">String</span>): <span class="type">UserLogData</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> original_json: <span class="type">JSONObject</span> = <span class="type">JSON</span>.parseObject(original_str)</span><br><span class="line">    <span class="type">UserLogData</span>(original_json.getString(<span class="string">"real_name"</span>), original_json.getString(<span class="string">"user_name"</span>), original_json.getInteger(<span class="string">"age"</span>),</span><br><span class="line">      original_json.getString(<span class="string">"sex"</span>), original_json.getString(<span class="string">"phone_number"</span>), original_json.getString(<span class="string">"province"</span>),</span><br><span class="line">      original_json.getString(<span class="string">"email"</span>), original_json.getString(<span class="string">"ip_address"</span>), original_json.getString(<span class="string">"company"</span>),</span><br><span class="line">      original_json.getString(<span class="string">"channel"</span>), original_json.getString(<span class="string">"device"</span>), original_json.getString(<span class="string">"register_date_time"</span>),</span><br><span class="line">      original_json.getString(<span class="string">"last_login_time"</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">province_count&gt; (安徽省,2)</span><br><span class="line">province_count&gt; (贵州省,1)</span><br><span class="line">province_count&gt; (江苏省,2)</span><br><span class="line">province_count&gt; (北京市,1)</span><br><span class="line">province_count&gt; (重庆市,1)</span><br><span class="line">province_count&gt; (湖南省,1)</span><br><span class="line">province_count&gt; (海南省,2)</span><br><span class="line">province_count&gt; (甘肃省,2)</span><br><span class="line">province_count&gt; (河南省,2)</span><br><span class="line">province_count&gt; (香港特别行政区,4)</span><br><span class="line">province_count&gt; (四川省,2)</span><br><span class="line">province_count&gt; (云南省,2)</span><br><span class="line">province_count&gt; (辽宁省,2)</span><br><span class="line">province_count&gt; (青海省,3)</span><br><span class="line">province_count&gt; (澳门特别行政区,1)</span><br><span class="line">province_count&gt; (天津市,1)</span><br><span class="line">province_count&gt; (新疆维吾尔自治区,1)</span><br><span class="line">province_count&gt; (河北省,2)</span><br><span class="line">province_count&gt; (吉林省,1)</span><br><span class="line">province_count&gt; (宁夏回族自治区,1)</span><br><span class="line">province_count&gt; (江西省,1)</span><br><span class="line">province_count&gt; (黑龙江省,1)</span><br><span class="line">province_count&gt; (山西省,5)</span><br><span class="line">province_count&gt; (西藏自治区,1)</span><br></pre></td></tr></table></figure><p><a name="aggregatefunction"></a></p><h3 id="AggregateFunction"><a href="#AggregateFunction" class="headerlink" title="AggregateFunction"></a>AggregateFunction</h3><p><br>AggregateFunction是一个普通版本ReduceFunction，其具有三种类型：输入类型（IN），累加器类型（ACC），和一个输出类型（OUT）。输入类型是输入流中数据的类型，并且AggregateFunction具有将一个输入元素添加到累加器的方法。该接口还具有创建初始累加器，将两个累加器合并为一个累加器以及OUT从累加器提取输出（类型）的方法。在下面的示例中，我们将了解其工作原理。与ReduceFunction一样，Flink将在窗口输入元素到达时逐步增量的聚合它们。<br><br><br>一个AggregateFunction可以被这样定义并使用：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The accumulator is used to keep a running sum and a count. The [getResult] method</span></span><br><span class="line"><span class="comment"> * computes the average.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AverageAggregate</span> <span class="keyword">extends</span> <span class="title">AggregateFunction</span>[(<span class="type">String</span>, <span class="type">Long</span>), (<span class="type">Long</span>, <span class="type">Long</span>), <span class="type">Double</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createAccumulator</span></span>() = (<span class="number">0</span>L, <span class="number">0</span>L)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(value: (<span class="type">String</span>, <span class="type">Long</span>), accumulator: (<span class="type">Long</span>, <span class="type">Long</span>)) =</span><br><span class="line">    (accumulator._1 + value._2, accumulator._2 + <span class="number">1</span>L)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getResult</span></span>(accumulator: (<span class="type">Long</span>, <span class="type">Long</span>)) = accumulator._1 / accumulator._2</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(a: (<span class="type">Long</span>, <span class="type">Long</span>), b: (<span class="type">Long</span>, <span class="type">Long</span>)) =</span><br><span class="line">    (a._1 + b._1, a._2 + b._2)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> input: <span class="type">DataStream</span>[(<span class="type">String</span>, <span class="type">Long</span>)] = ...</span><br><span class="line"></span><br><span class="line">input</span><br><span class="line">    .keyBy(&lt;key selector&gt;)</span><br><span class="line">    .window(&lt;window assigner&gt;)</span><br><span class="line">    .aggregate(<span class="keyword">new</span> <span class="type">AverageAggregate</span>)</span><br></pre></td></tr></table></figure><p><br>利用sliding window举例<br><br><br>aggregate()方法中不能像reduce(function: (T, T) =&gt; T)一样使用匿名函数，而是需要自定义继承了AggregateFunction的对象。</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> data_stream.window</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Properties</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.&#123;<span class="type">JSON</span>, <span class="type">JSONObject</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.<span class="type">AggregateFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.runtime.state.filesystem.<span class="type">FsStateBackend</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.<span class="type">CheckpointingMode</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.<span class="type">WindowFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.&#123;<span class="type">DataStream</span>, <span class="type">StreamExecutionEnvironment</span>, <span class="type">WindowedStream</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.assigners.<span class="type">SlidingProcessingTimeWindows</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.<span class="type">TimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.kafka.<span class="type">FlinkKafkaConsumerBase</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"><span class="keyword">import</span> utils.<span class="type">KafkaUtil</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">window_function_aggregate</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 增量处理，来一条数据处理一条。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">aggregate_channel_devices</span> <span class="keyword">extends</span> <span class="title">AggregateFunction</span>[((<span class="type">String</span>,<span class="type">String</span>), <span class="type">Int</span>),<span class="type">Long</span>, <span class="type">Long</span>]</span>&#123;</span><br><span class="line">    <span class="comment">// 数据累加逻辑</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(in: ((<span class="type">String</span>, <span class="type">String</span>), <span class="type">Int</span>), acc: <span class="type">Long</span>): <span class="type">Long</span> = acc + in._2</span><br><span class="line">    <span class="comment">// 累加器初始化</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createAccumulator</span></span>(): <span class="type">Long</span> = <span class="number">0</span>L</span><br><span class="line">    <span class="comment">// 累加器计算的结果</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getResult</span></span>(acc: <span class="type">Long</span>): <span class="type">Long</span> = acc</span><br><span class="line">    <span class="comment">// 不同分区之间，累加器的值相加</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(acc: <span class="type">Long</span>, acc1: <span class="type">Long</span>): <span class="type">Long</span> = acc + acc1</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 作用与窗口内，aggregate后数据的函数，窗口结束时运行</span></span><br><span class="line"><span class="comment">    * 基于接口WindowFunction[IN, OUT, KEY, W &lt;: Window]</span></span><br><span class="line"><span class="comment">    * IN ：输入参数，为 AggregateFunction的输出</span></span><br><span class="line"><span class="comment">    * OUT：输出参数</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">channel_devices_windowFuction</span> <span class="keyword">extends</span> <span class="title">WindowFunction</span>[<span class="type">Long</span>, ((<span class="type">String</span>, <span class="type">String</span>), <span class="type">Long</span>), (<span class="type">String</span>, <span class="type">String</span>), <span class="type">TimeWindow</span>]</span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>(key: (<span class="type">String</span>, <span class="type">String</span>), window: <span class="type">TimeWindow</span>, input: <span class="type">Iterable</span>[<span class="type">Long</span>], out: <span class="type">Collector</span>[((<span class="type">String</span>, <span class="type">String</span>), <span class="type">Long</span>)]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      out.collect((key, input.iterator.next()))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">UserLogData</span>(<span class="params">real_name: <span class="type">String</span>, user_name: <span class="type">String</span>, age: <span class="type">Int</span>, sex: <span class="type">String</span>, phone_number: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">                         province: <span class="type">String</span>, email: <span class="type">String</span>, ip_address: <span class="type">String</span>, company: <span class="type">String</span>, channel: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">                         device: <span class="type">String</span>, register_date_time: <span class="type">String</span>, last_login_time: <span class="type">String</span></span>)</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  <span class="title">private</span> <span class="title">val</span> <span class="title">KAFKA_TOPIC</span></span>: <span class="type">String</span> = <span class="string">"user_information"</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> properties: <span class="type">Properties</span> = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">    properties.setProperty(<span class="string">"bootstrap.servers"</span>, <span class="string">"localhost:9092"</span>)</span><br><span class="line">    properties.setProperty(<span class="string">"group.id"</span>, <span class="string">"kafka_consumer"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    <span class="comment">// exactly-once 语义保证整个应用内端到端的数据一致性</span></span><br><span class="line">    env.getCheckpointConfig.setCheckpointingMode(<span class="type">CheckpointingMode</span>.<span class="type">EXACTLY_ONCE</span>)</span><br><span class="line">    <span class="comment">// 开启检查点并指定检查点时间间隔为5s</span></span><br><span class="line">    env.enableCheckpointing(<span class="number">5000</span>) <span class="comment">// checkpoint every 5000 msecs</span></span><br><span class="line">    <span class="comment">// 设置StateBackend，并指定状态数据存储位置</span></span><br><span class="line">    env.setStateBackend(<span class="keyword">new</span> <span class="type">FsStateBackend</span>(<span class="string">"file:///Users/cpeixin/IdeaProjects/code_warehouse/data/KafkaSource/tumbling"</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> kafkaSource: <span class="type">FlinkKafkaConsumerBase</span>[<span class="type">String</span>] = <span class="type">KafkaUtil</span>.getKafkaSource(<span class="type">KAFKA_TOPIC</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算窗口内5秒的数据</span></span><br><span class="line">    <span class="keyword">val</span> original_stream: <span class="type">DataStream</span>[<span class="type">String</span>] = env.addSource(kafkaSource)</span><br><span class="line"></span><br><span class="line">    <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">      |original_stream&gt; UserLogData(纪淑兰,ehao,37,female,18529008264,辽宁省,apeng@gmail.com,110.75.179.140,易动力科技有限公司,app,xiaomi,2017-08-18 12:29:29,2018-09-02 05:05:56)</span></span><br><span class="line"><span class="string">      |original_stream&gt; UserLogData(刘玉英,caojing,42,male,15647635274,香港特别行政区,houwei@hotmail.com,50.188.173.136,同兴万点传媒有限公司,web,Firefox,2017-10-27 12:20:20,2018-10-11 09:26:20)</span></span><br><span class="line"><span class="string">      |original_stream&gt; UserLogData(薛萍,leizhong,32,male,18928404956,云南省,xxiao@yahoo.com,115.123.146.193,网新恒天传媒有限公司,web,360_browser,2017-06-17 16:42:24,2018-09-19 19:36:39)</span></span><br><span class="line"><span class="string">    "</span><span class="string">""</span>.stripMargin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 这里我们设定一个具体的需求，每5秒统计过去10秒中，用户渠道来源以及使用设备的排行</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> original_format_stream: <span class="type">DataStream</span>[((<span class="type">String</span>, <span class="type">String</span>),<span class="type">Int</span>)] = original_stream</span><br><span class="line">      .map(match_data(_: <span class="type">String</span>))</span><br><span class="line">      .map((raw: <span class="type">UserLogData</span>) =&gt; ((raw.channel, raw.device), <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    original_format_stream</span><br><span class="line">      .keyBy((_: ((<span class="type">String</span>, <span class="type">String</span>), <span class="type">Int</span>))._1)</span><br><span class="line">      .window(<span class="type">SlidingProcessingTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>),<span class="type">Time</span>.seconds(<span class="number">5</span>)))</span><br><span class="line">      .aggregate(<span class="keyword">new</span> aggregate_channel_devices, <span class="keyword">new</span> channel_devices_windowFuction)</span><br><span class="line">      .print(<span class="string">"channel_device"</span>)</span><br><span class="line">    env.execute(<span class="string">"channel_device stream"</span>)</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">match_data</span></span>(original_str: <span class="type">String</span>): <span class="type">UserLogData</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> original_json: <span class="type">JSONObject</span> = <span class="type">JSON</span>.parseObject(original_str)</span><br><span class="line">    <span class="type">UserLogData</span>(original_json.getString(<span class="string">"real_name"</span>), original_json.getString(<span class="string">"user_name"</span>), original_json.getInteger(<span class="string">"age"</span>),</span><br><span class="line">      original_json.getString(<span class="string">"sex"</span>), original_json.getString(<span class="string">"phone_number"</span>), original_json.getString(<span class="string">"province"</span>),</span><br><span class="line">      original_json.getString(<span class="string">"email"</span>), original_json.getString(<span class="string">"ip_address"</span>), original_json.getString(<span class="string">"company"</span>),</span><br><span class="line">      original_json.getString(<span class="string">"channel"</span>), original_json.getString(<span class="string">"device"</span>), original_json.getString(<span class="string">"register_date_time"</span>),</span><br><span class="line">      original_json.getString(<span class="string">"last_login_time"</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">channel_device:1&gt; ((app,Samsung),27)</span><br><span class="line">channel_device:2&gt; ((app,vivo),20)</span><br><span class="line">channel_device:3&gt; ((app,1+),19)</span><br><span class="line">channel_device:8&gt; ((pc,Mac),84)</span><br><span class="line">channel_device:4&gt; ((web,Chrome),26)</span><br><span class="line">channel_device:6&gt; ((app,meizu),22)</span><br><span class="line">channel_device:4&gt; ((app,oppo),21)</span><br><span class="line">channel_device:8&gt; ((pc,Windows),90)</span><br><span class="line">channel_device:3&gt; ((web,360_browser),25)</span><br><span class="line">channel_device:1&gt; ((web,QQ_browser),32)</span><br><span class="line">channel_device:2&gt; ((web,Opera),26)</span><br><span class="line">channel_device:3&gt; ((web,Firefox),34)</span><br><span class="line">channel_device:8&gt; ((web,UC_browser),25)</span><br><span class="line">channel_device:3&gt; ((app,huawei),19)</span><br></pre></td></tr></table></figure><p><a name="processwindowfunction"></a></p><h3 id="ProcessWindowFunction"><a href="#ProcessWindowFunction" class="headerlink" title="ProcessWindowFunction"></a>ProcessWindowFunction</h3><p><br>ProcessWindowFunction是处理窗口函数中，底层的处理数据API，获取一个Iterable，<strong>该Iterable包含窗口的所有元素</strong>，以及一个Context对象，该对象可以访问时间和状态信息，从而使其比其他窗口函数更具灵活性。这是以性能和资源消耗为代价的，因为无法增量聚合元素，而是需要在内部对其进行缓冲，直到将窗口视为已准备好进行处理为止。<br><br><br>ProcessWindowFunctionlook 的抽象类如下：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessWindowFunction</span>[<span class="type">IN</span>, <span class="type">OUT</span>, <span class="type">KEY</span>, <span class="type">W</span> &lt;: <span class="type">Window</span>] <span class="keyword">extends</span> <span class="title">Function</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Evaluates the window and outputs none or several elements.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * @param key      The key for which this window is evaluated.</span></span><br><span class="line"><span class="comment">    * @param context  The context in which the window is being evaluated.</span></span><br><span class="line"><span class="comment">    * @param elements The elements in the window being evaluated.</span></span><br><span class="line"><span class="comment">    * @param out      A collector for emitting elements.</span></span><br><span class="line"><span class="comment">    * @throws Exception The function may throw exceptions to fail the program and trigger recovery.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(</span><br><span class="line">      key: <span class="type">KEY</span>,</span><br><span class="line">      context: <span class="type">Context</span>,</span><br><span class="line">      elements: <span class="type">Iterable</span>[<span class="type">IN</span>],</span><br><span class="line">      out: <span class="type">Collector</span>[<span class="type">OUT</span>])</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The context holding window metadata</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * Returns the window that is being evaluated.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">window</span></span>: <span class="type">W</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * Returns the current processing time.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">currentProcessingTime</span></span>: <span class="type">Long</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * Returns the current event-time watermark.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">currentWatermark</span></span>: <span class="type">Long</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * State accessor for per-key and per-window state.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">windowState</span></span>: <span class="type">KeyedStateStore</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * State accessor for per-key global state.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">globalState</span></span>: <span class="type">KeyedStateStore</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br>Sliding Window 举例</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> data_stream.window</span><br><span class="line"><span class="keyword">import</span> java.text.<span class="type">SimpleDateFormat</span></span><br><span class="line"><span class="keyword">import</span> java.util.&#123;<span class="type">Date</span>, <span class="type">Properties</span>&#125;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.&#123;<span class="type">JSON</span>, <span class="type">JSONObject</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.runtime.state.filesystem.<span class="type">FsStateBackend</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.<span class="type">CheckpointingMode</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.&#123;<span class="type">DataStream</span>, <span class="type">StreamExecutionEnvironment</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.<span class="type">ProcessWindowFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.<span class="type">TimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.kafka.<span class="type">FlinkKafkaConsumerBase</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"><span class="keyword">import</span> utils.<span class="type">KafkaUtil</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">window_function_process</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">UserLogData</span>(<span class="params">real_name: <span class="type">String</span>, user_name: <span class="type">String</span>, age: <span class="type">Int</span>, sex: <span class="type">String</span>, phone_number: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">                         province: <span class="type">String</span>, email: <span class="type">String</span>, ip_address: <span class="type">String</span>, company: <span class="type">String</span>, channel: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">                         device: <span class="type">String</span>, register_date_time: <span class="type">String</span>, last_login_time: <span class="type">String</span></span>)</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  <span class="title">private</span> <span class="title">val</span> <span class="title">KAFKA_TOPIC</span></span>: <span class="type">String</span> = <span class="string">"user_information"</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> properties: <span class="type">Properties</span> = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">    properties.setProperty(<span class="string">"bootstrap.servers"</span>, <span class="string">"localhost:9092"</span>)</span><br><span class="line">    properties.setProperty(<span class="string">"group.id"</span>, <span class="string">"kafka_consumer"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line"></span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// exactly-once 语义保证整个应用内端到端的数据一致性</span></span><br><span class="line">    env.getCheckpointConfig.setCheckpointingMode(<span class="type">CheckpointingMode</span>.<span class="type">EXACTLY_ONCE</span>)</span><br><span class="line">    <span class="comment">// 开启检查点并指定检查点时间间隔为5s</span></span><br><span class="line">    env.enableCheckpointing(<span class="number">5000</span>) <span class="comment">// checkpoint every 5000 msecs</span></span><br><span class="line">    <span class="comment">// 设置StateBackend，并指定状态数据存储位置</span></span><br><span class="line">    env.setStateBackend(<span class="keyword">new</span> <span class="type">FsStateBackend</span>(<span class="string">"file:///Users/cpeixin/IdeaProjects/code_warehouse/data/KafkaSource/tumbling"</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> kafkaSource: <span class="type">FlinkKafkaConsumerBase</span>[<span class="type">String</span>] = <span class="type">KafkaUtil</span>.getKafkaSource(<span class="type">KAFKA_TOPIC</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算窗口内5秒的数据</span></span><br><span class="line">    <span class="keyword">val</span> original_stream: <span class="type">DataStream</span>[<span class="type">String</span>] = env.addSource(kafkaSource)</span><br><span class="line"></span><br><span class="line">    <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">      |original_stream&gt; UserLogData(纪淑兰,ehao,37,female,18529008264,辽宁省,apeng@gmail.com,110.75.179.140,易动力科技有限公司,app,xiaomi,2017-08-18 12:29:29,2018-09-02 05:05:56)</span></span><br><span class="line"><span class="string">      |original_stream&gt; UserLogData(刘玉英,caojing,42,male,15647635274,香港特别行政区,houwei@hotmail.com,50.188.173.136,同兴万点传媒有限公司,web,Firefox,2017-10-27 12:20:20,2018-10-11 09:26:20)</span></span><br><span class="line"><span class="string">      |original_stream&gt; UserLogData(薛萍,leizhong,32,male,18928404956,云南省,xxiao@yahoo.com,115.123.146.193,网新恒天传媒有限公司,web,360_browser,2017-06-17 16:42:24,2018-09-19 19:36:39)</span></span><br><span class="line"><span class="string">    "</span><span class="string">""</span>.stripMargin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 这里我们设定一个具体的需求，每5秒统计过去10秒中，用户渠道来源以及使用设备的排行</span></span><br><span class="line"><span class="comment">      * 这里是使用ProcessWindowFunction底层函数来做处理</span></span><br><span class="line"><span class="comment">      * 为了清楚的显示，在每个窗口上打印了时间。</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> original_format_stream: <span class="type">DataStream</span>[((<span class="type">String</span>, <span class="type">String</span>), <span class="type">Int</span>)] = original_stream</span><br><span class="line">      .map(match_data(_: <span class="type">String</span>))</span><br><span class="line">      .map((raw: <span class="type">UserLogData</span>) =&gt; ((raw.channel, raw.device), <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    original_format_stream</span><br><span class="line">      .keyBy((_: ((<span class="type">String</span>, <span class="type">String</span>), <span class="type">Int</span>))._1)</span><br><span class="line">      .timeWindow(<span class="type">Time</span>.seconds(<span class="number">10</span>), <span class="type">Time</span>.seconds(<span class="number">5</span>))</span><br><span class="line">      .process(<span class="keyword">new</span> <span class="type">ProcessWindowFunction</span>[((<span class="type">String</span>, <span class="type">String</span>), <span class="type">Int</span>), ((<span class="type">String</span>, <span class="type">String</span>), <span class="type">Long</span>), (<span class="type">String</span>, <span class="type">String</span>), <span class="type">TimeWindow</span>] &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(key: (<span class="type">String</span>, <span class="type">String</span>), context: <span class="type">Context</span>, elements: <span class="type">Iterable</span>[((<span class="type">String</span>, <span class="type">String</span>), <span class="type">Int</span>)], out: <span class="type">Collector</span>[((<span class="type">String</span>, <span class="type">String</span>), <span class="type">Long</span>)]): <span class="type">Unit</span> = &#123;</span><br><span class="line">          <span class="keyword">val</span> process_time: <span class="type">String</span> = <span class="keyword">new</span> <span class="type">SimpleDateFormat</span>(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>).format(<span class="keyword">new</span> <span class="type">Date</span>)</span><br><span class="line">          println(<span class="string">s"=========<span class="subst">$process_time</span>============="</span>)</span><br><span class="line">          out.collect((key, elements.size))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).print(<span class="string">"processFunctionWindow"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    env.execute(<span class="string">"process function stream"</span>)</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">match_data</span></span>(original_str: <span class="type">String</span>): <span class="type">UserLogData</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> original_json: <span class="type">JSONObject</span> = <span class="type">JSON</span>.parseObject(original_str)</span><br><span class="line">    <span class="type">UserLogData</span>(original_json.getString(<span class="string">"real_name"</span>), original_json.getString(<span class="string">"user_name"</span>), original_json.getInteger(<span class="string">"age"</span>),</span><br><span class="line">      original_json.getString(<span class="string">"sex"</span>), original_json.getString(<span class="string">"phone_number"</span>), original_json.getString(<span class="string">"province"</span>),</span><br><span class="line">      original_json.getString(<span class="string">"email"</span>), original_json.getString(<span class="string">"ip_address"</span>), original_json.getString(<span class="string">"company"</span>),</span><br><span class="line">      original_json.getString(<span class="string">"channel"</span>), original_json.getString(<span class="string">"device"</span>), original_json.getString(<span class="string">"register_date_time"</span>),</span><br><span class="line">      original_json.getString(<span class="string">"last_login_time"</span>))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br>结果打印</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">15</span>=============</span><br><span class="line">processFunctionWindow&gt; ((web,<span class="type">QQ_browser</span>),<span class="number">76</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">15</span>=============</span><br><span class="line">processFunctionWindow&gt; ((pc,<span class="type">Mac</span>),<span class="number">217</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">15</span>=============</span><br><span class="line">processFunctionWindow&gt; ((app,oppo),<span class="number">50</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">15</span>=============</span><br><span class="line">processFunctionWindow&gt; ((app,<span class="type">Samsung</span>),<span class="number">58</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">15</span>=============</span><br><span class="line">processFunctionWindow&gt; ((app,huawei),<span class="number">54</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">15</span>=============</span><br><span class="line">processFunctionWindow&gt; ((web,<span class="type">UC_browser</span>),<span class="number">54</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">15</span>=============</span><br><span class="line">processFunctionWindow&gt; ((web,<span class="type">Firefox</span>),<span class="number">63</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">15</span>=============</span><br><span class="line">processFunctionWindow&gt; ((web,<span class="number">360</span>_browser),<span class="number">66</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">15</span>=============</span><br><span class="line">processFunctionWindow&gt; ((app,meizu),<span class="number">56</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">15</span>=============</span><br><span class="line">processFunctionWindow&gt; ((app,xiaomi),<span class="number">53</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">15</span>=============</span><br><span class="line">processFunctionWindow&gt; ((app,vivo),<span class="number">49</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">15</span>=============</span><br><span class="line">processFunctionWindow&gt; ((app,iphone),<span class="number">61</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">15</span>=============</span><br><span class="line">processFunctionWindow&gt; ((web,<span class="type">Chrome</span>),<span class="number">57</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">15</span>=============</span><br><span class="line">processFunctionWindow&gt; ((pc,<span class="type">Windows</span>),<span class="number">230</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">15</span>=============</span><br><span class="line">processFunctionWindow&gt; ((web,<span class="type">Opera</span>),<span class="number">73</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">15</span>=============</span><br><span class="line">processFunctionWindow&gt; ((app,<span class="number">1</span>+),<span class="number">50</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">20</span>=============</span><br><span class="line">processFunctionWindow&gt; ((web,<span class="type">UC_browser</span>),<span class="number">55</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">20</span>=============</span><br><span class="line">processFunctionWindow&gt; ((web,<span class="type">Chrome</span>),<span class="number">60</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">20</span>=============</span><br><span class="line">processFunctionWindow&gt; ((app,<span class="number">1</span>+),<span class="number">50</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">20</span>=============</span><br><span class="line">processFunctionWindow&gt; ((app,huawei),<span class="number">54</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">20</span>=============</span><br><span class="line">processFunctionWindow&gt; ((web,<span class="type">QQ_browser</span>),<span class="number">76</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">20</span>=============</span><br><span class="line">processFunctionWindow&gt; ((app,<span class="type">Samsung</span>),<span class="number">58</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">20</span>=============</span><br><span class="line">processFunctionWindow&gt; ((pc,<span class="type">Windows</span>),<span class="number">231</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">20</span>=============</span><br><span class="line">processFunctionWindow&gt; ((app,oppo),<span class="number">51</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">20</span>=============</span><br><span class="line">processFunctionWindow&gt; ((web,<span class="type">Opera</span>),<span class="number">74</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">20</span>=============</span><br><span class="line">processFunctionWindow&gt; ((web,<span class="type">Firefox</span>),<span class="number">64</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">20</span>=============</span><br><span class="line">processFunctionWindow&gt; ((app,vivo),<span class="number">49</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">20</span>=============</span><br><span class="line">processFunctionWindow&gt; ((app,xiaomi),<span class="number">53</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">20</span>=============</span><br><span class="line">processFunctionWindow&gt; ((app,meizu),<span class="number">57</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">20</span>=============</span><br><span class="line">processFunctionWindow&gt; ((pc,<span class="type">Mac</span>),<span class="number">218</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">20</span>=============</span><br><span class="line">processFunctionWindow&gt; ((app,iphone),<span class="number">61</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">20</span>=============</span><br><span class="line">processFunctionWindow&gt; ((web,<span class="number">360</span>_browser),<span class="number">66</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">25</span>=============</span><br><span class="line">processFunctionWindow&gt; ((web,<span class="type">Opera</span>),<span class="number">3</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">25</span>=============</span><br><span class="line">processFunctionWindow&gt; ((web,<span class="type">Chrome</span>),<span class="number">3</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">25</span>=============</span><br><span class="line">processFunctionWindow&gt; ((app,meizu),<span class="number">1</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">25</span>=============</span><br><span class="line">processFunctionWindow&gt; ((web,<span class="type">Firefox</span>),<span class="number">5</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">25</span>=============</span><br><span class="line">processFunctionWindow&gt; ((pc,<span class="type">Mac</span>),<span class="number">2</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">25</span>=============</span><br><span class="line">processFunctionWindow&gt; ((app,oppo),<span class="number">1</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">25</span>=============</span><br><span class="line">processFunctionWindow&gt; ((pc,<span class="type">Windows</span>),<span class="number">1</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">25</span>=============</span><br><span class="line">processFunctionWindow&gt; ((web,<span class="type">UC_browser</span>),<span class="number">3</span>)</span><br><span class="line">=========<span class="number">2018</span><span class="number">-05</span><span class="number">-17</span> <span class="number">19</span>:<span class="number">29</span>:<span class="number">25</span>=============</span><br><span class="line">processFunctionWindow&gt; ((app,huawei),<span class="number">1</span>)</span><br></pre></td></tr></table></figure><br></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="cpeixin.cn/2019/09/17/Flink-window%E7%AA%97%E5%8F%A3%E6%93%8D%E4%BD%9C/" title="Flink window窗口操作" target="_blank" rel="external">cpeixin.cn/2019/09/17/Flink-window%E7%AA%97%E5%8F%A3%E6%93%8D%E4%BD%9C/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external nofollow noopener noreferrer">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://github.com/cpeixin" target="_blank" class="img-burn thumb-sm visible-lg" rel="external nofollow noopener noreferrer"><img src="/images/avatar.jpg" class="img-rounded w-full" alt></a></div><div class="media-body"><h3 class="media-heading"><a href="https://github.com/cpeixin" target="_blank" rel="external nofollow noopener noreferrer"><span class="text-dark">Brent</span><small class="ml-1x">大数据工程师 &amp; 机器学习</small></a></h3><div>一心九用的工程师</div></div></figure></div></div></div></article><section id="comments"><div id="vcomments"></div></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/2019/10/05/Hive-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/" title="Hive 窗口函数"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a></li><li class="next"><a href="/2019/09/15/Redis%E7%AE%80%E4%BB%8B/" title="Redis简介"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li></ul><button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div></div></div></nav><div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content donate"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><div class="modal-body"><div class="donate-box"><div class="donate-head"><p>感谢您的支持，我会继续努力的!</p></div><div class="tab-content"><div role="tabpanel" class="tab-pane fade active in" id="alipay"><div class="donate-payimg"><img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p></div><div role="tabpanel" class="tab-pane fade" id="wechatpay"><div class="donate-payimg"><img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p></div></div><div class="donate-footer"><ul class="nav nav-tabs nav-justified" role="tablist"><li role="presentation" class="active"><a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a></li><li role="presentation"><a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a></li></ul></div></div></div></div></div></div></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/cpeixin" target="_blank" title="Github" data-toggle="tooltip" data-placement="top" rel="external nofollow noopener noreferrer"><i class="icon icon-github"></i></a></li><li><a href="https://www.weibo.com/u/1970875963" target="_blank" title="Weibo" data-toggle="tooltip" data-placement="top" rel="external nofollow noopener noreferrer"><i class="icon icon-weibo"></i></a></li><li><a href="https://twitter.com/iwebued" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top" rel="external nofollow noopener noreferrer"><i class="icon icon-twitter"></i></a></li><li><a href="https://www.behance.net/cofess" target="_blank" title="Behance" data-toggle="tooltip" data-placement="top" rel="external nofollow noopener noreferrer"><i class="icon icon-behance"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul><div class="copyright"><div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank" rel="external nofollow noopener noreferrer">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank" rel="external nofollow noopener noreferrer">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>!function(T){var N={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"};T.INSIGHT_CONFIG=N}(window)</script><script src="/js/insight.js"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine"></script><script type="text/javascript">var GUEST=["nick","mail","link"],meta="nick,mail,link";meta=meta.split(",").filter(function(e){return GUEST.indexOf(e)>-1}),new Valine({el:"#vcomments",verify:!1,notify:!1,appId:"SsxmBzBQ3R2S2zWTv0FrONel-gzGzoHsz",appKey:"w0K528Ye7NhOr07RHrzVzHbW",placeholder:"说点什么呢？",avatar:"mm",meta:meta,pageSize:"10",visitor:!0})</script><script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.js"></script><script>$(document).ready(function(){$("article img").not("[hidden]").not(".panel-body img").each(function(){var a=$(this),t=a.attr("alt"),n=a.parent("a");if(n.length<1){var e=this.getAttribute("src"),r=e.lastIndexOf("?");-1!=r&&(e=e.substring(0,r)),n=a.wrap('<a href="'+e+'"></a>').parent("a")}n.attr("data-fancybox","images"),t&&n.attr("data-caption",t)}),$().fancybox({selector:'[data-fancybox="images"]',hash:!1,loop:!1})})</script></body></html><script type="text/javascript" src="//cdn.jsdelivr.net/gh/ygbhf/clicklove/clicklove.js"></script><!-- rebuild by neat -->